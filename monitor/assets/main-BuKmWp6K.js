const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/virtual_pwa-register-4EJd4gx4.js","assets/map-XSi3F034.js","assets/map-B1CfjdFi.css"])))=>i.map(i=>d[i]);
var qa=Object.defineProperty;var ja=(p,e,t)=>e in p?qa(p,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):p[e]=t;var y=(p,e,t)=>ja(p,typeof e!="symbol"?e+"":e,t);import"./main-KbY2xpw4.js";import{m as Va,M as Wa,P as ts,G as Ya,I as mt,S as R,T as ze,A as Za,H as Ka,_ as Xa}from"./map-XSi3F034.js";import{I as Qa,g as T,t as r,e as m,s as we,a as Ja,P as Gt,h as ei,b as ti,c as si,d as He,i as gt,f as ai,j as ii,k as ni,l as oi,U as ce,m as ha,S as M,M as ri,n as Xe,o as ga,C as Le,p as ss,N as Ne,G as Qe,q as De,E as ma,r as li,A as Se,u as ya,v as va,w as fa,x as ba,T as We,y as qt,z as jt,F as Vt,B as Wt,D as Yt,H as Ca,J as wa,K as ka,L as $a,O as le,Q as It,R as ci,V as pi,W as Sa,X as di,Y as ui,Z as La,_ as hi,$ as gi,a0 as mi,a1 as G,a2 as as,a3 as is,a4 as yi,a5 as vi,a6 as fi,a7 as yt,a8 as Ea,a9 as Rt,aa as bi,ab as Ci,ac as st,ad as wi,ae as ki,af as Z,ag as _e,ah as se,ai as ns,aj as $i,ak as Si,al as be,am as vt,an as os,ao as Li,ap as Ei,aq as xi,ar as rs,as as Mi,at as Ti,au as ls,av as Pi,aw as Ai,ax as Ii,ay as Ri,az as Ni,aA as S,aB as Di,aC as cs,aD as Fi,aE as W,aF as ps,aG as Hi,aH as Oe,aI as Bi,aJ as zi,aK as _i,aL as ds,aM as us,aN as hs,aO as Oi,aP as Ui,aQ as Gi,aR as qi,aS as ji,aT as gs,aU as O,aV as Vi,aW as Wi,aX as Yi,aY as Zi,aZ as Ki,a_ as Xi,a$ as Qi,b0 as at,b1 as Ji,b2 as en,b3 as tn,b4 as sn,b5 as an,b6 as nn,b7 as on,b8 as rn,b9 as ln,ba as cn,bb as pn,bc as dn,bd as un,be as hn,bf as gn,bg as mn,bh as yn,bi as vn,bj as fn,bk as bn,bl as Cn,bm as wn,bn as kn,bo as $n,bp as ms,bq as ys,br as vs,bs as Sn,bt as fs,bu as bs,bv as Cs,bw as ft,bx as bt,by as Ln,bz as En,bA as xn,bB as ws,bC as Mn,bD as Tn,bE as Pn,bF as An,bG as In,bH as Rn,bI as ks,bJ as $s,bK as Ss,bL as Ls,bM as Es,bN as Ct,bO as Nn,bP as Dn,bQ as Fn,bR as Hn,bS as Bn,bT as zn,bU as xs,bV as Ms,bW as Ts,bX as Ps,bY as As,bZ as Is,b_ as Rs,b$ as Ns,c0 as wt,c1 as Ds,c2 as Fs,c3 as Ue,c4 as Hs,c5 as Bs,c6 as zs,c7 as _n,c8 as On,c9 as Un,ca as Gn,cb as qn,cc as jn,cd as Vn,ce as _s,cf as Wn,cg as Yn,ch as Zn,ci as Kn,cj as Os,ck as kt,cl as Us,cm as Xn,cn as Qn,co as Jn,cp as eo,cq as to,cr as so,cs as ao,ct as io,cu as no,cv as oo,cw as it,cx as ro,cy as lo,cz as Gs,cA as qs,cB as xa,cC as co,cD as po,cE as uo,cF as ho,cG as go,cH as mo,cI as yo}from"./panels-iVzERR9n.js";import{s as Ye,t as vo,b as fo,a as bo,c as js,i as Co,e as wo,g as ko,l as Vs,d as Ws}from"./d3-B0sBblMR.js";import{f as $o}from"./topojson-BwRznoQ3.js";import{i as So}from"./sentry-CPVEVcfH.js";import"./i18n-VWbTNjcU.js";var Lo="@vercel/analytics",Eo="1.6.1",xo=()=>{window.va||(window.va=function(...e){(window.vaq=window.vaq||[]).push(e)})};function Ma(){return typeof window<"u"}function Ta(){try{const p="production"}catch{}return"production"}function Mo(p="auto"){if(p==="auto"){window.vam=Ta();return}window.vam=p}function To(){return(Ma()?window.vam:Ta())||"production"}function Nt(){return To()==="development"}function Po(p){return p.scriptSrc?p.scriptSrc:Nt()?"https://va.vercel-scripts.com/v1/script.debug.js":p.basePath?`${p.basePath}/insights/script.js`:"/_vercel/insights/script.js"}function Ao(p={debug:!0}){var e;if(!Ma())return;Mo(p.mode),xo(),p.beforeSend&&((e=window.va)==null||e.call(window,"beforeSend",p.beforeSend));const t=Po(p);if(document.head.querySelector(`script[src*="${t}"]`))return;const s=document.createElement("script");s.src=t,s.defer=!0,s.dataset.sdkn=Lo+(p.framework?`/${p.framework}`:""),s.dataset.sdkv=Eo,p.disableAutoTrack&&(s.dataset.disableAutoTrack="1"),p.endpoint?s.dataset.endpoint=p.endpoint:p.basePath&&(s.dataset.endpoint=`${p.basePath}/insights`),p.dsn&&(s.dataset.dsn=p.dsn),s.onerror=()=>{const a=Nt()?"Please check if any ad blockers are enabled and try again.":"Be sure to enable Web Analytics for your project and deploy again. See https://vercel.com/docs/analytics/quickstart for more information.";console.log(`[Vercel Web Analytics] Failed to load script from ${t}. ${a}`)},Nt()&&p.debug===!1&&(s.dataset.debug="false"),document.head.appendChild(s)}const Pa=new Qa("",{fetch:fetch.bind(globalThis)}),Io={military_flights:"Military flights",vessels:"Naval vessels",protests:"Protests",news:"News velocity",ais_gaps:"Dark ship activity",satellite_fires:"Satellite fire detections"},Ro=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],No=["","January","February","March","April","May","June","July","August","September","October","November","December"];function Do(p,e,t,s,a){const i=new Date,n=Ro[i.getUTCDay()],l=No[i.getUTCMonth()+1],o=a<10?`${a.toFixed(1)}x`:`${Math.round(a)}x`;return`${Io[p]} ${o} normal for ${n} (${l}) ‚Äî ${t} vs baseline ${Math.round(s)}`}function Fo(p){return p>=3?"critical":p>=2?"high":"medium"}async function Ho(p){try{await Pa.recordBaselineSnapshot({updates:p})}catch(e){console.warn("[TemporalBaseline] Update failed:",e)}}async function Bo(p,e,t){var s,a;try{const i=await Pa.getTemporalBaseline({type:p,region:e,count:t});return i.anomaly?{type:p,region:e,currentCount:t,expectedCount:Math.round(((s=i.baseline)==null?void 0:s.mean)??0),zScore:i.anomaly.zScore,severity:Fo(i.anomaly.zScore),message:Do(p,e,t,((a=i.baseline)==null?void 0:a.mean)??0,i.anomaly.multiplier)}:null}catch(i){return console.warn("[TemporalBaseline] Check failed:",i),null}}async function Ge(p){return Ho(p).catch(()=>{}),(await Promise.allSettled(p.map(t=>Bo(t.type,t.region,t.count)))).filter(t=>t.status==="fulfilled").map(t=>t.value).filter(t=>t!==null).sort((t,s)=>s.zScore-t.zScore)}function zo(p,e,t,s){p==null||p.enableLayer("gulfInvestments"),e.gulfInvestments=!0,p==null||p.setCenter(t,s,6)}const Ae=new Map;let Ys=0;const _o=1100;function Oo(p,e){return`${p.toFixed(1)},${e.toFixed(1)}`}async function Uo(p,e){var i,n,l;const t=Oo(p,e);if(Ae.has(t))return Ae.get(t)??null;const s=Date.now(),a=_o-(s-Ys);a>0&&await new Promise(o=>setTimeout(o,a)),Ys=Date.now();try{const o=`https://nominatim.openstreetmap.org/reverse?lat=${p}&lon=${e}&format=json&zoom=3&accept-language=en`,c=await fetch(o,{headers:{"User-Agent":"WorldMonitor/2.0 (https://worldmonitor.app)"}});if(!c.ok)return Ae.set(t,null),null;const h=await c.json(),d=(i=h.address)==null?void 0:i.country,g=(l=(n=h.address)==null?void 0:n.country_code)==null?void 0:l.toUpperCase();if(!d||!g)return Ae.set(t,null),null;const u={country:d,code:g,displayName:h.display_name||d};return Ae.set(t,u),u}catch(o){return console.warn("[reverseGeocode] Failed:",o),Ae.set(t,null),null}}const $e=class $e{constructor(){y(this,"overlay");y(this,"currentCode",null);y(this,"currentName",null);y(this,"currentHeadlineCount",0);y(this,"currentScore",null);y(this,"currentSignals",null);y(this,"currentBrief",null);y(this,"currentHeadlines",[]);y(this,"onCloseCallback");y(this,"onShareStory");y(this,"onExportImage");y(this,"boundExportMenuClose",null);y(this,"boundCitationClick",null);y(this,"abortController",new AbortController);this.overlay=document.createElement("div"),this.overlay.className="country-brief-overlay",document.body.appendChild(this.overlay),this.overlay.addEventListener("click",e=>{e.target.classList.contains("country-brief-overlay")&&this.hide()}),document.addEventListener("keydown",e=>{e.key==="Escape"&&this.overlay.classList.contains("active")&&this.hide()})}countryFlag(e){try{return e.toUpperCase().split("").map(t=>String.fromCodePoint(127462+t.charCodeAt(0)-65)).join("")}catch{return"üåç"}}levelColor(e){return T({critical:"--semantic-critical",high:"--semantic-high",elevated:"--semantic-elevated",normal:"--semantic-normal",low:"--semantic-low"}[e]||"--text-dim")}levelBadge(e){const t=this.levelColor(e),a=r(`countryBrief.levels.${e}`);return`<span class="cb-badge" style="background:${t}20;color:${t};border:1px solid ${t}40">${a.toUpperCase()}</span>`}trendIndicator(e){const t=e==="rising"?"‚Üó":e==="falling"?"‚Üò":"‚Üí",s=e==="rising"?"trend-up":e==="falling"?"trend-down":"trend-stable",i=r(`countryBrief.trends.${e}`);return`<span class="cb-trend ${s}">${t} ${i}</span>`}scoreRing(e,t){const s=this.levelColor(t),a=Math.min(100,Math.max(0,e)),i=2*Math.PI*42,n=i*(1-a/100);return`
      <div class="cb-score-ring">
        <svg viewBox="0 0 100 100" width="120" height="120">
          <circle cx="50" cy="50" r="42" fill="none" stroke="rgba(255,255,255,0.06)" stroke-width="6"/>
          <circle cx="50" cy="50" r="42" fill="none" stroke="${s}" stroke-width="6"
            stroke-dasharray="${i}" stroke-dashoffset="${n}"
            stroke-linecap="round" transform="rotate(-90 50 50)"
            style="transition: stroke-dashoffset 0.8s ease"/>
        </svg>
        <div class="cb-score-value" style="color:${s}">${e}</div>
        <div class="cb-score-label">/ 100</div>
      </div>`}componentBars(e){return[{label:r("modals.countryBrief.components.unrest"),value:e.unrest,icon:"üì¢"},{label:r("modals.countryBrief.components.conflict"),value:e.conflict,icon:"‚öî"},{label:r("modals.countryBrief.components.security"),value:e.security,icon:"üõ°Ô∏è"},{label:r("modals.countryBrief.components.information"),value:e.information,icon:"üì°"}].map(({label:s,value:a,icon:i})=>{const n=Math.min(100,Math.max(0,a)),l=n>=70?T("--semantic-critical"):n>=50?T("--semantic-high"):n>=30?T("--semantic-elevated"):T("--semantic-normal");return`
        <div class="cb-comp-row">
          <span class="cb-comp-icon">${i}</span>
          <span class="cb-comp-label">${s}</span>
          <div class="cb-comp-bar"><div class="cb-comp-fill" style="width:${n}%;background:${l}"></div></div>
          <span class="cb-comp-val">${Math.round(a)}</span>
        </div>`}).join("")}signalChips(e){const t=[];if(e.protests>0&&t.push(`<span class="signal-chip protest">üì¢ ${e.protests} ${r("modals.countryBrief.signals.protests")}</span>`),e.militaryFlights>0&&t.push(`<span class="signal-chip military">‚úàÔ∏è ${e.militaryFlights} ${r("modals.countryBrief.signals.militaryAir")}</span>`),e.militaryVessels>0&&t.push(`<span class="signal-chip military">‚öì ${e.militaryVessels} ${r("modals.countryBrief.signals.militarySea")}</span>`),e.outages>0&&t.push(`<span class="signal-chip outage">üåê ${e.outages} ${r("modals.countryBrief.signals.outages")}</span>`),e.earthquakes>0&&t.push(`<span class="signal-chip quake">üåç ${e.earthquakes} ${r("modals.countryBrief.signals.earthquakes")}</span>`),e.displacementOutflow>0){const s=e.displacementOutflow>=1e6?`${(e.displacementOutflow/1e6).toFixed(1)}M`:`${(e.displacementOutflow/1e3).toFixed(0)}K`;t.push(`<span class="signal-chip displacement">üåä ${s} ${r("modals.countryBrief.signals.displaced")}</span>`)}return e.climateStress>0&&t.push(`<span class="signal-chip climate">üå°Ô∏è ${r("modals.countryBrief.signals.climate")}</span>`),e.conflictEvents>0&&t.push(`<span class="signal-chip conflict">‚öîÔ∏è ${e.conflictEvents} ${r("modals.countryBrief.signals.conflictEvents")}</span>`),t.push(`<span class="signal-chip stock-loading">üìà ${r("modals.countryBrief.loadingIndex")}</span>`),t.join("")}setShareStoryHandler(e){this.onShareStory=e}setExportImageHandler(e){this.onExportImage=e}showLoading(){var e;this.currentCode="__loading__",this.overlay.innerHTML=`
      <div class="country-brief-page">
        <div class="cb-header">
          <div class="cb-header-left">
            <span class="cb-flag">üåç</span>
            <span class="cb-country-name">${r("modals.countryBrief.identifying")}</span>
          </div>
          <div class="cb-header-right">
            <button class="cb-close" aria-label="${r("components.newsPanel.close")}">√ó</button>
          </div>
        </div>
        <div class="cb-body">
          <div class="cb-loading-state">
            <div class="intel-skeleton"></div>
            <div class="intel-skeleton short"></div>
            <span class="intel-loading-text">${r("modals.countryBrief.locating")}</span>
          </div>
        </div>
      </div>`,(e=this.overlay.querySelector(".cb-close"))==null||e.addEventListener("click",()=>this.hide()),this.overlay.classList.add("active")}get signal(){return this.abortController.signal}show(e,t,s,a){var c,h,d;this.abortController.abort(),this.abortController=new AbortController,this.currentCode=t,this.currentName=e,this.currentScore=s,this.currentSignals=a,this.currentBrief=null,this.currentHeadlines=[],this.currentHeadlineCount=0;const i=this.countryFlag(t),n=a.isTier1?"":`<span class="cb-tier-badge">${r("modals.countryBrief.limitedCoverage")}</span>`;this.overlay.innerHTML=`
      <div class="country-brief-page">
        <div class="cb-header">
          <div class="cb-header-left">
            <span class="cb-flag">${i}</span>
            <span class="cb-country-name">${m(e)}</span>
            ${s?this.levelBadge(s.level):""}
            ${s?this.trendIndicator(s.trend):""}
            ${n}
          </div>
          <div class="cb-header-right">
            <button class="cb-share-btn" title="${r("components.countryBrief.shareStory")}">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v7a2 2 0 002 2h12a2 2 0 002-2v-7"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
            </button>
            <button class="cb-print-btn" title="${r("components.countryBrief.printPdf")}">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9V2h12v7"/><path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
            </button>
            <div style="position:relative;display:inline-block">
              <button class="cb-export-btn" title="${r("components.countryBrief.exportData")}">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
              </button>
              <div class="cb-export-menu hidden">
                <button class="cb-export-option" data-format="image">${r("common.exportImage")}</button>
                <button class="cb-export-option" data-format="json">${r("common.exportJson")}</button>
                <button class="cb-export-option" data-format="csv">${r("common.exportCsv")}</button>
              </div>
            </div>
            <button class="cb-close" aria-label="${r("components.newsPanel.close")}">√ó</button>
          </div>
        </div>
        <div class="cb-body">
          <div class="cb-grid">
            <div class="cb-col-left">
              ${s?`
                <section class="cb-section cb-risk-section">
                  <h3 class="cb-section-title">${r("modals.countryBrief.instabilityIndex")}</h3>
                  <div class="cb-risk-content">
                    ${this.scoreRing(s.score,s.level)}
                    <div class="cb-components">
                      ${this.componentBars(s.components)}
                    </div>
                  </div>
                </section>`:a.isTier1?"":`
                <section class="cb-section cb-risk-section">
                  <h3 class="cb-section-title">${r("modals.countryBrief.instabilityIndex")}</h3>
                  <div class="cb-not-tracked">
                    <span class="cb-not-tracked-icon">üìä</span>
                    <span>${r("modals.countryBrief.notTracked",{country:m(e)})}</span>
                  </div>
                </section>`}

              <section class="cb-section cb-brief-section">
                <h3 class="cb-section-title">${r("modals.countryBrief.intelBrief")}</h3>
                <div class="cb-brief-content">
                  <div class="intel-brief-loading">
                    <div class="intel-skeleton"></div>
                    <div class="intel-skeleton short"></div>
                    <div class="intel-skeleton"></div>
                    <div class="intel-skeleton short"></div>
                    <span class="intel-loading-text">${r("modals.countryBrief.generatingBrief")}</span>
                  </div>
                </div>
              </section>

              <section class="cb-section cb-news-section" style="display:none">
                <h3 class="cb-section-title">${r("modals.countryBrief.topNews")}</h3>
                <div class="cb-news-content"></div>
              </section>
            </div>

            <div class="cb-col-right">
              <section class="cb-section cb-signals-section">
                <h3 class="cb-section-title">${r("modals.countryBrief.activeSignals")}</h3>
                <div class="cb-signals-grid">
                  ${this.signalChips(a)}
                </div>
              </section>

              <section class="cb-section cb-timeline-section">
                <h3 class="cb-section-title">${r("modals.countryBrief.timeline")}</h3>
                <div class="cb-timeline-mount"></div>
              </section>

              <section class="cb-section cb-markets-section">
                <h3 class="cb-section-title">${r("modals.countryBrief.predictionMarkets")}</h3>
                <div class="cb-markets-content">
                  <span class="intel-loading-text">${r("modals.countryBrief.loadingMarkets")}</span>
                </div>
              </section>

              <section class="cb-section cb-infra-section" style="display:none">
                <h3 class="cb-section-title">${r("modals.countryBrief.infrastructure")}</h3>
                <div class="cb-infra-content"></div>
              </section>

            </div>
          </div>
        </div>
      </div>`,(c=this.overlay.querySelector(".cb-close"))==null||c.addEventListener("click",()=>this.hide()),(h=this.overlay.querySelector(".cb-share-btn"))==null||h.addEventListener("click",()=>{this.onShareStory&&this.currentCode&&this.currentName&&this.onShareStory(this.currentCode,this.currentName)}),(d=this.overlay.querySelector(".cb-print-btn"))==null||d.addEventListener("click",()=>{window.print()});const l=this.overlay.querySelector(".cb-export-btn"),o=this.overlay.querySelector(".cb-export-menu");l==null||l.addEventListener("click",g=>{g.stopPropagation(),o==null||o.classList.toggle("hidden")}),this.overlay.querySelectorAll(".cb-export-option").forEach(g=>{g.addEventListener("click",()=>{const u=g.dataset.format;u==="image"?this.onExportImage&&this.currentCode&&this.currentName&&this.onExportImage(this.currentCode,this.currentName):this.exportBrief(u),o==null||o.classList.add("hidden")})}),this.boundExportMenuClose&&this.overlay.removeEventListener("click",this.boundExportMenuClose),this.boundCitationClick&&this.overlay.removeEventListener("click",this.boundCitationClick),this.boundExportMenuClose=()=>o==null?void 0:o.classList.add("hidden"),this.overlay.addEventListener("click",this.boundExportMenuClose),this.boundCitationClick=g=>{const u=g.target;if(u.classList.contains("cb-citation")){g.preventDefault();const v=u.getAttribute("href");if(v){const f=this.overlay.querySelector(v);f==null||f.scrollIntoView({behavior:"smooth",block:"center"}),f==null||f.classList.add("cb-news-highlight"),setTimeout(()=>f==null?void 0:f.classList.remove("cb-news-highlight"),2e3)}}},this.overlay.addEventListener("click",this.boundCitationClick),this.overlay.classList.add("active")}updateBrief(e){if(e.code!==this.currentCode)return;const t=this.overlay.querySelector(".cb-brief-content");if(!t)return;if(e.error||e.skipped||!e.brief){const a=e.error||e.reason||r("modals.countryBrief.briefUnavailable");t.innerHTML=`<div class="intel-error">${m(a)}</div>`;return}this.currentBrief=e.brief;const s=this.formatBrief(e.brief,this.currentHeadlineCount);t.innerHTML=`
      <div class="cb-brief-text">${s}</div>
      <div class="cb-brief-footer">
        ${e.cached?`<span class="intel-cached">üìã ${r("modals.countryBrief.cached")}</span>`:`<span class="intel-fresh">‚ú® ${r("modals.countryBrief.fresh")}</span>`}
        <span class="intel-timestamp">${e.generatedAt?new Date(e.generatedAt).toLocaleTimeString():""}</span>
      </div>`}updateMarkets(e){const t=this.overlay.querySelector(".cb-markets-content");if(t){if(e.length===0){t.innerHTML=`<span class="cb-empty">${r("modals.countryBrief.noMarkets")}</span>`;return}t.innerHTML=e.slice(0,3).map(s=>{const a=Math.round(s.yesPrice),i=100-a,n=s.volume?`$${(s.volume/1e3).toFixed(0)}k vol`:"",l=we(s.url||""),o=l?` <a href="${l}" target="_blank" rel="noopener" class="cb-market-link">‚Üó</a>`:"";return`
        <div class="cb-market-item">
          <div class="cb-market-title">${m(s.title.slice(0,100))}${o}</div>
          <div class="market-bar">
            <div class="market-yes" style="width:${a}%">${a}%</div>
            <div class="market-no" style="width:${i}%">${i>15?i+"%":""}</div>
          </div>
          ${n?`<div class="market-vol">${n}</div>`:""}
        </div>`}).join("")}}updateStock(e){const t=this.overlay.querySelector(".stock-loading");if(!t)return;if(!e.available){t.remove();return}const s=parseFloat(e.weekChangePercent),a=s>=0?"+":"",i=s>=0?"stock-up":"stock-down",n=s>=0?"üìà":"üìâ";t.className=`signal-chip stock ${i}`,t.innerHTML=`${n} ${m(e.indexName)}: ${a}${e.weekChangePercent}% (1W)`}updateNews(e){const t=this.overlay.querySelector(".cb-news-section"),s=this.overlay.querySelector(".cb-news-content");if(!t||!s||e.length===0)return;const a=e.slice(0,8);this.currentHeadlineCount=a.length,this.currentHeadlines=a,t.style.display="",s.innerHTML=a.map((i,n)=>{var d,g,u;const l=we(i.link),o=((d=i.threat)==null?void 0:d.level)==="critical"?T("--threat-critical"):((g=i.threat)==null?void 0:g.level)==="high"?T("--threat-high"):((u=i.threat)==null?void 0:u.level)==="medium"?T("--threat-medium"):T("--threat-info"),c=this.timeAgo(i.pubDate),h=`
        <span class="cb-news-threat" style="background:${o}"></span>
        <div class="cb-news-body">
          <div class="cb-news-title">${m(i.title)}</div>
          <div class="cb-news-meta">${m(i.source)} ¬∑ ${c}</div>
        </div>`;return l?`<a href="${l}" target="_blank" rel="noopener" class="cb-news-card" id="cb-news-${n+1}">${h}</a>`:`<div class="cb-news-card" id="cb-news-${n+1}">${h}</div>`}).join("")}updateInfrastructure(e){const t=$e.BRIEF_BOUNDS[e];if(!t)return;const s=(t.n+t.s)/2,a=(t.e+t.w)/2,i=Ja(s,a,["pipeline","cable","datacenter","base","nuclear"]),n=Gt.map(g=>({port:g,dist:ei(s,a,g.lat,g.lon)})).filter(({dist:g})=>g<=600).sort((g,u)=>g.dist-u.dist).slice(0,5),l=new Map;for(const g of i){const u=l.get(g.type)||[];u.push({name:g.name,distanceKm:g.distanceKm}),l.set(g.type,u)}if(n.length>0&&l.set("port",n.map(({port:g,dist:u})=>({name:g.name,distanceKm:u}))),l.size===0)return;const o=this.overlay.querySelector(".cb-infra-section"),c=this.overlay.querySelector(".cb-infra-content");if(!o||!c)return;const h=["pipeline","cable","datacenter","base","nuclear","port"];let d="";for(const g of h){const u=l.get(g);if(!u||u.length===0)continue;const v=$e.INFRA_ICONS[g],f=$e.INFRA_LABELS[g],b=r(`modals.countryBrief.infra.${f}`);d+='<div class="cb-infra-group">',d+=`<div class="cb-infra-type">${v} ${b}</div>`;for(const k of u)d+=`<div class="cb-infra-item"><span>${m(k.name)}</span><span class="cb-infra-dist">${Math.round(k.distanceKm)} km</span></div>`;d+="</div>"}c.innerHTML=d,o.style.display=""}getTimelineMount(){return this.overlay.querySelector(".cb-timeline-mount")}getCode(){return this.currentCode}getName(){return this.currentName}timeAgo(e){const t=Date.now()-new Date(e).getTime(),s=Math.floor(t/36e5);return s<1?r("modals.countryBrief.timeAgo.m",{count:Math.floor(t/6e4)}):s<24?r("modals.countryBrief.timeAgo.h",{count:s}):r("modals.countryBrief.timeAgo.d",{count:Math.floor(s/24)})}formatBrief(e,t=0){let s=m(e).replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\n\n/g,"</p><p>").replace(/\n/g,"<br>").replace(/^/,"<p>").replace(/$/,"</p>");return t>0&&(s=s.replace(/\[(\d{1,2})\]/g,(a,i)=>{const n=parseInt(i,10);return n>=1&&n<=t?`<a href="#cb-news-${n}" class="cb-citation" title="${r("components.countryBrief.sourceRef",{n:String(n)})}">[${n}]</a>`:`[${i}]`})),s}exportBrief(e){if(!this.currentCode||!this.currentName)return;const t={country:this.currentName,code:this.currentCode,generatedAt:new Date().toISOString()};this.currentScore&&(t.score=this.currentScore.score,t.level=this.currentScore.level,t.trend=this.currentScore.trend,t.components=this.currentScore.components),this.currentSignals&&(t.signals={protests:this.currentSignals.protests,militaryFlights:this.currentSignals.militaryFlights,militaryVessels:this.currentSignals.militaryVessels,outages:this.currentSignals.outages,earthquakes:this.currentSignals.earthquakes,displacementOutflow:this.currentSignals.displacementOutflow,climateStress:this.currentSignals.climateStress,conflictEvents:this.currentSignals.conflictEvents}),this.currentBrief&&(t.brief=this.currentBrief),this.currentHeadlines.length>0&&(t.headlines=this.currentHeadlines.map(s=>({title:s.title,source:s.source,link:s.link,pubDate:s.pubDate?new Date(s.pubDate).toISOString():void 0}))),e==="json"?ti(t):si(t)}hide(){var e;this.abortController.abort(),this.overlay.classList.remove("active"),this.currentCode=null,this.currentName=null,(e=this.onCloseCallback)==null||e.call(this)}onClose(e){this.onCloseCallback=e}isVisible(){return this.overlay.classList.contains("active")}};y($e,"BRIEF_BOUNDS",{IR:{n:40,s:25,e:63,w:44},IL:{n:33.3,s:29.5,e:35.9,w:34.3},SA:{n:32,s:16,e:55,w:35},AE:{n:26.1,s:22.6,e:56.4,w:51.6},IQ:{n:37.4,s:29.1,e:48.6,w:38.8},SY:{n:37.3,s:32.3,e:42.4,w:35.7},YE:{n:19,s:12,e:54.5,w:42},LB:{n:34.7,s:33.1,e:36.6,w:35.1},CN:{n:53.6,s:18.2,e:134.8,w:73.5},TW:{n:25.3,s:21.9,e:122,w:120},JP:{n:45.5,s:24.2,e:153.9,w:122.9},KR:{n:38.6,s:33.1,e:131.9,w:124.6},KP:{n:43,s:37.7,e:130.7,w:124.2},IN:{n:35.5,s:6.7,e:97.4,w:68.2},PK:{n:37,s:24,e:77,w:61},AF:{n:38.5,s:29.4,e:74.9,w:60.5},UA:{n:52.4,s:44.4,e:40.2,w:22.1},RU:{n:82,s:41.2,e:180,w:19.6},BY:{n:56.2,s:51.3,e:32.8,w:23.2},PL:{n:54.8,s:49,e:24.1,w:14.1},EG:{n:31.7,s:22,e:36.9,w:25},LY:{n:33,s:19.5,e:25,w:9.4},SD:{n:22,s:8.7,e:38.6,w:21.8},US:{n:49,s:24.5,e:-66.9,w:-125},GB:{n:58.7,s:49.9,e:1.8,w:-8.2},DE:{n:55.1,s:47.3,e:15,w:5.9},FR:{n:51.1,s:41.3,e:9.6,w:-5.1},TR:{n:42.1,s:36,e:44.8,w:26}}),y($e,"INFRA_ICONS",{pipeline:"üîå",cable:"üåê",datacenter:"üñ•Ô∏è",base:"üèõÔ∏è",nuclear:"‚ò¢Ô∏è",port:"‚öì"}),y($e,"INFRA_LABELS",{pipeline:"pipeline",cable:"cable",datacenter:"datacenter",base:"base",nuclear:"nuclear",port:"port"});let Dt=$e;const $t=["protest","conflict","natural","military"],Zs={protest:"#ffaa00",conflict:"#ff4444",natural:"#b478ff",military:"#64b4ff"},Go={low:4,medium:5,high:7,critical:9},Ie={top:20,right:20,bottom:30,left:80},Ks=200,qo=10080*60*1e3;class jo{constructor(e){y(this,"container");y(this,"svg",null);y(this,"tooltip",null);y(this,"resizeObserver",null);y(this,"currentEvents",[]);this.container=e,this.createTooltip(),this.resizeObserver=new ResizeObserver(()=>{this.currentEvents.length>0&&this.render(this.currentEvents)}),this.resizeObserver.observe(this.container),window.addEventListener("theme-changed",()=>{this.tooltip&&(this.tooltip.remove(),this.tooltip=null),this.createTooltip(),this.currentEvents.length>0&&this.render(this.currentEvents)})}createTooltip(){this.tooltip=document.createElement("div"),Object.assign(this.tooltip.style,{position:"absolute",pointerEvents:"none",background:T("--bg"),border:`1px solid ${T("--border")}`,borderRadius:"6px",padding:"6px 10px",fontSize:"12px",color:T("--text"),zIndex:"9999",display:"none",whiteSpace:"nowrap",boxShadow:`0 2px 8px ${T("--shadow-color")}`}),this.container.style.position="relative",this.container.appendChild(this.tooltip)}render(e){this.currentEvents=e,this.svg&&this.svg.remove();const t=this.container.clientWidth;if(t<=0)return;const s=t-Ie.left-Ie.right,a=Ks-Ie.top-Ie.bottom;this.svg=Ye(this.container).append("svg").attr("width",t).attr("height",Ks).attr("style","display:block;");const i=this.svg.append("g").attr("transform",`translate(${Ie.left},${Ie.top})`),n=Date.now(),l=vo().domain([new Date(n-qo),new Date(n)]).range([0,s]),o=fo().domain($t).range([0,a]).padding(.2);this.drawGrid(i,l,a),this.drawAxes(i,l,o,a),this.drawNowMarker(i,l,new Date(n),a),this.drawEmptyLaneLabels(i,e,o,s),this.drawEvents(i,e,l,o)}drawGrid(e,t,s){const a=t.ticks(6);e.selectAll(".grid-line").data(a).join("line").attr("x1",i=>t(i)).attr("x2",i=>t(i)).attr("y1",0).attr("y2",s).attr("stroke",T("--border-subtle")).attr("stroke-width",1)}drawAxes(e,t,s,a){const i=bo(t).ticks(6).tickFormat(js("%b %d")),n=e.append("g").attr("transform",`translate(0,${a})`).call(i);n.selectAll("text").attr("fill",T("--text-dim")).attr("font-size","10px"),n.selectAll("line").attr("stroke",T("--border")),n.select(".domain").attr("stroke",T("--border"));const l={protest:"Protest",conflict:"Conflict",natural:"Natural",military:"Military"};e.selectAll(".lane-label").data($t).join("text").attr("x",-10).attr("y",o=>(s(o)??0)+s.bandwidth()/2).attr("text-anchor","end").attr("dominant-baseline","central").attr("fill",o=>Zs[o]).attr("font-size","11px").attr("font-weight","500").text(o=>l[o]||o)}drawNowMarker(e,t,s,a){const i=t(s);e.append("line").attr("x1",i).attr("x2",i).attr("y1",0).attr("y2",a).attr("stroke",T("--text")).attr("stroke-width",1).attr("stroke-dasharray","4,3").attr("opacity",.6),e.append("text").attr("x",i).attr("y",-6).attr("text-anchor","middle").attr("fill",T("--text-muted")).attr("font-size","9px").text(r("components.countryTimeline.now"))}drawEmptyLaneLabels(e,t,s,a){const i=new Set(t.map(l=>l.lane)),n=$t.filter(l=>!i.has(l));e.selectAll(".empty-label").data(n).join("text").attr("x",a/2).attr("y",l=>(s(l)??0)+s.bandwidth()/2).attr("text-anchor","middle").attr("dominant-baseline","central").attr("fill",T("--text-ghost")).attr("font-size","10px").attr("font-style","italic").text(r("components.countryTimeline.noEventsIn7Days"))}drawEvents(e,t,s,a){const i=this.tooltip,n=this.container,l=js("%b %d, %H:%M");e.selectAll(".event-circle").data(t).join("circle").attr("cx",o=>s(new Date(o.timestamp))).attr("cy",o=>(a(o.lane)??0)+a.bandwidth()/2).attr("r",o=>Go[o.severity??"medium"]??5).attr("fill",o=>Zs[o.lane]).attr("opacity",.85).attr("cursor","pointer").attr("stroke",T("--shadow-color")).attr("stroke-width",.5).on("mouseenter",function(o,c){Ye(this).attr("opacity",1).attr("stroke",T("--text")).attr("stroke-width",1.5);const h=l(new Date(c.timestamp));i.innerHTML=`<strong>${m(c.label)}</strong><br/>${m(h)}`,i.style.display="block";const d=n.getBoundingClientRect(),g=o.clientX-d.left+12,u=o.clientY-d.top-10;i.style.left=`${g}px`,i.style.top=`${u}px`}).on("mousemove",function(o){const c=n.getBoundingClientRect(),h=o.clientX-c.left+12,d=o.clientY-c.top-10;i.style.left=`${h}px`,i.style.top=`${d}px`}).on("mouseleave",function(){Ye(this).attr("opacity",.85).attr("stroke",T("--shadow-color")).attr("stroke-width",.5),i.style.display="none"})}destroy(){this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null),this.svg&&(this.svg.remove(),this.svg=null),this.tooltip&&(this.tooltip.remove(),this.tooltip=null),this.currentEvents=[]}}const Vo={tehran:"IR",moscow:"RU",beijing:"CN",kyiv:"UA",taipei:"TW",telaviv:"IL",pyongyang:"KP",sanaa:"YE",sahel:["ML","NE","BF"],haiti:"HT",horn_africa:["ET","SO","SD"],silicon_valley:"US",wall_street:"US",houston:"US",dc:"US",cairo:"EG",doha:"QA",beirut:"LB",riyadh:"SA",ankara:"TR",damascus:"SY",caracas:"VE"},nt={news:.35,cii:.25,geo:.25,military:.15},dt=new Map,Aa=1440*60*1e3,Xs=48;let ct=null,Ft=null;function Ia(p){ct=p}function Ra(p){Ft=p}function Wo(p){return p.escalationScore??3}function Yo(p){if(!ct)return null;const e=Vo[p];if(!e)return null;if(Array.isArray(e)){const t=e.map(s=>ct(s)).filter(s=>s!==null);return t.length>0?Math.max(...t):null}return ct(e)}function Zo(p){return Ft?Ft(p.lat,p.lon,150):null}function Ko(p,e,t){return Math.min(100,p*15+(e?30:0)+t*5)}function Xo(p){return p??30}function Qo(p,e){return p===0?0:Math.min(100,p+e*10)}function Jo(p,e){return Math.min(100,p*10+e*15)}function er(p){return p.newsActivity*nt.news+p.ciiContribution*nt.cii+p.geoConvergence*nt.geo+p.militaryActivity*nt.military}function tr(p){return 1+p/100*4}function sr(p,e){return p*.3+e*.7}function ar(p){const e=Date.now()-Aa,t=p.filter(s=>s.timestamp>=e);return t.length>Xs?t.slice(-Xs):t}function ir(p){if(p.length<3)return"stable";let e=0,t=0,s=0,a=0,i=0;for(let o=0;o<p.length;o++){const c=p[o];c&&(e+=i,t+=c.score,s+=i*c.score,a+=i*i,i++)}if(i<3)return"stable";const n=i*a-e*e;if(n===0)return"stable";const l=(i*s-e*t)/n;return l>.1?"escalating":l<-.1?"de-escalating":"stable"}function nr(p,e){const t=He.find(u=>u.id===p);if(!t)throw new Error(`Hotspot not found: ${p}`);const s=Wo(t),a=dt.get(p),i=Date.now(),n={newsActivity:Ko(e.newsMatches,e.hasBreaking,e.newsVelocity),ciiContribution:Xo(e.ciiScore),geoConvergence:Qo(e.geoAlertScore,e.geoAlertTypes),militaryActivity:Jo(e.flightsNearby,e.vesselsNearby)},l=er(n),o=tr(l),c=sr(s,o);let h=(a==null?void 0:a.history)??[];h=ar(h),h.push({timestamp:i,score:c});const d=ir(h),g={hotspotId:p,staticBaseline:s,dynamicScore:Math.round(o*10)/10,combinedScore:Math.round(c*10)/10,trend:d,components:n,history:h,lastUpdated:new Date};return dt.set(p,g),g}function Zt(p){return dt.get(p)??null}function Qs(p,e,t,s){const i=(t-p)*Math.PI/180,n=(s-e)*Math.PI/180,l=Math.sin(i/2)**2+Math.cos(p*Math.PI/180)*Math.cos(t*Math.PI/180)*Math.sin(n/2)**2;return 6371*2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l))}function or(p,e,t,s=200){let a=0,i=0;for(const n of e)Qs(p.lat,p.lon,n.lat,n.lon)<=s&&a++;for(const n of t)Qs(p.lat,p.lon,n.lat,n.lon)<=s&&i++;return{flights:a,vessels:i}}let Ht={flights:[],vessels:[]};function Na(p,e){Ht={flights:p,vessels:e}}function Da(p,e,t,s){const a=He.find(c=>c.id===p);if(!a)return null;const i=Yo(p),n=Zo(a),l=or(a,Ht.flights,Ht.vessels),o={newsMatches:e,hasBreaking:t,newsVelocity:s,ciiScore:i,geoAlertScore:(n==null?void 0:n.score)??0,geoAlertTypes:(n==null?void 0:n.types)??0,flightsNearby:l.flights,vesselsNearby:l.vessels};return nr(p,o)}function rr(p){const e=dt.get(p);if(!e||e.history.length<2)return null;const s=Date.now()-Aa,a=e.history.find(n=>n.timestamp>=s),i=e.history[e.history.length-1];return!a||!i?null:{change:Math.round((i.score-a.score)*10)/10,start:Math.round(a.score*10)/10,end:Math.round(i.score*10)/10}}class Fa{constructor(e){y(this,"container");y(this,"popup",null);y(this,"onClose");y(this,"cableAdvisories",[]);y(this,"repairShips",[]);y(this,"isMobileSheet",!1);y(this,"sheetTouchStartY",null);y(this,"sheetCurrentOffset",0);y(this,"mobileDismissThreshold",96);y(this,"outsideListenerTimeoutId",null);y(this,"handleOutsideClick",e=>{this.popup&&!this.popup.contains(e.target)&&this.hide()});y(this,"handleEscapeKey",e=>{e.key==="Escape"&&this.hide()});y(this,"handleSheetTouchStart",e=>{var a;if(!this.popup||!this.isMobileSheet||e.touches.length!==1)return;const t=e.target,s=this.popup.querySelector(".popup-body");if(t!=null&&t.closest(".popup-body")&&s&&s.scrollTop>0){this.sheetTouchStartY=null;return}this.sheetTouchStartY=((a=e.touches[0])==null?void 0:a.clientY)??null,this.sheetCurrentOffset=0,this.popup.classList.add("dragging")});y(this,"handleSheetTouchMove",e=>{var a;if(!this.popup||!this.isMobileSheet||this.sheetTouchStartY===null)return;const t=(a=e.touches[0])==null?void 0:a.clientY;if(t==null)return;const s=Math.max(0,t-this.sheetTouchStartY);s<=0||(this.sheetCurrentOffset=s,this.popup.style.transform=`translate3d(0, ${s}px, 0)`,e.preventDefault())});y(this,"handleSheetTouchEnd",()=>{if(!this.popup||!this.isMobileSheet||this.sheetTouchStartY===null)return;const e=this.sheetCurrentOffset>=this.mobileDismissThreshold;if(this.popup.classList.remove("dragging"),this.sheetTouchStartY=null,e){this.hide();return}this.sheetCurrentOffset=0,this.popup.style.transform="",this.popup.classList.add("open")});this.container=e}show(e){var a,i;this.hide(),this.isMobileSheet=gt(),this.popup=document.createElement("div"),this.popup.className=this.isMobileSheet?"map-popup map-popup-sheet":"map-popup";const t=this.renderContent(e);this.popup.innerHTML=this.isMobileSheet?`<button class="map-popup-sheet-handle" aria-label="${r("common.close")}"></button>${t}`:t;const s=this.container.getBoundingClientRect();this.isMobileSheet?(this.popup.style.left="",this.popup.style.top="",this.popup.style.transform=""):this.positionDesktopPopup(e,s),document.body.appendChild(this.popup),(a=this.popup.querySelector(".popup-close"))==null||a.addEventListener("click",()=>this.hide()),(i=this.popup.querySelector(".map-popup-sheet-handle"))==null||i.addEventListener("click",()=>this.hide()),this.isMobileSheet&&(this.popup.addEventListener("touchstart",this.handleSheetTouchStart,{passive:!0}),this.popup.addEventListener("touchmove",this.handleSheetTouchMove,{passive:!1}),this.popup.addEventListener("touchend",this.handleSheetTouchEnd),this.popup.addEventListener("touchcancel",this.handleSheetTouchEnd),requestAnimationFrame(()=>{this.popup&&(this.popup.classList.add("open"),this.popup.addEventListener("transitionend",()=>{this.popup&&(this.popup.style.willChange="auto")},{once:!0}))})),this.outsideListenerTimeoutId!==null&&window.clearTimeout(this.outsideListenerTimeoutId),this.outsideListenerTimeoutId=window.setTimeout(()=>{document.addEventListener("click",this.handleOutsideClick),document.addEventListener("touchstart",this.handleOutsideClick),document.addEventListener("keydown",this.handleEscapeKey),this.outsideListenerTimeoutId=null},0)}positionDesktopPopup(e,t){if(!this.popup)return;const s=380,a=50,i=60;this.popup.style.visibility="hidden",this.popup.style.top="0",this.popup.style.left="-9999px",document.body.appendChild(this.popup);const n=this.popup.offsetHeight;document.body.removeChild(this.popup),this.popup.style.visibility="";const l=t.left+e.x,o=t.top+e.y,c=window.innerWidth-s-20;let h=l+20;h>c&&(h=Math.max(10,l-s-20));const d=window.innerHeight-o-a,g=o-i;let u;d>=n?u=o+10:g>=n?u=o-n-10:u=i,u=Math.max(i,u);const v=window.innerHeight-n-a;v>i&&(u=Math.min(u,v)),this.popup.style.left=`${h}px`,this.popup.style.top=`${u}px`}hide(){var e;this.outsideListenerTimeoutId!==null&&(window.clearTimeout(this.outsideListenerTimeoutId),this.outsideListenerTimeoutId=null),this.popup&&(this.popup.removeEventListener("touchstart",this.handleSheetTouchStart),this.popup.removeEventListener("touchmove",this.handleSheetTouchMove),this.popup.removeEventListener("touchend",this.handleSheetTouchEnd),this.popup.removeEventListener("touchcancel",this.handleSheetTouchEnd),this.popup.remove(),this.popup=null,this.isMobileSheet=!1,this.sheetTouchStartY=null,this.sheetCurrentOffset=0,document.removeEventListener("click",this.handleOutsideClick),document.removeEventListener("touchstart",this.handleOutsideClick),document.removeEventListener("keydown",this.handleEscapeKey),(e=this.onClose)==null||e.call(this))}setOnClose(e){this.onClose=e}setCableActivity(e,t){this.cableAdvisories=e,this.repairShips=t}renderContent(e){switch(e.type){case"conflict":return this.renderConflictPopup(e.data);case"hotspot":return this.renderHotspotPopup(e.data,e.relatedNews);case"earthquake":return this.renderEarthquakePopup(e.data);case"weather":return this.renderWeatherPopup(e.data);case"base":return this.renderBasePopup(e.data);case"waterway":return this.renderWaterwayPopup(e.data);case"apt":return this.renderAPTPopup(e.data);case"cyberThreat":return this.renderCyberThreatPopup(e.data);case"nuclear":return this.renderNuclearPopup(e.data);case"economic":return this.renderEconomicPopup(e.data);case"irradiator":return this.renderIrradiatorPopup(e.data);case"pipeline":return this.renderPipelinePopup(e.data);case"cable":return this.renderCablePopup(e.data);case"cable-advisory":return this.renderCableAdvisoryPopup(e.data);case"repair-ship":return this.renderRepairShipPopup(e.data);case"outage":return this.renderOutagePopup(e.data);case"datacenter":return this.renderDatacenterPopup(e.data);case"datacenterCluster":return this.renderDatacenterClusterPopup(e.data);case"ais":return this.renderAisPopup(e.data);case"protest":return this.renderProtestPopup(e.data);case"protestCluster":return this.renderProtestClusterPopup(e.data);case"flight":return this.renderFlightPopup(e.data);case"militaryFlight":return this.renderMilitaryFlightPopup(e.data);case"militaryVessel":return this.renderMilitaryVesselPopup(e.data);case"militaryFlightCluster":return this.renderMilitaryFlightClusterPopup(e.data);case"militaryVesselCluster":return this.renderMilitaryVesselClusterPopup(e.data);case"natEvent":return this.renderNaturalEventPopup(e.data);case"port":return this.renderPortPopup(e.data);case"spaceport":return this.renderSpaceportPopup(e.data);case"mineral":return this.renderMineralPopup(e.data);case"startupHub":return this.renderStartupHubPopup(e.data);case"cloudRegion":return this.renderCloudRegionPopup(e.data);case"techHQ":return this.renderTechHQPopup(e.data);case"accelerator":return this.renderAcceleratorPopup(e.data);case"techEvent":return this.renderTechEventPopup(e.data);case"techHQCluster":return this.renderTechHQClusterPopup(e.data);case"techEventCluster":return this.renderTechEventClusterPopup(e.data);case"stockExchange":return this.renderStockExchangePopup(e.data);case"financialCenter":return this.renderFinancialCenterPopup(e.data);case"centralBank":return this.renderCentralBankPopup(e.data);case"commodityHub":return this.renderCommodityHubPopup(e.data);default:return""}}renderConflictPopup(e){var a;const t=e.intensity==="high"?"high":e.intensity==="medium"?"medium":"low",s=m(((a=e.intensity)==null?void 0:a.toUpperCase())||r("popups.unknown").toUpperCase());return`
      <div class="popup-header conflict">
        <span class="popup-title">${m(e.name.toUpperCase())}</span>
        <span class="popup-badge ${t}">${s}</span>
        <button class="popup-close">√ó</button>
      </div>
      <div class="popup-body">
        <div class="popup-stats">
          <div class="popup-stat">
            <span class="stat-label">${r("popups.startDate")}</span>
            <span class="stat-value">${m(e.startDate||r("popups.unknown"))}</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.casualties")}</span>
            <span class="stat-value">${m(e.casualties||r("popups.unknown"))}</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.displaced")}</span>
            <span class="stat-value">${m(e.displaced||r("popups.unknown"))}</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.location")}</span>
            <span class="stat-value">${m(e.location||`${e.center[1]}¬∞N, ${e.center[0]}¬∞E`)}</span>
          </div>
        </div>
        ${e.description?`<p class="popup-description">${m(e.description)}</p>`:""}
        ${e.parties&&e.parties.length>0?`
          <div class="popup-section">
            <span class="section-label">${r("popups.belligerents")}</span>
            <div class="popup-tags">
              ${e.parties.map(i=>`<span class="popup-tag">${m(i)}</span>`).join("")}
            </div>
          </div>
        `:""}
        ${e.keyDevelopments&&e.keyDevelopments.length>0?`
          <div class="popup-section">
            <span class="section-label">${r("popups.keyDevelopments")}</span>
            <ul class="popup-list">
              ${e.keyDevelopments.map(i=>`<li>${m(i)}</li>`).join("")}
            </ul>
          </div>
        `:""}
      </div>
    `}getLocalizedHotspotSubtext(e){const s=`popups.hotspotSubtexts.${e.toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_+|_+$/g,"")}`,a=r(s);return a===s?e:a}renderHotspotPopup(e,t){const s=e.level||"low",a=m((e.level||"low").toUpperCase()),i=e.subtext?this.getLocalizedHotspotSubtext(e.subtext):"",n=Zt(e.id),l=rr(e.id),o={1:T("--semantic-normal"),2:T("--semantic-normal"),3:T("--semantic-elevated"),4:T("--semantic-high"),5:T("--semantic-critical")},c={1:r("popups.hotspot.levels.stable"),2:r("popups.hotspot.levels.watch"),3:r("popups.hotspot.levels.elevated"),4:r("popups.hotspot.levels.high"),5:r("popups.hotspot.levels.critical")},h={escalating:"‚Üë",stable:"‚Üí","de-escalating":"‚Üì"},d={escalating:T("--semantic-critical"),stable:T("--semantic-elevated"),"de-escalating":T("--semantic-normal")},g=(n==null?void 0:n.combinedScore)??e.escalationScore??3,u=Math.round(g),v=(n==null?void 0:n.trend)??e.escalationTrend??"stable",f=`
      <div class="popup-section escalation-section">
        <span class="section-label">${r("popups.hotspot.escalation")}</span>
        <div class="escalation-display">
          <div class="escalation-score" style="background: ${o[u]||T("--text-dim")}">
            <span class="score-value">${g.toFixed(1)}/5</span>
            <span class="score-label">${c[u]||r("popups.unknown")}</span>
          </div>
          <div class="escalation-trend" style="color: ${d[v]||T("--text-dim")}">
            <span class="trend-icon">${h[v]||""}</span>
            <span class="trend-label">${m(v.toUpperCase())}</span>
          </div>
        </div>
        ${n?`
          <div class="escalation-breakdown">
            <div class="breakdown-header">
              <span class="baseline-label">${r("popups.hotspot.baseline")}: ${n.staticBaseline}/5</span>
              ${l?`
                <span class="change-label ${l.change>=0?"rising":"falling"}">
                  24h: ${l.change>=0?"+":""}${l.change}
                </span>
              `:""}
            </div>
            <div class="breakdown-components">
              <div class="breakdown-row">
                <span class="component-label">${r("popups.hotspot.components.news")}</span>
                <div class="component-bar-bg">
                  <div class="component-bar news" style="width: ${n.components.newsActivity}%"></div>
                </div>
                <span class="component-value">${Math.round(n.components.newsActivity)}</span>
              </div>
              <div class="breakdown-row">
                <span class="component-label">${r("popups.hotspot.components.cii")}</span>
                <div class="component-bar-bg">
                  <div class="component-bar cii" style="width: ${n.components.ciiContribution}%"></div>
                </div>
                <span class="component-value">${Math.round(n.components.ciiContribution)}</span>
              </div>
              <div class="breakdown-row">
                <span class="component-label">${r("popups.hotspot.components.geo")}</span>
                <div class="component-bar-bg">
                  <div class="component-bar geo" style="width: ${n.components.geoConvergence}%"></div>
                </div>
                <span class="component-value">${Math.round(n.components.geoConvergence)}</span>
              </div>
              <div class="breakdown-row">
                <span class="component-label">${r("popups.hotspot.components.military")}</span>
                <div class="component-bar-bg">
                  <div class="component-bar military" style="width: ${n.components.militaryActivity}%"></div>
                </div>
                <span class="component-value">${Math.round(n.components.militaryActivity)}</span>
              </div>
            </div>
          </div>
        `:""}
        ${e.escalationIndicators&&e.escalationIndicators.length>0?`
          <div class="escalation-indicators">
            ${e.escalationIndicators.map(C=>`<span class="indicator-tag">‚Ä¢ ${m(C)}</span>`).join("")}
          </div>
        `:""}
      </div>
    `,b=e.history?`
      <div class="popup-section history-section">
        <span class="section-label">${r("popups.historicalContext")}</span>
        <div class="history-content">
          ${e.history.lastMajorEvent?`
            <div class="history-event">
              <span class="history-label">${r("popups.lastMajorEvent")}:</span>
              <span class="history-value">${m(e.history.lastMajorEvent)} ${e.history.lastMajorEventDate?`(${m(e.history.lastMajorEventDate)})`:""}</span>
            </div>
          `:""}
          ${e.history.precedentDescription?`
            <div class="history-event">
              <span class="history-label">${r("popups.precedents")}:</span>
              <span class="history-value">${m(e.history.precedentDescription)}</span>
            </div>
          `:""}
          ${e.history.cyclicalRisk?`
            <div class="history-event cyclical">
              <span class="history-label">${r("popups.cyclicalPattern")}:</span>
              <span class="history-value">${m(e.history.cyclicalRisk)}</span>
            </div>
          `:""}
        </div>
      </div>
    `:"",k=e.whyItMatters?`
      <div class="popup-section why-matters-section">
        <span class="section-label">${r("popups.whyItMatters")}</span>
        <p class="why-matters-text">${m(e.whyItMatters)}</p>
      </div>
    `:"";return`
      <div class="popup-header hotspot">
        <span class="popup-title">${m(e.name.toUpperCase())}</span>
        <span class="popup-badge ${s}">${a}</span>
        <button class="popup-close">√ó</button>
      </div>
      <div class="popup-body">
        ${i?`<div class="popup-subtitle">${m(i)}</div>`:""}
        ${e.description?`<p class="popup-description">${m(e.description)}</p>`:""}
        ${f}
        <div class="popup-stats">
          ${e.location?`
            <div class="popup-stat">
              <span class="stat-label">${r("popups.location")}</span>
              <span class="stat-value">${m(e.location)}</span>
            </div>
          `:""}
          <div class="popup-stat">
            <span class="stat-label">${r("popups.coordinates")}</span>
            <span class="stat-value">${m(`${e.lat.toFixed(2)}¬∞N, ${e.lon.toFixed(2)}¬∞E`)}</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.status")}</span>
            <span class="stat-value">${m(e.status||r("popups.monitoring"))}</span>
          </div>
        </div>
        ${k}
        ${b}
        ${e.agencies&&e.agencies.length>0?`
          <div class="popup-section">
            <span class="section-label">${r("popups.keyEntities")}</span>
            <div class="popup-tags">
              ${e.agencies.map(C=>`<span class="popup-tag">${m(C)}</span>`).join("")}
            </div>
          </div>
        `:""}
        ${t&&t.length>0?`
          <div class="popup-section">
          <div class="popup-section">
            <span class="section-label">${r("popups.relatedHeadlines")}</span>
            <div class="popup-news">
              ${t.slice(0,5).map(C=>`
                <div class="popup-news-item">
                  <span class="news-source">${m(C.source)}</span>
                  <a href="${we(C.link)}" target="_blank" class="news-title">${m(C.title)}</a>
                </div>
              `).join("")}
            </div>
          </div>
        `:""}
        <div class="hotspot-gdelt-context" data-hotspot-id="${m(e.id)}">
          <div class="hotspot-gdelt-header">${r("popups.liveIntel")}</div>
          <div class="hotspot-gdelt-loading">${r("popups.loadingNews")}</div>
        </div>
      </div>
    `}async loadHotspotGdeltContext(e){if(!this.popup)return;const t=this.popup.querySelector(".hotspot-gdelt-context");if(t)try{const s=await ai(e);if(!this.popup||!t.isConnected)return;if(s.length===0){t.innerHTML=`
          <div class="hotspot-gdelt-header">${r("popups.liveIntel")}</div>
          <div class="hotspot-gdelt-loading">${r("popups.noCoverage")}</div>
        `;return}t.innerHTML=`
        <div class="hotspot-gdelt-header">${r("popups.liveIntel")}</div>
        <div class="hotspot-gdelt-articles">
          ${s.slice(0,5).map(a=>this.renderGdeltArticle(a)).join("")}
        </div>
      `}catch{t.isConnected&&(t.innerHTML=`
          <div class="hotspot-gdelt-header">${r("popups.liveIntel")}</div>
          <div class="hotspot-gdelt-loading">${r("common.error")}</div>
        `)}}renderGdeltArticle(e){const t=e.source||ii(e.url),s=ni(e.date);return`
      <a href="${we(e.url)}" target="_blank" rel="noopener" class="hotspot-gdelt-article">
        <div class="article-meta">
          <span>${m(t)}</span>
          <span>${m(s)}</span>
        </div>
        <div class="article-title">${m(e.title)}</div>
      </a>
    `}renderEarthquakePopup(e){var i,n;const t=e.magnitude>=6?"high":e.magnitude>=5?"medium":"low",s=e.magnitude>=6?r("popups.earthquake.levels.major"):e.magnitude>=5?r("popups.earthquake.levels.moderate"):r("popups.earthquake.levels.minor"),a=this.getTimeAgo(new Date(e.occurredAt));return`
      <div class="popup-header earthquake">
        <span class="popup-title magnitude">M${e.magnitude.toFixed(1)}</span>
        <span class="popup-badge ${t}">${s}</span>
        <button class="popup-close">√ó</button>
      </div>
      <div class="popup-body">
        <p class="popup-location">${m(e.place)}</p>
        <div class="popup-stats">
          <div class="popup-stat">
            <span class="stat-label">${r("popups.depth")}</span>
            <span class="stat-value">${e.depthKm.toFixed(1)} km</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.coordinates")}</span>
            <span class="stat-value">${(((i=e.location)==null?void 0:i.latitude)??0).toFixed(2)}¬∞, ${(((n=e.location)==null?void 0:n.longitude)??0).toFixed(2)}¬∞</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.time")}</span>
            <span class="stat-value">${a}</span>
          </div>
        </div>
        <a href="${we(e.sourceUrl)}" target="_blank" class="popup-link">${r("popups.viewUSGS")} ‚Üí</a>
      </div>
    `}getTimeAgo(e){const t=Math.floor((Date.now()-e.getTime())/1e3);if(t<60)return r("popups.timeAgo.s",{count:t});const s=Math.floor(t/60);if(s<60)return r("popups.timeAgo.m",{count:s});const a=Math.floor(s/60);if(a<24)return r("popups.timeAgo.h",{count:a});const i=Math.floor(a/24);return r("popups.timeAgo.d",{count:i})}renderWeatherPopup(e){const t=m(e.severity.toLowerCase()),s=this.getTimeUntil(e.expires);return`
      <div class="popup-header weather ${t}">
        <span class="popup-title">${m(e.event.toUpperCase())}</span>
        <span class="popup-badge ${t}">${m(e.severity.toUpperCase())}</span>
        <button class="popup-close">√ó</button>
      </div>
      <div class="popup-body">
        <p class="popup-headline">${m(e.headline)}</p>
        <div class="popup-stats">
          <div class="popup-stat">
            <span class="stat-label">${r("popups.area")}</span>
            <span class="stat-value">${m(e.areaDesc)}</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.expires")}</span>
            <span class="stat-value">${s}</span>
          </div>
        </div>
        <p class="popup-description">${m(e.description.slice(0,300))}${e.description.length>300?"...":""}</p>
      </div>
    `}getTimeUntil(e){const t=e.getTime()-Date.now();if(t<=0)return r("popups.expired");const s=Math.floor(t/(1e3*60*60));return s<1?`${Math.floor(t/(1e3*60))}${r("popups.timeUnits.m")}`:s<24?`${s}${r("popups.timeUnits.h")}`:`${Math.floor(s/24)}${r("popups.timeUnits.d")}`}renderBasePopup(e){const t={"us-nato":r("popups.base.types.us-nato"),china:r("popups.base.types.china"),russia:r("popups.base.types.russia")},s={"us-nato":"elevated",china:"high",russia:"high"};return`
      <div class="popup-header base">
        <span class="popup-title">${m(e.name.toUpperCase())}</span>
        <span class="popup-badge ${s[e.type]||"low"}">${m(t[e.type]||e.type.toUpperCase())}</span>
        <button class="popup-close">√ó</button>
      </div>
      <div class="popup-body">
        ${e.description?`<p class="popup-description">${m(e.description)}</p>`:""}
        <div class="popup-stats">
          <div class="popup-stat">
            <span class="stat-label">${r("popups.type")}</span>
            <span class="stat-value">${m(t[e.type]||e.type)}</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.coordinates")}</span>
            <span class="stat-value">${e.lat.toFixed(2)}¬∞, ${e.lon.toFixed(2)}¬∞</span>
          </div>
        </div>
      </div>
    `}renderWaterwayPopup(e){return`
      <div class="popup-header waterway">
        <span class="popup-title">${m(e.name)}</span>
        <span class="popup-badge elevated">${r("popups.strategic")}</span>
        <button class="popup-close">√ó</button>
      </div>
      <div class="popup-body">
        ${e.description?`<p class="popup-description">${m(e.description)}</p>`:""}
        <div class="popup-stats">
          <div class="popup-stat">
            <span class="stat-label">${r("popups.coordinates")}</span>
            <span class="stat-value">${e.lat.toFixed(2)}¬∞, ${e.lon.toFixed(2)}¬∞</span>
          </div>
        </div>
      </div>
    `}renderAisPopup(e){var o,c;const t=m(e.severity),s=m(e.severity.toUpperCase()),a=e.type==="gap_spike"?r("popups.aisGapSpike"):r("popups.chokepointCongestion"),i=e.type==="gap_spike"?r("popups.darkening"):r("popups.density"),n=e.type==="gap_spike"?r("popups.darkShips"):r("popups.vesselCount"),l=e.type==="gap_spike"?((o=e.darkShips)==null?void 0:o.toString())||"‚Äî":((c=e.vesselCount)==null?void 0:c.toString())||"‚Äî";return`
      <div class="popup-header ais">
        <span class="popup-title">${m(e.name.toUpperCase())}</span>
        <span class="popup-badge ${t}">${s}</span>
        <button class="popup-close">√ó</button>
      </div>
      <div class="popup-body">
        <div class="popup-subtitle">${a}</div>
        <div class="popup-stats">
          <div class="popup-stat">
            <span class="stat-label">${i}</span>
            <span class="stat-value">${e.changePct}% ‚Üë</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${n}</span>
            <span class="stat-value">${l}</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.window")}</span>
            <span class="stat-value">${e.windowHours}H</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.region")}</span>
            <span class="stat-value">${m(e.region||`${e.lat.toFixed(2)}¬∞, ${e.lon.toFixed(2)}¬∞`)}</span>
          </div>
        </div>
        <p class="popup-description">${m(e.description)}</p>
      </div>
    `}renderProtestPopup(e){var g,u,v;const t=m(e.severity),s=m(e.severity.toUpperCase()),a=m(e.eventType.replace("_"," ").toUpperCase()),i=e.eventType==="riot"?"üî•":e.eventType==="strike"?"‚úä":"üì¢",n=e.sourceType==="acled"?r("popups.protest.acledVerified"):r("popups.protest.gdelt"),l=e.validated?`<span class="popup-badge verified">${r("popups.verified")}</span>`:"",o=e.fatalities?`<div class="popup-stat"><span class="stat-label">${r("popups.fatalities")}</span><span class="stat-value alert">${e.fatalities}</span></div>`:"",c=(g=e.actors)!=null&&g.length?`<div class="popup-stat"><span class="stat-label">${r("popups.actors")}</span><span class="stat-value">${e.actors.map(f=>m(f)).join(", ")}</span></div>`:"",h=(u=e.tags)!=null&&u.length?`<div class="popup-tags">${e.tags.map(f=>`<span class="popup-tag">${m(f)}</span>`).join("")}</div>`:"",d=(v=e.relatedHotspots)!=null&&v.length?`<div class="popup-related">${r("popups.near")}: ${e.relatedHotspots.map(f=>m(f)).join(", ")}</div>`:"";return`
      <div class="popup-header protest ${t}">
        <span class="popup-icon">${i}</span>
        <span class="popup-title">${a}</span>
        <span class="popup-badge ${t}">${s}</span>
        ${l}
        <button class="popup-close">√ó</button>
      </div>
      <div class="popup-body">
        <div class="popup-subtitle">${e.city?`${m(e.city)}, `:""}${m(e.country)}</div>
        <div class="popup-stats">
          <div class="popup-stat">
            <span class="stat-label">${r("popups.time")}</span>
            <span class="stat-value">${e.time.toLocaleDateString()}</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.source")}</span>
            <span class="stat-value">${n}</span>
          </div>
          ${o}
          ${c}
        </div>
        ${e.title?`<p class="popup-description">${m(e.title)}</p>`:""}
        ${h}
        ${d}
      </div>
    `}renderProtestClusterPopup(e){const t=e.count??e.items.length,s=e.riotCount??e.items.filter(u=>u.eventType==="riot").length,a=e.highSeverityCount??e.items.filter(u=>u.severity==="high").length,i=e.verifiedCount??e.items.filter(u=>u.validated).length,n=e.totalFatalities??e.items.reduce((u,v)=>u+(v.fatalities||0),0),o=[...e.items].sort((u,v)=>{const f={high:0,medium:1,low:2},b={riot:0,civil_unrest:1,strike:2,demonstration:3,protest:4},k=(f[u.severity]??3)-(f[v.severity]??3);return k!==0?k:(b[u.eventType]??5)-(b[v.eventType]??5)}).slice(0,10).map(u=>{const v=u.eventType==="riot"?"üî•":u.eventType==="strike"?"‚úä":"üì¢",f=u.severity,b=u.time.toLocaleDateString(void 0,{month:"short",day:"numeric"}),k=u.city?m(u.city):"",C=u.title?`: ${m(u.title.slice(0,40))}${u.title.length>40?"...":""}`:"";return`<li class="cluster-item ${f}">${v} ${b}${k?` ‚Ä¢ ${k}`:""}${C}</li>`}).join(""),c=Math.min(10,e.items.length),h=Math.max(0,t-c),d=h>0?`<li class="cluster-more">+${h} ${r("popups.moreEvents")}</li>`:"";return`
      <div class="popup-header protest ${a>0?"high":s>0?"medium":"low"} cluster">
        <span class="popup-title">üì¢ ${m(e.country)}</span>
        <span class="popup-badge">${t} ${r("popups.events").toUpperCase()}</span>
        <button class="popup-close">√ó</button>
      </div>
      <div class="popup-body cluster-popup">
        <div class="cluster-summary">
          ${s?`<span class="summary-item riot">üî• ${s} ${r("popups.protest.riots")}</span>`:""}
          ${a?`<span class="summary-item high">‚ö†Ô∏è ${a} ${r("popups.protest.highSeverity")}</span>`:""}
          ${i?`<span class="summary-item verified">‚úì ${i} ${r("popups.verified")}</span>`:""}
          ${n>0?`<span class="summary-item fatalities">üíÄ ${n} ${r("popups.fatalities")}</span>`:""}
        </div>
        <ul class="cluster-list">${o}${d}</ul>
        ${e.sampled?`<p class="popup-more">${r("popups.sampledList",{count:e.items.length})}</p>`:""}
      </div>
    `}renderFlightPopup(e){const t=m(e.severity),s=m(e.severity.toUpperCase()),i={ground_stop:r("popups.flight.groundStop"),ground_delay:r("popups.flight.groundDelay"),departure_delay:r("popups.flight.departureDelay"),arrival_delay:r("popups.flight.arrivalDelay"),general:r("popups.flight.delaysReported")}[e.delayType]||r("popups.flight.delays"),n=e.delayType==="ground_stop"?"üõë":e.severity==="severe"?"‚úàÔ∏è":"üõ´",o={faa:r("popups.flight.sources.faa"),eurocontrol:r("popups.flight.sources.eurocontrol"),computed:r("popups.flight.sources.computed")}[e.source]||m(e.source),h={americas:r("popups.flight.regions.americas"),europe:r("popups.flight.regions.europe"),apac:r("popups.flight.regions.apac"),mena:r("popups.flight.regions.mena"),africa:r("popups.flight.regions.africa")}[e.region]||m(e.region),d=e.avgDelayMinutes>0?`<div class="popup-stat"><span class="stat-label">${r("popups.flight.avgDelay")}</span><span class="stat-value alert">+${e.avgDelayMinutes} ${r("popups.timeUnits.m")}</span></div>`:"",g=e.reason?`<div class="popup-stat"><span class="stat-label">${r("popups.reason")}</span><span class="stat-value">${m(e.reason)}</span></div>`:"",u=e.cancelledFlights?`<div class="popup-stat"><span class="stat-label">${r("popups.flight.cancelled")}</span><span class="stat-value alert">${e.cancelledFlights} ${r("popups.events")}</span></div>`:"";return`
      <div class="popup-header flight ${t}">
        <span class="popup-icon">${n}</span>
        <span class="popup-title">${m(e.iata)} - ${i}</span>
        <span class="popup-badge ${t}">${s}</span>
        <button class="popup-close">√ó</button>
      </div>
      <div class="popup-body">
        <div class="popup-subtitle">${m(e.name)}</div>
        <div class="popup-location">${m(e.city)}, ${m(e.country)}</div>
        <div class="popup-stats">
          ${d}
          ${g}
          ${u}
          <div class="popup-stat">
            <span class="stat-label">${r("popups.region")}</span>
            <span class="stat-value">${h}</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.source")}</span>
            <span class="stat-value">${o}</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.updated")}</span>
            <span class="stat-value">${e.updatedAt.toLocaleTimeString()}</span>
          </div>
        </div>
      </div>
    `}renderAPTPopup(e){return`
      <div class="popup-header apt">
        <span class="popup-title">${m(e.name)}</span>
        <span class="popup-badge high">${r("popups.threat")}</span>
        <button class="popup-close">√ó</button>
      </div>
      <div class="popup-body">
        <div class="popup-subtitle">${r("popups.aka")}: ${m(e.aka)}</div>
        <div class="popup-stats">
          <div class="popup-stat">
            <span class="stat-label">${r("popups.sponsor")}</span>
            <span class="stat-value">${m(e.sponsor)}</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.origin")}</span>
            <span class="stat-value">${e.lat.toFixed(1)}¬∞, ${e.lon.toFixed(1)}¬∞</span>
          </div>
        </div>
        <p class="popup-description">${r("popups.apt.description")}</p>
      </div>
    `}renderCyberThreatPopup(e){const t=m(e.severity),a={feodo:"Feodo Tracker",urlhaus:"URLhaus",c2intel:"C2 Intel Feeds",otx:"AlienVault OTX",abuseipdb:"AbuseIPDB"}[e.source]||e.source,i=e.type.replace(/_/g," ").toUpperCase(),n=(e.tags||[]).slice(0,6);return`
      <div class="popup-header apt ${t}">
        <span class="popup-title">${r("popups.cyberThreat.title")}</span>
        <span class="popup-badge ${t}">${m(e.severity.toUpperCase())}</span>
        <button class="popup-close">√ó</button>
      </div>
      <div class="popup-body">
        <div class="popup-subtitle">${m(i)}</div>
        <div class="popup-stats">
          <div class="popup-stat">
            <span class="stat-label">${m(e.indicatorType.toUpperCase())}</span>
            <span class="stat-value">${m(e.indicator)}</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.country")}</span>
            <span class="stat-value">${m(e.country||r("popups.unknown"))}</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.source")}</span>
            <span class="stat-value">${m(a)}</span>
          </div>
          ${e.malwareFamily?`<div class="popup-stat">
            <span class="stat-label">${r("popups.malware")}</span>
            <span class="stat-value">${m(e.malwareFamily)}</span>
          </div>`:""}
          <div class="popup-stat">
            <span class="stat-label">${r("popups.lastSeen")}</span>
            <span class="stat-value">${m(e.lastSeen?new Date(e.lastSeen).toLocaleString():r("popups.unknown"))}</span>
          </div>
        </div>
        ${n.length>0?`
        <div class="popup-tags">
          ${n.map(l=>`<span class="popup-tag">${m(l)}</span>`).join("")}
        </div>`:""}
      </div>
    `}renderNuclearPopup(e){const t={plant:r("popups.nuclear.types.plant"),enrichment:r("popups.nuclear.types.enrichment"),weapons:r("popups.nuclear.types.weapons"),research:r("popups.nuclear.types.research")},s={active:"elevated",contested:"high",decommissioned:"low"};return`
      <div class="popup-header nuclear">
        <span class="popup-title">${m(e.name.toUpperCase())}</span>
        <span class="popup-badge ${s[e.status]||"low"}">${m(e.status.toUpperCase())}</span>
        <button class="popup-close">√ó</button>
      </div>
      <div class="popup-body">
        <div class="popup-stats">
          <div class="popup-stat">
            <span class="stat-label">${r("popups.type")}</span>
            <span class="stat-value">${m(t[e.type]||e.type.toUpperCase())}</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.status")}</span>
            <span class="stat-value">${m(e.status.toUpperCase())}</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.coordinates")}</span>
            <span class="stat-value">${e.lat.toFixed(2)}¬∞, ${e.lon.toFixed(2)}¬∞</span>
          </div>
        </div>
        <p class="popup-description">${r("popups.nuclear.description")}</p>
      </div>
    `}renderEconomicPopup(e){const t={exchange:r("popups.economic.types.exchange"),"central-bank":r("popups.economic.types.centralBank"),"financial-hub":r("popups.economic.types.financialHub")},s={exchange:"üìà","central-bank":"üèõ","financial-hub":"üí∞"},a=e.marketHours?this.getMarketStatus(e.marketHours):null,i=a?a==="open"?r("popups.open"):a==="closed"?r("popups.economic.closed"):r("popups.unknown"):"";return`
      <div class="popup-header economic ${e.type}">
        <span class="popup-title">${s[e.type]||""} ${m(e.name.toUpperCase())}</span>
        <span class="popup-badge ${a==="open"?"elevated":"low"}">${m(i||t[e.type]||"")}</span>
        <button class="popup-close">√ó</button>
      </div>
      <div class="popup-body">
        ${e.description?`<p class="popup-description">${m(e.description)}</p>`:""}
        <div class="popup-stats">
          <div class="popup-stat">
            <span class="stat-label">${r("popups.type")}</span>
            <span class="stat-value">${m(t[e.type]||e.type.toUpperCase())}</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.country")}</span>
            <span class="stat-value">${m(e.country)}</span>
          </div>
          ${e.marketHours?`
          <div class="popup-stat">
            <span class="stat-label">${r("popups.tradingHours")}</span>
            <span class="stat-value">${m(e.marketHours.open)} - ${m(e.marketHours.close)}</span>
          </div>
          `:""}
          <div class="popup-stat">
            <span class="stat-label">${r("popups.coordinates")}</span>
            <span class="stat-value">${e.lat.toFixed(2)}¬∞, ${e.lon.toFixed(2)}¬∞</span>
          </div>
        </div>
      </div>
    `}renderIrradiatorPopup(e){return`
      <div class="popup-header irradiator">
        <span class="popup-title">‚ò¢ ${m(e.city.toUpperCase())}</span>
        <span class="popup-badge elevated">${r("popups.gamma")}</span>
        <button class="popup-close">√ó</button>
      </div>
      <div class="popup-body">
        <div class="popup-subtitle">${r("popups.irradiator.subtitle")}</div>
        <div class="popup-stats">
          <div class="popup-stat">
            <span class="stat-label">${r("popups.country")}</span>
            <span class="stat-value">${m(e.country)}</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.city")}</span>
            <span class="stat-value">${m(e.city)}</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.coordinates")}</span>
            <span class="stat-value">${e.lat.toFixed(2)}¬∞, ${e.lon.toFixed(2)}¬∞</span>
          </div>
        </div>
        <p class="popup-description">${r("popups.irradiator.description")}</p>
      </div>
    `}renderPipelinePopup(e){const t={oil:r("popups.pipeline.types.oil"),gas:r("popups.pipeline.types.gas"),products:r("popups.pipeline.types.products")},s={oil:"high",gas:"elevated",products:"low"},a={operating:r("popups.pipeline.status.operating"),construction:r("popups.pipeline.status.construction")},i=e.type==="oil"?"üõ¢":e.type==="gas"?"üî•":"‚õΩ";return`
      <div class="popup-header pipeline ${e.type}">
        <span class="popup-title">${i} ${m(e.name.toUpperCase())}</span>
        <span class="popup-badge ${s[e.type]||"low"}">${m(e.type.toUpperCase())}</span>
        <button class="popup-close">√ó</button>
      </div>
      <div class="popup-body">
        <div class="popup-subtitle">${t[e.type]||r("popups.pipeline.title")}</div>
        <div class="popup-stats">
          <div class="popup-stat">
            <span class="stat-label">${r("popups.status")}</span>
            <span class="stat-value">${m(a[e.status]||e.status.toUpperCase())}</span>
          </div>
          ${e.capacity?`
          <div class="popup-stat">
            <span class="stat-label">${r("popups.capacity")}</span>
            <span class="stat-value">${m(e.capacity)}</span>
          </div>
          `:""}
          ${e.length?`
          <div class="popup-stat">
            <span class="stat-label">${r("popups.length")}</span>
            <span class="stat-value">${m(e.length)}</span>
          </div>
          `:""}
          ${e.operator?`
          <div class="popup-stat">
            <span class="stat-label">${r("popups.operator")}</span>
            <span class="stat-value">${m(e.operator)}</span>
          </div>
          `:""}
        </div>
        ${e.countries&&e.countries.length>0?`
          <div class="popup-section">
            <span class="section-label">${r("popups.countries")}</span>
            <div class="popup-tags">
              ${e.countries.map(n=>`<span class="popup-tag">${m(n)}</span>`).join("")}
            </div>
          </div>
        `:""}
        <p class="popup-description">${r("popups.pipeline.description",{type:e.type,status:e.status==="operating"?r("popups.pipelineStatusDesc.operating"):r("popups.pipelineStatusDesc.construction")})}</p>
      </div>
    `}renderCablePopup(e){var b;const t=this.getLatestCableAdvisory(e.id),s=this.getPriorityRepairShip(e.id),a=oi(e.id);let i,n;(a==null?void 0:a.status)==="fault"?(i=r("popups.cable.fault"),n="high"):(a==null?void 0:a.status)==="degraded"?(i=r("popups.cable.degraded"),n="elevated"):t?(i=t.severity==="fault"?r("popups.cable.fault"):r("popups.cable.degraded"),n=t.severity==="fault"?"high":"elevated"):(i=r("popups.cable.active"),n="low");const l=(s==null?void 0:s.eta)||(t==null?void 0:t.repairEta),o=m(e.name.toUpperCase()),c=m(i),h=l?m(l):"",d=t?m(t.title):"",g=t?m(t.impact):"",u=t?m(t.description):"",v=s?m(s.name):"",f=s?m(s.note||r("popups.repairShip.note")):"";return`
      <div class="popup-header cable">
        <span class="popup-title">üåê ${o}</span>
        <span class="popup-badge ${n}">${e.major?r("popups.cable.major"):r("popups.cable.cable")}</span>
        <button class="popup-close">√ó</button>
      </div>
      <div class="popup-body">
        <div class="popup-subtitle">${r("popups.cable.subtitle")}</div>
        <div class="popup-stats">
          <div class="popup-stat">
            <span class="stat-label">${r("popups.type")}</span>
            <span class="stat-value">${r("popups.cable.type")}</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.waypoints")}</span>
            <span class="stat-value">${e.points.length}</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.status")}</span>
            <span class="stat-value">${c}</span>
          </div>
          ${l?`
          <div class="popup-stat">
            <span class="stat-label">${r("popups.repairEta")}</span>
            <span class="stat-value">${h}</span>
          </div>
          `:""}
        </div>
        ${t?`
          <div class="popup-section">
            <span class="section-label">${r("popups.cable.advisory")}</span>
            <div class="popup-tags">
              <span class="popup-tag">${d}</span>
              <span class="popup-tag">${g}</span>
            </div>
            <p class="popup-description">${u}</p>
          </div>
        `:""}
        ${s?`
          <div class="popup-section">
            <span class="section-label">${r("popups.cable.repairDeployment")}</span>
            <div class="popup-tags">
              <span class="popup-tag">${v}</span>
              <span class="popup-tag">${s.status==="on-station"?r("popups.cable.repairStatus.onStation"):r("popups.cable.repairStatus.enRoute")}</span>
            </div>
            <p class="popup-description">${f}</p>
          </div>
        `:""}
        ${(b=a==null?void 0:a.evidence)!=null&&b.length?`
          <div class="popup-section">
            <span class="section-label">${r("popups.cable.health.evidence")}</span>
            <ul class="evidence-list">
              ${a.evidence.map(k=>`<li class="evidence-item"><strong>${m(k.source)}</strong>: ${m(k.summary)}</li>`).join("")}
            </ul>
          </div>
        `:""}
        <p class="popup-description">${r("popups.cable.description")}</p>
      </div>
    `}renderCableAdvisoryPopup(e){const t=ce.find(h=>h.id===e.cableId),s=this.getTimeAgo(e.reported),a=e.severity==="fault"?r("popups.cable.fault"):r("popups.cable.degraded"),i=m((t==null?void 0:t.name.toUpperCase())||e.cableId.toUpperCase()),n=m(e.title),l=m(e.impact),o=e.repairEta?m(e.repairEta):"",c=m(e.description);return`
      <div class="popup-header cable">
        <span class="popup-title">üö® ${i}</span>
        <span class="popup-badge ${e.severity==="fault"?"high":"elevated"}">${a}</span>
        <button class="popup-close">√ó</button>
      </div>
      <div class="popup-body">
        <div class="popup-subtitle">${n}</div>
        <div class="popup-stats">
          <div class="popup-stat">
            <span class="stat-label">${r("popups.cableAdvisory.reported")}</span>
            <span class="stat-value">${s}</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.cableAdvisory.impact")}</span>
            <span class="stat-value">${l}</span>
          </div>
          ${e.repairEta?`
          <div class="popup-stat">
            <span class="stat-label">${r("popups.cableAdvisory.eta")}</span>
            <span class="stat-value">${o}</span>
          </div>
          `:""}
        </div>
        <p class="popup-description">${c}</p>
      </div>
    `}renderRepairShipPopup(e){const t=ce.find(o=>o.id===e.cableId),s=m(e.name.toUpperCase()),a=m((t==null?void 0:t.name)||e.cableId),i=m(e.eta),n=e.operator?m(e.operator):"",l=m(e.note||r("popups.repairShip.description"));return`
      <div class="popup-header cable">
        <span class="popup-title">üö¢ ${s}</span>
        <span class="popup-badge elevated">${r("popups.repairShip.badge")}</span>
        <button class="popup-close">√ó</button>
      </div>
      <div class="popup-body">
        <div class="popup-subtitle">${a}</div>
        <div class="popup-stats">
          <div class="popup-stat">
            <span class="stat-label">${r("popups.status")}</span>
            <span class="stat-value">${e.status==="on-station"?r("popups.repairShip.status.onStation"):r("popups.repairShip.status.enRoute")}</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.cableAdvisory.eta")}</span>
            <span class="stat-value">${i}</span>
          </div>
          ${e.operator?`
          <div class="popup-stat">
            <span class="stat-label">${r("popups.operator")}</span>
            <span class="stat-value">${n}</span>
          </div>
          `:""}
        </div>
        <p class="popup-description">${l}</p>
      </div>
    `}getLatestCableAdvisory(e){return this.cableAdvisories.filter(s=>s.cableId===e).reduce((s,a)=>s?a.reported.getTime()>s.reported.getTime()?a:s:a,void 0)}getPriorityRepairShip(e){const t=this.repairShips.filter(a=>a.cableId===e);return t.length===0?void 0:t.find(a=>a.status==="on-station")||t[0]}renderOutagePopup(e){const t={total:"high",major:"elevated",partial:"low"},s={total:r("popups.outage.levels.total"),major:r("popups.outage.levels.major"),partial:r("popups.outage.levels.partial")},a=this.getTimeAgo(e.pubDate);return`
      <div class="popup-header outage ${m(e.severity)}">
        <span class="popup-title">üì° ${m(e.country.toUpperCase())}</span>
        <span class="popup-badge ${t[e.severity]||"low"}">${s[e.severity]||r("popups.outage.levels.disruption")}</span>
        <button class="popup-close">√ó</button>
      </div>
      <div class="popup-body">
        <div class="popup-subtitle">${m(e.title)}</div>
        <div class="popup-stats">
          <div class="popup-stat">
            <span class="stat-label">${r("popups.severity")}</span>
            <span class="stat-value">${m(e.severity.toUpperCase())}</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.outage.reported")}</span>
            <span class="stat-value">${a}</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.coordinates")}</span>
            <span class="stat-value">${e.lat.toFixed(2)}¬∞, ${e.lon.toFixed(2)}¬∞</span>
          </div>
        </div>
        ${e.categories&&e.categories.length>0?`
          <div class="popup-section">
            <span class="section-label">${r("popups.outage.categories")}</span>
            <div class="popup-tags">
              ${e.categories.slice(0,5).map(n=>`<span class="popup-tag">${m(n)}</span>`).join("")}
            </div>
          </div>
        `:""}
        <p class="popup-description">${m(e.description.slice(0,250))}${e.description.length>250?"...":""}</p>
        <a href="${we(e.link)}" target="_blank" class="popup-link">${r("popups.outage.readReport")} ‚Üí</a>
      </div>
    `}renderDatacenterPopup(e){const t={existing:"normal",planned:"elevated",decommissioned:"low"},s={existing:r("popups.datacenter.status.existing"),planned:r("popups.datacenter.status.planned"),decommissioned:r("popups.datacenter.status.decommissioned")},a=i=>i>=1e6?`${(i/1e6).toFixed(1)}M`:i>=1e3?`${(i/1e3).toFixed(0)}K`:i.toString();return`
      <div class="popup-header datacenter ${e.status}">
        <span class="popup-title">üñ•Ô∏è ${m(e.name)}</span>
        <span class="popup-badge ${t[e.status]||"normal"}">${s[e.status]||r("popups.datacenter.status.unknown")}</span>
        <button class="popup-close">√ó</button>
      </div>
      <div class="popup-body">
        <div class="popup-subtitle">${m(e.owner)} ‚Ä¢ ${m(e.country)}</div>
        <div class="popup-stats">
          <div class="popup-stat">
            <span class="stat-label">${r("popups.datacenter.gpuChipCount")}</span>
            <span class="stat-value">${a(e.chipCount)}</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.datacenter.chipType")}</span>
            <span class="stat-value">${m(e.chipType||r("popups.unknown"))}</span>
          </div>
          ${e.powerMW?`
          <div class="popup-stat">
            <span class="stat-label">${r("popups.datacenter.power")}</span>
            <span class="stat-value">${e.powerMW.toFixed(0)} MW</span>
          </div>
          `:""}
          ${e.sector?`
          <div class="popup-stat">
            <span class="stat-label">${r("popups.datacenter.sector")}</span>
            <span class="stat-value">${m(e.sector)}</span>
          </div>
          `:""}
        </div>
        ${e.note?`<p class="popup-description">${m(e.note)}</p>`:""}
        <div class="popup-attribution">${r("popups.datacenter.attribution")}</div>
      </div>
    `}renderDatacenterClusterPopup(e){const t=e.count??e.items.length,s=e.totalChips??e.items.reduce((c,h)=>c+h.chipCount,0),a=e.totalPowerMW??e.items.reduce((c,h)=>c+(h.powerMW||0),0),i=e.existingCount??e.items.filter(c=>c.status==="existing").length,n=e.plannedCount??e.items.filter(c=>c.status==="planned").length,l=c=>c>=1e6?`${(c/1e6).toFixed(1)}M`:c>=1e3?`${(c/1e3).toFixed(0)}K`:c.toString(),o=e.items.slice(0,8).map(c=>`
      <div class="cluster-item">
        <span class="cluster-item-icon">${c.status==="planned"?"üî®":"üñ•Ô∏è"}</span>
        <div class="cluster-item-info">
          <span class="cluster-item-name">${m(c.name.slice(0,40))}${c.name.length>40?"...":""}</span>
          <span class="cluster-item-detail">${m(c.owner)} ‚Ä¢ ${l(c.chipCount)} ${r("popups.datacenter.chips")}</span>
        </div>
      </div>
    `).join("");return`
      <div class="popup-header datacenter cluster">
        <span class="popup-title">üñ•Ô∏è ${r("popups.datacenter.cluster.title",{count:String(t)})}</span>
        <span class="popup-badge elevated">${m(e.region)}</span>
        <button class="popup-close">√ó</button>
      </div>
      <div class="popup-body">
        <div class="popup-subtitle">${m(e.country)}</div>
        <div class="popup-stats">
          <div class="popup-stat">
            <span class="stat-label">${r("popups.datacenter.cluster.totalChips")}</span>
            <span class="stat-value">${l(s)}</span>
          </div>
          ${a>0?`
          <div class="popup-stat">
            <span class="stat-label">${r("popups.datacenter.cluster.totalPower")}</span>
            <span class="stat-value">${a.toFixed(0)} MW</span>
          </div>
          `:""}
          <div class="popup-stat">
            <span class="stat-label">${r("popups.datacenter.cluster.operational")}</span>
            <span class="stat-value">${i}</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.datacenter.cluster.planned")}</span>
            <span class="stat-value">${n}</span>
          </div>
        </div>
        <div class="cluster-list">
          ${o}
        </div>
        ${t>8?`<p class="popup-more">${r("popups.datacenter.cluster.moreDataCenters",{count:String(Math.max(0,t-8))})}</p>`:""}
        ${e.sampled?`<p class="popup-more">${r("popups.datacenter.cluster.sampledSites",{count:String(e.items.length)})}</p>`:""}
        <div class="popup-attribution">${r("popups.datacenter.attribution")}</div>
      </div>
    `}renderStartupHubPopup(e){const t={mega:r("popups.startupHub.tiers.mega"),major:r("popups.startupHub.tiers.major"),emerging:r("popups.startupHub.tiers.emerging")},s={mega:"ü¶Ñ",major:"üöÄ",emerging:"üí°"};return`
      <div class="popup-header startup-hub ${e.tier}">
        <span class="popup-title">${s[e.tier]||"üöÄ"} ${m(e.name)}</span>
        <span class="popup-badge ${e.tier}">${t[e.tier]||r("popups.startupHub.tiers.hub")}</span>
        <button class="popup-close">√ó</button>
      </div>
      <div class="popup-body">
        <div class="popup-subtitle">${m(e.city)}, ${m(e.country)}</div>
        ${e.unicorns?`
        <div class="popup-stats">
          <div class="popup-stat">
            <span class="stat-label">${r("popups.startupHub.unicorns")}</span>
            <span class="stat-value">${e.unicorns}+</span>
          </div>
        </div>
        `:""}
        ${e.description?`<p class="popup-description">${m(e.description)}</p>`:""}
      </div>
    `}renderCloudRegionPopup(e){const t={aws:"Amazon Web Services",gcp:"Google Cloud Platform",azure:"Microsoft Azure",cloudflare:"Cloudflare"},s={aws:"üü†",gcp:"üîµ",azure:"üü£",cloudflare:"üü°"};return`
      <div class="popup-header cloud-region ${e.provider}">
        <span class="popup-title">${s[e.provider]||"‚òÅÔ∏è"} ${m(e.name)}</span>
        <span class="popup-badge ${e.provider}">${m(e.provider.toUpperCase())}</span>
        <button class="popup-close">√ó</button>
      </div>
      <div class="popup-body">
        <div class="popup-subtitle">${m(e.city)}, ${m(e.country)}</div>
        <div class="popup-stats">
          <div class="popup-stat">
            <span class="stat-label">${r("popups.cloudRegion.provider")}</span>
            <span class="stat-value">${m(t[e.provider]||e.provider)}</span>
          </div>
          ${e.zones?`
          <div class="popup-stat">
            <span class="stat-label">${r("popups.cloudRegion.availabilityZones")}</span>
            <span class="stat-value">${e.zones}</span>
          </div>
          `:""}
        </div>
      </div>
    `}renderTechHQPopup(e){const t={faang:r("popups.techHQ.types.faang"),unicorn:r("popups.techHQ.types.unicorn"),public:r("popups.techHQ.types.public")},s={faang:"üèõÔ∏è",unicorn:"ü¶Ñ",public:"üè¢"};return`
      <div class="popup-header tech-hq ${e.type}">
        <span class="popup-title">${s[e.type]||"üè¢"} ${m(e.company)}</span>
        <span class="popup-badge ${e.type}">${t[e.type]||r("popups.techHQ.types.tech")}</span>
        <button class="popup-close">√ó</button>
      </div>
      <div class="popup-body">
        <div class="popup-subtitle">${m(e.city)}, ${m(e.country)}</div>
        <div class="popup-stats">
          ${e.marketCap?`
          <div class="popup-stat">
            <span class="stat-label">${r("popups.techHQ.marketCap")}</span>
            <span class="stat-value">${m(e.marketCap)}</span>
          </div>
          `:""}
          ${e.employees?`
          <div class="popup-stat">
            <span class="stat-label">${r("popups.techHQ.employees")}</span>
            <span class="stat-value">${e.employees.toLocaleString()}</span>
          </div>
          `:""}
        </div>
      </div>
    `}renderAcceleratorPopup(e){const t={accelerator:r("popups.accelerator.types.accelerator"),incubator:r("popups.accelerator.types.incubator"),studio:r("popups.accelerator.types.studio")},s={accelerator:"üéØ",incubator:"üî¨",studio:"üé®"};return`
      <div class="popup-header accelerator ${e.type}">
        <span class="popup-title">${s[e.type]||"üéØ"} ${m(e.name)}</span>
        <span class="popup-badge ${e.type}">${t[e.type]||r("popups.accelerator.types.accelerator")}</span>
        <button class="popup-close">√ó</button>
      </div>
      <div class="popup-body">
        <div class="popup-subtitle">${m(e.city)}, ${m(e.country)}</div>
        <div class="popup-stats">
          ${e.founded?`
          <div class="popup-stat">
            <span class="stat-label">${r("popups.accelerator.founded")}</span>
            <span class="stat-value">${e.founded}</span>
          </div>
          `:""}
        </div>
        ${e.notable&&e.notable.length>0?`
        <div class="popup-notable">
          <span class="notable-label">${r("popups.accelerator.notableAlumni")}</span>
          <span class="notable-list">${e.notable.map(a=>m(a)).join(", ")}</span>
        </div>
        `:""}
      </div>
    `}renderTechEventPopup(e){const t=new Date(e.startDate),s=new Date(e.endDate),a=t.toLocaleDateString(void 0,{month:"short",day:"numeric",year:"numeric"}),i=s>t&&s.toDateString()!==t.toDateString()?` - ${s.toLocaleDateString(void 0,{month:"short",day:"numeric"})}`:"",n=e.daysUntil<=7?"urgent":e.daysUntil<=30?"soon":"",l=e.daysUntil===0?r("popups.techEvent.days.today"):e.daysUntil===1?r("popups.techEvent.days.tomorrow"):r("popups.techEvent.days.inDays",{count:String(e.daysUntil)});return`
      <div class="popup-header tech-event ${n}">
        <span class="popup-title">üìÖ ${m(e.title)}</span>
        <span class="popup-badge ${n}">${l}</span>
        <button class="popup-close">√ó</button>
      </div>
      <div class="popup-body">
        <div class="popup-subtitle">üìç ${m(e.location)}, ${m(e.country)}</div>
        <div class="popup-stats">
          <div class="popup-stat">
            <span class="stat-label">${r("popups.techEvent.date")}</span>
            <span class="stat-value">${a}${i}</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.location")}</span>
            <span class="stat-value">${m(e.location)}</span>
          </div>
        </div>
        ${e.url?`
        <a href="${we(e.url)}" target="_blank" rel="noopener noreferrer" class="popup-link">
          ${r("popups.techEvent.moreInformation")} ‚Üí
        </a>
        `:""}
      </div>
    `}renderTechHQClusterPopup(e){const t=e.count??e.items.length,s=e.unicornCount??e.items.filter(o=>o.type==="unicorn").length,a=e.faangCount??e.items.filter(o=>o.type==="faang").length,i=e.publicCount??e.items.filter(o=>o.type==="public").length,l=[...e.items].sort((o,c)=>{const h={faang:0,unicorn:1,public:2};return(h[o.type]??3)-(h[c.type]??3)}).map(o=>{const c=o.type==="faang"?"üèõÔ∏è":o.type==="unicorn"?"ü¶Ñ":"üè¢",h=o.marketCap?` (${m(o.marketCap)})`:"";return`<li class="cluster-item ${o.type}">${c} ${m(o.company)}${h}</li>`}).join("");return`
      <div class="popup-header tech-hq cluster">
        <span class="popup-title">üèôÔ∏è ${m(e.city)}</span>
        <span class="popup-badge">${r("popups.techHQCluster.companiesCount",{count:String(t)})}</span>
        <button class="popup-close">√ó</button>
      </div>
      <div class="popup-body cluster-popup">
        <div class="popup-subtitle">üìç ${m(e.city)}, ${m(e.country)}</div>
        <div class="cluster-summary">
          ${a?`<span class="summary-item faang">üèõÔ∏è ${r("popups.techHQCluster.bigTechCount",{count:String(a)})}</span>`:""}
          ${s?`<span class="summary-item unicorn">ü¶Ñ ${r("popups.techHQCluster.unicornsCount",{count:String(s)})}</span>`:""}
          ${i?`<span class="summary-item public">üè¢ ${r("popups.techHQCluster.publicCount",{count:String(i)})}</span>`:""}
        </div>
        <ul class="cluster-list">${l}</ul>
        ${e.sampled?`<p class="popup-more">${r("popups.techHQCluster.sampled",{count:String(e.items.length)})}</p>`:""}
      </div>
    `}renderTechEventClusterPopup(e){const t=e.count??e.items.length,s=e.soonCount??e.items.filter(n=>n.daysUntil<=14).length,i=[...e.items].sort((n,l)=>n.daysUntil-l.daysUntil).map(n=>{const o=new Date(n.startDate).toLocaleDateString(void 0,{month:"short",day:"numeric"});return`<li class="cluster-item ${n.daysUntil<=7?"urgent":n.daysUntil<=30?"soon":""}">üìÖ ${o}: ${m(n.title)}</li>`}).join("");return`
      <div class="popup-header tech-event cluster">
        <span class="popup-title">üìÖ ${m(e.location)}</span>
        <span class="popup-badge">${r("popups.techEventCluster.eventsCount",{count:String(t)})}</span>
        <button class="popup-close">√ó</button>
      </div>
      <div class="popup-body cluster-popup">
        <div class="popup-subtitle">üìç ${m(e.location)}, ${m(e.country)}</div>
        ${s?`<div class="cluster-summary"><span class="summary-item soon">‚ö° ${r("popups.techEventCluster.upcomingWithin2Weeks",{count:String(s)})}</span></div>`:""}
        <ul class="cluster-list">${i}</ul>
        ${e.sampled?`<p class="popup-more">${r("popups.techEventCluster.sampled",{count:String(e.items.length)})}</p>`:""}
      </div>
    `}getMarketStatus(e){try{const t=new Date,a=new Intl.DateTimeFormat(void 0,{hour:"2-digit",minute:"2-digit",hour12:!1,timeZone:e.timezone}).format(t),[i=0,n=0]=e.open.split(":").map(Number),[l=0,o=0]=e.close.split(":").map(Number),[c=0,h=0]=a.split(":").map(Number),d=i*60+n,g=l*60+o,u=c*60+h;return u>=d&&u<g?"open":"closed"}catch{return"unknown"}}renderMilitaryFlightPopup(e){const t={usaf:"US Air Force",usn:"US Navy",usmc:"US Marines",usa:"US Army",raf:"Royal Air Force",rn:"Royal Navy",faf:"French Air Force",gaf:"German Air Force",plaaf:"PLA Air Force",plan:"PLA Navy",vks:"Russian Aerospace",iaf:"Israeli Air Force",nato:"NATO",other:r("popups.unknown")},s={fighter:r("popups.militaryFlight.types.fighter"),bomber:r("popups.militaryFlight.types.bomber"),transport:r("popups.militaryFlight.types.transport"),tanker:r("popups.militaryFlight.types.tanker"),awacs:r("popups.militaryFlight.types.awacs"),reconnaissance:r("popups.militaryFlight.types.reconnaissance"),helicopter:r("popups.militaryFlight.types.helicopter"),drone:r("popups.militaryFlight.types.drone"),patrol:r("popups.militaryFlight.types.patrol"),special_ops:r("popups.militaryFlight.types.specialOps"),vip:r("popups.militaryFlight.types.vip"),unknown:r("popups.unknown")},a={high:"elevated",medium:"low",low:"low"},i=m(e.callsign||r("popups.unknown")),n=m(e.aircraftType.toUpperCase()),l=m(t[e.operator]||e.operatorCountry||r("popups.unknown")),o=m(e.hexCode||""),c=m(s[e.aircraftType]||e.aircraftType),h=e.squawk?m(e.squawk):"",d=e.note?m(e.note):"";return`
      <div class="popup-header military-flight ${e.operator}">
        <span class="popup-title">${i}</span>
        <span class="popup-badge ${a[e.confidence]||"low"}">${n}</span>
        <button class="popup-close">√ó</button>
      </div>
      <div class="popup-body">
        <div class="popup-subtitle">${l}</div>
        <div class="popup-stats">
          <div class="popup-stat">
            <span class="stat-label">${r("popups.militaryFlight.altitude")}</span>
            <span class="stat-value">${e.altitude>0?`FL${Math.round(e.altitude/100)}`:r("popups.militaryFlight.ground")}</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.militaryFlight.speed")}</span>
            <span class="stat-value">${e.speed} kts</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.militaryFlight.heading")}</span>
            <span class="stat-value">${Math.round(e.heading)}¬∞</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.militaryFlight.hexCode")}</span>
            <span class="stat-value">${o}</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.type")}</span>
            <span class="stat-value">${c}</span>
          </div>
          ${e.squawk?`
          <div class="popup-stat">
            <span class="stat-label">${r("popups.militaryFlight.squawk")}</span>
            <span class="stat-value">${h}</span>
          </div>
          `:""}
        </div>
        ${e.note?`<p class="popup-description">${d}</p>`:""}
        <div class="popup-attribution">${r("popups.militaryFlight.attribution")}</div>
      </div>
    `}renderMilitaryVesselPopup(e){const t={usn:"US Navy",uscg:"US Coast Guard",rn:"Royal Navy",fn:"French Navy",plan:"PLA Navy",ruf:"Russian Navy",jmsdf:"Japan Maritime SDF",rokn:"ROK Navy",other:r("popups.unknown")},s={carrier:"Aircraft Carrier",destroyer:"Destroyer",frigate:"Frigate",submarine:"Submarine",amphibious:"Amphibious",patrol:"Patrol",auxiliary:"Auxiliary",research:"Research",icebreaker:"Icebreaker",special:"Special",unknown:r("popups.unknown")},a=e.isDark?`<span class="popup-badge high">${r("popups.militaryVessel.aisDark")}</span>`:"",i=e.usniDeploymentStatus&&e.usniDeploymentStatus!=="unknown"?`<span class="popup-badge ${e.usniDeploymentStatus==="deployed"?"high":e.usniDeploymentStatus==="underway"?"elevated":"low"}">${e.usniDeploymentStatus.toUpperCase().replace("-"," ")}</span>`:"",n=e.vesselType==="unknown"&&e.aisShipType?e.aisShipType:s[e.vesselType]||e.vesselType,l=e.vesselType==="unknown"&&e.aisShipType?e.aisShipType.toUpperCase():e.vesselType.toUpperCase(),o=m(e.name||`${r("popups.militaryVessel.vessel")} ${e.mmsi}`),c=m(t[e.operator]||e.operatorCountry||r("popups.unknown")),h=m(n),d=m(l),g=m(e.mmsi||"‚Äî"),u=e.hullNumber?m(e.hullNumber):"",v=e.note?m(e.note):"";return`
      <div class="popup-header military-vessel ${e.operator}">
        <span class="popup-title">${o}</span>
        ${a}
        ${i}
        <span class="popup-badge elevated">${d}</span>
        <button class="popup-close">√ó</button>
      </div>
      <div class="popup-body">
        <div class="popup-subtitle">${c}</div>
        <div class="popup-stats">
          <div class="popup-stat">
            <span class="stat-label">${r("popups.type")}</span>
            <span class="stat-value">${h}</span>
          </div>
          ${e.usniRegion?`
          <div class="popup-stat">
            <span class="stat-label">${r("popups.militaryVessel.region")}</span>
            <span class="stat-value">${m(e.usniRegion)}</span>
          </div>
          `:""}
          ${e.usniStrikeGroup?`
          <div class="popup-stat">
            <span class="stat-label">${r("popups.militaryVessel.strikeGroup")}</span>
            <span class="stat-value">${m(e.usniStrikeGroup)}</span>
          </div>
          `:""}
          <div class="popup-stat">
            <span class="stat-label">${r("popups.militaryVessel.speed")}</span>
            <span class="stat-value">${e.speed} kts</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.militaryVessel.heading")}</span>
            <span class="stat-value">${Math.round(e.heading)}¬∞</span>
          </div>
          ${e.mmsi?`
          <div class="popup-stat">
            <span class="stat-label">${r("popups.militaryVessel.mmsi")}</span>
            <span class="stat-value">${g}</span>
          </div>
          `:""}
          ${e.hullNumber?`
          <div class="popup-stat">
            <span class="stat-label">${r("popups.militaryVessel.hull")}</span>
            <span class="stat-value">${u}</span>
          </div>
          `:""}
        </div>
        ${e.usniActivityDescription?`<p class="popup-description"><strong>${r("popups.militaryVessel.usniIntel")}:</strong> ${m(e.usniActivityDescription)}</p>`:""}
        ${e.note?`<p class="popup-description">${v}</p>`:""}
        ${e.isDark?`<p class="popup-description alert">${r("popups.militaryVessel.darkDescription")}</p>`:""}
        ${e.usniSource?`<p class="popup-description" style="opacity:0.7;font-size:0.85em">${r("popups.militaryVessel.approximatePosition")}</p>`:""}
        ${e.usniArticleUrl?`<div class="popup-attribution"><a href="${m(e.usniArticleUrl)}" target="_blank" rel="noopener">${r("popups.militaryVessel.usniSource")}${e.usniArticleDate?` (${new Date(e.usniArticleDate).toLocaleDateString()})`:""}</a></div>`:""}
      </div>
    `}renderMilitaryFlightClusterPopup(e){const t={exercise:r("popups.militaryCluster.flightActivity.exercise"),patrol:r("popups.militaryCluster.flightActivity.patrol"),transport:r("popups.militaryCluster.flightActivity.transport"),unknown:r("popups.militaryCluster.flightActivity.unknown")},s={exercise:"high",patrol:"elevated",transport:"low",unknown:"low"},a=e.activityType||"unknown",i=m(e.name),n=m(a.toUpperCase()),l=e.dominantOperator?m(e.dominantOperator.toUpperCase()):"",o=e.flights.slice(0,5).map(h=>`<div class="cluster-flight-item">${m(h.callsign)} - ${m(h.aircraftType)}</div>`).join(""),c=e.flightCount>5?`<div class="cluster-more">${r("popups.militaryCluster.moreAircraft",{count:String(e.flightCount-5)})}</div>`:"";return`
      <div class="popup-header military-cluster">
        <span class="popup-title">${i}</span>
        <span class="popup-badge ${s[a]||"low"}">${r("popups.militaryCluster.aircraftCount",{count:String(e.flightCount)})}</span>
        <button class="popup-close">√ó</button>
      </div>
      <div class="popup-body">
        <div class="popup-subtitle">${t[a]||r("popups.militaryCluster.flightActivity.unknown")}</div>
        <div class="popup-stats">
          <div class="popup-stat">
            <span class="stat-label">${r("popups.militaryCluster.aircraft")}</span>
            <span class="stat-value">${e.flightCount}</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.militaryCluster.activity")}</span>
            <span class="stat-value">${n}</span>
          </div>
          ${e.dominantOperator?`
          <div class="popup-stat">
            <span class="stat-label">${r("popups.militaryCluster.primary")}</span>
            <span class="stat-value">${l}</span>
          </div>
          `:""}
        </div>
        <div class="popup-section">
          <span class="section-label">${r("popups.militaryCluster.trackedAircraft")}</span>
          <div class="cluster-flights">
            ${o}
            ${c}
          </div>
        </div>
      </div>
    `}renderMilitaryVesselClusterPopup(e){const t={exercise:r("popups.militaryCluster.vesselActivity.exercise"),deployment:r("popups.militaryCluster.vesselActivity.deployment"),patrol:r("popups.militaryCluster.vesselActivity.patrol"),transit:r("popups.militaryCluster.vesselActivity.transit"),unknown:r("popups.militaryCluster.vesselActivity.unknown")},s={exercise:"high",deployment:"high",patrol:"elevated",transit:"low",unknown:"low"},a=e.activityType||"unknown",i=m(e.name),n=m(a.toUpperCase()),l=e.region?m(e.region):"",o=e.vessels.slice(0,5).map(h=>`<div class="cluster-vessel-item">${m(h.name)} - ${m(h.vesselType)}</div>`).join(""),c=e.vesselCount>5?`<div class="cluster-more">${r("popups.militaryCluster.moreVessels",{count:String(e.vesselCount-5)})}</div>`:"";return`
      <div class="popup-header military-cluster">
        <span class="popup-title">${i}</span>
        <span class="popup-badge ${s[a]||"low"}">${r("popups.militaryCluster.vesselsCount",{count:String(e.vesselCount)})}</span>
        <button class="popup-close">√ó</button>
      </div>
      <div class="popup-body">
        <div class="popup-subtitle">${t[a]||r("popups.militaryCluster.vesselActivity.unknown")}</div>
        <div class="popup-stats">
          <div class="popup-stat">
            <span class="stat-label">${r("popups.militaryCluster.vessels")}</span>
            <span class="stat-value">${e.vesselCount}</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.militaryCluster.activity")}</span>
            <span class="stat-value">${n}</span>
          </div>
          ${e.region?`
          <div class="popup-stat">
            <span class="stat-label">${r("popups.region")}</span>
            <span class="stat-value">${l}</span>
          </div>
          `:""}
        </div>
        <div class="popup-section">
          <span class="section-label">${r("popups.militaryCluster.trackedVessels")}</span>
          <div class="cluster-vessels">
            ${o}
            ${c}
          </div>
        </div>
      </div>
    `}renderNaturalEventPopup(e){const t={severeStorms:"high",wildfires:"high",volcanoes:"high",earthquakes:"elevated",floods:"elevated",landslides:"elevated",drought:"medium",dustHaze:"low",snow:"low",tempExtremes:"elevated",seaLakeIce:"low",waterColor:"low",manmade:"elevated"},s=ha(e.category),a=t[e.category]||"low",i=this.getTimeAgo(e.date);return`
      <div class="popup-header nat-event ${e.category}">
        <span class="popup-icon">${s}</span>
        <span class="popup-title">${m(e.categoryTitle.toUpperCase())}</span>
        <span class="popup-badge ${a}">${e.closed?r("popups.naturalEvent.closed"):r("popups.naturalEvent.active")}</span>
        <button class="popup-close">√ó</button>
      </div>
      <div class="popup-body">
        <div class="popup-subtitle">${m(e.title)}</div>
        <div class="popup-stats">
          <div class="popup-stat">
            <span class="stat-label">${r("popups.naturalEvent.reported")}</span>
            <span class="stat-value">${i}</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.coordinates")}</span>
            <span class="stat-value">${e.lat.toFixed(2)}¬∞, ${e.lon.toFixed(2)}¬∞</span>
          </div>
          ${e.magnitude?`
          <div class="popup-stat">
            <span class="stat-label">${r("popups.magnitude")}</span>
            <span class="stat-value">${e.magnitude}${e.magnitudeUnit?` ${m(e.magnitudeUnit)}`:""}</span>
          </div>
          `:""}
          ${e.sourceName?`
          <div class="popup-stat">
            <span class="stat-label">${r("popups.source")}</span>
            <span class="stat-value">${m(e.sourceName)}</span>
          </div>
          `:""}
        </div>
        ${e.description?`<p class="popup-description">${m(e.description)}</p>`:""}
        ${e.sourceUrl?`<a href="${we(e.sourceUrl)}" target="_blank" class="popup-link">${r("popups.naturalEvent.viewOnSource",{source:m(e.sourceName||r("popups.source"))})} ‚Üí</a>`:""}
        <div class="popup-attribution">${r("popups.naturalEvent.attribution")}</div>
      </div>
    `}renderPortPopup(e){const t={container:r("popups.port.types.container"),oil:r("popups.port.types.oil"),lng:r("popups.port.types.lng"),naval:r("popups.port.types.naval"),mixed:r("popups.port.types.mixed"),bulk:r("popups.port.types.bulk")},s={container:"elevated",oil:"high",lng:"high",naval:"elevated",mixed:"normal",bulk:"low"},a={container:"üè≠",oil:"üõ¢Ô∏è",lng:"üî•",naval:"‚öì",mixed:"üö¢",bulk:"üì¶"},i=e.rank?`<div class="popup-stat"><span class="stat-label">${r("popups.port.worldRank")}</span><span class="stat-value">#${e.rank}</span></div>`:"";return`
      <div class="popup-header port ${m(e.type)}">
        <span class="popup-icon">${a[e.type]||"üö¢"}</span>
        <span class="popup-title">${m(e.name.toUpperCase())}</span>
        <span class="popup-badge ${s[e.type]||"normal"}">${t[e.type]||e.type.toUpperCase()}</span>
        <button class="popup-close">√ó</button>
      </div>
      <div class="popup-body">
        <div class="popup-subtitle">${m(e.country)}</div>
        <div class="popup-stats">
          ${i}
          <div class="popup-stat">
            <span class="stat-label">${r("popups.type")}</span>
            <span class="stat-value">${t[e.type]||e.type.toUpperCase()}</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.coordinates")}</span>
            <span class="stat-value">${e.lat.toFixed(2)}¬∞, ${e.lon.toFixed(2)}¬∞</span>
          </div>
        </div>
        <p class="popup-description">${m(e.note)}</p>
      </div>
    `}renderSpaceportPopup(e){const t={active:"elevated",construction:"high",inactive:"low"},s={active:r("popups.spaceport.status.active"),construction:r("popups.spaceport.status.construction"),inactive:r("popups.spaceport.status.inactive")};return`
      <div class="popup-header spaceport ${e.status}">
        <span class="popup-icon">üöÄ</span>
        <span class="popup-title">${m(e.name.toUpperCase())}</span>
        <span class="popup-badge ${t[e.status]||"normal"}">${s[e.status]||e.status.toUpperCase()}</span>
        <button class="popup-close">√ó</button>
      </div>
      <div class="popup-body">
        <div class="popup-subtitle">${m(e.operator)} ‚Ä¢ ${m(e.country)}</div>
        <div class="popup-stats">
          <div class="popup-stat">
            <span class="stat-label">${r("popups.spaceport.launchActivity")}</span>
            <span class="stat-value">${m(e.launches.toUpperCase())}</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.coordinates")}</span>
            <span class="stat-value">${e.lat.toFixed(2)}¬∞, ${e.lon.toFixed(2)}¬∞</span>
          </div>
        </div>
        <p class="popup-description">${r("popups.spaceport.description")}</p>
      </div>
    `}renderMineralPopup(e){const t={producing:"elevated",development:"high",exploration:"low"},s={producing:r("popups.mineral.status.producing"),development:r("popups.mineral.status.development"),exploration:r("popups.mineral.status.exploration")},a=e.mineral==="Lithium"?"üîã":e.mineral==="Rare Earths"?"üß≤":"üíé";return`
      <div class="popup-header mineral ${e.status}">
        <span class="popup-icon">${a}</span>
        <span class="popup-title">${m(e.name.toUpperCase())}</span>
        <span class="popup-badge ${t[e.status]||"normal"}">${s[e.status]||e.status.toUpperCase()}</span>
        <button class="popup-close">√ó</button>
      </div>
      <div class="popup-body">
        <div class="popup-subtitle">${r("popups.mineral.projectSubtitle",{mineral:m(e.mineral.toUpperCase())})}</div>
        <div class="popup-stats">
          <div class="popup-stat">
            <span class="stat-label">${r("popups.operator")}</span>
            <span class="stat-value">${m(e.operator)}</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.country")}</span>
            <span class="stat-value">${m(e.country)}</span>
          </div>
          <div class="popup-stat">
            <span class="stat-label">${r("popups.coordinates")}</span>
            <span class="stat-value">${e.lat.toFixed(2)}¬∞, ${e.lon.toFixed(2)}¬∞</span>
          </div>
        </div>
        <p class="popup-description">${m(e.significance)}</p>
      </div>
    `}renderStockExchangePopup(e){const t=e.tier.toUpperCase(),s=e.tier==="mega"?"high":e.tier==="major"?"medium":"low";return`
      <div class="popup-header exchange">
        <span class="popup-title">${m(e.shortName)}</span>
        <span class="popup-badge ${s}">${t}</span>
        <button class="popup-close">√ó</button>
      </div>
      <div class="popup-body">
        <div class="popup-subtitle">${m(e.name)}</div>
        <div class="popup-stats">
          <div class="popup-stat">
            <span class="stat-label">${r("popups.location")}</span>
            <span class="stat-value">${m(e.city)}, ${m(e.country)}</span>
          </div>
          ${e.marketCap?`<div class="popup-stat"><span class="stat-label">${r("popups.stockExchange.marketCap")}</span><span class="stat-value">$${e.marketCap}T</span></div>`:""}
          ${e.tradingHours?`<div class="popup-stat"><span class="stat-label">${r("popups.tradingHours")}</span><span class="stat-value">${m(e.tradingHours)}</span></div>`:""}
        </div>
        ${e.description?`<p class="popup-description">${m(e.description)}</p>`:""}
      </div>
    `}renderFinancialCenterPopup(e){const t=e.type.toUpperCase();return`
      <div class="popup-header financial-center">
        <span class="popup-title">${m(e.name)}</span>
        <span class="popup-badge">${t}</span>
        <button class="popup-close">√ó</button>
      </div>
      <div class="popup-body">
        <div class="popup-stats">
          <div class="popup-stat">
            <span class="stat-label">${r("popups.location")}</span>
            <span class="stat-value">${m(e.city)}, ${m(e.country)}</span>
          </div>
          ${e.gfciRank?`<div class="popup-stat"><span class="stat-label">${r("popups.financialCenter.gfciRank")}</span><span class="stat-value">#${e.gfciRank}</span></div>`:""}
        </div>
        ${e.specialties&&e.specialties.length>0?`
          <div class="popup-section">
            <span class="section-label">${r("popups.financialCenter.specialties")}</span>
            <div class="popup-tags">
              ${e.specialties.map(s=>`<span class="popup-tag">${m(s)}</span>`).join("")}
            </div>
          </div>
        `:""}
        ${e.description?`<p class="popup-description">${m(e.description)}</p>`:""}
      </div>
    `}renderCentralBankPopup(e){const t=e.type.toUpperCase();return`
      <div class="popup-header central-bank">
        <span class="popup-title">${m(e.shortName)}</span>
        <span class="popup-badge">${t}</span>
        <button class="popup-close">√ó</button>
      </div>
      <div class="popup-body">
        <div class="popup-subtitle">${m(e.name)}</div>
        <div class="popup-stats">
          <div class="popup-stat">
            <span class="stat-label">${r("popups.location")}</span>
            <span class="stat-value">${m(e.city)}, ${m(e.country)}</span>
          </div>
          ${e.currency?`<div class="popup-stat"><span class="stat-label">${r("popups.centralBank.currency")}</span><span class="stat-value">${m(e.currency)}</span></div>`:""}
        </div>
        ${e.description?`<p class="popup-description">${m(e.description)}</p>`:""}
      </div>
    `}renderCommodityHubPopup(e){const t=e.type.toUpperCase();return`
      <div class="popup-header commodity-hub">
        <span class="popup-title">${m(e.name)}</span>
        <span class="popup-badge">${t}</span>
        <button class="popup-close">√ó</button>
      </div>
      <div class="popup-body">
        <div class="popup-stats">
          <div class="popup-stat">
            <span class="stat-label">${r("popups.location")}</span>
            <span class="stat-value">${m(e.city)}, ${m(e.country)}</span>
          </div>
        </div>
        ${e.commodities&&e.commodities.length>0?`
          <div class="popup-section">
            <span class="section-label">${r("popups.commodityHub.commodities")}</span>
            <div class="popup-tags">
              ${e.commodities.map(s=>`<span class="popup-tag">${m(s)}</span>`).join("")}
            </div>
          </div>
        `:""}
        ${e.description?`<p class="popup-description">${m(e.description)}</p>`:""}
      </div>
    `}}const he=class he{constructor(e,t){y(this,"container");y(this,"svg");y(this,"wrapper");y(this,"overlays");y(this,"clusterCanvas");y(this,"clusterGl",null);y(this,"state");y(this,"worldData",null);y(this,"countryFeatures",null);y(this,"baseLayerGroup",null);y(this,"dynamicLayerGroup",null);y(this,"baseRendered",!1);y(this,"baseWidth",0);y(this,"baseHeight",0);y(this,"hotspots");y(this,"earthquakes",[]);y(this,"weatherAlerts",[]);y(this,"outages",[]);y(this,"aisDisruptions",[]);y(this,"aisDensity",[]);y(this,"cableAdvisories",[]);y(this,"repairShips",[]);y(this,"healthByCableId",{});y(this,"protests",[]);y(this,"flightDelays",[]);y(this,"militaryFlights",[]);y(this,"militaryFlightClusters",[]);y(this,"militaryVessels",[]);y(this,"militaryVesselClusters",[]);y(this,"naturalEvents",[]);y(this,"firmsFireData",[]);y(this,"techEvents",[]);y(this,"techActivities",[]);y(this,"geoActivities",[]);y(this,"news",[]);y(this,"onTechHubClick");y(this,"onGeoHubClick");y(this,"popup");y(this,"onHotspotClick");y(this,"onTimeRangeChange");y(this,"onLayerChange");y(this,"layerZoomOverrides",{});y(this,"onStateChange");y(this,"highlightedAssets",{pipeline:new Set,cable:new Set,datacenter:new Set,base:new Set,nuclear:new Set});y(this,"boundVisibilityHandler");y(this,"renderScheduled",!1);y(this,"lastRenderTime",0);y(this,"MIN_RENDER_INTERVAL_MS",100);y(this,"healthCheckIntervalId",null);this.container=e,this.state=t,this.hotspots=[...He],this.wrapper=document.createElement("div"),this.wrapper.className="map-wrapper",this.wrapper.id="mapWrapper";const s=document.createElementNS("http://www.w3.org/2000/svg","svg");s.classList.add("map-svg"),s.id="mapSvg",this.wrapper.appendChild(s),this.clusterCanvas=document.createElement("canvas"),this.clusterCanvas.className="map-cluster-canvas",this.clusterCanvas.id="mapClusterCanvas",this.wrapper.appendChild(this.clusterCanvas),this.overlays=document.createElement("div"),this.overlays.id="mapOverlays",this.wrapper.appendChild(this.overlays),e.appendChild(this.wrapper),e.appendChild(this.createControls()),e.appendChild(this.createTimeSlider()),e.appendChild(this.createLayerToggles()),e.appendChild(this.createLegend()),this.healthCheckIntervalId=setInterval(()=>this.runHealthCheck(),3e4),this.svg=Ye(s),this.baseLayerGroup=this.svg.append("g").attr("class","map-base"),this.dynamicLayerGroup=this.svg.append("g").attr("class","map-dynamic"),this.popup=new Fa(e),this.initClusterRenderer(),this.setupZoomHandlers(),this.loadMapData(),this.setupResizeObserver(),window.addEventListener("theme-changed",()=>{this.baseRendered=!1,this.render()})}setupResizeObserver(){let e=0,t=0;new ResizeObserver(a=>{for(const i of a){const{width:n,height:l}=i.contentRect;n>0&&l>0&&(n!==e||l!==t)&&(e=n,t=l,requestAnimationFrame(()=>this.render()))}}).observe(this.container),this.boundVisibilityHandler=()=>{document.hidden||requestAnimationFrame(()=>this.render())},document.addEventListener("visibilitychange",this.boundVisibilityHandler)}destroy(){document.removeEventListener("visibilitychange",this.boundVisibilityHandler),this.healthCheckIntervalId&&(clearInterval(this.healthCheckIntervalId),this.healthCheckIntervalId=null)}createControls(){const e=document.createElement("div");return e.className="map-controls",e.innerHTML=`
      <button class="map-control-btn" data-action="zoom-in">+</button>
      <button class="map-control-btn" data-action="zoom-out">‚àí</button>
      <button class="map-control-btn" data-action="reset">‚ü≤</button>
    `,e.addEventListener("click",t=>{const a=t.target.dataset.action;a==="zoom-in"?this.zoomIn():a==="zoom-out"?this.zoomOut():a==="reset"&&this.reset()}),e}createTimeSlider(){const e=document.createElement("div");e.className="time-slider",e.id="timeSlider";const t=[{value:"1h",label:"1H"},{value:"6h",label:"6H"},{value:"24h",label:"24H"},{value:"48h",label:"48H"},{value:"7d",label:"7D"},{value:"all",label:"ALL"}];return e.innerHTML=`
      <span class="time-slider-label">TIME RANGE</span>
      <div class="time-slider-buttons">
        ${t.map(s=>`<button class="time-btn ${this.state.timeRange===s.value?"active":""}" data-range="${s.value}">${s.label}</button>`).join("")}
      </div>
    `,e.addEventListener("click",s=>{const a=s.target;if(a.classList.contains("time-btn")){const i=a.dataset.range;this.setTimeRange(i),e.querySelectorAll(".time-btn").forEach(n=>n.classList.remove("active")),a.classList.add("active")}}),e}updateTimeSliderButtons(){const e=this.container.querySelector("#timeSlider");e&&e.querySelectorAll(".time-btn").forEach(t=>{const s=t.dataset.range;t.classList.toggle("active",s===this.state.timeRange)})}setTimeRange(e){var t;this.state.timeRange=e,(t=this.onTimeRangeChange)==null||t.call(this,e),this.updateTimeSliderButtons(),this.render()}getTimeRangeMs(){return{"1h":36e5,"6h":216e5,"24h":864e5,"48h":1728e5,"7d":6048e5,all:1/0}[this.state.timeRange]}createLayerToggles(){const e=document.createElement("div");e.className="layer-toggles",e.id="layerToggles";const i=M==="tech"?["cables","datacenters","outages","startupHubs","cloudRegions","accelerators","techHQs","techEvents","natural","weather","economic"]:M==="finance"?["stockExchanges","financialCenters","centralBanks","commodityHubs","cables","pipelines","outages","sanctions","economic","waterways","natural","weather"]:["conflicts","hotspots","sanctions","protests","bases","nuclear","irradiators","military","cables","pipelines","outages","datacenters","ais","flights","natural","weather","economic","waterways"],n={hotspots:"components.deckgl.layers.intelHotspots",conflicts:"components.deckgl.layers.conflictZones",bases:"components.deckgl.layers.militaryBases",nuclear:"components.deckgl.layers.nuclearSites",irradiators:"components.deckgl.layers.gammaIrradiators",military:"components.deckgl.layers.militaryActivity",cables:"components.deckgl.layers.underseaCables",pipelines:"components.deckgl.layers.pipelines",outages:"components.deckgl.layers.internetOutages",datacenters:"components.deckgl.layers.aiDataCenters",ais:"components.deckgl.layers.shipTraffic",flights:"components.deckgl.layers.flightDelays",natural:"components.deckgl.layers.naturalEvents",weather:"components.deckgl.layers.weatherAlerts",economic:"components.deckgl.layers.economicCenters",waterways:"components.deckgl.layers.strategicWaterways",startupHubs:"components.deckgl.layers.startupHubs",cloudRegions:"components.deckgl.layers.cloudRegions",accelerators:"components.deckgl.layers.accelerators",techHQs:"components.deckgl.layers.techHQs",techEvents:"components.deckgl.layers.techEvents",stockExchanges:"components.deckgl.layers.stockExchanges",financialCenters:"components.deckgl.layers.financialCenters",centralBanks:"components.deckgl.layers.centralBanks",commodityHubs:"components.deckgl.layers.commodityHubs",gulfInvestments:"components.deckgl.layers.gulfInvestments"},l=c=>{if(c==="sanctions")return r("components.deckgl.layerHelp.labels.sanctions");const h=n[c];return h?r(h):c};i.forEach(c=>{const h=document.createElement("button");h.className=`layer-toggle ${this.state.layers[c]?"active":""}`,h.dataset.layer=c,h.textContent=l(c),h.addEventListener("click",()=>this.toggleLayer(c)),e.appendChild(h)});const o=document.createElement("button");return o.className="layer-help-btn",o.textContent="?",o.title=r("components.deckgl.layerGuide"),o.addEventListener("click",()=>this.showLayerHelp()),e.appendChild(o),e}showLayerHelp(){var g;const e=this.container.querySelector(".layer-help-popup");if(e){e.remove();return}const t=document.createElement("div");t.className="layer-help-popup";const s=u=>r(`components.deckgl.layers.${u}`).toUpperCase(),a=u=>r(`components.deckgl.layerHelp.labels.${u}`).toUpperCase(),i=(u,v)=>`<div class="layer-help-item"><span>${u}</span> ${r(`components.deckgl.layerHelp.descriptions.${v}`)}</div>`,n=(u,v,f)=>`
      <div class="layer-help-section">
        <div class="layer-help-title">${r(`components.deckgl.layerHelp.sections.${u}`)}</div>
        ${v.join("")}
        ${f?`<div class="layer-help-note">${r(`components.deckgl.layerHelp.notes.${f}`)}</div>`:""}
      </div>
    `,l=`
      <div class="layer-help-header">
        <span>${r("components.deckgl.layerHelp.title")}</span>
        <button class="layer-help-close">√ó</button>
      </div>
    `,o=`
      ${l}
      <div class="layer-help-content">
        ${n("techEcosystem",[i(s("startupHubs"),"techStartupHubs"),i(s("cloudRegions"),"techCloudRegions"),i(s("techHQs"),"techHQs"),i(s("accelerators"),"techAccelerators")])}
        ${n("infrastructure",[i(s("underseaCables"),"infraCables"),i(s("aiDataCenters"),"infraDatacenters"),i(s("internetOutages"),"infraOutages")])}
        ${n("naturalEconomic",[i(s("naturalEvents"),"naturalEventsTech"),i(s("weatherAlerts"),"weatherAlerts"),i(s("economicCenters"),"economicCenters"),i(a("countries"),"countriesOverlay")])}
      </div>
    `,c=`
      ${l}
      <div class="layer-help-content">
        ${n("financeCore",[i(s("stockExchanges"),"financeExchanges"),i(s("financialCenters"),"financeCenters"),i(s("centralBanks"),"financeCentralBanks"),i(s("commodityHubs"),"financeCommodityHubs")])}
        ${n("infrastructureRisk",[i(s("underseaCables"),"financeCables"),i(s("pipelines"),"financePipelines"),i(s("internetOutages"),"financeOutages"),i(s("cyberThreats"),"financeCyberThreats")])}
        ${n("macroContext",[i(s("economicCenters"),"economicCenters"),i(s("strategicWaterways"),"macroWaterways"),i(s("weatherAlerts"),"weatherAlertsMarket"),i(s("naturalEvents"),"naturalEventsMacro")])}
      </div>
    `,h=`
      ${l}
      <div class="layer-help-content">
        ${n("timeFilter",[i(a("timeRecent"),"timeRecent"),i(a("timeExtended"),"timeExtended")],"timeAffects")}
        ${n("geopolitical",[i(s("conflictZones"),"geoConflicts"),i(s("intelHotspots"),"geoHotspots"),i(a("sanctions"),"geoSanctions"),i(s("protests"),"geoProtests")])}
        ${n("militaryStrategic",[i(s("militaryBases"),"militaryBases"),i(s("nuclearSites"),"militaryNuclear"),i(s("gammaIrradiators"),"militaryIrradiators"),i(s("militaryActivity"),"militaryActivity")])}
        ${n("infrastructure",[i(s("underseaCables"),"infraCablesFull"),i(s("pipelines"),"infraPipelinesFull"),i(s("internetOutages"),"infraOutages"),i(s("aiDataCenters"),"infraDatacentersFull")])}
        ${n("transport",[i(a("shipping"),"transportShipping"),i(s("flightDelays"),"transportDelays")])}
        ${n("naturalEconomic",[i(s("naturalEvents"),"naturalEventsFull"),i(s("weatherAlerts"),"weatherAlerts"),i(s("economicCenters"),"economicCenters")])}
        ${n("labels",[i(a("countries"),"countriesOverlay"),i(s("strategicWaterways"),"waterwaysLabels")])}
      </div>
    `;t.innerHTML=M==="tech"?o:M==="finance"?c:h,(g=t.querySelector(".layer-help-close"))==null||g.addEventListener("click",()=>t.remove());const d=t.querySelector(".layer-help-content");d&&(d.addEventListener("wheel",u=>u.stopPropagation(),{passive:!1}),d.addEventListener("touchmove",u=>u.stopPropagation(),{passive:!1})),setTimeout(()=>{const u=v=>{t.contains(v.target)||(t.remove(),document.removeEventListener("click",u))};document.addEventListener("click",u)},100),this.container.appendChild(t)}syncLayerButtons(){this.container.querySelectorAll(".layer-toggle").forEach(e=>{const t=e.dataset.layer;t&&e.classList.toggle("active",this.state.layers[t])})}createLegend(){const e=document.createElement("div");return e.className="map-legend",M==="tech"?e.innerHTML=`
        <div class="map-legend-item"><span class="legend-dot" style="background:#8b5cf6"></span>${m(r("components.deckgl.layers.techHQs").toUpperCase())}</div>
        <div class="map-legend-item"><span class="legend-dot" style="background:#06b6d4"></span>${m(r("components.deckgl.layers.startupHubs").toUpperCase())}</div>
        <div class="map-legend-item"><span class="legend-dot" style="background:#f59e0b"></span>${m(r("components.deckgl.layers.cloudRegions").toUpperCase())}</div>
        <div class="map-legend-item"><span class="map-legend-icon" style="color:#a855f7">üìÖ</span>${m(r("components.deckgl.layers.techEvents").toUpperCase())}</div>
        <div class="map-legend-item"><span class="map-legend-icon" style="color:#4ecdc4">üíæ</span>${m(r("components.deckgl.layers.aiDataCenters").toUpperCase())}</div>
      `:e.innerHTML=`
        <div class="map-legend-item"><span class="legend-dot high"></span>${m((r("popups.hotspot.levels.high")??"HIGH").toUpperCase())}</div>
        <div class="map-legend-item"><span class="legend-dot elevated"></span>${m((r("popups.hotspot.levels.elevated")??"ELEVATED").toUpperCase())}</div>
        <div class="map-legend-item"><span class="legend-dot low"></span>${m((r("popups.monitoring")??"MONITORING").toUpperCase())}</div>
        <div class="map-legend-item"><span class="map-legend-icon conflict">‚öî</span>${m(r("modals.search.types.conflict").toUpperCase())}</div>
        <div class="map-legend-item"><span class="map-legend-icon earthquake">‚óè</span>${m(r("modals.search.types.earthquake").toUpperCase())}</div>
        <div class="map-legend-item"><span class="map-legend-icon apt">‚ö†</span>APT</div>
      `,e}runHealthCheck(){var a;if(document.hidden)return;const e=this.svg.node();if(!e)return;const t=e.querySelector(".map-base"),s=(t==null?void 0:t.querySelectorAll(".country").length)??0;this.countryFeatures&&this.countryFeatures.length>0&&s===0&&(console.warn("[Map] Health check: Base layer missing countries, initiating recovery"),this.baseRendered=!1,t&&((a=this.baseLayerGroup)==null?void 0:a.node())!==t&&console.warn("[Map] Health check: Stale d3 selection detected"),this.render())}setupZoomHandlers(){let e=!1,t={x:0,y:0},s=0,a={x:0,y:0};const i=n=>n instanceof Element?!!n.closest(".map-controls, .time-slider, .layer-toggles, .map-legend, .layer-help-popup, .map-popup, button, select, input, textarea, a"):!1;this.container.addEventListener("wheel",n=>{if(n.preventDefault(),n.ctrlKey){const l=-n.deltaY*.01;this.state.zoom=Math.max(1,Math.min(10,this.state.zoom+l))}else if(Math.abs(n.deltaX)>Math.abs(n.deltaY)*.5||n.shiftKey){const l=2/this.state.zoom;this.state.pan.x-=n.deltaX*l,this.state.pan.y-=n.deltaY*l}else{const l=n.deltaY>0?-.15:.15;this.state.zoom=Math.max(1,Math.min(10,this.state.zoom+l))}this.applyTransform()},{passive:!1}),this.container.addEventListener("mousedown",n=>{i(n.target)||n.button===0&&(e=!0,t={x:n.clientX,y:n.clientY},this.container.style.cursor="grabbing")}),document.addEventListener("mousemove",n=>{if(!e)return;const l=n.clientX-t.x,o=n.clientY-t.y,c=1/this.state.zoom;this.state.pan.x+=l*c,this.state.pan.y+=o*c,t={x:n.clientX,y:n.clientY},this.applyTransform()}),document.addEventListener("mouseup",()=>{e&&(e=!1,this.container.style.cursor="grab")}),this.container.addEventListener("touchstart",n=>{if(i(n.target))return;const l=n.touches[0],o=n.touches[1];n.touches.length===2&&l&&o?(n.preventDefault(),s=Math.hypot(o.clientX-l.clientX,o.clientY-l.clientY),a={x:(l.clientX+o.clientX)/2,y:(l.clientY+o.clientY)/2}):n.touches.length===1&&l&&(e=!0,t={x:l.clientX,y:l.clientY})},{passive:!1}),this.container.addEventListener("touchmove",n=>{const l=n.touches[0],o=n.touches[1];if(n.touches.length===2&&l&&o){n.preventDefault();const c=Math.hypot(o.clientX-l.clientX,o.clientY-l.clientY),h=c/s;this.state.zoom=Math.max(1,Math.min(10,this.state.zoom*h)),s=c;const d={x:(l.clientX+o.clientX)/2,y:(l.clientY+o.clientY)/2},g=1/this.state.zoom;this.state.pan.x+=(d.x-a.x)*g,this.state.pan.y+=(d.y-a.y)*g,a=d,this.applyTransform()}else if(n.touches.length===1&&e&&l){const c=l.clientX-t.x,h=l.clientY-t.y,d=1/this.state.zoom;this.state.pan.x+=c*d,this.state.pan.y+=h*d,t={x:l.clientX,y:l.clientY},this.applyTransform()}},{passive:!1}),this.container.addEventListener("touchend",()=>{e=!1,s=0}),this.container.style.cursor="grab"}async loadMapData(){try{const e=await fetch(ri.world);if(this.worldData=await e.json(),this.worldData){const t=$o(this.worldData,this.worldData.objects.countries);this.countryFeatures="features"in t?t.features:[t]}this.baseRendered=!1,this.render(),requestAnimationFrame(()=>requestAnimationFrame(()=>this.render()))}catch(e){console.error("Failed to load map data:",e)}}initClusterRenderer(){const e=this.clusterCanvas.getContext("webgl");e&&(this.clusterGl=e)}clearClusterCanvas(){this.clusterGl&&(this.clusterGl.clearColor(0,0,0,0),this.clusterGl.clear(this.clusterGl.COLOR_BUFFER_BIT))}renderClusterLayer(e){this.wrapper.classList.toggle("cluster-active",!1),this.clearClusterCanvas()}scheduleRender(){this.renderScheduled||(this.renderScheduled=!0,requestAnimationFrame(()=>{this.renderScheduled=!1,this.render()}))}render(){var u,v,f,b,k,C,w;const e=performance.now();if(e-this.lastRenderTime<this.MIN_RENDER_INTERVAL_MS){this.scheduleRender();return}this.lastRenderTime=e;const t=this.container.clientWidth,s=this.container.clientHeight;if(t===0||s===0||!this.svg)return;this.svg.attr("viewBox",`0 0 ${t} ${s}`);const a=this.svg.node();if(!a)return;const i=a.querySelector(".map-base"),n=a.querySelector(".map-dynamic"),l=!i||((u=this.baseLayerGroup)==null?void 0:u.node())!==i,o=!n||((v=this.dynamicLayerGroup)==null?void 0:v.node())!==n;if((l||o)&&(a.querySelectorAll(".map-base, .map-dynamic").forEach($=>$.remove()),this.baseLayerGroup=this.svg.append("g").attr("class","map-base"),this.dynamicLayerGroup=this.svg.append("g").attr("class","map-dynamic"),this.baseRendered=!1,console.warn("[Map] Layer groups recreated - baseStale:",l,"dynamicStale:",o)),!((f=this.baseLayerGroup)!=null&&f.node())||!((b=this.dynamicLayerGroup)!=null&&b.node())){console.error("[Map] Failed to create layer groups");return}const c=this.baseLayerGroup.node().querySelectorAll(".country").length,h=!this.baseRendered||c===0||t!==this.baseWidth||s!==this.baseHeight;if(h&&c===0&&this.baseRendered&&console.warn("[Map] Base layer missing countries, forcing re-render. countryFeatures:",((k=this.countryFeatures)==null?void 0:k.length)??"null"),h){this.baseWidth=t,this.baseHeight=s;const $=this.baseLayerGroup.node();for(;$.firstChild;)$.removeChild($.firstChild);this.baseLayerGroup.append("rect").attr("x",-t).attr("y",-s).attr("width",t*3).attr("height",s*3).attr("fill",T("--map-bg")),this.renderGrid(this.baseLayerGroup,t,s);const P=this.getProjection(t,s),E=Co().projection(P);this.renderGraticule(this.baseLayerGroup,E),this.renderCountries(this.baseLayerGroup,E),this.baseRendered=!0}const d=this.dynamicLayerGroup.node();for(;d.firstChild;)d.removeChild(d.firstChild);this.dynamicLayerGroup.append("g").attr("class","overlays-svg");const g=this.getProjection(t,s);if(this.updateCountryFills(),this.state.layers.cables&&this.renderCables(g),this.state.layers.pipelines&&this.renderPipelines(g),this.state.layers.conflicts&&this.renderConflicts(g),this.state.layers.ais&&this.renderAisDensity(g),this.renderClusterLayer(g),this.renderOverlays(g),this.baseRendered&&this.countryFeatures&&this.countryFeatures.length>0&&(((w=(C=this.baseLayerGroup)==null?void 0:C.node())==null?void 0:w.querySelectorAll(".country").length)??0)===0){console.error("[Map] POST-RENDER: Countries failed to render despite baseRendered=true. Forcing full rebuild."),this.baseRendered=!1,requestAnimationFrame(()=>this.render());return}this.applyTransform()}renderGrid(e,t,s,a=0){const i=e.append("g").attr("class","grid");for(let n=0;n<t;n+=20)i.append("line").attr("x1",n).attr("y1",a).attr("x2",n).attr("y2",a+s).attr("stroke",T("--map-grid")).attr("stroke-width",.5);for(let n=a;n<a+s;n+=20)i.append("line").attr("x1",0).attr("y1",n).attr("x2",t).attr("y2",n).attr("stroke",T("--map-grid")).attr("stroke-width",.5)}getProjection(e,t){const l=e/(2*Math.PI),o=t/(128*Math.PI/180),c=Math.min(l,o);return wo().scale(c).center([0,8]).translate([e/2,t/2])}renderGraticule(e,t){const s=ko();e.append("path").datum(s()).attr("class","graticule").attr("d",t).attr("fill","none").attr("stroke",T("--map-stroke")).attr("stroke-width",.4)}renderCountries(e,t){this.countryFeatures&&e.selectAll(".country").data(this.countryFeatures).enter().append("path").attr("class","country").attr("d",t).attr("fill",T("--map-country")).attr("stroke",T("--map-stroke")).attr("stroke-width",.7)}renderCables(e){if(!this.dynamicLayerGroup)return;const t=this.dynamicLayerGroup.append("g").attr("class","cables");ce.forEach(s=>{const a=Vs().x(g=>{var u;return((u=e(g))==null?void 0:u[0])??0}).y(g=>{var u;return((u=e(g))==null?void 0:u[1])??0}).curve(Ws),i=this.highlightedAssets.cable.has(s.id),n=this.getCableAdvisory(s.id),l=n?`cable-${n.severity}`:"",o=this.healthByCableId[s.id],c=(o==null?void 0:o.status)==="fault"?"cable-health-fault":(o==null?void 0:o.status)==="degraded"?"cable-health-degraded":"",h=i?"asset-highlight asset-highlight-cable":"",d=t.append("path").attr("class",`cable-path ${l} ${c} ${h}`.trim()).attr("d",a(s.points));d.append("title").text(s.name),d.on("click",g=>{g.stopPropagation();const u=this.container.getBoundingClientRect();this.popup.show({type:"cable",data:s,x:g.clientX-u.left,y:g.clientY-u.top})})})}renderPipelines(e){if(!this.dynamicLayerGroup)return;const t=this.dynamicLayerGroup.append("g").attr("class","pipelines");Xe.forEach(s=>{const a=Vs().x(h=>{var d;return((d=e(h))==null?void 0:d[0])??0}).y(h=>{var d;return((d=e(h))==null?void 0:d[1])??0}).curve(Ws.tension(.5)),i=ga[s.type]||T("--text-dim"),n=.85,l=s.status==="construction"?"4,2":"none",o=this.highlightedAssets.pipeline.has(s.id),c=t.append("path").attr("class",`pipeline-path pipeline-${s.type} pipeline-${s.status}${o?" asset-highlight asset-highlight-pipeline":""}`).attr("d",a(s.points)).attr("fill","none").attr("stroke",i).attr("stroke-width",2.5).attr("stroke-opacity",n).attr("stroke-linecap","round").attr("stroke-linejoin","round");l!=="none"&&c.attr("stroke-dasharray",l),c.append("title").text(`${s.name} (${s.type.toUpperCase()})`),c.on("click",h=>{h.stopPropagation();const d=this.container.getBoundingClientRect();this.popup.show({type:"pipeline",data:s,x:h.clientX-d.left,y:h.clientY-d.top})})})}renderConflicts(e){if(!this.dynamicLayerGroup)return;const t=this.dynamicLayerGroup.append("g").attr("class","conflicts");Le.forEach(s=>{const a=s.coords.map(i=>e(i)).filter(i=>i!==null);a.length>0&&t.append("polygon").attr("class","conflict-zone").attr("points",a.map(i=>i.join(",")).join(" "))})}updateCountryFills(){if(!this.baseLayerGroup||!this.countryFeatures)return;const e={severe:"rgba(255, 0, 0, 0.35)",high:"rgba(255, 100, 0, 0.25)",moderate:"rgba(255, 200, 0, 0.2)"},t=T("--map-country"),s=this.state.layers.sanctions;this.baseLayerGroup.selectAll(".country").each(function(a){const i=Ye(this),n=a;if(!s){i.attr("fill",t);return}if((n==null?void 0:n.id)!==void 0&&ss[n.id]){const l=ss[n.id];if(l){i.attr("fill",e[l]||t);return}}i.attr("fill",t)})}clusterMarkers(e,t,s,a){const i=[],n=new Set;for(let l=0;l<e.length;l++){if(n.has(l))continue;const o=e[l];if(!Number.isFinite(o.lat)||!Number.isFinite(o.lon))continue;const c=t([o.lon,o.lat]);if(!c||!Number.isFinite(c[0])||!Number.isFinite(c[1]))continue;const h=[o];n.add(l);const d=a==null?void 0:a(o);for(let C=l+1;C<e.length;C++){if(n.has(C))continue;const w=e[C];if(a&&a(w)!==d||!Number.isFinite(w.lat)||!Number.isFinite(w.lon))continue;const $=t([w.lon,w.lat]);if(!$||!Number.isFinite($[0])||!Number.isFinite($[1]))continue;const P=c[0]-$[0],E=c[1]-$[1];Math.sqrt(P*P+E*E)<=s&&(h.push(w),n.add(C))}let g=0,u=0;for(const C of h)g+=C.lat,u+=C.lon;const v=g/h.length,f=u/h.length,b=t([f,v]),k=b&&Number.isFinite(b[0])&&Number.isFinite(b[1])?b:c;i.push({items:h,center:[f,v],pos:k})}return i}renderOverlays(e){if(this.overlays.innerHTML="",this.state.layers.waterways&&this.renderWaterways(e),this.state.layers.ais&&(this.renderAisDisruptions(e),this.renderPorts(e)),M!=="tech"&&this.renderAPTMarkers(e),this.state.layers.nuclear&&Ne.forEach(s=>{const a=e([s.lon,s.lat]);if(!a)return;const i=document.createElement("div"),n=this.highlightedAssets.nuclear.has(s.id);i.className=`nuclear-marker ${s.status}${n?" asset-highlight asset-highlight-nuclear":""}`,i.style.left=`${a[0]}px`,i.style.top=`${a[1]}px`,i.title=`${s.name} (${s.type})`,i.addEventListener("click",l=>{l.stopPropagation();const o=this.container.getBoundingClientRect();this.popup.show({type:"nuclear",data:s,x:l.clientX-o.left,y:l.clientY-o.top})}),this.overlays.appendChild(i)}),this.state.layers.irradiators&&Qe.forEach(s=>{const a=e([s.lon,s.lat]);if(!a)return;const i=document.createElement("div");i.className="irradiator-marker",i.style.left=`${a[0]}px`,i.style.top=`${a[1]}px`,i.title=`${s.city}, ${s.country}`,i.addEventListener("click",n=>{n.stopPropagation();const l=this.container.getBoundingClientRect();this.popup.show({type:"irradiator",data:s,x:n.clientX-l.left,y:n.clientY-l.top})}),this.overlays.appendChild(i)}),this.state.layers.conflicts&&Le.forEach(s=>{const a=e(s.center);if(!a)return;const i=document.createElement("div");i.className="conflict-click-area",i.style.left=`${a[0]-40}px`,i.style.top=`${a[1]-20}px`,i.style.width="80px",i.style.height="40px",i.style.cursor="pointer",i.addEventListener("click",n=>{n.stopPropagation();const l=this.container.getBoundingClientRect();this.popup.show({type:"conflict",data:s,x:n.clientX-l.left,y:n.clientY-l.top})}),this.overlays.appendChild(i)}),this.state.layers.hotspots&&this.hotspots.forEach(s=>{const a=e([s.lon,s.lat]);if(!a)return;const i=document.createElement("div");i.className="hotspot",i.style.left=`${a[0]}px`,i.style.top=`${a[1]}px`,i.innerHTML=`
          <div class="hotspot-marker ${m(s.level||"low")}"></div>
        `,i.addEventListener("click",n=>{var c;n.stopPropagation();const l=this.getRelatedNews(s),o=this.container.getBoundingClientRect();this.popup.show({type:"hotspot",data:s,relatedNews:l,x:n.clientX-o.left,y:n.clientY-o.top}),this.popup.loadHotspotGdeltContext(s),(c=this.onHotspotClick)==null||c.call(this,s)}),this.overlays.appendChild(i)}),this.state.layers.bases&&De.forEach(s=>{const a=e([s.lon,s.lat]);if(!a)return;const i=document.createElement("div"),n=this.highlightedAssets.base.has(s.id);i.className=`base-marker ${s.type}${n?" asset-highlight asset-highlight-base":""}`,i.style.left=`${a[0]}px`,i.style.top=`${a[1]}px`;const l=document.createElement("div");l.className="base-label",l.textContent=s.name,i.appendChild(l),i.addEventListener("click",o=>{o.stopPropagation();const c=this.container.getBoundingClientRect();this.popup.show({type:"base",data:s,x:o.clientX-c.left,y:o.clientY-c.top})}),this.overlays.appendChild(i)}),this.state.layers.natural){console.log("[Map] Rendering earthquakes. Total:",this.earthquakes.length,"Layer enabled:",this.state.layers.natural);const s=this.state.timeRange==="all"?this.earthquakes:this.earthquakes.filter(i=>i.occurredAt>=Date.now()-this.getTimeRangeMs());console.log("[Map] After time filter:",s.length,"earthquakes. TimeRange:",this.state.timeRange);let a=0;s.forEach(i=>{var h,d,g,u;const n=e([((h=i.location)==null?void 0:h.longitude)??0,((d=i.location)==null?void 0:d.latitude)??0]);if(!n){console.log("[Map] Earthquake position null for:",i.place,(g=i.location)==null?void 0:g.longitude,(u=i.location)==null?void 0:u.latitude);return}a++;const l=Math.max(8,i.magnitude*3),o=document.createElement("div");o.className="earthquake-marker",o.style.left=`${n[0]}px`,o.style.top=`${n[1]}px`,o.style.width=`${l}px`,o.style.height=`${l}px`,o.title=`M${i.magnitude.toFixed(1)} - ${i.place}`;const c=document.createElement("div");c.className="earthquake-label",c.textContent=`M${i.magnitude.toFixed(1)}`,o.appendChild(c),o.addEventListener("click",v=>{v.stopPropagation();const f=this.container.getBoundingClientRect();this.popup.show({type:"earthquake",data:i,x:v.clientX-f.left,y:v.clientY-f.top})}),this.overlays.appendChild(o)}),console.log("[Map] Actually rendered",a,"earthquake markers")}this.state.layers.economic&&ma.forEach(s=>{const a=e([s.lon,s.lat]);if(!a)return;const i=document.createElement("div");i.className=`economic-marker ${s.type}`,i.style.left=`${a[0]}px`,i.style.top=`${a[1]}px`;const n=document.createElement("div");n.className="economic-icon",n.textContent=s.type==="exchange"?"üìà":s.type==="central-bank"?"üèõ":"üí∞",i.appendChild(n),i.title=s.name,i.addEventListener("click",l=>{l.stopPropagation();const o=this.container.getBoundingClientRect();this.popup.show({type:"economic",data:s,x:l.clientX-o.left,y:l.clientY-o.top})}),this.overlays.appendChild(i)}),this.state.layers.weather&&this.weatherAlerts.forEach(s=>{if(!s.centroid)return;const a=e(s.centroid);if(!a)return;const i=document.createElement("div");i.className=`weather-marker ${s.severity.toLowerCase()}`,i.style.left=`${a[0]}px`,i.style.top=`${a[1]}px`,i.style.borderColor=li(s.severity);const n=document.createElement("div");n.className="weather-icon",n.textContent="‚ö†",i.appendChild(n),i.addEventListener("click",l=>{l.stopPropagation();const o=this.container.getBoundingClientRect();this.popup.show({type:"weather",data:s,x:l.clientX-o.left,y:l.clientY-o.top})}),this.overlays.appendChild(i)}),this.state.layers.outages&&this.outages.forEach(s=>{const a=e([s.lon,s.lat]);if(!a)return;const i=document.createElement("div");i.className=`outage-marker ${s.severity}`,i.style.left=`${a[0]}px`,i.style.top=`${a[1]}px`;const n=document.createElement("div");n.className="outage-icon",n.textContent="üì°",i.appendChild(n);const l=document.createElement("div");l.className="outage-label",l.textContent=s.country,i.appendChild(l),i.addEventListener("click",o=>{o.stopPropagation();const c=this.container.getBoundingClientRect();this.popup.show({type:"outage",data:s,x:o.clientX-c.left,y:o.clientY-c.top})}),this.overlays.appendChild(i)}),this.state.layers.cables&&(this.cableAdvisories.forEach(s=>{const a=e([s.lon,s.lat]);if(!a)return;const i=document.createElement("div");i.className=`cable-advisory-marker ${s.severity}`,i.style.left=`${a[0]}px`,i.style.top=`${a[1]}px`;const n=document.createElement("div");n.className="cable-advisory-icon",n.textContent=s.severity==="fault"?"‚ö°":"‚ö†",i.appendChild(n);const l=document.createElement("div");l.className="cable-advisory-label",l.textContent=this.getCableName(s.cableId),i.appendChild(l),i.addEventListener("click",o=>{o.stopPropagation();const c=this.container.getBoundingClientRect();this.popup.show({type:"cable-advisory",data:s,x:o.clientX-c.left,y:o.clientY-c.top})}),this.overlays.appendChild(i)}),this.repairShips.forEach(s=>{const a=e([s.lon,s.lat]);if(!a)return;const i=document.createElement("div");i.className=`repair-ship-marker ${s.status}`,i.style.left=`${a[0]}px`,i.style.top=`${a[1]}px`;const n=document.createElement("div");n.className="repair-ship-icon",n.textContent="üö¢",i.appendChild(n);const l=document.createElement("div");l.className="repair-ship-label",l.textContent=s.name,i.appendChild(l),i.addEventListener("click",o=>{o.stopPropagation();const c=this.container.getBoundingClientRect();this.popup.show({type:"repair-ship",data:s,x:o.clientX-c.left,y:o.clientY-c.top})}),this.overlays.appendChild(i)}));const t=1e4;if(this.state.layers.datacenters&&Se.filter(s=>(s.chipCount||0)>=t).forEach(s=>{const a=e([s.lon,s.lat]);if(!a)return;const i=document.createElement("div"),n=this.highlightedAssets.datacenter.has(s.id);i.className=`datacenter-marker ${s.status}${n?" asset-highlight asset-highlight-datacenter":""}`,i.style.left=`${a[0]}px`,i.style.top=`${a[1]}px`;const l=document.createElement("div");l.className="datacenter-icon",l.textContent="üñ•Ô∏è",i.appendChild(l),i.addEventListener("click",o=>{o.stopPropagation();const c=this.container.getBoundingClientRect();this.popup.show({type:"datacenter",data:s,x:o.clientX-c.left,y:o.clientY-c.top})}),this.overlays.appendChild(i)}),this.state.layers.spaceports&&ya.forEach(s=>{const a=e([s.lon,s.lat]);if(!a)return;const i=document.createElement("div");i.className=`spaceport-marker ${s.status}`,i.style.left=`${a[0]}px`,i.style.top=`${a[1]}px`;const n=document.createElement("div");n.className="spaceport-icon",n.textContent="üöÄ",i.appendChild(n);const l=document.createElement("div");l.className="spaceport-label",l.textContent=s.name,i.appendChild(l),i.addEventListener("click",o=>{o.stopPropagation();const c=this.container.getBoundingClientRect();this.popup.show({type:"spaceport",data:s,x:o.clientX-c.left,y:o.clientY-c.top})}),this.overlays.appendChild(i)}),this.state.layers.minerals&&va.forEach(s=>{const a=e([s.lon,s.lat]);if(!a)return;const i=document.createElement("div");i.className=`mineral-marker ${s.status}`,i.style.left=`${a[0]}px`,i.style.top=`${a[1]}px`;const n=document.createElement("div");n.className="mineral-icon",n.textContent=s.mineral==="Lithium"?"üîã":s.mineral==="Rare Earths"?"üß≤":"üíé",i.appendChild(n);const l=document.createElement("div");l.className="mineral-label",l.textContent=`${s.mineral} - ${s.name}`,i.appendChild(l),i.addEventListener("click",o=>{o.stopPropagation();const c=this.container.getBoundingClientRect();this.popup.show({type:"mineral",data:s,x:o.clientX-c.left,y:o.clientY-c.top})}),this.overlays.appendChild(i)}),this.state.layers.startupHubs&&fa.forEach(s=>{const a=e([s.lon,s.lat]);if(!a)return;const i=document.createElement("div");i.className=`startup-hub-marker ${s.tier}`,i.style.left=`${a[0]}px`,i.style.top=`${a[1]}px`;const n=document.createElement("div");if(n.className="startup-hub-icon",n.textContent=s.tier==="mega"?"ü¶Ñ":s.tier==="major"?"üöÄ":"üí°",i.appendChild(n),this.state.zoom>=2||s.tier==="mega"){const l=document.createElement("div");l.className="startup-hub-label",l.textContent=s.name,i.appendChild(l)}i.addEventListener("click",l=>{l.stopPropagation();const o=this.container.getBoundingClientRect();this.popup.show({type:"startupHub",data:s,x:l.clientX-o.left,y:l.clientY-o.top})}),this.overlays.appendChild(i)}),this.state.layers.cloudRegions&&ba.forEach(s=>{const a=e([s.lon,s.lat]);if(!a)return;const i=document.createElement("div");i.className=`cloud-region-marker ${s.provider}`,i.style.left=`${a[0]}px`,i.style.top=`${a[1]}px`;const n=document.createElement("div");n.className="cloud-region-icon";const l={aws:"üü†",gcp:"üîµ",azure:"üü£",cloudflare:"üü°"};if(n.textContent=l[s.provider]||"‚òÅÔ∏è",i.appendChild(n),this.state.zoom>=3){const o=document.createElement("div");o.className="cloud-region-label",o.textContent=s.provider.toUpperCase(),i.appendChild(o)}i.addEventListener("click",o=>{o.stopPropagation();const c=this.container.getBoundingClientRect();this.popup.show({type:"cloudRegion",data:s,x:o.clientX-c.left,y:o.clientY-c.top})}),this.overlays.appendChild(i)}),this.state.layers.techHQs){const s=this.state.zoom>=4?15:this.state.zoom>=3?25:40;this.clusterMarkers(We,e,s,i=>i.city).forEach(i=>{if(i.items.length===0)return;const n=document.createElement("div"),l=i.items.length>1,o=i.items[0];n.className=`tech-hq-marker ${o.type} ${l?"cluster":""}`,n.style.left=`${i.pos[0]}px`,n.style.top=`${i.pos[1]}px`;const c=document.createElement("div");if(c.className="tech-hq-icon",l){const h=i.items.filter(u=>u.type==="unicorn").length,d=i.items.filter(u=>u.type==="faang").length;c.textContent=d>0?"üèõÔ∏è":h>0?"ü¶Ñ":"üè¢";const g=document.createElement("div");g.className="cluster-badge",g.textContent=String(i.items.length),n.appendChild(g),n.title=i.items.map(u=>u.company).join(", ")}else c.textContent=o.type==="faang"?"üèõÔ∏è":o.type==="unicorn"?"ü¶Ñ":"üè¢";if(n.appendChild(c),!l&&(this.state.zoom>=3||o.type==="faang")){const h=document.createElement("div");h.className="tech-hq-label",h.textContent=o.company,n.appendChild(h)}n.addEventListener("click",h=>{h.stopPropagation();const d=this.container.getBoundingClientRect();l?this.popup.show({type:"techHQCluster",data:{items:i.items,city:o.city,country:o.country},x:h.clientX-d.left,y:h.clientY-d.top}):this.popup.show({type:"techHQ",data:o,x:h.clientX-d.left,y:h.clientY-d.top})}),this.overlays.appendChild(n)})}if(this.state.layers.accelerators&&qt.forEach(s=>{const a=e([s.lon,s.lat]);if(!a)return;const i=document.createElement("div");i.className=`accelerator-marker ${s.type}`,i.style.left=`${a[0]}px`,i.style.top=`${a[1]}px`;const n=document.createElement("div");if(n.className="accelerator-icon",n.textContent=s.type==="accelerator"?"üéØ":s.type==="incubator"?"üî¨":"üé®",i.appendChild(n),this.state.zoom>=3){const l=document.createElement("div");l.className="accelerator-label",l.textContent=s.name,i.appendChild(l)}i.addEventListener("click",l=>{l.stopPropagation();const o=this.container.getBoundingClientRect();this.popup.show({type:"accelerator",data:s,x:l.clientX-o.left,y:l.clientY-o.top})}),this.overlays.appendChild(i)}),this.state.layers.techEvents&&this.techEvents.length>0){const s=this.container.clientWidth,a=this.container.clientHeight,i=this.techEvents.map(o=>({...o,lon:o.lng})).filter(o=>{const c=e([o.lon,o.lat]);return c&&c[0]>=0&&c[0]<=s&&c[1]>=0&&c[1]<=a}),n=this.state.zoom>=4?15:this.state.zoom>=3?25:40;this.clusterMarkers(i,e,n,o=>o.location).forEach(o=>{if(o.items.length===0)return;const c=document.createElement("div"),h=o.items.length>1,d=o.items[0],g=o.items.some(u=>u.daysUntil<=14);if(c.className=`tech-event-marker ${g?"upcoming-soon":""} ${h?"cluster":""}`,c.style.left=`${o.pos[0]}px`,c.style.top=`${o.pos[1]}px`,h){const u=document.createElement("div");u.className="cluster-badge",u.textContent=String(o.items.length),c.appendChild(u),c.title=o.items.map(v=>v.title).join(", ")}c.addEventListener("click",u=>{u.stopPropagation();const v=this.container.getBoundingClientRect();h?this.popup.show({type:"techEventCluster",data:{items:o.items,location:d.location,country:d.country},x:u.clientX-v.left,y:u.clientY-v.top}):this.popup.show({type:"techEvent",data:d,x:u.clientX-v.left,y:u.clientY-v.top})}),this.overlays.appendChild(c)})}if(this.state.layers.stockExchanges&&jt.forEach(s=>{const a=e([s.lon,s.lat]);if(!a||!Number.isFinite(a[0])||!Number.isFinite(a[1]))return;const i=s.tier==="mega"?"üèõÔ∏è":s.tier==="major"?"üìä":"üìà",n=document.createElement("div");if(n.className=`map-marker exchange-marker tier-${s.tier}`,n.style.left=`${a[0]}px`,n.style.top=`${a[1]}px`,n.style.zIndex=s.tier==="mega"?"50":"40",n.textContent=i,n.title=`${s.shortName} (${s.city})`,this.state.zoom>=2&&s.tier==="mega"||this.state.zoom>=3){const l=document.createElement("span");l.className="marker-label",l.textContent=s.shortName,n.appendChild(l)}n.addEventListener("click",l=>{l.stopPropagation();const o=this.container.getBoundingClientRect();this.popup.show({type:"stockExchange",data:s,x:l.clientX-o.left,y:l.clientY-o.top})}),this.overlays.appendChild(n)}),this.state.layers.financialCenters&&Vt.forEach(s=>{const a=e([s.lon,s.lat]);if(!a||!Number.isFinite(a[0])||!Number.isFinite(a[1]))return;const i=s.type==="global"?"üí∞":s.type==="regional"?"üè¶":"üèùÔ∏è",n=document.createElement("div");if(n.className=`map-marker financial-center-marker type-${s.type}`,n.style.left=`${a[0]}px`,n.style.top=`${a[1]}px`,n.style.zIndex=s.type==="global"?"45":"35",n.textContent=i,n.title=`${s.name} Financial Center`,this.state.zoom>=2&&s.type==="global"||this.state.zoom>=3){const l=document.createElement("span");l.className="marker-label",l.textContent=s.name,n.appendChild(l)}n.addEventListener("click",l=>{l.stopPropagation();const o=this.container.getBoundingClientRect();this.popup.show({type:"financialCenter",data:s,x:l.clientX-o.left,y:l.clientY-o.top})}),this.overlays.appendChild(n)}),this.state.layers.centralBanks&&Wt.forEach(s=>{const a=e([s.lon,s.lat]);if(!a||!Number.isFinite(a[0])||!Number.isFinite(a[1]))return;const i=s.type==="supranational"?"üåê":s.type==="major"?"üèõÔ∏è":"üè¶",n=document.createElement("div");if(n.className=`map-marker central-bank-marker type-${s.type}`,n.style.left=`${a[0]}px`,n.style.top=`${a[1]}px`,n.style.zIndex=s.type==="supranational"?"48":s.type==="major"?"42":"38",n.textContent=i,n.title=`${s.shortName} - ${s.name}`,this.state.zoom>=2&&(s.type==="major"||s.type==="supranational")||this.state.zoom>=3){const l=document.createElement("span");l.className="marker-label",l.textContent=s.shortName,n.appendChild(l)}n.addEventListener("click",l=>{l.stopPropagation();const o=this.container.getBoundingClientRect();this.popup.show({type:"centralBank",data:s,x:l.clientX-o.left,y:l.clientY-o.top})}),this.overlays.appendChild(n)}),this.state.layers.commodityHubs&&Yt.forEach(s=>{const a=e([s.lon,s.lat]);if(!a||!Number.isFinite(a[0])||!Number.isFinite(a[1]))return;const i=s.type==="exchange"?"üì¶":s.type==="port"?"üö¢":"‚õΩ",n=document.createElement("div");if(n.className=`map-marker commodity-hub-marker type-${s.type}`,n.style.left=`${a[0]}px`,n.style.top=`${a[1]}px`,n.style.zIndex="38",n.textContent=i,n.title=`${s.name} (${s.city})`,this.state.zoom>=3){const l=document.createElement("span");l.className="marker-label",l.textContent=s.name,n.appendChild(l)}n.addEventListener("click",l=>{l.stopPropagation();const o=this.container.getBoundingClientRect();this.popup.show({type:"commodityHub",data:s,x:l.clientX-o.left,y:l.clientY-o.top})}),this.overlays.appendChild(n)}),M==="tech"&&this.techActivities.length>0&&this.techActivities.forEach(s=>{const a=e([s.lon,s.lat]);if(!a||s.newsCount===0)return;const i=document.createElement("div");if(i.className=`tech-activity-marker ${s.activityLevel}`,i.style.left=`${a[0]}px`,i.style.top=`${a[1]}px`,i.style.zIndex=s.activityLevel==="high"?"60":s.activityLevel==="elevated"?"50":"40",i.title=`${s.city}: ${s.newsCount} stories`,i.addEventListener("click",n=>{var o;n.stopPropagation(),(o=this.onTechHubClick)==null||o.call(this,s);const l=this.container.getBoundingClientRect();this.popup.show({type:"techActivity",data:s,x:n.clientX-l.left,y:n.clientY-l.top})}),this.overlays.appendChild(i),(s.activityLevel==="high"||s.activityLevel==="elevated"&&this.state.zoom>=2)&&this.state.zoom>=1.5){const n=document.createElement("div");n.className="tech-activity-label",n.textContent=s.city,n.style.left=`${a[0]}px`,n.style.top=`${a[1]+14}px`,this.overlays.appendChild(n)}}),M==="full"&&this.geoActivities.length>0&&this.geoActivities.forEach(s=>{const a=e([s.lon,s.lat]);if(!a||s.newsCount===0)return;const i=document.createElement("div");i.className=`geo-activity-marker ${s.activityLevel}`,i.style.left=`${a[0]}px`,i.style.top=`${a[1]}px`,i.style.zIndex=s.activityLevel==="high"?"60":s.activityLevel==="elevated"?"50":"40",i.title=`${s.name}: ${s.newsCount} stories`,i.addEventListener("click",n=>{var o;n.stopPropagation(),(o=this.onGeoHubClick)==null||o.call(this,s);const l=this.container.getBoundingClientRect();this.popup.show({type:"geoActivity",data:s,x:n.clientX-l.left,y:n.clientY-l.top})}),this.overlays.appendChild(i)}),this.state.layers.protests){const s=this.protests.filter(n=>n.eventType==="riot"||n.severity==="high"),a=this.state.zoom>=4?12:this.state.zoom>=3?20:35;this.clusterMarkers(s,e,a,n=>n.country).forEach(n=>{if(n.items.length===0)return;const l=document.createElement("div"),o=n.items.length>1,c=n.items[0],h=n.items.some(u=>u.eventType==="riot"),d=n.items.some(u=>u.severity==="high");l.className=`protest-marker ${d?"high":c.severity} ${h?"riot":c.eventType} ${o?"cluster":""}`,l.style.left=`${n.pos[0]}px`,l.style.top=`${n.pos[1]}px`;const g=document.createElement("div");if(g.className="protest-icon",g.textContent=h?"üî•":c.eventType==="strike"?"‚úä":"üì¢",l.appendChild(g),o){const u=document.createElement("div");u.className="cluster-badge",u.textContent=String(n.items.length),l.appendChild(u),l.title=`${c.country}: ${n.items.length} ${r("popups.events")}`}else l.title=`${c.city||c.country} - ${c.eventType} (${c.severity})`,c.validated&&l.classList.add("validated");l.addEventListener("click",u=>{u.stopPropagation();const v=this.container.getBoundingClientRect();o?this.popup.show({type:"protestCluster",data:{items:n.items,country:c.country},x:u.clientX-v.left,y:u.clientY-v.top}):this.popup.show({type:"protest",data:c,x:u.clientX-v.left,y:u.clientY-v.top})}),this.overlays.appendChild(l)})}this.state.layers.flights&&this.flightDelays.forEach(s=>{const a=e([s.lon,s.lat]);if(!a)return;const i=document.createElement("div");i.className=`flight-delay-marker ${s.severity}`,i.style.left=`${a[0]}px`,i.style.top=`${a[1]}px`;const n=document.createElement("div");if(n.className="flight-delay-icon",n.textContent=s.delayType==="ground_stop"?"üõë":s.severity==="severe"?"‚úàÔ∏è":"üõ´",i.appendChild(n),this.state.zoom>=3){const l=document.createElement("div");l.className="flight-delay-label",l.textContent=`${s.iata} ${s.avgDelayMinutes>0?`+${s.avgDelayMinutes}m`:""}`,i.appendChild(l)}i.addEventListener("click",l=>{l.stopPropagation();const o=this.container.getBoundingClientRect();this.popup.show({type:"flight",data:s,x:l.clientX-o.left,y:l.clientY-o.top})}),this.overlays.appendChild(i)}),this.state.layers.military&&(this.militaryFlights.forEach(s=>{var l;const a=e([s.lon,s.lat]);if(!a)return;const i=document.createElement("div");i.className=`military-flight-marker ${s.operator} ${s.aircraftType}${s.isInteresting?" interesting":""}`,i.style.left=`${a[0]}px`,i.style.top=`${a[1]}px`;const n=document.createElement("div");if(n.className=`military-flight-icon ${s.aircraftType}`,n.style.transform=`rotate(${s.heading}deg)`,i.appendChild(n),this.state.zoom>=3){const o=document.createElement("div");o.className="military-flight-label",o.textContent=s.callsign,i.appendChild(o)}if(s.altitude>0){const o=document.createElement("div");o.className="military-flight-altitude",o.textContent=`FL${Math.round(s.altitude/100)}`,i.appendChild(o)}if(i.addEventListener("click",o=>{o.stopPropagation();const c=this.container.getBoundingClientRect();this.popup.show({type:"militaryFlight",data:s,x:o.clientX-c.left,y:o.clientY-c.top})}),this.overlays.appendChild(i),s.track&&s.track.length>1&&this.state.zoom>=2){const o=document.createElementNS("http://www.w3.org/2000/svg","polyline"),c=s.track.map(h=>{const d=e([h[1],h[0]]);return d?`${d[0]},${d[1]}`:null}).filter(Boolean).join(" ");c&&(o.setAttribute("points",c),o.setAttribute("class",`military-flight-track ${s.operator}`),o.setAttribute("fill","none"),o.setAttribute("stroke-width","1.5"),o.setAttribute("stroke-dasharray","4,2"),(l=this.dynamicLayerGroup)==null||l.select(".overlays-svg").append(()=>o))}}),this.militaryFlightClusters.forEach(s=>{const a=e([s.lon,s.lat]);if(!a)return;const i=document.createElement("div");i.className=`military-cluster-marker flight-cluster ${s.activityType||"unknown"}`,i.style.left=`${a[0]}px`,i.style.top=`${a[1]}px`;const n=document.createElement("div");n.className="cluster-count",n.textContent=String(s.flightCount),i.appendChild(n);const l=document.createElement("div");l.className="cluster-label",l.textContent=s.name,i.appendChild(l),i.addEventListener("click",o=>{o.stopPropagation();const c=this.container.getBoundingClientRect();this.popup.show({type:"militaryFlightCluster",data:s,x:o.clientX-c.left,y:o.clientY-c.top})}),this.overlays.appendChild(i)}),this.militaryVessels.forEach(s=>{var l;const a=e([s.lon,s.lat]);if(!a)return;const i=document.createElement("div");i.className=`military-vessel-marker ${s.operator} ${s.vesselType}${s.isDark?" dark-vessel":""}${s.isInteresting?" interesting":""}`,i.style.left=`${a[0]}px`,i.style.top=`${a[1]}px`;const n=document.createElement("div");if(n.className=`military-vessel-icon ${s.vesselType}`,n.style.transform=`rotate(${s.heading}deg)`,i.appendChild(n),s.isDark){const o=document.createElement("div");o.className="dark-vessel-indicator",o.textContent="‚ö†Ô∏è",o.title="AIS Signal Lost",i.appendChild(o)}if(this.state.zoom>=3){const o=document.createElement("div");o.className="military-vessel-label",o.textContent=s.name,i.appendChild(o)}if(i.addEventListener("click",o=>{o.stopPropagation();const c=this.container.getBoundingClientRect();this.popup.show({type:"militaryVessel",data:s,x:o.clientX-c.left,y:o.clientY-c.top})}),this.overlays.appendChild(i),s.track&&s.track.length>1&&this.state.zoom>=2){const o=document.createElementNS("http://www.w3.org/2000/svg","polyline"),c=s.track.map(h=>{const d=e([h[1],h[0]]);return d?`${d[0]},${d[1]}`:null}).filter(Boolean).join(" ");c&&(o.setAttribute("points",c),o.setAttribute("class",`military-vessel-track ${s.operator}`),o.setAttribute("fill","none"),o.setAttribute("stroke-width","2"),(l=this.dynamicLayerGroup)==null||l.select(".overlays-svg").append(()=>o))}}),this.militaryVesselClusters.forEach(s=>{const a=e([s.lon,s.lat]);if(!a)return;const i=document.createElement("div");i.className=`military-cluster-marker vessel-cluster ${s.activityType||"unknown"}`,i.style.left=`${a[0]}px`,i.style.top=`${a[1]}px`;const n=document.createElement("div");n.className="cluster-count",n.textContent=String(s.vesselCount),i.appendChild(n);const l=document.createElement("div");l.className="cluster-label",l.textContent=s.name,i.appendChild(l),i.addEventListener("click",o=>{o.stopPropagation();const c=this.container.getBoundingClientRect();this.popup.show({type:"militaryVesselCluster",data:s,x:o.clientX-c.left,y:o.clientY-c.top})}),this.overlays.appendChild(i)})),this.state.layers.natural&&this.naturalEvents.forEach(s=>{const a=e([s.lon,s.lat]);if(!a)return;const i=document.createElement("div");i.className=`nat-event-marker ${s.category}`,i.style.left=`${a[0]}px`,i.style.top=`${a[1]}px`;const n=document.createElement("div");if(n.className="nat-event-icon",n.textContent=ha(s.category),i.appendChild(n),this.state.zoom>=2){const l=document.createElement("div");l.className="nat-event-label",l.textContent=s.title.length>25?s.title.slice(0,25)+"‚Ä¶":s.title,i.appendChild(l)}if(s.magnitude){const l=document.createElement("div");l.className="nat-event-magnitude",l.textContent=`${s.magnitude}${s.magnitudeUnit?` ${s.magnitudeUnit}`:""}`,i.appendChild(l)}i.addEventListener("click",l=>{l.stopPropagation();const o=this.container.getBoundingClientRect();this.popup.show({type:"natEvent",data:s,x:l.clientX-o.left,y:l.clientY-o.top})}),this.overlays.appendChild(i)}),this.state.layers.fires&&this.firmsFireData.forEach(s=>{const a=e([s.lon,s.lat]);if(!a)return;const i=s.brightness>400?T("--semantic-critical"):s.brightness>350?T("--semantic-high"):T("--semantic-elevated"),n=Math.max(4,Math.min(10,(s.frp||1)*.5)),l=document.createElement("div");l.className="fire-dot",l.style.left=`${a[0]}px`,l.style.top=`${a[1]}px`,l.style.width=`${n}px`,l.style.height=`${n}px`,l.style.backgroundColor=i,l.title=`${s.region} ‚Äî ${Math.round(s.brightness)}K, ${s.frp}MW`,this.overlays.appendChild(l)})}renderWaterways(e){Ca.forEach(t=>{const s=e([t.lon,t.lat]);if(!s)return;const a=document.createElement("div");a.className="waterway-marker",a.style.left=`${s[0]}px`,a.style.top=`${s[1]}px`,a.title=t.name;const i=document.createElement("div");i.className="waterway-diamond",a.appendChild(i),a.addEventListener("click",n=>{n.stopPropagation();const l=this.container.getBoundingClientRect();this.popup.show({type:"waterway",data:t,x:n.clientX-l.left,y:n.clientY-l.top})}),this.overlays.appendChild(a)})}renderAisDisruptions(e){this.aisDisruptions.forEach(t=>{const s=e([t.lon,t.lat]);if(!s)return;const a=document.createElement("div");a.className=`ais-disruption-marker ${t.severity} ${t.type}`,a.style.left=`${s[0]}px`,a.style.top=`${s[1]}px`;const i=document.createElement("div");i.className="ais-disruption-icon",i.textContent=t.type==="gap_spike"?"üõ∞Ô∏è":"üö¢",a.appendChild(i);const n=document.createElement("div");n.className="ais-disruption-label",n.textContent=t.name,a.appendChild(n),a.addEventListener("click",l=>{l.stopPropagation();const o=this.container.getBoundingClientRect();this.popup.show({type:"ais",data:t,x:l.clientX-o.left,y:l.clientY-o.top})}),this.overlays.appendChild(a)})}renderAisDensity(e){if(!this.dynamicLayerGroup)return;const t=this.dynamicLayerGroup.append("g").attr("class","ais-density");this.aisDensity.forEach(s=>{const a=e([s.lon,s.lat]);if(!a)return;const i=Math.min(Math.max(s.intensity,.15),1),n=4+i*8,o=s.deltaPct>=15?T("--semantic-elevated"):T("--semantic-info"),c=.15+i*.25;t.append("circle").attr("class","ais-density-spot").attr("cx",a[0]).attr("cy",a[1]).attr("r",n).attr("fill",o).attr("fill-opacity",c).attr("stroke","none")})}renderPorts(e){Gt.forEach(t=>{const s=e([t.lon,t.lat]);if(!s)return;const a=document.createElement("div");a.className=`port-marker port-${t.type}`,a.style.left=`${s[0]}px`,a.style.top=`${s[1]}px`;const i=document.createElement("div");i.className="port-icon",i.textContent=t.type==="naval"?"‚öì":t.type==="oil"||t.type==="lng"?"üõ¢Ô∏è":"üè≠",a.appendChild(i);const n=document.createElement("div");n.className="port-label",n.textContent=t.name,a.appendChild(n),a.addEventListener("click",l=>{l.stopPropagation();const o=this.container.getBoundingClientRect();this.popup.show({type:"port",data:t,x:l.clientX-o.left,y:l.clientY-o.top})}),this.overlays.appendChild(a)})}renderAPTMarkers(e){wa.forEach(t=>{const s=e([t.lon,t.lat]);if(!s)return;const a=document.createElement("div");a.className="apt-marker",a.style.left=`${s[0]}px`,a.style.top=`${s[1]}px`,a.innerHTML=`
        <div class="apt-icon">‚ö†</div>
        <div class="apt-label">${m(t.name)}</div>
      `,a.addEventListener("click",i=>{i.stopPropagation();const n=this.container.getBoundingClientRect();this.popup.show({type:"apt",data:t,x:i.clientX-n.left,y:i.clientY-n.top})}),this.overlays.appendChild(a)})}getRelatedNews(e){const t=["gaza","ukraine","russia","israel","iran","china","taiwan","korea","syria"];return this.news.map(s=>{const a=s.title.toLowerCase(),i=e.keywords.filter(o=>a.includes(o.toLowerCase()));if(i.length===0||t.filter(o=>a.includes(o)&&!e.keywords.some(c=>c.toLowerCase().includes(o))).length>0&&!i.some(c=>{var h;return c.toLowerCase()===e.name.toLowerCase()||((h=e.agencies)==null?void 0:h.some(d=>a.includes(d.toLowerCase())))}))return null;const l=i.length;return{item:s,score:l}}).filter(s=>s!==null).sort((s,a)=>a.score-s.score).slice(0,5).map(s=>s.item)}updateHotspotActivity(e){this.news=e,this.hotspots.forEach(t=>{let s=0,a=!1,i=0;e.forEach(l=>{const o=l.title.toLowerCase(),c=t.keywords.filter(h=>o.includes(h.toLowerCase()));if(c.length>0&&(i++,s+=c.length*2,l.isAlert&&(s+=5,a=!0),l.pubDate)){const h=(Date.now()-l.pubDate.getTime())/36e5;h<1?s+=3:h<6?s+=2:h<24&&(s+=1)}}),t.hasBreaking=a,a||i>=4||s>=10?(t.level="high",t.status=a?"BREAKING NEWS":"High activity"):i>=2||s>=4?(t.level="elevated",t.status="Elevated activity"):i>=1?(t.level="low",t.status="Recent mentions"):(t.level="low",t.status="Monitoring");const n=i>0?s/i:0;Da(t.id,i,a,n)}),this.render()}flashLocation(e,t,s=2e3){const a=this.container.clientWidth,i=this.container.clientHeight;if(!a||!i)return;const l=this.getProjection(a,i)([t,e]);if(!l)return;const o=document.createElement("div");o.className="map-flash",o.style.left=`${l[0]}px`,o.style.top=`${l[1]}px`,o.style.setProperty("--flash-duration",`${s}ms`),this.overlays.appendChild(o),window.setTimeout(()=>{o.remove()},s)}initEscalationGetters(){Ia(ka),Ra($a)}updateMilitaryForEscalation(e,t){Na(e,t)}getHotspotDynamicScore(e){return Zt(e)}setView(e){this.state.view=e;const s={global:{zoom:1,pan:{x:0,y:0}},america:{zoom:1.8,pan:{x:180,y:30}},mena:{zoom:3.5,pan:{x:-100,y:50}},eu:{zoom:2.4,pan:{x:-30,y:100}},asia:{zoom:2,pan:{x:-320,y:40}},latam:{zoom:2,pan:{x:120,y:-100}},africa:{zoom:2.2,pan:{x:-40,y:-30}},oceania:{zoom:2.2,pan:{x:-420,y:-100}}}[e];this.state.zoom=s.zoom,this.state.pan=s.pan,this.applyTransform(),this.render()}toggleLayer(e,t="user"){var n;if(console.log(`[Map.toggleLayer] ${e}: ${this.state.layers[e]} -> ${!this.state.layers[e]}`),this.state.layers[e]=!this.state.layers[e],this.state.layers[e]){const l=he.LAYER_ZOOM_THRESHOLDS[e];l&&this.state.zoom<l.minZoom?this.layerZoomOverrides[e]=!0:delete this.layerZoomOverrides[e]}else delete this.layerZoomOverrides[e];const s=this.container.querySelector(`[data-layer="${e}"]`),a=this.state.layers[e],i=he.ASYNC_DATA_LAYERS.has(e);a&&i?(s==null||s.classList.remove("active"),s==null||s.classList.add("loading")):(s==null||s.classList.toggle("active",a),s==null||s.classList.remove("loading")),(n=this.onLayerChange)==null||n.call(this,e,this.state.layers[e],t),requestAnimationFrame(()=>this.render())}setOnLayerChange(e){this.onLayerChange=e}hideLayerToggle(e){const t=this.container.querySelector(`.layer-toggle[data-layer="${e}"]`);t&&(t.style.display="none")}setLayerLoading(e,t){const s=this.container.querySelector(`.layer-toggle[data-layer="${e}"]`);s&&s.classList.toggle("loading",t)}setLayerReady(e,t){const s=this.container.querySelector(`.layer-toggle[data-layer="${e}"]`);s&&(s.classList.remove("loading"),this.state.layers[e]&&t?s.classList.add("active"):s.classList.remove("active"))}onStateChanged(e){this.onStateChange=e}zoomIn(){this.state.zoom=Math.min(this.state.zoom+.5,10),this.applyTransform()}zoomOut(){this.state.zoom=Math.max(this.state.zoom-.5,1),this.applyTransform()}reset(){this.state.zoom=1,this.state.pan={x:0,y:0},this.state.view!=="global"?(this.state.view="global",this.render()):this.applyTransform()}triggerHotspotClick(e){var o;const t=this.hotspots.find(c=>c.id===e);if(!t)return;const s=this.container.clientWidth,a=this.container.clientHeight,n=this.getProjection(s,a)([t.lon,t.lat]);if(!n)return;const l=this.getRelatedNews(t);this.popup.show({type:"hotspot",data:t,relatedNews:l,x:n[0],y:n[1]}),this.popup.loadHotspotGdeltContext(t),(o=this.onHotspotClick)==null||o.call(this,t)}triggerConflictClick(e){const t=Le.find(l=>l.id===e);if(!t)return;const s=this.container.clientWidth,a=this.container.clientHeight,n=this.getProjection(s,a)(t.center);n&&this.popup.show({type:"conflict",data:t,x:n[0],y:n[1]})}triggerBaseClick(e){const t=De.find(l=>l.id===e);if(!t)return;const s=this.container.clientWidth,a=this.container.clientHeight,n=this.getProjection(s,a)([t.lon,t.lat]);n&&this.popup.show({type:"base",data:t,x:n[0],y:n[1]})}triggerPipelineClick(e){const t=Xe.find(o=>o.id===e);if(!t||t.points.length===0)return;const s=this.container.clientWidth,a=this.container.clientHeight,i=this.getProjection(s,a),n=t.points[Math.floor(t.points.length/2)],l=i(n);l&&this.popup.show({type:"pipeline",data:t,x:l[0],y:l[1]})}triggerCableClick(e){const t=ce.find(o=>o.id===e);if(!t||t.points.length===0)return;const s=this.container.clientWidth,a=this.container.clientHeight,i=this.getProjection(s,a),n=t.points[Math.floor(t.points.length/2)],l=i(n);l&&this.popup.show({type:"cable",data:t,x:l[0],y:l[1]})}triggerDatacenterClick(e){const t=Se.find(l=>l.id===e);if(!t)return;const s=this.container.clientWidth,a=this.container.clientHeight,n=this.getProjection(s,a)([t.lon,t.lat]);n&&this.popup.show({type:"datacenter",data:t,x:n[0],y:n[1]})}triggerNuclearClick(e){const t=Ne.find(l=>l.id===e);if(!t)return;const s=this.container.clientWidth,a=this.container.clientHeight,n=this.getProjection(s,a)([t.lon,t.lat]);n&&this.popup.show({type:"nuclear",data:t,x:n[0],y:n[1]})}triggerIrradiatorClick(e){const t=Qe.find(l=>l.id===e);if(!t)return;const s=this.container.clientWidth,a=this.container.clientHeight,n=this.getProjection(s,a)([t.lon,t.lat]);n&&this.popup.show({type:"irradiator",data:t,x:n[0],y:n[1]})}enableLayer(e){var t;if(!this.state.layers[e]){this.state.layers[e]=!0;const s=he.LAYER_ZOOM_THRESHOLDS[e];s&&this.state.zoom<s.minZoom?this.layerZoomOverrides[e]=!0:delete this.layerZoomOverrides[e];const a=document.querySelector(`[data-layer="${e}"]`);a==null||a.classList.add("active"),(t=this.onLayerChange)==null||t.call(this,e,!0,"programmatic"),this.render()}}highlightAssets(e){Object.keys(this.highlightedAssets).forEach(t=>{this.highlightedAssets[t].clear()}),e&&e.forEach(t=>{this.highlightedAssets[t.type].add(t.id)}),this.render()}clampPan(){const e=this.state.zoom,t=this.container.clientWidth,s=this.container.clientHeight,a=t/2*Math.max(1,e*.8),i=s/2*Math.max(1,e*.8);this.state.pan.x=Math.max(-a,Math.min(a,this.state.pan.x)),this.state.pan.y=Math.max(-i,Math.min(i,this.state.pan.y))}applyTransform(){this.clampPan();const e=this.state.zoom,t=this.container.clientWidth,s=this.container.clientHeight,a=t/2*(1-e),i=s/2*(1-e),n=a+this.state.pan.x*e,l=i+this.state.pan.y*e;this.wrapper.style.transform=`translate(${n}px, ${l}px) scale(${e})`;const o=Math.min(1.5,e)/e,c=1/e;this.wrapper.style.setProperty("--label-scale",String(o)),this.wrapper.style.setProperty("--marker-scale",String(c)),this.wrapper.style.setProperty("--zoom",String(e)),this.updateLabelVisibility(e),this.updateZoomLayerVisibility(),this.emitStateChange()}updateZoomLayerVisibility(){const e=this.state.zoom;Object.keys(he.LAYER_ZOOM_THRESHOLDS).forEach(t=>{const s=he.LAYER_ZOOM_THRESHOLDS[t];if(!s)return;const a=this.state.layers[t],i=!!this.layerZoomOverrides[t],n=a&&(i||e>=s.minZoom),l=s.showLabels??s.minZoom,o=a&&e>=l,c=`data-layer-hidden-${t}`,h=`data-labels-hidden-${t}`;n?this.wrapper.removeAttribute(c):this.wrapper.setAttribute(c,"true"),o?this.wrapper.removeAttribute(h):this.wrapper.setAttribute(h,"true");const d=document.querySelector(`[data-layer="${t}"]`),g=a&&!i&&e<s.minZoom;d==null||d.classList.toggle("auto-hidden",g)})}emitStateChange(){var e;(e=this.onStateChange)==null||e.call(this,this.getState())}updateLabelVisibility(e){const t=this.overlays.querySelectorAll(".hotspot-label, .earthquake-label, .weather-label, .apt-label"),s=[];t.forEach(n=>{const l=n,o=l.closest(".hotspot, .earthquake-marker, .weather-marker, .apt-marker");let c=1;if(o!=null&&o.classList.contains("hotspot")){const d=o.querySelector(".hotspot-marker");d!=null&&d.classList.contains("high")?c=5:d!=null&&d.classList.contains("elevated")?c=3:c=2}else o!=null&&o.classList.contains("earthquake-marker")?c=4:o!=null&&o.classList.contains("weather-marker")&&(o.classList.contains("extreme")?c=5:o.classList.contains("severe")?c=4:c=2);l.style.opacity="1";const h=l.getBoundingClientRect();s.push({el:l,rect:h,priority:c})}),s.sort((n,l)=>l.priority-n.priority);const a=[],i=30/e;s.forEach(({el:n,rect:l,priority:o})=>{a.some(h=>{const d=Math.abs(l.left+l.width/2-(h.left+h.width/2)),g=Math.abs(l.top+l.height/2-(h.top+h.height/2));return d<(l.width+h.width)/2+i&&g<(l.height+h.height)/2+i})&&e<2?n.style.opacity=o>=4?"0.7":"0":a.push(l)})}onHotspotClicked(e){this.onHotspotClick=e}onTimeRangeChanged(e){this.onTimeRangeChange=e}getState(){return{...this.state}}getCenter(){const e=this.container.clientWidth,t=this.container.clientHeight,s=this.getProjection(e,t);if(!s.invert)return null;const a=this.state.zoom,i=e/(2*a)-this.state.pan.x,n=t/(2*a)-this.state.pan.y,l=s.invert([i,n]);return l?{lon:l[0],lat:l[1]}:null}getTimeRange(){return this.state.timeRange}setZoom(e){this.state.zoom=Math.max(1,Math.min(10,e)),this.applyTransform(),this.ensureBaseLayerIntact()}ensureBaseLayerIntact(){var i;const e=this.svg.node(),t=e==null?void 0:e.querySelector(".map-base"),s=(i=this.baseLayerGroup)==null?void 0:i.node();if(t&&s!==t){console.warn("[Map] Stale base layer selection detected, forcing full rebuild"),this.baseRendered=!1,this.render();return}((t==null?void 0:t.querySelectorAll(".country").length)??0)===0&&this.countryFeatures&&this.countryFeatures.length>0&&(console.warn("[Map] Base layer missing countries, triggering recovery render"),this.baseRendered=!1,this.render())}setCenter(e,t){console.log("[Map] setCenter called:",{lat:e,lon:t});const s=this.container.clientWidth,a=this.container.clientHeight,n=this.getProjection(s,a)([t,e]);console.log("[Map] projected pos:",n,"container:",{width:s,height:a},"zoom:",this.state.zoom),n&&(this.state.pan={x:s/2-n[0],y:a/2-n[1]},this.applyTransform(),this.ensureBaseLayerIntact())}setLayers(e){this.state.layers={...e},this.syncLayerButtons(),this.render()}setEarthquakes(e){console.log("[Map] setEarthquakes called with",e.length,"earthquakes"),e.length>0||this.earthquakes.length===0?this.earthquakes=e:console.log("[Map] Keeping existing",this.earthquakes.length,"earthquakes (new data was empty)"),this.render()}setWeatherAlerts(e){this.weatherAlerts=e,this.render()}setOutages(e){this.outages=e,this.render()}setAisData(e,t){this.aisDisruptions=e,this.aisDensity=t,this.render()}setCableActivity(e,t){this.cableAdvisories=e,this.repairShips=t,this.popup.setCableActivity(e,t),this.render()}setCableHealth(e){this.healthByCableId=e,this.render()}setProtests(e){this.protests=e,this.render()}setFlightDelays(e){this.flightDelays=e,this.render()}setMilitaryFlights(e,t=[]){this.militaryFlights=e,this.militaryFlightClusters=t,this.render()}setMilitaryVessels(e,t=[]){this.militaryVessels=e,this.militaryVesselClusters=t,this.render()}setNaturalEvents(e){this.naturalEvents=e,this.render()}setFires(e){this.firmsFireData=e,this.render()}setTechEvents(e){this.techEvents=e,this.render()}setCyberThreats(e){}setNewsLocations(e){}setTechActivity(e){this.techActivities=e,this.render()}setOnTechHubClick(e){this.onTechHubClick=e}setGeoActivity(e){this.geoActivities=e,this.render()}setOnGeoHubClick(e){this.onGeoHubClick=e}getCableAdvisory(e){return this.cableAdvisories.filter(s=>s.cableId===e).reduce((s,a)=>s?a.reported.getTime()>s.reported.getTime()?a:s:a,void 0)}getCableName(e){var t;return((t=ce.find(s=>s.id===e))==null?void 0:t.name)||e}getHotspotLevels(){const e={};return this.hotspots.forEach(t=>{e[t.name]=t.level||"low"}),e}setHotspotLevels(e){this.hotspots.forEach(t=>{e[t.name]&&(t.level=e[t.name])}),this.render()}};y(he,"LAYER_ZOOM_THRESHOLDS",{bases:{minZoom:3,showLabels:5},nuclear:{minZoom:2},conflicts:{minZoom:1,showLabels:3},economic:{minZoom:2},natural:{minZoom:1,showLabels:2}}),y(he,"ASYNC_DATA_LAYERS",new Set(["natural","weather","outages","ais","protests","flights","military","techEvents"]));let Bt=he;const Js=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array],St=1,qe=8;class Kt{static from(e){if(!(e instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[t,s]=new Uint8Array(e,0,2);if(t!==219)throw new Error("Data does not appear to be in a KDBush format.");const a=s>>4;if(a!==St)throw new Error(`Got v${a} data when expected v${St}.`);const i=Js[s&15];if(!i)throw new Error("Unrecognized array type.");const[n]=new Uint16Array(e,2,1),[l]=new Uint32Array(e,4,1);return new Kt(l,n,i,e)}constructor(e,t=64,s=Float64Array,a){if(isNaN(e)||e<0)throw new Error(`Unpexpected numItems value: ${e}.`);this.numItems=+e,this.nodeSize=Math.min(Math.max(+t,2),65535),this.ArrayType=s,this.IndexArrayType=e<65536?Uint16Array:Uint32Array;const i=Js.indexOf(this.ArrayType),n=e*2*this.ArrayType.BYTES_PER_ELEMENT,l=e*this.IndexArrayType.BYTES_PER_ELEMENT,o=(8-l%8)%8;if(i<0)throw new Error(`Unexpected typed array class: ${s}.`);a&&a instanceof ArrayBuffer?(this.data=a,this.ids=new this.IndexArrayType(this.data,qe,e),this.coords=new this.ArrayType(this.data,qe+l+o,e*2),this._pos=e*2,this._finished=!0):(this.data=new ArrayBuffer(qe+n+l+o),this.ids=new this.IndexArrayType(this.data,qe,e),this.coords=new this.ArrayType(this.data,qe+l+o,e*2),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,(St<<4)+i]),new Uint16Array(this.data,2,1)[0]=t,new Uint32Array(this.data,4,1)[0]=e)}add(e,t){const s=this._pos>>1;return this.ids[s]=s,this.coords[this._pos++]=e,this.coords[this._pos++]=t,s}finish(){const e=this._pos>>1;if(e!==this.numItems)throw new Error(`Added ${e} items when expected ${this.numItems}.`);return zt(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(e,t,s,a){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:i,coords:n,nodeSize:l}=this,o=[0,i.length-1,0],c=[];for(;o.length;){const h=o.pop()||0,d=o.pop()||0,g=o.pop()||0;if(d-g<=l){for(let b=g;b<=d;b++){const k=n[2*b],C=n[2*b+1];k>=e&&k<=s&&C>=t&&C<=a&&c.push(i[b])}continue}const u=g+d>>1,v=n[2*u],f=n[2*u+1];v>=e&&v<=s&&f>=t&&f<=a&&c.push(i[u]),(h===0?e<=v:t<=f)&&(o.push(g),o.push(u-1),o.push(1-h)),(h===0?s>=v:a>=f)&&(o.push(u+1),o.push(d),o.push(1-h))}return c}within(e,t,s){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:a,coords:i,nodeSize:n}=this,l=[0,a.length-1,0],o=[],c=s*s;for(;l.length;){const h=l.pop()||0,d=l.pop()||0,g=l.pop()||0;if(d-g<=n){for(let b=g;b<=d;b++)ea(i[2*b],i[2*b+1],e,t)<=c&&o.push(a[b]);continue}const u=g+d>>1,v=i[2*u],f=i[2*u+1];ea(v,f,e,t)<=c&&o.push(a[u]),(h===0?e-s<=v:t-s<=f)&&(l.push(g),l.push(u-1),l.push(1-h)),(h===0?e+s>=v:t+s>=f)&&(l.push(u+1),l.push(d),l.push(1-h))}return o}}function zt(p,e,t,s,a,i){if(a-s<=t)return;const n=s+a>>1;Ha(p,e,n,s,a,i),zt(p,e,t,s,n-1,1-i),zt(p,e,t,n+1,a,1-i)}function Ha(p,e,t,s,a,i){for(;a>s;){if(a-s>600){const c=a-s+1,h=t-s+1,d=Math.log(c),g=.5*Math.exp(2*d/3),u=.5*Math.sqrt(d*g*(c-g)/c)*(h-c/2<0?-1:1),v=Math.max(s,Math.floor(t-h*g/c+u)),f=Math.min(a,Math.floor(t+(c-h)*g/c+u));Ha(p,e,t,v,f,i)}const n=e[2*t+i];let l=s,o=a;for(je(p,e,s,t),e[2*a+i]>n&&je(p,e,s,a);l<o;){for(je(p,e,l,o),l++,o--;e[2*l+i]<n;)l++;for(;e[2*o+i]>n;)o--}e[2*s+i]===n?je(p,e,s,o):(o++,je(p,e,o,a)),o<=t&&(s=o+1),t<=o&&(a=o-1)}}function je(p,e,t,s){Lt(p,t,s),Lt(e,2*t,2*s),Lt(e,2*t+1,2*s+1)}function Lt(p,e,t){const s=p[e];p[e]=p[t],p[t]=s}function ea(p,e,t,s){const a=p-t,i=e-s;return a*a+i*i}const lr={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:p=>p},ta=Math.fround||(p=>(e=>(p[0]=+e,p[0])))(new Float32Array(1)),Me=2,ke=3,Et=4,Ce=5,Ba=6;class ot{constructor(e){this.options=Object.assign(Object.create(lr),e),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(e){const{log:t,minZoom:s,maxZoom:a}=this.options;t&&console.time("total time");const i=`prepare ${e.length} points`;t&&console.time(i),this.points=e;const n=[];for(let o=0;o<e.length;o++){const c=e[o];if(!c.geometry)continue;const[h,d]=c.geometry.coordinates,g=ta(rt(h)),u=ta(lt(d));n.push(g,u,1/0,o,-1,1),this.options.reduce&&n.push(0)}let l=this.trees[a+1]=this._createTree(n);t&&console.timeEnd(i);for(let o=a;o>=s;o--){const c=+Date.now();l=this.trees[o]=this._createTree(this._cluster(l,o)),t&&console.log("z%d: %d clusters in %dms",o,l.numItems,+Date.now()-c)}return t&&console.timeEnd("total time"),this}getClusters(e,t){let s=((e[0]+180)%360+360)%360-180;const a=Math.max(-90,Math.min(90,e[1]));let i=e[2]===180?180:((e[2]+180)%360+360)%360-180;const n=Math.max(-90,Math.min(90,e[3]));if(e[2]-e[0]>=360)s=-180,i=180;else if(s>i){const d=this.getClusters([s,a,180,n],t),g=this.getClusters([-180,a,i,n],t);return d.concat(g)}const l=this.trees[this._limitZoom(t)],o=l.range(rt(s),lt(n),rt(i),lt(a)),c=l.data,h=[];for(const d of o){const g=this.stride*d;h.push(c[g+Ce]>1?sa(c,g,this.clusterProps):this.points[c[g+ke]])}return h}getChildren(e){const t=this._getOriginId(e),s=this._getOriginZoom(e),a="No cluster with the specified id.",i=this.trees[s];if(!i)throw new Error(a);const n=i.data;if(t*this.stride>=n.length)throw new Error(a);const l=this.options.radius/(this.options.extent*Math.pow(2,s-1)),o=n[t*this.stride],c=n[t*this.stride+1],h=i.within(o,c,l),d=[];for(const g of h){const u=g*this.stride;n[u+Et]===e&&d.push(n[u+Ce]>1?sa(n,u,this.clusterProps):this.points[n[u+ke]])}if(d.length===0)throw new Error(a);return d}getLeaves(e,t,s){t=t||10,s=s||0;const a=[];return this._appendLeaves(a,e,t,s,0),a}getTile(e,t,s){const a=this.trees[this._limitZoom(e)],i=Math.pow(2,e),{extent:n,radius:l}=this.options,o=l/n,c=(s-o)/i,h=(s+1+o)/i,d={features:[]};return this._addTileFeatures(a.range((t-o)/i,c,(t+1+o)/i,h),a.data,t,s,i,d),t===0&&this._addTileFeatures(a.range(1-o/i,c,1,h),a.data,i,s,i,d),t===i-1&&this._addTileFeatures(a.range(0,c,o/i,h),a.data,-1,s,i,d),d.features.length?d:null}getClusterExpansionZoom(e){let t=this._getOriginZoom(e)-1;for(;t<=this.options.maxZoom;){const s=this.getChildren(e);if(t++,s.length!==1)break;e=s[0].properties.cluster_id}return t}_appendLeaves(e,t,s,a,i){const n=this.getChildren(t);for(const l of n){const o=l.properties;if(o&&o.cluster?i+o.point_count<=a?i+=o.point_count:i=this._appendLeaves(e,o.cluster_id,s,a,i):i<a?i++:e.push(l),e.length===s)break}return i}_createTree(e){const t=new Kt(e.length/this.stride|0,this.options.nodeSize,Float32Array);for(let s=0;s<e.length;s+=this.stride)t.add(e[s],e[s+1]);return t.finish(),t.data=e,t}_addTileFeatures(e,t,s,a,i,n){for(const l of e){const o=l*this.stride,c=t[o+Ce]>1;let h,d,g;if(c)h=za(t,o,this.clusterProps),d=t[o],g=t[o+1];else{const f=this.points[t[o+ke]];h=f.properties;const[b,k]=f.geometry.coordinates;d=rt(b),g=lt(k)}const u={type:1,geometry:[[Math.round(this.options.extent*(d*i-s)),Math.round(this.options.extent*(g*i-a))]],tags:h};let v;c||this.options.generateId?v=t[o+ke]:v=this.points[t[o+ke]].id,v!==void 0&&(u.id=v),n.features.push(u)}}_limitZoom(e){return Math.max(this.options.minZoom,Math.min(Math.floor(+e),this.options.maxZoom+1))}_cluster(e,t){const{radius:s,extent:a,reduce:i,minPoints:n}=this.options,l=s/(a*Math.pow(2,t)),o=e.data,c=[],h=this.stride;for(let d=0;d<o.length;d+=h){if(o[d+Me]<=t)continue;o[d+Me]=t;const g=o[d],u=o[d+1],v=e.within(o[d],o[d+1],l),f=o[d+Ce];let b=f;for(const k of v){const C=k*h;o[C+Me]>t&&(b+=o[C+Ce])}if(b>f&&b>=n){let k=g*f,C=u*f,w,$=-1;const P=((d/h|0)<<5)+(t+1)+this.points.length;for(const E of v){const A=E*h;if(o[A+Me]<=t)continue;o[A+Me]=t;const N=o[A+Ce];k+=o[A]*N,C+=o[A+1]*N,o[A+Et]=P,i&&(w||(w=this._map(o,d,!0),$=this.clusterProps.length,this.clusterProps.push(w)),i(w,this._map(o,A)))}o[d+Et]=P,c.push(k/b,C/b,1/0,P,-1,b),i&&c.push($)}else{for(let k=0;k<h;k++)c.push(o[d+k]);if(b>1)for(const k of v){const C=k*h;if(!(o[C+Me]<=t)){o[C+Me]=t;for(let w=0;w<h;w++)c.push(o[C+w])}}}}return c}_getOriginId(e){return e-this.points.length>>5}_getOriginZoom(e){return(e-this.points.length)%32}_map(e,t,s){if(e[t+Ce]>1){const n=this.clusterProps[e[t+Ba]];return s?Object.assign({},n):n}const a=this.points[e[t+ke]].properties,i=this.options.map(a);return s&&i===a?Object.assign({},i):i}}function sa(p,e,t){return{type:"Feature",id:p[e+ke],properties:za(p,e,t),geometry:{type:"Point",coordinates:[cr(p[e]),pr(p[e+1])]}}}function za(p,e,t){const s=p[e+Ce],a=s>=1e4?`${Math.round(s/1e3)}k`:s>=1e3?`${Math.round(s/100)/10}k`:s,i=p[e+Ba],n=i===-1?{}:Object.assign({},t[i]);return Object.assign(n,{cluster:!0,cluster_id:p[e+ke],point_count:s,point_count_abbreviated:a})}function rt(p){return p/360+.5}function lt(p){const e=Math.sin(p*Math.PI/180),t=.5-.25*Math.log((1+e)/(1-e))/Math.PI;return t<0?0:t>1?1:t}function cr(p){return(p-.5)*360}function pr(p){const e=(180-p*360)*Math.PI/180;return 360*Math.atan(Math.exp(e))/Math.PI-90}const aa={global:{longitude:0,latitude:20,zoom:1.5},america:{longitude:-95,latitude:38,zoom:3},mena:{longitude:45,latitude:28,zoom:3.5},eu:{longitude:15,latitude:50,zoom:3.5},asia:{longitude:105,latitude:35,zoom:3},latam:{longitude:-60,latitude:-15,zoom:3},africa:{longitude:20,latitude:5,zoom:3},oceania:{longitude:135,latitude:-25,zoom:3.5}},ia="https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json",na="https://basemaps.cartocdn.com/gl/voyager-gl-style/style.json",dr={bases:{minZoom:3,showLabels:5},nuclear:{minZoom:3},conflicts:{minZoom:1,showLabels:3},economic:{minZoom:3},natural:{minZoom:1,showLabels:2},datacenters:{minZoom:5},irradiators:{minZoom:4},spaceports:{minZoom:3},gulfInvestments:{minZoom:2,showLabels:5}};function _a(){const p=le()==="light";return{hotspotHigh:[255,68,68,200],hotspotElevated:[255,165,0,200],hotspotLow:[255,255,0,180],conflict:p?[255,0,0,60]:[255,0,0,100],base:[0,150,255,200],nuclear:p?[180,120,0,220]:[255,215,0,200],datacenter:p?[13,148,136,200]:[0,255,200,180],cable:[0,200,255,150],cableHighlight:[255,100,100,200],cableFault:[255,50,50,220],cableDegraded:[255,165,0,200],earthquake:[255,100,50,200],vesselMilitary:[255,100,100,220],flightMilitary:[255,50,50,220],protest:[255,150,0,200],outage:[255,50,50,180],weather:[100,150,255,180],startupHub:p?[22,163,74,220]:[0,255,150,200],techHQ:[100,200,255,200],accelerator:p?[180,120,0,220]:[255,200,0,200],cloudRegion:[150,100,255,180],stockExchange:p?[20,120,200,220]:[80,200,255,210],financialCenter:p?[0,150,110,215]:[0,220,150,200],centralBank:p?[180,120,0,220]:[255,210,80,210],commodityHub:p?[190,95,40,220]:[255,150,80,200],gulfInvestmentSA:[0,168,107,220],gulfInvestmentUAE:[255,0,100,220],ucdpStateBased:[255,50,50,200],ucdpNonState:[255,165,0,200],ucdpOneSided:[255,255,0,200]}}let j=_a();const xt={square:"data:image/svg+xml;base64,"+btoa('<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><rect x="2" y="2" width="28" height="28" rx="3" fill="white"/></svg>'),diamond:"data:image/svg+xml;base64,"+btoa('<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><polygon points="16,2 30,16 16,30 2,16" fill="white"/></svg>'),triangleUp:"data:image/svg+xml;base64,"+btoa('<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><polygon points="16,2 30,28 2,28" fill="white"/></svg>'),hexagon:"data:image/svg+xml;base64,"+btoa('<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><polygon points="16,2 28,9 28,23 16,30 4,23 4,9" fill="white"/></svg>'),circle:"data:image/svg+xml;base64,"+btoa('<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><circle cx="16" cy="16" r="14" fill="white"/></svg>'),star:"data:image/svg+xml;base64,"+btoa('<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><polygon points="16,2 20,12 30,12 22,19 25,30 16,23 7,30 10,19 2,12 12,12" fill="white"/></svg>')},Pe=class Pe{constructor(e,t){y(this,"container");y(this,"deckOverlay",null);y(this,"maplibreMap",null);y(this,"state");y(this,"popup");y(this,"hotspots");y(this,"earthquakes",[]);y(this,"weatherAlerts",[]);y(this,"outages",[]);y(this,"cyberThreats",[]);y(this,"aisDisruptions",[]);y(this,"aisDensity",[]);y(this,"cableAdvisories",[]);y(this,"repairShips",[]);y(this,"healthByCableId",{});y(this,"protests",[]);y(this,"militaryFlights",[]);y(this,"militaryFlightClusters",[]);y(this,"militaryVessels",[]);y(this,"militaryVesselClusters",[]);y(this,"naturalEvents",[]);y(this,"firmsFireData",[]);y(this,"techEvents",[]);y(this,"flightDelays",[]);y(this,"news",[]);y(this,"newsLocations",[]);y(this,"newsLocationFirstSeen",new Map);y(this,"ucdpEvents",[]);y(this,"displacementFlows",[]);y(this,"climateAnomalies",[]);y(this,"countryGeoJsonLoaded",!1);y(this,"countryHoverSetup",!1);y(this,"highlightedCountryCode",null);y(this,"onHotspotClick");y(this,"onTimeRangeChange");y(this,"onCountryClick");y(this,"onLayerChange");y(this,"onStateChange");y(this,"highlightedAssets",{pipeline:new Set,cable:new Set,datacenter:new Set,base:new Set,nuclear:new Set});y(this,"renderScheduled",!1);y(this,"renderPaused",!1);y(this,"renderPending",!1);y(this,"webglLost",!1);y(this,"resizeObserver",null);y(this,"layerCache",new Map);y(this,"lastZoomThreshold",0);y(this,"protestSC",null);y(this,"techHQSC",null);y(this,"techEventSC",null);y(this,"datacenterSC",null);y(this,"protestClusters",[]);y(this,"techHQClusters",[]);y(this,"techEventClusters",[]);y(this,"datacenterClusters",[]);y(this,"lastSCZoom",-1);y(this,"lastSCBoundsKey","");y(this,"lastSCMask","");y(this,"protestSuperclusterSource",[]);y(this,"newsPulseIntervalId",null);y(this,"startupTime",Date.now());y(this,"lastCableHighlightSignature","");y(this,"lastCableHealthSignature","");y(this,"lastPipelineHighlightSignature","");y(this,"debouncedRebuildLayers");y(this,"rafUpdateLayers");y(this,"moveTimeoutId",null);y(this,"pulseTime",0);var s;this.container=e,this.state=t,this.hotspots=[...He],this.rebuildTechHQSupercluster(),this.rebuildDatacenterSupercluster(),this.debouncedRebuildLayers=It(()=>{var a;if(!(this.renderPaused||this.webglLost||!this.maplibreMap)){this.maplibreMap.resize();try{(a=this.deckOverlay)==null||a.setProps({layers:this.buildLayers()})}catch{}}},150),this.rafUpdateLayers=ci(()=>{var a;if(!(this.renderPaused||this.webglLost||!this.maplibreMap))try{(a=this.deckOverlay)==null||a.setProps({layers:this.buildLayers()})}catch{}}),this.setupDOM(),this.popup=new Fa(e),window.addEventListener("theme-changed",a=>{var n;const i=(n=a.detail)==null?void 0:n.theme;i&&(this.switchBasemap(i),this.render())}),this.initMapLibre(),(s=this.maplibreMap)==null||s.on("load",()=>{this.initDeck(),this.loadCountryBoundaries(),this.render()}),this.setupResizeObserver(),this.createControls(),this.createTimeSlider(),this.createLayerToggles(),this.createLegend()}setupDOM(){const e=document.createElement("div");e.className="deckgl-map-wrapper",e.id="deckglMapWrapper",e.style.cssText="position: relative; width: 100%; height: 100%; overflow: hidden;";const t=document.createElement("div");t.id="deckgl-basemap",t.style.cssText="position: absolute; top: 0; left: 0; width: 100%; height: 100%;",e.appendChild(t),this.container.appendChild(e)}initMapLibre(){const e=aa[this.state.view],t=le();this.maplibreMap=new Va.Map({container:"deckgl-basemap",style:t==="light"?na:ia,center:[e.longitude,e.latitude],zoom:e.zoom,renderWorldCopies:!1,attributionControl:!1,interactive:!0});const s=this.maplibreMap.getCanvas();s.addEventListener("webglcontextlost",a=>{a.preventDefault(),this.webglLost=!0,console.warn("[DeckGLMap] WebGL context lost ‚Äî will restore when browser recovers")}),s.addEventListener("webglcontextrestored",()=>{var a;this.webglLost=!1,console.info("[DeckGLMap] WebGL context restored"),(a=this.maplibreMap)==null||a.triggerRepaint()})}initDeck(){this.maplibreMap&&(this.deckOverlay=new Wa({interleaved:!0,layers:this.buildLayers(),getTooltip:e=>this.getTooltip(e),onClick:e=>this.handleClick(e),pickingRadius:10,useDevicePixels:window.devicePixelRatio>2?2:!0,onError:e=>console.warn("[DeckGLMap] Render error (non-fatal):",e.message)}),this.maplibreMap.addControl(this.deckOverlay),this.maplibreMap.on("movestart",()=>{this.moveTimeoutId&&(clearTimeout(this.moveTimeoutId),this.moveTimeoutId=null)}),this.maplibreMap.on("moveend",()=>{this.lastSCZoom=-1,this.rafUpdateLayers()}),this.maplibreMap.on("move",()=>{this.moveTimeoutId&&clearTimeout(this.moveTimeoutId),this.moveTimeoutId=setTimeout(()=>{this.lastSCZoom=-1,this.rafUpdateLayers()},100)}),this.maplibreMap.on("zoom",()=>{this.moveTimeoutId&&clearTimeout(this.moveTimeoutId),this.moveTimeoutId=setTimeout(()=>{this.lastSCZoom=-1,this.rafUpdateLayers()},100)}),this.maplibreMap.on("zoomend",()=>{var s;const e=Math.floor(((s=this.maplibreMap)==null?void 0:s.getZoom())||2);Math.abs(e-this.lastZoomThreshold)>=1&&(this.lastZoomThreshold=e,this.debouncedRebuildLayers())}))}setupResizeObserver(){this.resizeObserver=new ResizeObserver(()=>{this.maplibreMap&&this.maplibreMap.resize()}),this.resizeObserver.observe(this.container)}getSetSignature(e){return[...e].sort().join("|")}hasRecentNews(e=Date.now()){for(const t of this.newsLocationFirstSeen.values())if(e-t<3e4)return!0;return!1}getTimeRangeMs(e=this.state.timeRange){return{"1h":36e5,"6h":216e5,"24h":864e5,"48h":1728e5,"7d":6048e5,all:1/0}[e]}parseTime(e){if(e==null)return null;const t=e instanceof Date?e.getTime():new Date(e).getTime();return Number.isFinite(t)?t:null}filterByTime(e,t){if(this.state.timeRange==="all")return e;const s=Date.now()-this.getTimeRangeMs();return e.filter(a=>{const i=this.parseTime(t(a));return i==null?!0:i>=s})}getFilteredProtests(){return this.filterByTime(this.protests,e=>e.time)}filterMilitaryFlightClustersByTime(e){return e.map(t=>{const s=this.filterByTime(t.flights??[],a=>a.lastSeen);return s.length===0?null:{...t,flights:s,flightCount:s.length}}).filter(t=>t!==null)}filterMilitaryVesselClustersByTime(e){return e.map(t=>{const s=this.filterByTime(t.vessels??[],a=>a.lastAisUpdate);return s.length===0?null:{...t,vessels:s,vesselCount:s.length}}).filter(t=>t!==null)}rebuildProtestSupercluster(e=this.getFilteredProtests()){this.protestSuperclusterSource=e;const t=e.map((s,a)=>({type:"Feature",geometry:{type:"Point",coordinates:[s.lon,s.lat]},properties:{index:a,country:s.country,severity:s.severity,eventType:s.eventType,validated:!!s.validated,fatalities:Number.isFinite(s.fatalities)?Number(s.fatalities):0}}));this.protestSC=new ot({radius:60,maxZoom:14,map:s=>({index:Number(s.index??0),country:String(s.country??""),maxSeverityRank:s.severity==="high"?2:s.severity==="medium"?1:0,riotCount:s.eventType==="riot"?1:0,highSeverityCount:s.severity==="high"?1:0,verifiedCount:s.validated?1:0,totalFatalities:Number(s.fatalities??0)||0}),reduce:(s,a)=>{s.maxSeverityRank=Math.max(Number(s.maxSeverityRank??0),Number(a.maxSeverityRank??0)),s.riotCount=Number(s.riotCount??0)+Number(a.riotCount??0),s.highSeverityCount=Number(s.highSeverityCount??0)+Number(a.highSeverityCount??0),s.verifiedCount=Number(s.verifiedCount??0)+Number(a.verifiedCount??0),s.totalFatalities=Number(s.totalFatalities??0)+Number(a.totalFatalities??0),!s.country&&a.country&&(s.country=a.country)}}),this.protestSC.load(t),this.lastSCZoom=-1}rebuildTechHQSupercluster(){const e=We.map((t,s)=>({type:"Feature",geometry:{type:"Point",coordinates:[t.lon,t.lat]},properties:{index:s,city:t.city,country:t.country,type:t.type}}));this.techHQSC=new ot({radius:50,maxZoom:14,map:t=>({index:Number(t.index??0),city:String(t.city??""),country:String(t.country??""),faangCount:t.type==="faang"?1:0,unicornCount:t.type==="unicorn"?1:0,publicCount:t.type==="public"?1:0}),reduce:(t,s)=>{t.faangCount=Number(t.faangCount??0)+Number(s.faangCount??0),t.unicornCount=Number(t.unicornCount??0)+Number(s.unicornCount??0),t.publicCount=Number(t.publicCount??0)+Number(s.publicCount??0),!t.city&&s.city&&(t.city=s.city),!t.country&&s.country&&(t.country=s.country)}}),this.techHQSC.load(e),this.lastSCZoom=-1}rebuildTechEventSupercluster(){const e=this.techEvents.map((t,s)=>({type:"Feature",geometry:{type:"Point",coordinates:[t.lng,t.lat]},properties:{index:s,location:t.location,country:t.country,daysUntil:t.daysUntil}}));this.techEventSC=new ot({radius:50,maxZoom:14,map:t=>{const s=Number(t.daysUntil??Number.MAX_SAFE_INTEGER);return{index:Number(t.index??0),location:String(t.location??""),country:String(t.country??""),soonestDaysUntil:Number.isFinite(s)?s:Number.MAX_SAFE_INTEGER,soonCount:Number.isFinite(s)&&s<=14?1:0}},reduce:(t,s)=>{t.soonestDaysUntil=Math.min(Number(t.soonestDaysUntil??Number.MAX_SAFE_INTEGER),Number(s.soonestDaysUntil??Number.MAX_SAFE_INTEGER)),t.soonCount=Number(t.soonCount??0)+Number(s.soonCount??0),!t.location&&s.location&&(t.location=s.location),!t.country&&s.country&&(t.country=s.country)}}),this.techEventSC.load(e),this.lastSCZoom=-1}rebuildDatacenterSupercluster(){const t=Se.filter(s=>s.status!=="decommissioned").map((s,a)=>({type:"Feature",geometry:{type:"Point",coordinates:[s.lon,s.lat]},properties:{index:a,country:s.country,chipCount:s.chipCount,powerMW:s.powerMW??0,status:s.status}}));this.datacenterSC=new ot({radius:70,maxZoom:14,map:s=>({index:Number(s.index??0),country:String(s.country??""),totalChips:Number(s.chipCount??0)||0,totalPowerMW:Number(s.powerMW??0)||0,existingCount:s.status==="existing"?1:0,plannedCount:s.status==="planned"?1:0}),reduce:(s,a)=>{s.totalChips=Number(s.totalChips??0)+Number(a.totalChips??0),s.totalPowerMW=Number(s.totalPowerMW??0)+Number(a.totalPowerMW??0),s.existingCount=Number(s.existingCount??0)+Number(a.existingCount??0),s.plannedCount=Number(s.plannedCount??0)+Number(a.plannedCount??0),!s.country&&a.country&&(s.country=a.country)}}),this.datacenterSC.load(t),this.lastSCZoom=-1}updateClusterData(){var d,g;const e=Math.floor(((d=this.maplibreMap)==null?void 0:d.getZoom())??2),t=(g=this.maplibreMap)==null?void 0:g.getBounds();if(!t)return;const s=[t.getWest(),t.getSouth(),t.getEast(),t.getNorth()],a=`${s[0].toFixed(4)}:${s[1].toFixed(4)}:${s[2].toFixed(4)}:${s[3].toFixed(4)}`,i=this.state.layers,n=i.protests&&this.protestSuperclusterSource.length>0,l=M==="tech"&&i.techHQs,o=M==="tech"&&i.techEvents&&this.techEvents.length>0,c=i.datacenters&&e<5,h=`${Number(n)}${Number(l)}${Number(o)}${Number(c)}`;if(!(e===this.lastSCZoom&&a===this.lastSCBoundsKey&&h===this.lastSCMask))if(this.lastSCZoom=e,this.lastSCBoundsKey=a,this.lastSCMask=h,n&&this.protestSC?this.protestClusters=this.protestSC.getClusters(s,e).map(u=>{var b;const v=u.geometry.coordinates;if(u.properties.cluster){const k=u.properties,w=this.protestSC.getLeaves(u.properties.cluster_id,Pe.MAX_CLUSTER_LEAVES).map(X=>this.protestSuperclusterSource[X.properties.index]).filter(X=>!!X),$=Number(k.maxSeverityRank??0),P=$>=2?"high":$===1?"medium":"low",E=Number(k.riotCount??0),A=Number(k.highSeverityCount??0),N=Number(k.verifiedCount??0),F=Number(k.totalFatalities??0),B=Number(u.properties.point_count??w.length),te=w.reduce((X,Q)=>{if(Q.eventType!=="riot"||Q.sourceType==="gdelt")return X;const ie=Q.time.getTime();return Number.isFinite(ie)?Math.max(X,ie):X},0);return{id:`pc-${u.properties.cluster_id}`,lat:v[1],lon:v[0],count:B,items:w,country:String(k.country??((b=w[0])==null?void 0:b.country)??""),maxSeverity:P,hasRiot:E>0,latestRiotEventTimeMs:te||void 0,totalFatalities:F,riotCount:E,highSeverityCount:A,verifiedCount:N,sampled:w.length<B}}const f=this.protestSuperclusterSource[u.properties.index];return{id:`pp-${u.properties.index}`,lat:f.lat,lon:f.lon,count:1,items:[f],country:f.country,maxSeverity:f.severity,hasRiot:f.eventType==="riot",latestRiotEventTimeMs:f.eventType==="riot"&&f.sourceType!=="gdelt"&&Number.isFinite(f.time.getTime())?f.time.getTime():void 0,totalFatalities:f.fatalities??0,riotCount:f.eventType==="riot"?1:0,highSeverityCount:f.severity==="high"?1:0,verifiedCount:f.validated?1:0,sampled:!1}}):this.protestClusters=[],l&&this.techHQSC?this.techHQClusters=this.techHQSC.getClusters(s,e).map(u=>{var b,k;const v=u.geometry.coordinates;if(u.properties.cluster){const C=u.properties,$=this.techHQSC.getLeaves(u.properties.cluster_id,Pe.MAX_CLUSTER_LEAVES).map(B=>We[B.properties.index]).filter(Boolean),P=Number(C.faangCount??0),E=Number(C.unicornCount??0),A=Number(C.publicCount??0),N=Number(u.properties.point_count??$.length),F=P>=E&&P>=A?"faang":E>=A?"unicorn":"public";return{id:`hc-${u.properties.cluster_id}`,lat:v[1],lon:v[0],count:N,items:$,city:String(C.city??((b=$[0])==null?void 0:b.city)??""),country:String(C.country??((k=$[0])==null?void 0:k.country)??""),primaryType:F,faangCount:P,unicornCount:E,publicCount:A,sampled:$.length<N}}const f=We[u.properties.index];return{id:`hp-${u.properties.index}`,lat:f.lat,lon:f.lon,count:1,items:[f],city:f.city,country:f.country,primaryType:f.type,faangCount:f.type==="faang"?1:0,unicornCount:f.type==="unicorn"?1:0,publicCount:f.type==="public"?1:0,sampled:!1}}):this.techHQClusters=[],o&&this.techEventSC?this.techEventClusters=this.techEventSC.getClusters(s,e).map(u=>{var b,k;const v=u.geometry.coordinates;if(u.properties.cluster){const C=u.properties,$=this.techEventSC.getLeaves(u.properties.cluster_id,Pe.MAX_CLUSTER_LEAVES).map(N=>this.techEvents[N.properties.index]).filter(N=>!!N),P=Number(u.properties.point_count??$.length),E=Number(C.soonestDaysUntil??Number.MAX_SAFE_INTEGER),A=Number(C.soonCount??0);return{id:`ec-${u.properties.cluster_id}`,lat:v[1],lon:v[0],count:P,items:$,location:String(C.location??((b=$[0])==null?void 0:b.location)??""),country:String(C.country??((k=$[0])==null?void 0:k.country)??""),soonestDaysUntil:Number.isFinite(E)?E:Number.MAX_SAFE_INTEGER,soonCount:A,sampled:$.length<P}}const f=this.techEvents[u.properties.index];return{id:`ep-${u.properties.index}`,lat:f.lat,lon:f.lng,count:1,items:[f],location:f.location,country:f.country,soonestDaysUntil:f.daysUntil,soonCount:f.daysUntil<=14?1:0,sampled:!1}}):this.techEventClusters=[],c&&this.datacenterSC){const u=Se.filter(v=>v.status!=="decommissioned");this.datacenterClusters=this.datacenterSC.getClusters(s,e).map(v=>{var k,C;const f=v.geometry.coordinates;if(v.properties.cluster){const w=v.properties,P=this.datacenterSC.getLeaves(v.properties.cluster_id,Pe.MAX_CLUSTER_LEAVES).map(te=>u[te.properties.index]).filter(te=>!!te),E=Number(v.properties.point_count??P.length),A=Number(w.existingCount??0),N=Number(w.plannedCount??0),F=Number(w.totalChips??0),B=Number(w.totalPowerMW??0);return{id:`dc-${v.properties.cluster_id}`,lat:f[1],lon:f[0],count:E,items:P,region:String(w.country??((k=P[0])==null?void 0:k.country)??""),country:String(w.country??((C=P[0])==null?void 0:C.country)??""),totalChips:F,totalPowerMW:B,majorityExisting:A>=Math.max(1,E/2),existingCount:A,plannedCount:N,sampled:P.length<E}}const b=u[v.properties.index];return{id:`dp-${v.properties.index}`,lat:b.lat,lon:b.lon,count:1,items:[b],region:b.country,country:b.country,totalChips:b.chipCount,totalPowerMW:b.powerMW??0,majorityExisting:b.status==="existing",existingCount:b.status==="existing"?1:0,plannedCount:b.status==="planned"?1:0,sampled:!1}})}else this.datacenterClusters=[]}isLayerVisible(e){var a;const t=dr[e];return t?(((a=this.maplibreMap)==null?void 0:a.getZoom())||2)>=t.minZoom:!0}buildLayers(){var k;const e=performance.now();j=_a();const t=[],{layers:s}=this.state,a=this.filterByTime(this.earthquakes,C=>C.occurredAt),i=this.filterByTime(this.naturalEvents,C=>C.date),n=this.filterByTime(this.weatherAlerts,C=>C.onset),l=this.filterByTime(this.outages,C=>C.pubDate),o=this.filterByTime(this.cableAdvisories,C=>C.reported),c=this.filterByTime(this.flightDelays,C=>C.updatedAt),h=this.filterByTime(this.militaryFlights,C=>C.lastSeen),d=this.filterByTime(this.militaryVessels,C=>C.lastAisUpdate),g=this.filterMilitaryFlightClustersByTime(this.militaryFlightClusters),u=this.filterMilitaryVesselClustersByTime(this.militaryVesselClusters),v=this.filterByTime(this.ucdpEvents,C=>C.date_start);s.cables?t.push(this.createCablesLayer()):this.layerCache.delete("cables-layer"),s.pipelines?t.push(this.createPipelinesLayer()):this.layerCache.delete("pipelines-layer"),s.conflicts&&t.push(this.createConflictZonesLayer()),s.bases&&this.isLayerVisible("bases")&&(t.push(this.createBasesLayer()),t.push(this.createGhostLayer("bases-layer",De,C=>[C.lon,C.lat],{radiusMinPixels:12}))),s.nuclear&&this.isLayerVisible("nuclear")&&(t.push(this.createNuclearLayer()),t.push(this.createGhostLayer("nuclear-layer",Ne.filter(C=>C.status!=="decommissioned"),C=>[C.lon,C.lat],{radiusMinPixels:12}))),s.irradiators&&this.isLayerVisible("irradiators")&&t.push(this.createIrradiatorsLayer()),s.spaceports&&this.isLayerVisible("spaceports")&&t.push(this.createSpaceportsLayer()),s.hotspots&&t.push(...this.createHotspotsLayers());const f=((k=this.maplibreMap)==null?void 0:k.getZoom())||2;s.datacenters&&(f>=5?t.push(this.createDatacentersLayer()):t.push(...this.createDatacenterClusterLayers())),s.natural&&a.length>0&&(t.push(this.createEarthquakesLayer(a)),t.push(this.createGhostLayer("earthquakes-layer",a,C=>{var w,$;return[((w=C.location)==null?void 0:w.longitude)??0,(($=C.location)==null?void 0:$.latitude)??0]},{radiusMinPixels:12}))),s.natural&&i.length>0&&t.push(this.createNaturalEventsLayer(i)),s.fires&&this.firmsFireData.length>0&&t.push(this.createFiresLayer()),s.weather&&n.length>0&&t.push(this.createWeatherLayer(n)),s.outages&&l.length>0&&(t.push(this.createOutagesLayer(l)),t.push(this.createGhostLayer("outages-layer",l,C=>[C.lon,C.lat],{radiusMinPixels:12}))),s.cyberThreats&&this.cyberThreats.length>0&&(t.push(this.createCyberThreatsLayer()),t.push(this.createGhostLayer("cyber-threats-layer",this.cyberThreats,C=>[C.lon,C.lat],{radiusMinPixels:12}))),s.ais&&this.aisDensity.length>0&&t.push(this.createAisDensityLayer()),s.ais&&this.aisDisruptions.length>0&&t.push(this.createAisDisruptionsLayer()),s.ais&&t.push(this.createPortsLayer()),s.cables&&o.length>0&&t.push(this.createCableAdvisoriesLayer(o)),s.cables&&this.repairShips.length>0&&t.push(this.createRepairShipsLayer()),s.flights&&c.length>0&&t.push(this.createFlightDelaysLayer(c)),s.protests&&this.protests.length>0&&t.push(...this.createProtestClusterLayers()),s.military&&d.length>0&&t.push(this.createMilitaryVesselsLayer(d)),s.military&&u.length>0&&t.push(this.createMilitaryVesselClustersLayer(u)),s.military&&h.length>0&&t.push(this.createMilitaryFlightsLayer(h)),s.military&&g.length>0&&t.push(this.createMilitaryFlightClustersLayer(g)),s.waterways&&t.push(this.createWaterwaysLayer()),s.economic&&this.isLayerVisible("economic")&&t.push(this.createEconomicCentersLayer()),s.stockExchanges&&t.push(this.createStockExchangesLayer()),s.financialCenters&&t.push(this.createFinancialCentersLayer()),s.centralBanks&&t.push(this.createCentralBanksLayer()),s.commodityHubs&&t.push(this.createCommodityHubsLayer()),s.minerals&&t.push(this.createMineralsLayer()),M!=="tech"&&t.push(this.createAPTGroupsLayer()),s.ucdpEvents&&v.length>0&&t.push(this.createUcdpEventsLayer(v)),s.displacement&&this.displacementFlows.length>0&&t.push(this.createDisplacementArcsLayer()),s.climate&&this.climateAnomalies.length>0&&t.push(this.createClimateHeatmapLayer()),M==="tech"&&(s.startupHubs&&t.push(this.createStartupHubsLayer()),s.techHQs&&t.push(...this.createTechHQClusterLayers()),s.accelerators&&t.push(this.createAcceleratorsLayer()),s.cloudRegions&&t.push(this.createCloudRegionsLayer()),s.techEvents&&this.techEvents.length>0&&t.push(...this.createTechEventClusterLayers())),s.gulfInvestments&&t.push(this.createGulfInvestmentsLayer()),this.newsLocations.length>0&&t.push(...this.createNewsLocationsLayer());const b=t.filter(Boolean);return performance.now()-e,b}createCablesLayer(){const e=this.highlightedAssets.cable,t="cables-layer",s=this.layerCache.get(t),a=this.getSetSignature(e),i=Object.keys(this.healthByCableId).sort().join(",");if(s&&a===this.lastCableHighlightSignature&&i===this.lastCableHealthSignature)return s;const n=this.healthByCableId,l=new ts({id:t,data:ce,getPath:o=>o.points,getColor:o=>{if(e.has(o.id))return j.cableHighlight;const c=n[o.id];return(c==null?void 0:c.status)==="fault"?j.cableFault:(c==null?void 0:c.status)==="degraded"?j.cableDegraded:j.cable},getWidth:o=>{if(e.has(o.id))return 3;const c=n[o.id];return(c==null?void 0:c.status)==="fault"?2.5:(c==null?void 0:c.status)==="degraded"?2:1},widthMinPixels:1,widthMaxPixels:5,pickable:!0,updateTriggers:{highlighted:a,health:i}});return this.lastCableHighlightSignature=a,this.lastCableHealthSignature=i,this.layerCache.set(t,l),l}createPipelinesLayer(){const e=this.highlightedAssets.pipeline,t="pipelines-layer",s=this.layerCache.get(t),a=this.getSetSignature(e);if(s&&a===this.lastPipelineHighlightSignature)return s;const i=new ts({id:t,data:Xe,getPath:n=>n.points,getColor:n=>{if(e.has(n.id))return[255,100,100,200];const l=n.type,o=ga[l]||"#666666";return this.hexToRgba(o,150)},getWidth:n=>e.has(n.id)?3:1.5,widthMinPixels:1,widthMaxPixels:4,pickable:!0,updateTriggers:{highlighted:a}});return this.lastPipelineHighlightSignature=a,this.layerCache.set(t,i),i}createConflictZonesLayer(){const e="conflict-zones-layer",t={type:"FeatureCollection",features:Le.map(a=>({type:"Feature",properties:{id:a.id,name:a.name,intensity:a.intensity},geometry:{type:"Polygon",coordinates:[a.coords]}}))};return new Ya({id:e,data:t,filled:!0,stroked:!0,getFillColor:()=>j.conflict,getLineColor:()=>le()==="light"?[255,0,0,120]:[255,0,0,180],getLineWidth:2,lineWidthMinPixels:1,pickable:!0})}createBasesLayer(){var n;const e=this.highlightedAssets.base,t=((n=this.maplibreMap)==null?void 0:n.getZoom())||3,s=Math.min(1,(t-2.5)/2.5),a=Math.round(160*Math.max(.3,s)),i=l=>{switch(l){case"us-nato":return[68,136,255,a];case"russia":return[255,68,68,a];case"china":return[255,136,68,a];case"uk":return[68,170,255,a];case"france":return[0,85,164,a];case"india":return[255,153,51,a];case"japan":return[188,0,45,a];default:return[136,136,136,a]}};return new mt({id:"bases-layer",data:De,getPosition:l=>[l.lon,l.lat],getIcon:()=>"triangleUp",iconAtlas:xt.triangleUp,iconMapping:{triangleUp:{x:0,y:0,width:32,height:32,mask:!0}},getSize:l=>e.has(l.id)?16:11,getColor:l=>e.has(l.id)?[255,100,100,220]:i(l.type),sizeScale:1,sizeMinPixels:6,sizeMaxPixels:16,pickable:!0})}createNuclearLayer(){const e=this.highlightedAssets.nuclear,t=Ne.filter(s=>s.status!=="decommissioned");return new mt({id:"nuclear-layer",data:t,getPosition:s=>[s.lon,s.lat],getIcon:()=>"hexagon",iconAtlas:xt.hexagon,iconMapping:{hexagon:{x:0,y:0,width:32,height:32,mask:!0}},getSize:s=>e.has(s.id)?15:11,getColor:s=>e.has(s.id)?[255,100,100,220]:s.status==="contested"?[255,50,50,200]:[255,220,0,200],sizeScale:1,sizeMinPixels:6,sizeMaxPixels:15,pickable:!0})}createIrradiatorsLayer(){return new R({id:"irradiators-layer",data:Qe,getPosition:e=>[e.lon,e.lat],getRadius:6e3,getFillColor:[255,100,255,180],radiusMinPixels:4,radiusMaxPixels:10,pickable:!0})}createSpaceportsLayer(){return new R({id:"spaceports-layer",data:ya,getPosition:e=>[e.lon,e.lat],getRadius:1e4,getFillColor:[200,100,255,200],radiusMinPixels:5,radiusMaxPixels:12,pickable:!0})}createPortsLayer(){return new R({id:"ports-layer",data:Gt,getPosition:e=>[e.lon,e.lat],getRadius:6e3,getFillColor:e=>{switch(e.type){case"naval":return[100,150,255,200];case"oil":return[255,140,0,200];case"lng":return[255,200,50,200];case"container":return[0,200,255,180];case"mixed":return[150,200,150,180];case"bulk":return[180,150,120,180];default:return[0,200,255,160]}},radiusMinPixels:4,radiusMaxPixels:10,pickable:!0})}createFlightDelaysLayer(e){return new R({id:"flight-delays-layer",data:e,getPosition:t=>[t.lon,t.lat],getRadius:t=>t.severity==="GDP"?15e3:t.severity==="GS"?12e3:8e3,getFillColor:t=>t.severity==="GS"?[255,50,50,200]:t.severity==="GDP"?[255,150,0,200]:[255,200,100,180],radiusMinPixels:4,radiusMaxPixels:15,pickable:!0})}createGhostLayer(e,t,s,a={}){return new R({id:`${e}-ghost`,data:t,getPosition:s,getRadius:1,radiusMinPixels:a.radiusMinPixels??12,getFillColor:[0,0,0,0],pickable:!0})}createDatacentersLayer(){const e=this.highlightedAssets.datacenter,t=Se.filter(s=>s.status!=="decommissioned");return new mt({id:"datacenters-layer",data:t,getPosition:s=>[s.lon,s.lat],getIcon:()=>"square",iconAtlas:xt.square,iconMapping:{square:{x:0,y:0,width:32,height:32,mask:!0}},getSize:s=>e.has(s.id)?14:10,getColor:s=>e.has(s.id)?[255,100,100,200]:s.status==="planned"?[136,68,255,100]:[136,68,255,140],sizeScale:1,sizeMinPixels:6,sizeMaxPixels:14,pickable:!0})}createEarthquakesLayer(e){return new R({id:"earthquakes-layer",data:e,getPosition:t=>{var s,a;return[((s=t.location)==null?void 0:s.longitude)??0,((a=t.location)==null?void 0:a.latitude)??0]},getRadius:t=>Math.pow(2,t.magnitude)*1e3,getFillColor:t=>{const s=t.magnitude;return s>=6?[255,0,0,200]:s>=5?[255,100,0,200]:j.earthquake},radiusMinPixels:4,radiusMaxPixels:30,pickable:!0})}createNaturalEventsLayer(e){return new R({id:"natural-events-layer",data:e,getPosition:t=>[t.lon,t.lat],getRadius:t=>t.title.startsWith("üî¥")?2e4:t.title.startsWith("üü†")?15e3:8e3,getFillColor:t=>t.title.startsWith("üî¥")?[255,0,0,220]:t.title.startsWith("üü†")?[255,140,0,200]:[255,150,50,180],radiusMinPixels:5,radiusMaxPixels:18,pickable:!0})}createFiresLayer(){return new R({id:"fires-layer",data:this.firmsFireData,getPosition:e=>[e.lon,e.lat],getRadius:e=>Math.min(e.frp*200,3e4)||5e3,getFillColor:e=>e.brightness>400?[255,30,0,220]:e.brightness>350?[255,140,0,200]:[255,220,50,180],radiusMinPixels:3,radiusMaxPixels:12,pickable:!0})}createWeatherLayer(e){const t=e.filter(s=>s.centroid&&s.centroid.length===2);return new R({id:"weather-layer",data:t,getPosition:s=>s.centroid,getRadius:25e3,getFillColor:s=>s.severity==="Extreme"?[255,0,0,200]:s.severity==="Severe"?[255,100,0,180]:s.severity==="Moderate"?[255,170,0,160]:j.weather,radiusMinPixels:8,radiusMaxPixels:20,pickable:!0})}createOutagesLayer(e){return new R({id:"outages-layer",data:e,getPosition:t=>[t.lon,t.lat],getRadius:2e4,getFillColor:j.outage,radiusMinPixels:6,radiusMaxPixels:18,pickable:!0})}createCyberThreatsLayer(){return new R({id:"cyber-threats-layer",data:this.cyberThreats,getPosition:e=>[e.lon,e.lat],getRadius:e=>{switch(e.severity){case"critical":return 22e3;case"high":return 17e3;case"medium":return 13e3;default:return 9e3}},getFillColor:e=>{switch(e.severity){case"critical":return[255,61,0,225];case"high":return[255,102,0,205];case"medium":return[255,176,0,185];default:return[255,235,59,170]}},radiusMinPixels:6,radiusMaxPixels:18,pickable:!0,stroked:!0,getLineColor:[255,255,255,160],lineWidthMinPixels:1})}createAisDensityLayer(){return new R({id:"ais-density-layer",data:this.aisDensity,getPosition:e=>[e.lon,e.lat],getRadius:e=>4e3+e.intensity*8e3,getFillColor:e=>{const t=Math.min(Math.max(e.intensity,.15),1),s=(e.deltaPct||0)>=15,a=Math.round(40+t*160);return s?[255,183,3,a]:[0,209,255,a]},radiusMinPixels:4,radiusMaxPixels:12,pickable:!0})}createAisDisruptionsLayer(){return new R({id:"ais-disruptions-layer",data:this.aisDisruptions,getPosition:e=>[e.lon,e.lat],getRadius:12e3,getFillColor:e=>e.severity==="high"||e.type==="spoofing"?[255,50,50,220]:e.severity==="medium"?[255,150,0,200]:[255,200,100,180],radiusMinPixels:6,radiusMaxPixels:14,pickable:!0,stroked:!0,getLineColor:[255,255,255,150],lineWidthMinPixels:1})}createCableAdvisoriesLayer(e){return new R({id:"cable-advisories-layer",data:e,getPosition:t=>[t.lon,t.lat],getRadius:1e4,getFillColor:t=>t.severity==="fault"?[255,50,50,220]:[255,200,0,200],radiusMinPixels:5,radiusMaxPixels:12,pickable:!0,stroked:!0,getLineColor:[0,200,255,200],lineWidthMinPixels:2})}createRepairShipsLayer(){return new R({id:"repair-ships-layer",data:this.repairShips,getPosition:e=>[e.lon,e.lat],getRadius:8e3,getFillColor:[0,255,200,200],radiusMinPixels:4,radiusMaxPixels:10,pickable:!0})}createMilitaryVesselsLayer(e){return new R({id:"military-vessels-layer",data:e,getPosition:t=>[t.lon,t.lat],getRadius:6e3,getFillColor:t=>t.usniSource?[255,160,60,160]:j.vesselMilitary,radiusMinPixels:4,radiusMaxPixels:10,pickable:!0,stroked:!0,getLineColor:t=>t.usniSource?[255,180,80,200]:[0,0,0,0],lineWidthMinPixels:2})}createMilitaryVesselClustersLayer(e){return new R({id:"military-vessel-clusters-layer",data:e,getPosition:t=>[t.lon,t.lat],getRadius:t=>15e3+(t.vesselCount||1)*3e3,getFillColor:t=>{const s=t.activityType||"unknown";return s==="exercise"||s==="deployment"?[255,100,100,200]:s==="transit"?[255,180,100,180]:[200,150,150,160]},radiusMinPixels:8,radiusMaxPixels:25,pickable:!0})}createMilitaryFlightsLayer(e){return new R({id:"military-flights-layer",data:e,getPosition:t=>[t.lon,t.lat],getRadius:8e3,getFillColor:j.flightMilitary,radiusMinPixels:4,radiusMaxPixels:12,pickable:!0})}createMilitaryFlightClustersLayer(e){return new R({id:"military-flight-clusters-layer",data:e,getPosition:t=>[t.lon,t.lat],getRadius:t=>15e3+(t.flightCount||1)*3e3,getFillColor:t=>{const s=t.activityType||"unknown";return s==="exercise"||s==="patrol"?[100,150,255,200]:s==="transport"?[255,200,100,180]:[150,150,200,160]},radiusMinPixels:8,radiusMaxPixels:25,pickable:!0})}createWaterwaysLayer(){return new R({id:"waterways-layer",data:Ca,getPosition:e=>[e.lon,e.lat],getRadius:1e4,getFillColor:[100,150,255,180],radiusMinPixels:5,radiusMaxPixels:12,pickable:!0})}createEconomicCentersLayer(){return new R({id:"economic-centers-layer",data:ma,getPosition:e=>[e.lon,e.lat],getRadius:8e3,getFillColor:[255,215,0,180],radiusMinPixels:4,radiusMaxPixels:10,pickable:!0})}createStockExchangesLayer(){return new R({id:"stock-exchanges-layer",data:jt,getPosition:e=>[e.lon,e.lat],getRadius:e=>e.tier==="mega"?18e3:e.tier==="major"?14e3:11e3,getFillColor:e=>e.tier==="mega"?[255,215,80,220]:e.tier==="major"?j.stockExchange:[140,210,255,190],radiusMinPixels:5,radiusMaxPixels:14,pickable:!0})}createFinancialCentersLayer(){return new R({id:"financial-centers-layer",data:Vt,getPosition:e=>[e.lon,e.lat],getRadius:e=>e.type==="global"?17e3:e.type==="regional"?13e3:1e4,getFillColor:e=>e.type==="global"?j.financialCenter:e.type==="regional"?[0,190,130,185]:[0,150,110,165],radiusMinPixels:4,radiusMaxPixels:12,pickable:!0})}createCentralBanksLayer(){return new R({id:"central-banks-layer",data:Wt,getPosition:e=>[e.lon,e.lat],getRadius:e=>e.type==="major"?15e3:e.type==="supranational"?17e3:12e3,getFillColor:e=>e.type==="major"?j.centralBank:e.type==="supranational"?[255,235,140,220]:[235,180,80,185],radiusMinPixels:4,radiusMaxPixels:12,pickable:!0})}createCommodityHubsLayer(){return new R({id:"commodity-hubs-layer",data:Yt,getPosition:e=>[e.lon,e.lat],getRadius:e=>e.type==="exchange"?14e3:e.type==="port"?12e3:1e4,getFillColor:e=>e.type==="exchange"?j.commodityHub:e.type==="port"?[80,170,255,190]:[255,110,80,185],radiusMinPixels:4,radiusMaxPixels:11,pickable:!0})}createAPTGroupsLayer(){return new R({id:"apt-groups-layer",data:wa,getPosition:e=>[e.lon,e.lat],getRadius:6e3,getFillColor:[255,140,0,140],radiusMinPixels:4,radiusMaxPixels:8,pickable:!0,stroked:!1})}createMineralsLayer(){return new R({id:"minerals-layer",data:va,getPosition:e=>[e.lon,e.lat],getRadius:8e3,getFillColor:e=>{switch(e.mineral){case"Lithium":return[0,200,255,200];case"Cobalt":return[100,100,255,200];case"Rare Earths":return[255,100,200,200];case"Nickel":return[100,255,100,200];default:return[200,200,200,200]}},radiusMinPixels:5,radiusMaxPixels:12,pickable:!0})}createStartupHubsLayer(){return new R({id:"startup-hubs-layer",data:fa,getPosition:e=>[e.lon,e.lat],getRadius:1e4,getFillColor:j.startupHub,radiusMinPixels:5,radiusMaxPixels:12,pickable:!0})}createAcceleratorsLayer(){return new R({id:"accelerators-layer",data:qt,getPosition:e=>[e.lon,e.lat],getRadius:6e3,getFillColor:j.accelerator,radiusMinPixels:3,radiusMaxPixels:8,pickable:!0})}createCloudRegionsLayer(){return new R({id:"cloud-regions-layer",data:ba,getPosition:e=>[e.lon,e.lat],getRadius:12e3,getFillColor:j.cloudRegion,radiusMinPixels:4,radiusMaxPixels:12,pickable:!0})}createProtestClusterLayers(){this.updateClusterData();const e=[];e.push(new R({id:"protest-clusters-layer",data:this.protestClusters,getPosition:a=>[a.lon,a.lat],getRadius:a=>15e3+a.count*2e3,radiusMinPixels:6,radiusMaxPixels:22,getFillColor:a=>a.hasRiot?[220,40,40,200]:a.maxSeverity==="high"?[255,80,60,180]:a.maxSeverity==="medium"?[255,160,40,160]:[255,220,80,140],pickable:!0,updateTriggers:{getRadius:this.lastSCZoom,getFillColor:this.lastSCZoom}})),e.push(this.createGhostLayer("protest-clusters-layer",this.protestClusters,a=>[a.lon,a.lat],{radiusMinPixels:14}));const t=this.protestClusters.filter(a=>a.count>1);t.length>0&&e.push(new ze({id:"protest-clusters-badge",data:t,getText:a=>String(a.count),getPosition:a=>[a.lon,a.lat],background:!0,getBackgroundColor:[0,0,0,180],backgroundPadding:[4,2,4,2],getColor:[255,255,255,255],getSize:12,getPixelOffset:[0,-14],pickable:!1,fontFamily:"system-ui, sans-serif",fontWeight:700}));const s=this.protestClusters.filter(a=>a.maxSeverity==="high"||a.hasRiot);if(s.length>0){const a=1+.8*(.5+.5*Math.sin((this.pulseTime||Date.now())/400));e.push(new R({id:"protest-clusters-pulse",data:s,getPosition:i=>[i.lon,i.lat],getRadius:i=>15e3+i.count*2e3,radiusScale:a,radiusMinPixels:8,radiusMaxPixels:30,stroked:!0,filled:!1,getLineColor:i=>i.hasRiot?[220,40,40,120]:[255,80,60,100],lineWidthMinPixels:1.5,pickable:!1,updateTriggers:{radiusScale:this.pulseTime}}))}return e}createTechHQClusterLayers(){var a;this.updateClusterData();const e=[],t=((a=this.maplibreMap)==null?void 0:a.getZoom())||2;e.push(new R({id:"tech-hq-clusters-layer",data:this.techHQClusters,getPosition:i=>[i.lon,i.lat],getRadius:i=>1e4+i.count*1500,radiusMinPixels:5,radiusMaxPixels:18,getFillColor:i=>i.primaryType==="faang"?[0,220,120,200]:i.primaryType==="unicorn"?[255,100,200,180]:[80,160,255,180],pickable:!0,updateTriggers:{getRadius:this.lastSCZoom}})),e.push(this.createGhostLayer("tech-hq-clusters-layer",this.techHQClusters,i=>[i.lon,i.lat],{radiusMinPixels:14}));const s=this.techHQClusters.filter(i=>i.count>1);if(s.length>0&&e.push(new ze({id:"tech-hq-clusters-badge",data:s,getText:i=>String(i.count),getPosition:i=>[i.lon,i.lat],background:!0,getBackgroundColor:[0,0,0,180],backgroundPadding:[4,2,4,2],getColor:[255,255,255,255],getSize:12,getPixelOffset:[0,-14],pickable:!1,fontFamily:"system-ui, sans-serif",fontWeight:700})),t>=3){const i=this.techHQClusters.filter(n=>n.count===1);i.length>0&&e.push(new ze({id:"tech-hq-clusters-label",data:i,getText:n=>{var l;return((l=n.items[0])==null?void 0:l.company)??""},getPosition:n=>[n.lon,n.lat],getSize:11,getColor:[220,220,220,200],getPixelOffset:[0,12],pickable:!1,fontFamily:"system-ui, sans-serif"}))}return e}createTechEventClusterLayers(){this.updateClusterData();const e=[];e.push(new R({id:"tech-event-clusters-layer",data:this.techEventClusters,getPosition:s=>[s.lon,s.lat],getRadius:s=>1e4+s.count*1500,radiusMinPixels:5,radiusMaxPixels:18,getFillColor:s=>s.soonestDaysUntil<=14?[255,220,50,200]:[80,140,255,180],pickable:!0,updateTriggers:{getRadius:this.lastSCZoom}})),e.push(this.createGhostLayer("tech-event-clusters-layer",this.techEventClusters,s=>[s.lon,s.lat],{radiusMinPixels:14}));const t=this.techEventClusters.filter(s=>s.count>1);return t.length>0&&e.push(new ze({id:"tech-event-clusters-badge",data:t,getText:s=>String(s.count),getPosition:s=>[s.lon,s.lat],background:!0,getBackgroundColor:[0,0,0,180],backgroundPadding:[4,2,4,2],getColor:[255,255,255,255],getSize:12,getPixelOffset:[0,-14],pickable:!1,fontFamily:"system-ui, sans-serif",fontWeight:700})),e}createDatacenterClusterLayers(){this.updateClusterData();const e=[];e.push(new R({id:"datacenter-clusters-layer",data:this.datacenterClusters,getPosition:s=>[s.lon,s.lat],getRadius:s=>15e3+s.count*2e3,radiusMinPixels:6,radiusMaxPixels:20,getFillColor:s=>s.majorityExisting?[160,80,255,180]:[80,160,255,180],pickable:!0,updateTriggers:{getRadius:this.lastSCZoom}})),e.push(this.createGhostLayer("datacenter-clusters-layer",this.datacenterClusters,s=>[s.lon,s.lat],{radiusMinPixels:14}));const t=this.datacenterClusters.filter(s=>s.count>1);return t.length>0&&e.push(new ze({id:"datacenter-clusters-badge",data:t,getText:s=>String(s.count),getPosition:s=>[s.lon,s.lat],background:!0,getBackgroundColor:[0,0,0,180],backgroundPadding:[4,2,4,2],getColor:[255,255,255,255],getSize:12,getPixelOffset:[0,-14],pickable:!1,fontFamily:"system-ui, sans-serif",fontWeight:700})),e}createHotspotsLayers(){var l;const e=((l=this.maplibreMap)==null?void 0:l.getZoom())||2,t=Math.min(1,(e-1)/3),s=6+Math.round(14*t),a=e<2.5?.5:e<4?.7:1,i=[];i.push(new R({id:"hotspots-layer",data:this.hotspots,getPosition:o=>[o.lon,o.lat],getRadius:o=>1e4+(o.escalationScore||1)*5e3,getFillColor:o=>{const c=o.escalationScore||1,h=Math.round((c>=4||c>=2?200:180)*a);return c>=4?[255,68,68,h]:c>=2?[255,165,0,h]:[255,255,0,h]},radiusMinPixels:4,radiusMaxPixels:s,pickable:!0,stroked:!0,getLineColor:o=>o.hasBreaking?[255,255,255,255]:[0,0,0,0],lineWidthMinPixels:2})),i.push(this.createGhostLayer("hotspots-layer",this.hotspots,o=>[o.lon,o.lat],{radiusMinPixels:14}));const n=this.hotspots.filter(o=>o.level==="high"||o.hasBreaking);if(n.length>0){const o=1+.8*(.5+.5*Math.sin((this.pulseTime||Date.now())/400));i.push(new R({id:"hotspots-pulse",data:n,getPosition:c=>[c.lon,c.lat],getRadius:c=>1e4+(c.escalationScore||1)*5e3,radiusScale:o,radiusMinPixels:6,radiusMaxPixels:30,stroked:!0,filled:!1,getLineColor:c=>{const h=Math.round(120*a);return c.hasBreaking?[255,50,50,h]:[255,165,0,h]},lineWidthMinPixels:1.5,pickable:!1,updateTriggers:{radiusScale:this.pulseTime}}))}return i}createGulfInvestmentsLayer(){return new R({id:"gulf-investments-layer",data:pi,getPosition:e=>[e.lon,e.lat],getRadius:e=>e.investmentUSD?e.investmentUSD>=5e4?7e4:e.investmentUSD>=1e4?55e3:e.investmentUSD>=1e3?4e4:25e3:2e4,getFillColor:e=>e.investingCountry==="SA"?j.gulfInvestmentSA:j.gulfInvestmentUAE,getLineColor:[255,255,255,80],lineWidthMinPixels:1,radiusMinPixels:5,radiusMaxPixels:28,pickable:!0})}canPulse(e=Date.now()){return e-this.startupTime>6e4}hasRecentRiot(e=Date.now(),t=7200*1e3){return this.protestClusters.some(a=>a.hasRiot&&a.latestRiotEventTimeMs!=null&&e-a.latestRiotEventTimeMs<t)?!0:this.protests.some(a=>{if(a.eventType!=="riot"||a.sourceType==="gdelt")return!1;const i=a.time.getTime();return Number.isFinite(i)&&e-i<t})}needsPulseAnimation(e=Date.now()){return this.hasRecentNews(e)||this.hasRecentRiot(e)||this.hotspots.some(t=>t.hasBreaking)}syncPulseAnimation(e=Date.now()){if(this.renderPaused){this.newsPulseIntervalId!==null&&this.stopPulseAnimation();return}const t=this.canPulse(e)&&this.needsPulseAnimation(e);t&&this.newsPulseIntervalId===null?this.startPulseAnimation():!t&&this.newsPulseIntervalId!==null&&this.stopPulseAnimation()}startPulseAnimation(){if(this.newsPulseIntervalId!==null)return;const e=500;this.newsPulseIntervalId=setInterval(()=>{const t=Date.now();if(!this.needsPulseAnimation(t)){this.pulseTime=t,this.stopPulseAnimation(),this.rafUpdateLayers();return}this.pulseTime=t,this.rafUpdateLayers()},e)}stopPulseAnimation(){this.newsPulseIntervalId!==null&&(clearInterval(this.newsPulseIntervalId),this.newsPulseIntervalId=null)}createNewsLocationsLayer(){var h;const e=((h=this.maplibreMap)==null?void 0:h.getZoom())||2,t=e<2.5?.4:e<4?.7:1,s=this.filterByTime(this.newsLocations,d=>d.timestamp),a={critical:[239,68,68],high:[249,115,22],medium:[234,179,8],low:[34,197,94],info:[59,130,246]},i={critical:220,high:190,medium:160,low:120,info:80},n=this.pulseTime||Date.now(),l=3e4,o=[new R({id:"news-locations-layer",data:s,getPosition:d=>[d.lon,d.lat],getRadius:18e3,getFillColor:d=>{const g=a[d.threatLevel]||[59,130,246],u=Math.round((i[d.threatLevel]||120)*t);return[...g,u]},radiusMinPixels:3,radiusMaxPixels:12,pickable:!0})],c=s.filter(d=>{const g=this.newsLocationFirstSeen.get(d.title);return g&&n-g<l});if(c.length>0){const d=1+1.5*(.5+.5*Math.sin(n/318));o.push(new R({id:"news-pulse-layer",data:c,getPosition:g=>[g.lon,g.lat],getRadius:18e3,radiusScale:d,radiusMinPixels:6,radiusMaxPixels:30,pickable:!1,stroked:!0,filled:!1,getLineColor:g=>{const u=a[g.threatLevel]||[59,130,246],v=this.newsLocationFirstSeen.get(g.title)||n,f=n-v,b=Math.max(0,1-f/l),k=Math.round(150*b*t);return[...u,k]},lineWidthMinPixels:1.5,updateTriggers:{pulseTime:n}}))}return o}getTooltip(e){var n,l,o,c,h,d,g;if(!e.object)return null;const t=((n=e.layer)==null?void 0:n.id)||"",s=t.endsWith("-ghost")?t.slice(0,-6):t,a=e.object,i=u=>m(String(u??""));switch(s){case"hotspots-layer":return{html:`<div class="deckgl-tooltip"><strong>${i(a.name)}</strong><br/>${i(a.subtext)}</div>`};case"earthquakes-layer":return{html:`<div class="deckgl-tooltip"><strong>M${(a.magnitude||0).toFixed(1)} ${r("components.deckgl.tooltip.earthquake")}</strong><br/>${i(a.place)}</div>`};case"military-vessels-layer":return{html:`<div class="deckgl-tooltip"><strong>${i(a.name)}</strong><br/>${i(a.operatorCountry)}</div>`};case"military-flights-layer":return{html:`<div class="deckgl-tooltip"><strong>${i(a.callsign||a.registration||r("components.deckgl.tooltip.militaryAircraft"))}</strong><br/>${i(a.type)}</div>`};case"military-vessel-clusters-layer":return{html:`<div class="deckgl-tooltip"><strong>${i(a.name||r("components.deckgl.tooltip.vesselCluster"))}</strong><br/>${a.vesselCount||0} ${r("components.deckgl.tooltip.vessels")}<br/>${i(a.activityType)}</div>`};case"military-flight-clusters-layer":return{html:`<div class="deckgl-tooltip"><strong>${i(a.name||r("components.deckgl.tooltip.flightCluster"))}</strong><br/>${a.flightCount||0} ${r("components.deckgl.tooltip.aircraft")}<br/>${i(a.activityType)}</div>`};case"protests-layer":return{html:`<div class="deckgl-tooltip"><strong>${i(a.title)}</strong><br/>${i(a.country)}</div>`};case"protest-clusters-layer":if(a.count===1){const u=(l=a.items)==null?void 0:l[0];return{html:`<div class="deckgl-tooltip"><strong>${i((u==null?void 0:u.title)||r("components.deckgl.tooltip.protest"))}</strong><br/>${i((u==null?void 0:u.city)||(u==null?void 0:u.country)||"")}</div>`}}return{html:`<div class="deckgl-tooltip"><strong>${r("components.deckgl.tooltip.protestsCount",{count:String(a.count)})}</strong><br/>${i(a.country)}</div>`};case"tech-hq-clusters-layer":if(a.count===1){const u=(o=a.items)==null?void 0:o[0];return{html:`<div class="deckgl-tooltip"><strong>${i((u==null?void 0:u.company)||"")}</strong><br/>${i((u==null?void 0:u.city)||"")}</div>`}}return{html:`<div class="deckgl-tooltip"><strong>${r("components.deckgl.tooltip.techHQsCount",{count:String(a.count)})}</strong><br/>${i(a.city)}</div>`};case"tech-event-clusters-layer":if(a.count===1){const u=(c=a.items)==null?void 0:c[0];return{html:`<div class="deckgl-tooltip"><strong>${i((u==null?void 0:u.title)||"")}</strong><br/>${i((u==null?void 0:u.location)||"")}</div>`}}return{html:`<div class="deckgl-tooltip"><strong>${r("components.deckgl.tooltip.techEventsCount",{count:String(a.count)})}</strong><br/>${i(a.location)}</div>`};case"datacenter-clusters-layer":if(a.count===1){const u=(h=a.items)==null?void 0:h[0];return{html:`<div class="deckgl-tooltip"><strong>${i((u==null?void 0:u.name)||"")}</strong><br/>${i((u==null?void 0:u.owner)||"")}</div>`}}return{html:`<div class="deckgl-tooltip"><strong>${r("components.deckgl.tooltip.dataCentersCount",{count:String(a.count)})}</strong><br/>${i(a.country)}</div>`};case"bases-layer":return{html:`<div class="deckgl-tooltip"><strong>${i(a.name)}</strong><br/>${i(a.country)}</div>`};case"nuclear-layer":return{html:`<div class="deckgl-tooltip"><strong>${i(a.name)}</strong><br/>${i(a.type)}</div>`};case"datacenters-layer":return{html:`<div class="deckgl-tooltip"><strong>${i(a.name)}</strong><br/>${i(a.owner)}</div>`};case"cables-layer":return{html:`<div class="deckgl-tooltip"><strong>${i(a.name)}</strong><br/>${r("components.deckgl.tooltip.underseaCable")}</div>`};case"pipelines-layer":{const u=String(a.type||"").toLowerCase(),v=u==="oil"?r("popups.pipeline.types.oil"):u==="gas"?r("popups.pipeline.types.gas"):u==="products"?r("popups.pipeline.types.products"):`${i(a.type)} ${r("components.deckgl.tooltip.pipeline")}`;return{html:`<div class="deckgl-tooltip"><strong>${i(a.name)}</strong><br/>${v}</div>`}}case"conflict-zones-layer":{const u=a.properties||a;return{html:`<div class="deckgl-tooltip"><strong>${i(u.name)}</strong><br/>${r("components.deckgl.tooltip.conflictZone")}</div>`}}case"natural-events-layer":return{html:`<div class="deckgl-tooltip"><strong>${i(a.title)}</strong><br/>${i(a.category||r("components.deckgl.tooltip.naturalEvent"))}</div>`};case"ais-density-layer":return{html:`<div class="deckgl-tooltip"><strong>${r("components.deckgl.layers.shipTraffic")}</strong><br/>${r("popups.intensity")}: ${i(a.intensity)}</div>`};case"waterways-layer":return{html:`<div class="deckgl-tooltip"><strong>${i(a.name)}</strong><br/>${r("components.deckgl.layers.strategicWaterways")}</div>`};case"economic-centers-layer":return{html:`<div class="deckgl-tooltip"><strong>${i(a.name)}</strong><br/>${i(a.country)}</div>`};case"stock-exchanges-layer":return{html:`<div class="deckgl-tooltip"><strong>${i(a.shortName)}</strong><br/>${i(a.city)}, ${i(a.country)}</div>`};case"financial-centers-layer":return{html:`<div class="deckgl-tooltip"><strong>${i(a.name)}</strong><br/>${i(a.type)} ${r("components.deckgl.tooltip.financialCenter")}</div>`};case"central-banks-layer":return{html:`<div class="deckgl-tooltip"><strong>${i(a.shortName)}</strong><br/>${i(a.city)}, ${i(a.country)}</div>`};case"commodity-hubs-layer":return{html:`<div class="deckgl-tooltip"><strong>${i(a.name)}</strong><br/>${i(a.type)} ¬∑ ${i(a.city)}</div>`};case"startup-hubs-layer":return{html:`<div class="deckgl-tooltip"><strong>${i(a.city)}</strong><br/>${i(a.country)}</div>`};case"tech-hqs-layer":return{html:`<div class="deckgl-tooltip"><strong>${i(a.company)}</strong><br/>${i(a.city)}</div>`};case"accelerators-layer":return{html:`<div class="deckgl-tooltip"><strong>${i(a.name)}</strong><br/>${i(a.city)}</div>`};case"cloud-regions-layer":return{html:`<div class="deckgl-tooltip"><strong>${i(a.provider)}</strong><br/>${i(a.region)}</div>`};case"tech-events-layer":return{html:`<div class="deckgl-tooltip"><strong>${i(a.title)}</strong><br/>${i(a.location)}</div>`};case"irradiators-layer":return{html:`<div class="deckgl-tooltip"><strong>${i(a.name)}</strong><br/>${i(a.type||r("components.deckgl.layers.gammaIrradiators"))}</div>`};case"spaceports-layer":return{html:`<div class="deckgl-tooltip"><strong>${i(a.name)}</strong><br/>${i(a.country||r("components.deckgl.layers.spaceports"))}</div>`};case"ports-layer":return{html:`<div class="deckgl-tooltip"><strong>${a.type==="naval"?"‚öì":a.type==="oil"||a.type==="lng"?"üõ¢Ô∏è":"üè≠"} ${i(a.name)}</strong><br/>${i(a.type||r("components.deckgl.tooltip.port"))} - ${i(a.country)}</div>`};case"flight-delays-layer":return{html:`<div class="deckgl-tooltip"><strong>${i(a.airport)}</strong><br/>${i(a.severity)}: ${i(a.reason)}</div>`};case"apt-groups-layer":return{html:`<div class="deckgl-tooltip"><strong>${i(a.name)}</strong><br/>${i(a.aka)}<br/>${r("popups.sponsor")}: ${i(a.sponsor)}</div>`};case"minerals-layer":return{html:`<div class="deckgl-tooltip"><strong>${i(a.name)}</strong><br/>${i(a.mineral)} - ${i(a.country)}<br/>${i(a.operator)}</div>`};case"ais-disruptions-layer":return{html:`<div class="deckgl-tooltip"><strong>AIS ${i(a.type||r("components.deckgl.tooltip.disruption"))}</strong><br/>${i(a.severity)} ${r("popups.severity")}<br/>${i(a.description)}</div>`};case"cable-advisories-layer":{const u=((d=ce.find(v=>v.id===a.cableId))==null?void 0:d.name)||a.cableId;return{html:`<div class="deckgl-tooltip"><strong>${i(u)}</strong><br/>${i(a.severity||r("components.deckgl.tooltip.advisory"))}<br/>${i(a.description)}</div>`}}case"repair-ships-layer":return{html:`<div class="deckgl-tooltip"><strong>${i(a.name||r("components.deckgl.tooltip.repairShip"))}</strong><br/>${i(a.status)}</div>`};case"weather-layer":{const u=typeof a.areaDesc=="string"?a.areaDesc:"",v=u?`<br/><small>${i(u.slice(0,50))}${u.length>50?"...":""}</small>`:"";return{html:`<div class="deckgl-tooltip"><strong>${i(a.event||r("components.deckgl.layers.weatherAlerts"))}</strong><br/>${i(a.severity)}${v}</div>`}}case"outages-layer":return{html:`<div class="deckgl-tooltip"><strong>${i(a.asn||r("components.deckgl.tooltip.internetOutage"))}</strong><br/>${i(a.country)}</div>`};case"cyber-threats-layer":return{html:`<div class="deckgl-tooltip"><strong>${r("popups.cyberThreat.title")}</strong><br/>${i(a.severity||r("components.deckgl.tooltip.medium"))} ¬∑ ${i(a.country||r("popups.unknown"))}</div>`};case"news-locations-layer":return{html:`<div class="deckgl-tooltip"><strong>üì∞ ${r("components.deckgl.tooltip.news")}</strong><br/>${i(((g=a.title)==null?void 0:g.slice(0,80))||"")}</div>`};case"gulf-investments-layer":{const u=a,v=u.investingCountry==="SA"?"üá∏üá¶":"üá¶üá™",f=u.investmentUSD!=null?u.investmentUSD>=1e3?`$${(u.investmentUSD/1e3).toFixed(1)}B`:`$${u.investmentUSD}M`:r("components.deckgl.tooltip.undisclosed"),b=u.stakePercent!=null?`<br/>${i(String(u.stakePercent))}% ${r("components.deckgl.tooltip.stake")}`:"";return{html:`<div class="deckgl-tooltip">
            <strong>${v} ${i(u.assetName)}</strong><br/>
            <em>${i(u.investingEntity)}</em><br/>
            ${i(u.targetCountry)} ¬∑ ${i(u.sector)}<br/>
            <strong>${f}</strong>${b}<br/>
            <span style="text-transform:capitalize">${i(u.status)}</span>
          </div>`}}default:return null}}handleClick(e){var c,h;if(!e.object){if(e.coordinate&&this.onCountryClick){const[d,g]=e.coordinate,u=this.resolveCountryFromCoordinate(d,g);this.onCountryClick({lat:g,lon:d,...u?{code:u.code,name:u.name}:{}})}return}const t=((c=e.layer)==null?void 0:c.id)||"",s=t.endsWith("-ghost")?t.slice(0,-6):t;if(s==="hotspots-layer"){const d=e.object,g=this.getRelatedNews(d);this.popup.show({type:"hotspot",data:d,relatedNews:g,x:e.x,y:e.y}),this.popup.loadHotspotGdeltContext(d),(h=this.onHotspotClick)==null||h.call(this,d);return}if(s==="protest-clusters-layer"){const d=e.object;d.count===1&&d.items[0]?this.popup.show({type:"protest",data:d.items[0],x:e.x,y:e.y}):this.popup.show({type:"protestCluster",data:{items:d.items,country:d.country,count:d.count,riotCount:d.riotCount,highSeverityCount:d.highSeverityCount,verifiedCount:d.verifiedCount,totalFatalities:d.totalFatalities,sampled:d.sampled},x:e.x,y:e.y});return}if(s==="tech-hq-clusters-layer"){const d=e.object;d.count===1&&d.items[0]?this.popup.show({type:"techHQ",data:d.items[0],x:e.x,y:e.y}):this.popup.show({type:"techHQCluster",data:{items:d.items,city:d.city,country:d.country,count:d.count,faangCount:d.faangCount,unicornCount:d.unicornCount,publicCount:d.publicCount,sampled:d.sampled},x:e.x,y:e.y});return}if(s==="tech-event-clusters-layer"){const d=e.object;d.count===1&&d.items[0]?this.popup.show({type:"techEvent",data:d.items[0],x:e.x,y:e.y}):this.popup.show({type:"techEventCluster",data:{items:d.items,location:d.location,country:d.country,count:d.count,soonCount:d.soonCount,sampled:d.sampled},x:e.x,y:e.y});return}if(s==="datacenter-clusters-layer"){const d=e.object;d.count===1&&d.items[0]?this.popup.show({type:"datacenter",data:d.items[0],x:e.x,y:e.y}):this.popup.show({type:"datacenterCluster",data:{items:d.items,region:d.region||d.country,country:d.country,count:d.count,totalChips:d.totalChips,totalPowerMW:d.totalPowerMW,existingCount:d.existingCount,plannedCount:d.plannedCount,sampled:d.sampled},x:e.x,y:e.y});return}const i={"conflict-zones-layer":"conflict","bases-layer":"base","nuclear-layer":"nuclear","irradiators-layer":"irradiator","datacenters-layer":"datacenter","cables-layer":"cable","pipelines-layer":"pipeline","earthquakes-layer":"earthquake","weather-layer":"weather","outages-layer":"outage","cyber-threats-layer":"cyberThreat","protests-layer":"protest","military-flights-layer":"militaryFlight","military-vessels-layer":"militaryVessel","military-vessel-clusters-layer":"militaryVesselCluster","military-flight-clusters-layer":"militaryFlightCluster","natural-events-layer":"natEvent","waterways-layer":"waterway","economic-centers-layer":"economic","stock-exchanges-layer":"stockExchange","financial-centers-layer":"financialCenter","central-banks-layer":"centralBank","commodity-hubs-layer":"commodityHub","spaceports-layer":"spaceport","ports-layer":"port","flight-delays-layer":"flight","startup-hubs-layer":"startupHub","tech-hqs-layer":"techHQ","accelerators-layer":"accelerator","cloud-regions-layer":"cloudRegion","tech-events-layer":"techEvent","apt-groups-layer":"apt","minerals-layer":"mineral","ais-disruptions-layer":"ais","cable-advisories-layer":"cable-advisory","repair-ships-layer":"repair-ship"}[s];if(!i)return;let n=e.object;if(s==="conflict-zones-layer"&&e.object.properties){const d=e.object.properties.id,g=Le.find(u=>u.id===d);g&&(n=g)}const l=e.x??0,o=e.y??0;this.popup.show({type:i,data:n,x:l,y:o})}hexToRgba(e,t){const s=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return s&&s[1]&&s[2]&&s[3]?[parseInt(s[1],16),parseInt(s[2],16),parseInt(s[3],16),t]:[100,100,100,t]}createControls(){const e=document.createElement("div");e.className="map-controls deckgl-controls",e.innerHTML=`
      <div class="zoom-controls">
        <button class="map-btn zoom-in" title="${r("components.deckgl.zoomIn")}">+</button>
        <button class="map-btn zoom-out" title="${r("components.deckgl.zoomOut")}">-</button>
        <button class="map-btn zoom-reset" title="${r("components.deckgl.resetView")}">&#8962;</button>
      </div>
      <div class="view-selector">
        <select class="view-select">
          <option value="global">${r("components.deckgl.views.global")}</option>
          <option value="america">${r("components.deckgl.views.americas")}</option>
          <option value="mena">${r("components.deckgl.views.mena")}</option>
          <option value="eu">${r("components.deckgl.views.europe")}</option>
          <option value="asia">${r("components.deckgl.views.asia")}</option>
          <option value="latam">${r("components.deckgl.views.latam")}</option>
          <option value="africa">${r("components.deckgl.views.africa")}</option>
          <option value="oceania">${r("components.deckgl.views.oceania")}</option>
        </select>
      </div>
    `,this.container.appendChild(e),e.addEventListener("click",s=>{const a=s.target;a.classList.contains("zoom-in")?this.zoomIn():a.classList.contains("zoom-out")?this.zoomOut():a.classList.contains("zoom-reset")&&this.resetView()});const t=e.querySelector(".view-select");t.value=this.state.view,t.addEventListener("change",()=>{this.setView(t.value)})}createTimeSlider(){const e=document.createElement("div");e.className="time-slider deckgl-time-slider",e.innerHTML=`
      <div class="time-options">
        <button class="time-btn ${this.state.timeRange==="1h"?"active":""}" data-range="1h">1h</button>
        <button class="time-btn ${this.state.timeRange==="6h"?"active":""}" data-range="6h">6h</button>
        <button class="time-btn ${this.state.timeRange==="24h"?"active":""}" data-range="24h">24h</button>
        <button class="time-btn ${this.state.timeRange==="48h"?"active":""}" data-range="48h">48h</button>
        <button class="time-btn ${this.state.timeRange==="7d"?"active":""}" data-range="7d">7d</button>
        <button class="time-btn ${this.state.timeRange==="all"?"active":""}" data-range="all">${r("components.deckgl.timeAll")}</button>
      </div>
    `,this.container.appendChild(e),e.querySelectorAll(".time-btn").forEach(t=>{t.addEventListener("click",()=>{const s=t.dataset.range;this.setTimeRange(s)})})}updateTimeSliderButtons(){const e=this.container.querySelector(".deckgl-time-slider");e&&e.querySelectorAll(".time-btn").forEach(t=>{const s=t.dataset.range;t.classList.toggle("active",s===this.state.timeRange)})}createLayerToggles(){const e=document.createElement("div");e.className="layer-toggles deckgl-layer-toggles";const t=M==="tech"?[{key:"startupHubs",label:r("components.deckgl.layers.startupHubs"),icon:"&#128640;"},{key:"techHQs",label:r("components.deckgl.layers.techHQs"),icon:"&#127970;"},{key:"accelerators",label:r("components.deckgl.layers.accelerators"),icon:"&#9889;"},{key:"cloudRegions",label:r("components.deckgl.layers.cloudRegions"),icon:"&#9729;"},{key:"datacenters",label:r("components.deckgl.layers.aiDataCenters"),icon:"&#128421;"},{key:"cables",label:r("components.deckgl.layers.underseaCables"),icon:"&#128268;"},{key:"outages",label:r("components.deckgl.layers.internetOutages"),icon:"&#128225;"},{key:"cyberThreats",label:r("components.deckgl.layers.cyberThreats"),icon:"&#128737;"},{key:"techEvents",label:r("components.deckgl.layers.techEvents"),icon:"&#128197;"},{key:"natural",label:r("components.deckgl.layers.naturalEvents"),icon:"&#127755;"},{key:"fires",label:r("components.deckgl.layers.fires"),icon:"&#128293;"}]:M==="finance"?[{key:"stockExchanges",label:r("components.deckgl.layers.stockExchanges"),icon:"&#127963;"},{key:"financialCenters",label:r("components.deckgl.layers.financialCenters"),icon:"&#128176;"},{key:"centralBanks",label:r("components.deckgl.layers.centralBanks"),icon:"&#127974;"},{key:"commodityHubs",label:r("components.deckgl.layers.commodityHubs"),icon:"&#128230;"},{key:"gulfInvestments",label:r("components.deckgl.layers.gulfInvestments"),icon:"&#127760;"},{key:"cables",label:r("components.deckgl.layers.underseaCables"),icon:"&#128268;"},{key:"pipelines",label:r("components.deckgl.layers.pipelines"),icon:"&#128738;"},{key:"outages",label:r("components.deckgl.layers.internetOutages"),icon:"&#128225;"},{key:"weather",label:r("components.deckgl.layers.weatherAlerts"),icon:"&#9928;"},{key:"economic",label:r("components.deckgl.layers.economicCenters"),icon:"&#128176;"},{key:"waterways",label:r("components.deckgl.layers.strategicWaterways"),icon:"&#9875;"},{key:"natural",label:r("components.deckgl.layers.naturalEvents"),icon:"&#127755;"},{key:"cyberThreats",label:r("components.deckgl.layers.cyberThreats"),icon:"&#128737;"}]:[{key:"hotspots",label:r("components.deckgl.layers.intelHotspots"),icon:"&#127919;"},{key:"conflicts",label:r("components.deckgl.layers.conflictZones"),icon:"&#9876;"},{key:"bases",label:r("components.deckgl.layers.militaryBases"),icon:"&#127963;"},{key:"nuclear",label:r("components.deckgl.layers.nuclearSites"),icon:"&#9762;"},{key:"irradiators",label:r("components.deckgl.layers.gammaIrradiators"),icon:"&#9888;"},{key:"spaceports",label:r("components.deckgl.layers.spaceports"),icon:"&#128640;"},{key:"cables",label:r("components.deckgl.layers.underseaCables"),icon:"&#128268;"},{key:"pipelines",label:r("components.deckgl.layers.pipelines"),icon:"&#128738;"},{key:"datacenters",label:r("components.deckgl.layers.aiDataCenters"),icon:"&#128421;"},{key:"military",label:r("components.deckgl.layers.militaryActivity"),icon:"&#9992;"},{key:"ais",label:r("components.deckgl.layers.shipTraffic"),icon:"&#128674;"},{key:"flights",label:r("components.deckgl.layers.flightDelays"),icon:"&#9992;"},{key:"protests",label:r("components.deckgl.layers.protests"),icon:"&#128226;"},{key:"ucdpEvents",label:r("components.deckgl.layers.ucdpEvents"),icon:"&#9876;"},{key:"displacement",label:r("components.deckgl.layers.displacementFlows"),icon:"&#128101;"},{key:"climate",label:r("components.deckgl.layers.climateAnomalies"),icon:"&#127787;"},{key:"weather",label:r("components.deckgl.layers.weatherAlerts"),icon:"&#9928;"},{key:"outages",label:r("components.deckgl.layers.internetOutages"),icon:"&#128225;"},{key:"cyberThreats",label:r("components.deckgl.layers.cyberThreats"),icon:"&#128737;"},{key:"natural",label:r("components.deckgl.layers.naturalEvents"),icon:"&#127755;"},{key:"fires",label:r("components.deckgl.layers.fires"),icon:"&#128293;"},{key:"waterways",label:r("components.deckgl.layers.strategicWaterways"),icon:"&#9875;"},{key:"economic",label:r("components.deckgl.layers.economicCenters"),icon:"&#128176;"},{key:"minerals",label:r("components.deckgl.layers.criticalMinerals"),icon:"&#128142;"}];e.innerHTML=`
      <div class="toggle-header">
        <span>${r("components.deckgl.layersTitle")}</span>
        <button class="layer-help-btn" title="${r("components.deckgl.layerGuide")}">?</button>
        <button class="toggle-collapse">&#9660;</button>
      </div>
      <div class="toggle-list" style="max-height: 32vh; overflow-y: auto; scrollbar-width: thin;">
        ${t.map(({key:n,label:l,icon:o})=>`
          <label class="layer-toggle" data-layer="${n}">
            <input type="checkbox" ${this.state.layers[n]?"checked":""}>
            <span class="toggle-icon">${o}</span>
            <span class="toggle-label">${l}</span>
          </label>
        `).join("")}
      </div>
    `,this.container.appendChild(e),e.querySelectorAll(".layer-toggle input").forEach(n=>{n.addEventListener("change",()=>{var o,c;const l=(o=n.closest(".layer-toggle"))==null?void 0:o.getAttribute("data-layer");l&&(this.state.layers[l]=n.checked,this.render(),(c=this.onLayerChange)==null||c.call(this,l,n.checked,"user"))})});const s=e.querySelector(".layer-help-btn");s==null||s.addEventListener("click",()=>this.showLayerHelp());const a=e.querySelector(".toggle-collapse"),i=e.querySelector(".toggle-list");i&&(e.addEventListener("wheel",n=>{n.stopPropagation(),n.preventDefault(),i.scrollTop+=n.deltaY},{passive:!1}),e.addEventListener("touchmove",n=>n.stopPropagation(),{passive:!1})),a==null||a.addEventListener("click",()=>{i==null||i.classList.toggle("collapsed"),a&&(a.innerHTML=i!=null&&i.classList.contains("collapsed")?"&#9654;":"&#9660;")})}showLayerHelp(){var g;const e=this.container.querySelector(".layer-help-popup");if(e){e.remove();return}const t=document.createElement("div");t.className="layer-help-popup";const s=u=>r(`components.deckgl.layers.${u}`).toUpperCase(),a=u=>r(`components.deckgl.layerHelp.labels.${u}`).toUpperCase(),i=(u,v)=>`<div class="layer-help-item"><span>${u}</span> ${r(`components.deckgl.layerHelp.descriptions.${v}`)}</div>`,n=(u,v,f)=>`
      <div class="layer-help-section">
        <div class="layer-help-title">${r(`components.deckgl.layerHelp.sections.${u}`)}</div>
        ${v.join("")}
        ${f?`<div class="layer-help-note">${r(`components.deckgl.layerHelp.notes.${f}`)}</div>`:""}
      </div>
    `,l=`
      <div class="layer-help-header">
        <span>${r("components.deckgl.layerHelp.title")}</span>
        <button class="layer-help-close">√ó</button>
      </div>
    `,o=`
      ${l}
      <div class="layer-help-content">
        ${n("techEcosystem",[i(s("startupHubs"),"techStartupHubs"),i(s("cloudRegions"),"techCloudRegions"),i(s("techHQs"),"techHQs"),i(s("accelerators"),"techAccelerators")])}
        ${n("infrastructure",[i(s("underseaCables"),"infraCables"),i(s("aiDataCenters"),"infraDatacenters"),i(s("internetOutages"),"infraOutages")])}
        ${n("naturalEconomic",[i(s("naturalEvents"),"naturalEventsTech"),i(s("weatherAlerts"),"weatherAlerts"),i(s("economicCenters"),"economicCenters"),i(a("countries"),"countriesOverlay")])}
      </div>
    `,c=`
      ${l}
      <div class="layer-help-content">
        ${n("financeCore",[i(s("stockExchanges"),"financeExchanges"),i(s("financialCenters"),"financeCenters"),i(s("centralBanks"),"financeCentralBanks"),i(s("commodityHubs"),"financeCommodityHubs")])}
        ${n("infrastructureRisk",[i(s("underseaCables"),"financeCables"),i(s("pipelines"),"financePipelines"),i(s("internetOutages"),"financeOutages"),i(s("cyberThreats"),"financeCyberThreats")])}
        ${n("macroContext",[i(s("economicCenters"),"economicCenters"),i(s("strategicWaterways"),"macroWaterways"),i(s("weatherAlerts"),"weatherAlertsMarket"),i(s("naturalEvents"),"naturalEventsMacro")])}
      </div>
    `,h=`
      ${l}
      <div class="layer-help-content">
        ${n("timeFilter",[i(a("timeRecent"),"timeRecent"),i(a("timeExtended"),"timeExtended")],"timeAffects")}
        ${n("geopolitical",[i(s("conflictZones"),"geoConflicts"),i(s("intelHotspots"),"geoHotspots"),i(a("sanctions"),"geoSanctions"),i(s("protests"),"geoProtests")])}
        ${n("militaryStrategic",[i(s("militaryBases"),"militaryBases"),i(s("nuclearSites"),"militaryNuclear"),i(s("gammaIrradiators"),"militaryIrradiators"),i(s("militaryActivity"),"militaryActivity")])}
        ${n("infrastructure",[i(s("underseaCables"),"infraCablesFull"),i(s("pipelines"),"infraPipelinesFull"),i(s("internetOutages"),"infraOutages"),i(s("aiDataCenters"),"infraDatacentersFull")])}
        ${n("transport",[i(a("shipping"),"transportShipping"),i(s("flightDelays"),"transportDelays")])}
        ${n("naturalEconomic",[i(s("naturalEvents"),"naturalEventsFull"),i(s("weatherAlerts"),"weatherAlerts"),i(s("economicCenters"),"economicCenters")])}
        ${n("labels",[i(a("countries"),"countriesOverlay"),i(s("strategicWaterways"),"waterwaysLabels")])}
      </div>
    `;t.innerHTML=M==="tech"?o:M==="finance"?c:h,(g=t.querySelector(".layer-help-close"))==null||g.addEventListener("click",()=>t.remove());const d=t.querySelector(".layer-help-content");d&&(d.addEventListener("wheel",u=>u.stopPropagation(),{passive:!1}),d.addEventListener("touchmove",u=>u.stopPropagation(),{passive:!1})),setTimeout(()=>{const u=v=>{t.contains(v.target)||(t.remove(),document.removeEventListener("click",u))};document.addEventListener("click",u)},100),this.container.appendChild(t)}createLegend(){const e=document.createElement("div");e.className="map-legend deckgl-legend";const t={circle:i=>`<svg width="12" height="12" viewBox="0 0 12 12"><circle cx="6" cy="6" r="5" fill="${i}"/></svg>`,triangle:i=>`<svg width="12" height="12" viewBox="0 0 12 12"><polygon points="6,1 11,10 1,10" fill="${i}"/></svg>`,square:i=>`<svg width="12" height="12" viewBox="0 0 12 12"><rect x="1" y="1" width="10" height="10" rx="1" fill="${i}"/></svg>`,hexagon:i=>`<svg width="12" height="12" viewBox="0 0 12 12"><polygon points="6,1 10.5,3.5 10.5,8.5 6,11 1.5,8.5 1.5,3.5" fill="${i}"/></svg>`},s=le()==="light",a=M==="tech"?[{shape:t.circle(s?"rgb(22, 163, 74)":"rgb(0, 255, 150)"),label:r("components.deckgl.legend.startupHub")},{shape:t.circle("rgb(100, 200, 255)"),label:r("components.deckgl.legend.techHQ")},{shape:t.circle(s?"rgb(180, 120, 0)":"rgb(255, 200, 0)"),label:r("components.deckgl.legend.accelerator")},{shape:t.circle("rgb(150, 100, 255)"),label:r("components.deckgl.legend.cloudRegion")},{shape:t.square("rgb(136, 68, 255)"),label:r("components.deckgl.legend.datacenter")}]:M==="finance"?[{shape:t.circle("rgb(255, 215, 80)"),label:r("components.deckgl.legend.stockExchange")},{shape:t.circle("rgb(0, 220, 150)"),label:r("components.deckgl.legend.financialCenter")},{shape:t.hexagon("rgb(255, 210, 80)"),label:r("components.deckgl.legend.centralBank")},{shape:t.square("rgb(255, 150, 80)"),label:r("components.deckgl.legend.commodityHub")},{shape:t.triangle("rgb(80, 170, 255)"),label:r("components.deckgl.legend.waterway")}]:[{shape:t.circle("rgb(255, 68, 68)"),label:r("components.deckgl.legend.highAlert")},{shape:t.circle("rgb(255, 165, 0)"),label:r("components.deckgl.legend.elevated")},{shape:t.circle(s?"rgb(180, 120, 0)":"rgb(255, 255, 0)"),label:r("components.deckgl.legend.monitoring")},{shape:t.triangle("rgb(68, 136, 255)"),label:r("components.deckgl.legend.base")},{shape:t.hexagon(s?"rgb(180, 120, 0)":"rgb(255, 220, 0)"),label:r("components.deckgl.legend.nuclear")},{shape:t.square("rgb(136, 68, 255)"),label:r("components.deckgl.legend.datacenter")}];e.innerHTML=`
      <span class="legend-label-title">${r("components.deckgl.legend.title")}</span>
      ${a.map(({shape:i,label:n})=>`<span class="legend-item">${i}<span class="legend-label">${n}</span></span>`).join("")}
    `,this.container.appendChild(e)}render(){if(this.renderPaused){this.renderPending=!0;return}this.renderScheduled||(this.renderScheduled=!0,requestAnimationFrame(()=>{this.renderScheduled=!1,this.updateLayers()}))}setRenderPaused(e){if(this.renderPaused!==e){if(this.renderPaused=e,e){this.stopPulseAnimation();return}this.syncPulseAnimation(),!e&&this.renderPending&&(this.renderPending=!1,this.render())}}updateLayers(){var t;if(this.renderPaused||this.webglLost||!this.maplibreMap)return;const e=performance.now();try{(t=this.deckOverlay)==null||t.setProps({layers:this.buildLayers()})}catch{}performance.now()-e}setView(e){var a;this.state.view=e;const t=aa[e];this.maplibreMap&&this.maplibreMap.flyTo({center:[t.longitude,t.latitude],zoom:t.zoom,duration:1e3});const s=this.container.querySelector(".view-select");s&&(s.value=e),(a=this.onStateChange)==null||a.call(this,this.state)}setZoom(e){this.state.zoom=e,this.maplibreMap&&this.maplibreMap.setZoom(e)}setCenter(e,t,s){this.maplibreMap&&this.maplibreMap.flyTo({center:[t,e],...s!=null&&{zoom:s},duration:500})}getCenter(){if(this.maplibreMap){const e=this.maplibreMap.getCenter();return{lat:e.lat,lon:e.lng}}return null}setTimeRange(e){var t;this.state.timeRange=e,this.rebuildProtestSupercluster(),(t=this.onTimeRangeChange)==null||t.call(this,e),this.updateTimeSliderButtons(),this.render()}getTimeRange(){return this.state.timeRange}setLayers(e){this.state.layers=e,this.render(),Object.entries(e).forEach(([t,s])=>{const a=this.container.querySelector(`.layer-toggle[data-layer="${t}"] input`);a&&(a.checked=s)})}getState(){return{...this.state}}zoomIn(){this.maplibreMap&&this.maplibreMap.zoomIn()}zoomOut(){this.maplibreMap&&this.maplibreMap.zoomOut()}resetView(){this.setView("global")}createUcdpEventsLayer(e){return new R({id:"ucdp-events-layer",data:e,getPosition:t=>[t.longitude,t.latitude],getRadius:t=>Math.max(4e3,Math.sqrt(t.deaths_best||1)*3e3),getFillColor:t=>{switch(t.type_of_violence){case"state-based":return j.ucdpStateBased;case"non-state":return j.ucdpNonState;case"one-sided":return j.ucdpOneSided;default:return j.ucdpStateBased}},radiusMinPixels:3,radiusMaxPixels:20,pickable:!1})}createDisplacementArcsLayer(){const t=this.displacementFlows.filter(a=>a.originLat!=null&&a.asylumLat!=null).slice(0,50),s=Math.max(1,...t.map(a=>a.refugees));return new Za({id:"displacement-arcs-layer",data:t,getSourcePosition:a=>[a.originLon,a.originLat],getTargetPosition:a=>[a.asylumLon,a.asylumLat],getSourceColor:le()==="light"?[50,80,180,220]:[100,150,255,180],getTargetColor:le()==="light"?[20,150,100,220]:[100,255,200,180],getWidth:a=>Math.max(1,a.refugees/s*8),widthMinPixels:1,widthMaxPixels:8,pickable:!1})}createClimateHeatmapLayer(){return new Ka({id:"climate-heatmap-layer",data:this.climateAnomalies,getPosition:e=>[e.lon,e.lat],getWeight:e=>Math.abs(e.tempDelta)+Math.abs(e.precipDelta)*.1,radiusPixels:40,intensity:.6,threshold:.15,opacity:.45,colorRange:[[68,136,255],[100,200,255],[255,255,100],[255,200,50],[255,100,50],[255,50,50]],pickable:!1})}setEarthquakes(e){this.earthquakes=e,this.render()}setWeatherAlerts(e){this.weatherAlerts=e;const t=e.filter(s=>s.centroid&&s.centroid.length===2).length;console.log(`[DeckGLMap] Weather alerts: ${e.length} total, ${t} with coordinates`),this.render()}setOutages(e){this.outages=e,this.render()}setCyberThreats(e){this.cyberThreats=e,this.render()}setAisData(e,t){this.aisDisruptions=e,this.aisDensity=t,this.render()}setCableActivity(e,t){this.cableAdvisories=e,this.repairShips=t,this.render()}setCableHealth(e){this.healthByCableId=e,this.layerCache.delete("cables-layer"),this.render()}setProtests(e){this.protests=e,this.rebuildProtestSupercluster(),this.render(),this.syncPulseAnimation()}setFlightDelays(e){this.flightDelays=e,this.render()}setMilitaryFlights(e,t=[]){this.militaryFlights=e,this.militaryFlightClusters=t,this.render()}setMilitaryVessels(e,t=[]){this.militaryVessels=e,this.militaryVesselClusters=t,this.render()}setNaturalEvents(e){this.naturalEvents=e,this.render()}setFires(e){this.firmsFireData=e,this.render()}setTechEvents(e){this.techEvents=e,this.rebuildTechEventSupercluster(),this.render()}setUcdpEvents(e){this.ucdpEvents=e,this.render()}setDisplacementFlows(e){this.displacementFlows=e,this.render()}setClimateAnomalies(e){this.climateAnomalies=e,this.render()}setNewsLocations(e){const t=Date.now();for(const s of e)this.newsLocationFirstSeen.has(s.title)||this.newsLocationFirstSeen.set(s.title,t);for(const[s,a]of this.newsLocationFirstSeen)t-a>6e4&&this.newsLocationFirstSeen.delete(s);this.newsLocations=e,this.render(),this.syncPulseAnimation(t)}updateHotspotActivity(e){this.news=e;const t=new Set,s=e.filter(i=>Date.now()-i.pubDate.getTime()<7200*1e3),a=new Map;s.forEach(i=>{this.hotspots.forEach(n=>{n.keywords.some(l=>i.title.toLowerCase().includes(l.toLowerCase()))&&(t.add(n.id),a.set(n.id,(a.get(n.id)||0)+1))})}),this.hotspots.forEach(i=>{i.hasBreaking=t.has(i.id);const n=a.get(i.id)||0,l=n>0?n/2:0;Da(i.id,n,i.hasBreaking||!1,l)}),this.render(),this.syncPulseAnimation()}getRelatedNews(e){const t=["gaza","ukraine","russia","israel","iran","china","taiwan","korea","syria"];return this.news.map(s=>{const a=s.title.toLowerCase(),i=e.keywords.filter(o=>a.includes(o.toLowerCase()));if(i.length===0||t.filter(o=>a.includes(o)&&!e.keywords.some(c=>c.toLowerCase().includes(o))).length>0&&!i.some(c=>{var h;return c.toLowerCase()===e.name.toLowerCase()||((h=e.agencies)==null?void 0:h.some(d=>a.includes(d.toLowerCase())))}))return null;const l=i.length;return{item:s,score:l}}).filter(s=>s!==null).sort((s,a)=>a.score-s.score).slice(0,5).map(s=>s.item)}updateMilitaryForEscalation(e,t){Na(e,t)}getHotspotDynamicScore(e){return Zt(e)}getMilitaryFlightClusters(){return this.militaryFlightClusters}getMilitaryVesselClusters(){return this.militaryVesselClusters}highlightAssets(e){Object.values(this.highlightedAssets).forEach(t=>t.clear()),e&&e.forEach(t=>{this.highlightedAssets[t.type].add(t.id)}),this.render()}setOnHotspotClick(e){this.onHotspotClick=e}setOnTimeRangeChange(e){this.onTimeRangeChange=e}setOnLayerChange(e){this.onLayerChange=e}setOnStateChange(e){this.onStateChange=e}getHotspotLevels(){const e={};return this.hotspots.forEach(t=>{e[t.name]=t.level||"low"}),e}setHotspotLevels(e){this.hotspots.forEach(t=>{e[t.name]&&(t.level=e[t.name])}),this.render()}initEscalationGetters(){Ia(ka),Ra($a)}hideLayerToggle(e){const t=this.container.querySelector(`.layer-toggle[data-layer="${e}"]`);t&&(t.style.display="none")}setLayerLoading(e,t){const s=this.container.querySelector(`.layer-toggle[data-layer="${e}"]`);s&&s.classList.toggle("loading",t)}setLayerReady(e,t){const s=this.container.querySelector(`.layer-toggle[data-layer="${e}"]`);s&&(s.classList.remove("loading"),this.state.layers[e]&&t?s.classList.add("active"):s.classList.remove("active"))}flashAssets(e,t){t.forEach(s=>this.highlightedAssets[e].add(s)),this.render(),setTimeout(()=>{t.forEach(s=>this.highlightedAssets[e].delete(s)),this.render()},3e3)}enableLayer(e){var t;if(!this.state.layers[e]){this.state.layers[e]=!0;const s=this.container.querySelector(`.layer-toggle[data-layer="${e}"] input`);s&&(s.checked=!0),this.render(),(t=this.onLayerChange)==null||t.call(this,e,!0,"programmatic")}}toggleLayer(e){var s;console.log(`[DeckGLMap.toggleLayer] ${e}: ${this.state.layers[e]} -> ${!this.state.layers[e]}`),this.state.layers[e]=!this.state.layers[e];const t=this.container.querySelector(`.layer-toggle[data-layer="${e}"] input`);t&&(t.checked=this.state.layers[e]),this.render(),(s=this.onLayerChange)==null||s.call(this,e,this.state.layers[e],"programmatic")}getContainerCenter(){const e=this.container.getBoundingClientRect();return{x:e.width/2,y:e.height/2}}projectToScreen(e,t){if(!this.maplibreMap)return null;const s=this.maplibreMap.project([t,e]);return{x:s.x,y:s.y}}triggerHotspotClick(e){var l;const t=this.hotspots.find(o=>o.id===e);if(!t)return;const s=this.projectToScreen(t.lat,t.lon),{x:a,y:i}=s||this.getContainerCenter(),n=this.getRelatedNews(t);this.popup.show({type:"hotspot",data:t,relatedNews:n,x:a,y:i}),this.popup.loadHotspotGdeltContext(t),(l=this.onHotspotClick)==null||l.call(this,t)}triggerConflictClick(e){const t=Le.find(s=>s.id===e);if(t){const s=this.projectToScreen(t.center[1],t.center[0]),{x:a,y:i}=s||this.getContainerCenter();this.popup.show({type:"conflict",data:t,x:a,y:i})}}triggerBaseClick(e){const t=De.find(s=>s.id===e);if(t){const s=this.projectToScreen(t.lat,t.lon),{x:a,y:i}=s||this.getContainerCenter();this.popup.show({type:"base",data:t,x:a,y:i})}}triggerPipelineClick(e){const t=Xe.find(s=>s.id===e);if(t&&t.points.length>0){const s=Math.floor(t.points.length/2),a=t.points[s],i=a?this.projectToScreen(a[1],a[0]):null,{x:n,y:l}=i||this.getContainerCenter();this.popup.show({type:"pipeline",data:t,x:n,y:l})}}triggerCableClick(e){const t=ce.find(s=>s.id===e);if(t&&t.points.length>0){const s=Math.floor(t.points.length/2),a=t.points[s],i=a?this.projectToScreen(a[1],a[0]):null,{x:n,y:l}=i||this.getContainerCenter();this.popup.show({type:"cable",data:t,x:n,y:l})}}triggerDatacenterClick(e){const t=Se.find(s=>s.id===e);if(t){const s=this.projectToScreen(t.lat,t.lon),{x:a,y:i}=s||this.getContainerCenter();this.popup.show({type:"datacenter",data:t,x:a,y:i})}}triggerNuclearClick(e){const t=Ne.find(s=>s.id===e);if(t){const s=this.projectToScreen(t.lat,t.lon),{x:a,y:i}=s||this.getContainerCenter();this.popup.show({type:"nuclear",data:t,x:a,y:i})}}triggerIrradiatorClick(e){const t=Qe.find(s=>s.id===e);if(t){const s=this.projectToScreen(t.lat,t.lon),{x:a,y:i}=s||this.getContainerCenter();this.popup.show({type:"irradiator",data:t,x:a,y:i})}}flashLocation(e,t,s=2e3){const a=this.projectToScreen(e,t);if(!a)return;const i=document.createElement("div");if(i.className="flash-location-marker",i.style.cssText=`
      position: absolute;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.5);
      border: 2px solid #fff;
      animation: flash-pulse 0.5s ease-out infinite;
      pointer-events: none;
      z-index: 1000;
      left: ${a.x}px;
      top: ${a.y}px;
      transform: translate(-50%, -50%);
    `,!document.getElementById("flash-animation-styles")){const l=document.createElement("style");l.id="flash-animation-styles",l.textContent=`
        @keyframes flash-pulse {
          0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
          100% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
        }
      `,document.head.appendChild(l)}const n=this.container.querySelector(".deckgl-map-wrapper");n&&(n.appendChild(i),setTimeout(()=>i.remove(),s))}setOnCountryClick(e){this.onCountryClick=e}resolveCountryFromCoordinate(e,t){var a;const s=Sa(t,e);if(s)return s;if(!this.maplibreMap||!this.countryGeoJsonLoaded)return null;try{const i=this.maplibreMap.project([e,t]),n=this.maplibreMap.queryRenderedFeatures(i,{layers:["country-interactive"]}),l=((a=n==null?void 0:n[0])==null?void 0:a.properties)??{},o=typeof l["ISO3166-1-Alpha-2"]=="string"?l["ISO3166-1-Alpha-2"].trim().toUpperCase():"",c=typeof l.name=="string"?l.name.trim():"";return!o||!c?null:{code:o,name:c}}catch{return null}}loadCountryBoundaries(){!this.maplibreMap||this.countryGeoJsonLoaded||(this.countryGeoJsonLoaded=!0,di().then(e=>{!this.maplibreMap||!e||(this.maplibreMap.addSource("country-boundaries",{type:"geojson",data:e}),this.maplibreMap.addLayer({id:"country-interactive",type:"fill",source:"country-boundaries",paint:{"fill-color":"#3b82f6","fill-opacity":0}}),this.maplibreMap.addLayer({id:"country-hover-fill",type:"fill",source:"country-boundaries",paint:{"fill-color":"#3b82f6","fill-opacity":.06},filter:["==",["get","name"],""]}),this.maplibreMap.addLayer({id:"country-highlight-fill",type:"fill",source:"country-boundaries",paint:{"fill-color":"#3b82f6","fill-opacity":.12},filter:["==",["get","ISO3166-1-Alpha-2"],""]}),this.maplibreMap.addLayer({id:"country-highlight-border",type:"line",source:"country-boundaries",paint:{"line-color":"#3b82f6","line-width":1.5,"line-opacity":.5},filter:["==",["get","ISO3166-1-Alpha-2"],""]}),this.countryHoverSetup||this.setupCountryHover(),this.updateCountryLayerPaint(le()),this.highlightedCountryCode&&this.highlightCountry(this.highlightedCountryCode),console.log("[DeckGLMap] Country boundaries loaded"))}).catch(e=>console.warn("[DeckGLMap] Failed to load country boundaries:",e)))}setupCountryHover(){if(!this.maplibreMap||this.countryHoverSetup)return;this.countryHoverSetup=!0;const e=this.maplibreMap;let t=null;e.on("mousemove",s=>{var n,l;if(!this.onCountryClick)return;const a=e.queryRenderedFeatures(s.point,{layers:["country-interactive"]}),i=(l=(n=a==null?void 0:a[0])==null?void 0:n.properties)==null?void 0:l.name;try{i&&i!==t?(t=i,e.setFilter("country-hover-fill",["==",["get","name"],i]),e.getCanvas().style.cursor="pointer"):!i&&t&&(t=null,e.setFilter("country-hover-fill",["==",["get","name"],""]),e.getCanvas().style.cursor="")}catch{}}),e.on("mouseout",()=>{if(t){t=null;try{e.setFilter("country-hover-fill",["==",["get","name"],""])}catch{}e.getCanvas().style.cursor=""}})}highlightCountry(e){if(this.highlightedCountryCode=e,!this.maplibreMap||!this.countryGeoJsonLoaded)return;const t=["==",["get","ISO3166-1-Alpha-2"],e];try{this.maplibreMap.setFilter("country-highlight-fill",t),this.maplibreMap.setFilter("country-highlight-border",t)}catch{}}clearCountryHighlight(){if(this.highlightedCountryCode=null,!this.maplibreMap)return;const e=["==",["get","ISO3166-1-Alpha-2"],""];try{this.maplibreMap.setFilter("country-highlight-fill",e),this.maplibreMap.setFilter("country-highlight-border",e)}catch{}}switchBasemap(e){this.maplibreMap&&(this.maplibreMap.setStyle(e==="light"?na:ia),this.countryGeoJsonLoaded=!1,this.maplibreMap.once("style.load",()=>{this.loadCountryBoundaries()}))}updateCountryLayerPaint(e){if(!this.maplibreMap||!this.countryGeoJsonLoaded)return;const t=e==="light"?.1:.06,s=e==="light"?.18:.12;try{this.maplibreMap.setPaintProperty("country-hover-fill","fill-opacity",t),this.maplibreMap.setPaintProperty("country-highlight-fill","fill-opacity",s)}catch{}}destroy(){var e,t;this.moveTimeoutId&&(clearTimeout(this.moveTimeoutId),this.moveTimeoutId=null),this.stopPulseAnimation(),this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null),this.layerCache.clear(),(e=this.deckOverlay)==null||e.finalize(),this.deckOverlay=null,(t=this.maplibreMap)==null||t.remove(),this.maplibreMap=null,this.container.innerHTML=""}};y(Pe,"MAX_CLUSTER_LEAVES",200);let _t=Pe;class ur{constructor(e,t){y(this,"container");y(this,"isMobile");y(this,"deckGLMap",null);y(this,"svgMap",null);y(this,"initialState");y(this,"useDeckGL");this.container=e,this.initialState=t,this.isMobile=gt(),this.useDeckGL=!this.isMobile&&this.hasWebGLSupport(),this.init()}hasWebGLSupport(){try{return!!document.createElement("canvas").getContext("webgl2")}catch{return!1}}initSvgMap(e){console.log(e),this.useDeckGL=!1,this.deckGLMap=null,this.container.classList.remove("deckgl-mode"),this.container.classList.add("svg-mode"),this.container.innerHTML="",this.svgMap=new Bt(this.container,this.initialState)}init(){if(this.useDeckGL){console.log("[MapContainer] Initializing deck.gl map (desktop mode)");try{this.container.classList.add("deckgl-mode"),this.deckGLMap=new _t(this.container,{...this.initialState,view:this.initialState.view})}catch(e){console.warn("[MapContainer] DeckGL initialization failed, falling back to SVG map",e),this.initSvgMap("[MapContainer] Initializing SVG map (DeckGL fallback mode)")}}else this.initSvgMap("[MapContainer] Initializing SVG map (mobile/fallback mode)")}render(){var e,t;this.useDeckGL?(e=this.deckGLMap)==null||e.render():(t=this.svgMap)==null||t.render()}setView(e){var t,s;this.useDeckGL?(t=this.deckGLMap)==null||t.setView(e):(s=this.svgMap)==null||s.setView(e)}setZoom(e){var t,s;this.useDeckGL?(t=this.deckGLMap)==null||t.setZoom(e):(s=this.svgMap)==null||s.setZoom(e)}setCenter(e,t,s){var a,i,n;this.useDeckGL?(a=this.deckGLMap)==null||a.setCenter(e,t,s):((i=this.svgMap)==null||i.setCenter(e,t),s!=null&&((n=this.svgMap)==null||n.setZoom(s)))}getCenter(){var e,t;return this.useDeckGL?((e=this.deckGLMap)==null?void 0:e.getCenter())??null:((t=this.svgMap)==null?void 0:t.getCenter())??null}setTimeRange(e){var t,s;this.useDeckGL?(t=this.deckGLMap)==null||t.setTimeRange(e):(s=this.svgMap)==null||s.setTimeRange(e)}getTimeRange(){var e,t;return this.useDeckGL?((e=this.deckGLMap)==null?void 0:e.getTimeRange())??"7d":((t=this.svgMap)==null?void 0:t.getTimeRange())??"7d"}setLayers(e){var t,s;this.useDeckGL?(t=this.deckGLMap)==null||t.setLayers(e):(s=this.svgMap)==null||s.setLayers(e)}getState(){var e,t;if(this.useDeckGL){const s=(e=this.deckGLMap)==null?void 0:e.getState();return s?{...s,view:s.view}:this.initialState}return((t=this.svgMap)==null?void 0:t.getState())??this.initialState}setEarthquakes(e){var t,s;this.useDeckGL?(t=this.deckGLMap)==null||t.setEarthquakes(e):(s=this.svgMap)==null||s.setEarthquakes(e)}setWeatherAlerts(e){var t,s;this.useDeckGL?(t=this.deckGLMap)==null||t.setWeatherAlerts(e):(s=this.svgMap)==null||s.setWeatherAlerts(e)}setOutages(e){var t,s;this.useDeckGL?(t=this.deckGLMap)==null||t.setOutages(e):(s=this.svgMap)==null||s.setOutages(e)}setAisData(e,t){var s,a;this.useDeckGL?(s=this.deckGLMap)==null||s.setAisData(e,t):(a=this.svgMap)==null||a.setAisData(e,t)}setCableActivity(e,t){var s,a;this.useDeckGL?(s=this.deckGLMap)==null||s.setCableActivity(e,t):(a=this.svgMap)==null||a.setCableActivity(e,t)}setCableHealth(e){var t,s;this.useDeckGL?(t=this.deckGLMap)==null||t.setCableHealth(e):(s=this.svgMap)==null||s.setCableHealth(e)}setProtests(e){var t,s;this.useDeckGL?(t=this.deckGLMap)==null||t.setProtests(e):(s=this.svgMap)==null||s.setProtests(e)}setFlightDelays(e){var t,s;this.useDeckGL?(t=this.deckGLMap)==null||t.setFlightDelays(e):(s=this.svgMap)==null||s.setFlightDelays(e)}setMilitaryFlights(e,t=[]){var s,a;this.useDeckGL?(s=this.deckGLMap)==null||s.setMilitaryFlights(e,t):(a=this.svgMap)==null||a.setMilitaryFlights(e,t)}setMilitaryVessels(e,t=[]){var s,a;this.useDeckGL?(s=this.deckGLMap)==null||s.setMilitaryVessels(e,t):(a=this.svgMap)==null||a.setMilitaryVessels(e,t)}setNaturalEvents(e){var t,s;this.useDeckGL?(t=this.deckGLMap)==null||t.setNaturalEvents(e):(s=this.svgMap)==null||s.setNaturalEvents(e)}setFires(e){var t,s;this.useDeckGL?(t=this.deckGLMap)==null||t.setFires(e):(s=this.svgMap)==null||s.setFires(e)}setTechEvents(e){var t,s;this.useDeckGL?(t=this.deckGLMap)==null||t.setTechEvents(e):(s=this.svgMap)==null||s.setTechEvents(e)}setUcdpEvents(e){var t;this.useDeckGL&&((t=this.deckGLMap)==null||t.setUcdpEvents(e))}setDisplacementFlows(e){var t;this.useDeckGL&&((t=this.deckGLMap)==null||t.setDisplacementFlows(e))}setClimateAnomalies(e){var t;this.useDeckGL&&((t=this.deckGLMap)==null||t.setClimateAnomalies(e))}setCyberThreats(e){var t,s;this.useDeckGL?(t=this.deckGLMap)==null||t.setCyberThreats(e):(s=this.svgMap)==null||s.setCyberThreats(e)}setNewsLocations(e){var t,s;this.useDeckGL?(t=this.deckGLMap)==null||t.setNewsLocations(e):(s=this.svgMap)==null||s.setNewsLocations(e)}updateHotspotActivity(e){var t,s;this.useDeckGL?(t=this.deckGLMap)==null||t.updateHotspotActivity(e):(s=this.svgMap)==null||s.updateHotspotActivity(e)}updateMilitaryForEscalation(e,t){var s,a;this.useDeckGL?(s=this.deckGLMap)==null||s.updateMilitaryForEscalation(e,t):(a=this.svgMap)==null||a.updateMilitaryForEscalation(e,t)}getHotspotDynamicScore(e){var t,s;return this.useDeckGL?(t=this.deckGLMap)==null?void 0:t.getHotspotDynamicScore(e):(s=this.svgMap)==null?void 0:s.getHotspotDynamicScore(e)}highlightAssets(e){var t,s;this.useDeckGL?(t=this.deckGLMap)==null||t.highlightAssets(e):(s=this.svgMap)==null||s.highlightAssets(e)}onHotspotClicked(e){var t,s;this.useDeckGL?(t=this.deckGLMap)==null||t.setOnHotspotClick(e):(s=this.svgMap)==null||s.onHotspotClicked(e)}onTimeRangeChanged(e){var t,s;this.useDeckGL?(t=this.deckGLMap)==null||t.setOnTimeRangeChange(e):(s=this.svgMap)==null||s.onTimeRangeChanged(e)}setOnLayerChange(e){var t,s;this.useDeckGL?(t=this.deckGLMap)==null||t.setOnLayerChange(e):(s=this.svgMap)==null||s.setOnLayerChange(e)}onStateChanged(e){var t,s;this.useDeckGL?(t=this.deckGLMap)==null||t.setOnStateChange(a=>{e({...a,view:a.view})}):(s=this.svgMap)==null||s.onStateChanged(e)}getHotspotLevels(){var e,t;return this.useDeckGL?((e=this.deckGLMap)==null?void 0:e.getHotspotLevels())??{}:((t=this.svgMap)==null?void 0:t.getHotspotLevels())??{}}setHotspotLevels(e){var t,s;this.useDeckGL?(t=this.deckGLMap)==null||t.setHotspotLevels(e):(s=this.svgMap)==null||s.setHotspotLevels(e)}initEscalationGetters(){var e,t;this.useDeckGL?(e=this.deckGLMap)==null||e.initEscalationGetters():(t=this.svgMap)==null||t.initEscalationGetters()}hideLayerToggle(e){var t,s;this.useDeckGL?(t=this.deckGLMap)==null||t.hideLayerToggle(e):(s=this.svgMap)==null||s.hideLayerToggle(e)}setLayerLoading(e,t){var s,a;this.useDeckGL?(s=this.deckGLMap)==null||s.setLayerLoading(e,t):(a=this.svgMap)==null||a.setLayerLoading(e,t)}setLayerReady(e,t){var s,a;this.useDeckGL?(s=this.deckGLMap)==null||s.setLayerReady(e,t):(a=this.svgMap)==null||a.setLayerReady(e,t)}flashAssets(e,t){var s;this.useDeckGL&&((s=this.deckGLMap)==null||s.flashAssets(e,t))}enableLayer(e){var t,s;this.useDeckGL?(t=this.deckGLMap)==null||t.enableLayer(e):(s=this.svgMap)==null||s.enableLayer(e)}triggerHotspotClick(e){var t,s;this.useDeckGL?(t=this.deckGLMap)==null||t.triggerHotspotClick(e):(s=this.svgMap)==null||s.triggerHotspotClick(e)}triggerConflictClick(e){var t,s;this.useDeckGL?(t=this.deckGLMap)==null||t.triggerConflictClick(e):(s=this.svgMap)==null||s.triggerConflictClick(e)}triggerBaseClick(e){var t,s;this.useDeckGL?(t=this.deckGLMap)==null||t.triggerBaseClick(e):(s=this.svgMap)==null||s.triggerBaseClick(e)}triggerPipelineClick(e){var t,s;this.useDeckGL?(t=this.deckGLMap)==null||t.triggerPipelineClick(e):(s=this.svgMap)==null||s.triggerPipelineClick(e)}triggerCableClick(e){var t,s;this.useDeckGL?(t=this.deckGLMap)==null||t.triggerCableClick(e):(s=this.svgMap)==null||s.triggerCableClick(e)}triggerDatacenterClick(e){var t,s;this.useDeckGL?(t=this.deckGLMap)==null||t.triggerDatacenterClick(e):(s=this.svgMap)==null||s.triggerDatacenterClick(e)}triggerNuclearClick(e){var t,s;this.useDeckGL?(t=this.deckGLMap)==null||t.triggerNuclearClick(e):(s=this.svgMap)==null||s.triggerNuclearClick(e)}triggerIrradiatorClick(e){var t,s;this.useDeckGL?(t=this.deckGLMap)==null||t.triggerIrradiatorClick(e):(s=this.svgMap)==null||s.triggerIrradiatorClick(e)}flashLocation(e,t,s){var a,i;this.useDeckGL?(a=this.deckGLMap)==null||a.flashLocation(e,t,s):(i=this.svgMap)==null||i.flashLocation(e,t,s)}onCountryClicked(e){var t;this.useDeckGL&&((t=this.deckGLMap)==null||t.setOnCountryClick(e))}highlightCountry(e){var t;this.useDeckGL&&((t=this.deckGLMap)==null||t.highlightCountry(e))}clearCountryHighlight(){var e;this.useDeckGL&&((e=this.deckGLMap)==null||e.clearCountryHighlight())}setRenderPaused(e){var t;this.useDeckGL&&((t=this.deckGLMap)==null||t.setRenderPaused(e))}isDeckGLMode(){return this.useDeckGL}isMobileMode(){return this.isMobile}destroy(){var e,t;this.useDeckGL?(e=this.deckGLMap)==null||e.destroy():(t=this.svgMap)==null||t.destroy()}}class hr{constructor(){y(this,"element");y(this,"currentSignals",[]);y(this,"audioEnabled",!0);y(this,"audio",null);y(this,"onLocationClick");this.element=document.createElement("div"),this.element.className="signal-modal-overlay",this.element.innerHTML=`
      <div class="signal-modal">
        <div class="signal-modal-header">
          <span class="signal-modal-title">üéØ ${r("modals.signal.title")}</span>
          <button class="signal-modal-close">√ó</button>
        </div>
        <div class="signal-modal-content"></div>
        <div class="signal-modal-footer">
          <label class="signal-audio-toggle">
            <input type="checkbox" checked>
            <span>${r("modals.signal.soundAlerts")}</span>
          </label>
          <button class="signal-dismiss-btn">${r("modals.signal.dismiss")}</button>
        </div>
      </div>
    `,document.body.appendChild(this.element),this.setupEventListeners(),this.initAudio();const e=this.element.querySelector(".signal-modal");e==null||e.addEventListener("animationend",()=>{e.style.willChange="auto"},{once:!0})}initAudio(){this.audio=new Audio("data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleQYjfKapmWswEjCJvuPQfSoXZZ+3qqBJESSP0unGaxMJVYiytrFeLhR6p8znrFUXRW+bs7V3Qx1hn8Xjp1cYPnegprhkMCFmoLi1k0sZTYGlqqlUIA=="),this.audio.volume=.3}setupEventListeners(){var t,s;(t=this.element.querySelector(".signal-modal-close"))==null||t.addEventListener("click",()=>{this.hide()}),(s=this.element.querySelector(".signal-dismiss-btn"))==null||s.addEventListener("click",()=>{this.hide()}),this.element.addEventListener("click",a=>{a.target.classList.contains("signal-modal-overlay")&&this.hide()});const e=this.element.querySelector('input[type="checkbox"]');e==null||e.addEventListener("change",()=>{this.audioEnabled=e.checked}),this.element.addEventListener("click",a=>{const i=a.target;if(i.classList.contains("location-link")){const n=parseFloat(i.dataset.lat||"0"),l=parseFloat(i.dataset.lon||"0");this.onLocationClick&&!isNaN(n)&&!isNaN(l)&&(this.onLocationClick(n,l),this.hide());return}if(i.classList.contains("suppress-keyword-btn")){const n=(i.dataset.term||"").trim();if(!n)return;ui(n),this.currentSignals=this.currentSignals.filter(l=>{const o=l.data.term;return typeof o!="string"||o.toLowerCase()!==n.toLowerCase()}),this.renderSignals()}})}setLocationClickHandler(e){this.onLocationClick=e}show(e){e.length!==0&&(document.fullscreenElement||(this.currentSignals=[...e,...this.currentSignals].slice(0,50),this.renderSignals(),this.element.classList.add("active"),this.playSound()))}showSignal(e){this.currentSignals=[e],this.renderSignals(),this.element.classList.add("active")}showAlert(e){if(document.fullscreenElement)return;const t=this.element.querySelector(".signal-modal-content"),s={critical:T("--semantic-critical"),high:T("--semantic-high"),medium:T("--semantic-low"),low:T("--text-dim")},i={cii_spike:"üìä",convergence:"üåç",cascade:"‚ö°",composite:"üîó"}[e.type]||"‚ö†Ô∏è",n=s[e.priority]||"#ff9944";let l="";if(e.components.ciiChange){const o=e.components.ciiChange,c=o.change>0?"+":"";l+=`
        <div class="signal-context-item">
          <span class="context-label">${r("modals.signal.country")}</span>
          <span class="context-value">${m(o.countryName)}</span>
        </div>
        <div class="signal-context-item">
          <span class="context-label">${r("modals.signal.scoreChange")}</span>
          <span class="context-value">${o.previousScore} ‚Üí ${o.currentScore} (${c}${o.change})</span>
        </div>
        <div class="signal-context-item">
          <span class="context-label">${r("modals.signal.instabilityLevel")}</span>
          <span class="context-value" style="text-transform: uppercase; color: ${n}">${o.level}</span>
        </div>
        <div class="signal-context-item">
          <span class="context-label">${r("modals.signal.primaryDriver")}</span>
          <span class="context-value">${m(o.driver)}</span>
        </div>
      `}if(e.components.convergence){const o=e.components.convergence;l+=`
        <div class="signal-context-item">
          <span class="context-label">${r("modals.signal.location")}</span>
          <button class="location-link" data-lat="${o.lat}" data-lon="${o.lon}">${o.lat.toFixed(2)}¬∞, ${o.lon.toFixed(2)}¬∞ ‚Üó</button>
        </div>
        <div class="signal-context-item">
          <span class="context-label">${r("modals.signal.eventTypes")}</span>
          <span class="context-value">${o.types.join(", ")}</span>
        </div>
        <div class="signal-context-item">
          <span class="context-label">${r("modals.signal.eventCount")}</span>
          <span class="context-value">${r("modals.signal.eventCountValue",{count:o.totalEvents})}</span>
        </div>
      `}if(e.components.cascade){const o=e.components.cascade;l+=`
        <div class="signal-context-item">
          <span class="context-label">${r("modals.signal.source")}</span>
          <span class="context-value">${m(o.sourceName)} (${o.sourceType})</span>
        </div>
        <div class="signal-context-item">
          <span class="context-label">${r("modals.signal.countriesAffected")}</span>
          <span class="context-value">${o.countriesAffected}</span>
        </div>
        <div class="signal-context-item">
          <span class="context-label">${r("modals.signal.impactLevel")}</span>
          <span class="context-value">${m(o.highestImpact)}</span>
        </div>
      `}t.innerHTML=`
      <div class="signal-item" style="border-left-color: ${n}">
        <div class="signal-type">${i} ${e.type.toUpperCase().replace("_"," ")}</div>
        <div class="signal-title">${m(e.title)}</div>
        <div class="signal-description">${m(e.summary)}</div>
        <div class="signal-meta">
          <span class="signal-confidence" style="background: ${n}22; color: ${n}">${e.priority.toUpperCase()}</span>
          <span class="signal-time">${this.formatTime(e.timestamp)}</span>
        </div>
        <div class="signal-context">
          ${l}
        </div>
        ${e.countries.length>0?`
          <div class="signal-topics">
            ${e.countries.map(o=>`<span class="signal-topic">${m(o)}</span>`).join("")}
          </div>
        `:""}
      </div>
    `,this.element.classList.add("active")}playSound(){this.audioEnabled&&this.audio&&(this.audio.currentTime=0,this.audio.play().catch(()=>{}))}hide(){this.element.classList.remove("active")}renderSignals(){const e=this.element.querySelector(".signal-modal-content"),t={prediction_leads_news:`üîÆ ${r("modals.signal.predictionLeading")}`,news_leads_markets:`üì∞ ${r("modals.signal.newsLeading")}`,silent_divergence:`üîá ${r("modals.signal.silentDivergence")}`,velocity_spike:`üî• ${r("modals.signal.velocitySpike")}`,keyword_spike:`üìä ${r("modals.signal.keywordSpike")}`,convergence:`‚óâ ${r("modals.signal.convergence")}`,triangulation:`‚ñ≥ ${r("modals.signal.triangulation")}`,flow_drop:`üõ¢Ô∏è ${r("modals.signal.flowDrop")}`,flow_price_divergence:`üìà ${r("modals.signal.flowPriceDivergence")}`,geo_convergence:`üåê ${r("modals.signal.geoConvergence")}`,explained_market_move:`‚úì ${r("modals.signal.marketMove")}`,sector_cascade:`üìä ${r("modals.signal.sectorCascade")}`,military_surge:`üõ©Ô∏è ${r("modals.signal.militarySurge")}`},s=this.currentSignals.map(a=>{var h;const i=La(a.type),n=a.data,l=n==null?void 0:n.newsCorrelation,o=n==null?void 0:n.focalPointContext,c={lat:n==null?void 0:n.lat,lon:n==null?void 0:n.lon,regionName:n==null?void 0:n.regionName};return`
        <div class="signal-item ${m(a.type)}">
          <div class="signal-type">${t[a.type]||m(a.type)}</div>
          <div class="signal-title">${m(a.title)}</div>
          <div class="signal-description">${m(a.description)}</div>
          <div class="signal-meta">
            <span class="signal-confidence">${r("modals.signal.confidence")}: ${Math.round(a.confidence*100)}%</span>
            <span class="signal-time">${this.formatTime(a.timestamp)}</span>
          </div>
          ${a.data.explanation?`
            <div class="signal-explanation">${m(a.data.explanation)}</div>
          `:""}
          ${o&&o.length>0?`
            <div class="signal-focal-points">
              <div class="focal-points-header">üì° ${r("modals.signal.focalPoints")}</div>
              ${o.map(d=>`<div class="focal-point-item">${m(d)}</div>`).join("")}
            </div>
          `:""}
          ${l?`
            <div class="signal-news-correlation">
              <div class="news-correlation-header">üì∞ ${r("modals.signal.newsCorrelation")}</div>
              <pre class="news-correlation-text">${m(l)}</pre>
            </div>
          `:""}
          ${c.lat&&c.lon?`
            <div class="signal-location">
              <button class="location-link" data-lat="${c.lat}" data-lon="${c.lon}">
                üìç ${r("modals.signal.viewOnMap")}: ${c.regionName||`${c.lat.toFixed(2)}¬∞, ${c.lon.toFixed(2)}¬∞`}
              </button>
            </div>
          `:""}
          <div class="signal-context">
            <div class="signal-context-item why-matters">
              <span class="context-label">${r("modals.signal.whyItMatters")}</span>
              <span class="context-value">${m(i.whyItMatters)}</span>
            </div>
            <div class="signal-context-item actionable">
              <span class="context-label">${r("modals.signal.action")}</span>
              <span class="context-value">${m(i.actionableInsight)}</span>
            </div>
            <div class="signal-context-item confidence-note">
              <span class="context-label">${r("modals.signal.note")}</span>
              <span class="context-value">${m(i.confidenceNote)}</span>
            </div>
          </div>
          ${(h=a.data.relatedTopics)!=null&&h.length?`
            <div class="signal-topics">
              ${a.data.relatedTopics.map(d=>`<span class="signal-topic">${m(d)}</span>`).join("")}
            </div>
          `:""}
          ${a.type==="keyword_spike"&&typeof(n==null?void 0:n.term)=="string"?`
            <div class="signal-actions">
              <button class="suppress-keyword-btn" data-term="${m(n.term)}">${r("modals.signal.suppress")}</button>
            </div>
          `:""}
        </div>
      `}).join("");e.innerHTML=s}formatTime(e){return e.toLocaleTimeString(void 0,{hour:"2-digit",minute:"2-digit"})}getElement(){return this.element}}class gr{constructor(){y(this,"element");y(this,"isPlaybackMode",!1);y(this,"timestamps",[]);y(this,"currentIndex",0);y(this,"onSnapshotChange",null);this.element=document.createElement("div"),this.element.className="playback-control",this.element.innerHTML=`
      <button class="playback-toggle" title="${r("components.playback.toggleMode")}">
        <span class="playback-icon">‚è™</span>
      </button>
      <div class="playback-panel hidden">
        <div class="playback-header">
          <span>${r("components.playback.historicalPlayback")}</span>
          <button class="playback-close">√ó</button>
        </div>
        <div class="playback-slider-container">
          <input type="range" class="playback-slider" min="0" max="100" value="100">
          <div class="playback-time">${r("components.playback.live")}</div>
        </div>
        <div class="playback-controls">
          <button class="playback-btn" data-action="start">‚èÆ</button>
          <button class="playback-btn" data-action="prev">‚óÄ</button>
          <button class="playback-btn playback-live" data-action="live">${r("components.playback.live")}</button>
          <button class="playback-btn" data-action="next">‚ñ∂</button>
          <button class="playback-btn" data-action="end">‚è≠</button>
        </div>
      </div>
    `,this.setupEventListeners()}setupEventListeners(){const e=this.element.querySelector(".playback-toggle"),t=this.element.querySelector(".playback-panel"),s=this.element.querySelector(".playback-close"),a=this.element.querySelector(".playback-slider");e.addEventListener("click",async()=>{t.classList.toggle("hidden"),t.classList.contains("hidden")||await this.loadTimestamps()}),s.addEventListener("click",()=>{t.classList.add("hidden"),this.goLive()}),a.addEventListener("input",()=>{const i=parseInt(a.value);this.currentIndex=i,this.loadSnapshot(i)}),this.element.querySelectorAll(".playback-btn").forEach(i=>{i.addEventListener("click",()=>{const n=i.dataset.action;this.handleAction(n)})})}async loadTimestamps(){this.timestamps=await hi(),this.timestamps.sort((t,s)=>t-s);const e=this.element.querySelector(".playback-slider");e.max=String(Math.max(0,this.timestamps.length-1)),e.value=e.max,this.currentIndex=this.timestamps.length-1,this.updateTimeDisplay()}async loadSnapshot(e){var a,i;if(e<0||e>=this.timestamps.length){this.goLive();return}const t=this.timestamps[e];if(!t){this.goLive();return}this.isPlaybackMode=!0,this.updateTimeDisplay();const s=await gi(t);(a=this.onSnapshotChange)==null||a.call(this,s),document.body.classList.add("playback-mode"),(i=this.element.querySelector(".playback-live"))==null||i.classList.remove("active")}goLive(){var t,s;this.isPlaybackMode=!1,this.currentIndex=this.timestamps.length-1;const e=this.element.querySelector(".playback-slider");e.value=e.max,this.updateTimeDisplay(),(t=this.onSnapshotChange)==null||t.call(this,null),document.body.classList.remove("playback-mode"),(s=this.element.querySelector(".playback-live"))==null||s.classList.add("active")}handleAction(e){switch(e){case"start":this.currentIndex=0;break;case"prev":this.currentIndex=Math.max(0,this.currentIndex-1);break;case"next":this.currentIndex=Math.min(this.timestamps.length-1,this.currentIndex+1);break;case"end":this.currentIndex=this.timestamps.length-1;break;case"live":this.goLive();return}const t=this.element.querySelector(".playback-slider");t.value=String(this.currentIndex),this.loadSnapshot(this.currentIndex)}updateTimeDisplay(){const e=this.element.querySelector(".playback-time");if(!this.isPlaybackMode||this.timestamps.length===0){e.textContent=r("components.playback.live"),e.classList.remove("historical");return}const t=this.timestamps[this.currentIndex];if(t){const s=new Date(t);e.textContent=s.toLocaleString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}),e.classList.add("historical")}}onSnapshot(e){this.onSnapshotChange=e}getElement(){return this.element}isInPlaybackMode(){return this.isPlaybackMode}}const oa="worldmonitor_recent_searches",mr=8,ra=24;class yr{constructor(e,t){y(this,"container");y(this,"overlay",null);y(this,"input",null);y(this,"resultsList",null);y(this,"sources",[]);y(this,"results",[]);y(this,"selectedIndex",0);y(this,"recentSearches",[]);y(this,"onSelect");y(this,"placeholder");y(this,"hint");this.container=e,this.placeholder=(t==null?void 0:t.placeholder)||r("modals.search.placeholder"),this.hint=(t==null?void 0:t.hint)||r("modals.search.hint"),this.loadRecentSearches()}registerSource(e,t){const s=this.sources.findIndex(a=>a.type===e);s>=0?this.sources[s]={type:e,items:t}:this.sources.push({type:e,items:t})}setOnSelect(e){this.onSelect=e}open(){var e;this.overlay||(this.createModal(),(e=this.input)==null||e.focus(),this.showRecentOrEmpty())}close(){this.overlay&&(this.overlay.remove(),this.overlay=null,this.input=null,this.resultsList=null,this.results=[],this.selectedIndex=0)}isOpen(){return this.overlay!==null}createModal(){var e,t;this.overlay=document.createElement("div"),this.overlay.className="search-overlay",this.overlay.innerHTML=`
      <div class="search-modal">
        <div class="search-header">
          <span class="search-icon">‚åò</span>
          <input type="text" class="search-input" placeholder="${this.placeholder}" autofocus />
          <kbd class="search-kbd">ESC</kbd>
        </div>
        <div class="search-results"></div>
        <div class="search-footer">
          <span><kbd>‚Üë‚Üì</kbd> ${r("modals.search.navigate")}</span>
          <span><kbd>‚Üµ</kbd> ${r("modals.search.select")}</span>
          <span><kbd>esc</kbd> ${r("modals.search.close")}</span>
        </div>
      </div>
    `,this.overlay.addEventListener("click",s=>{s.target===this.overlay&&this.close()}),this.input=this.overlay.querySelector(".search-input"),this.resultsList=this.overlay.querySelector(".search-results"),(e=this.input)==null||e.addEventListener("input",()=>this.handleSearch()),(t=this.input)==null||t.addEventListener("keydown",s=>this.handleKeydown(s)),this.container.appendChild(this.overlay)}handleSearch(){var a,i;const e=((a=this.input)==null?void 0:a.value.trim().toLowerCase())||"";if(!e){this.showRecentOrEmpty();return}const t=new Map;for(const n of this.sources)for(const l of n.items){const o=l.title.toLowerCase(),c=((i=l.subtitle)==null?void 0:i.toLowerCase())||"";if(o.includes(e)||c.includes(e)){const h=o.startsWith(e)||c.startsWith(e),d={type:n.type,id:l.id,title:l.title,subtitle:l.subtitle,data:l.data,_score:h?2:1};t.has(n.type)||t.set(n.type,[]),t.get(n.type).push(d)}}const s=["news","prediction","market","earthquake","outage","conflict","hotspot","country","base","pipeline","cable","datacenter","nuclear","irradiator","techcompany","ailab","startup","techevent","techhq","accelerator"];this.results=[];for(const n of s){const l=t.get(n)||[];l.sort((c,h)=>h._score-c._score);const o=n==="news"?6:n==="country"?4:3;if(this.results.push(...l.slice(0,o)),this.results.length>=ra)break}this.results=this.results.slice(0,ra),mi(e.length,this.results.length),this.selectedIndex=0,this.renderResults()}showRecentOrEmpty(){this.results=[],this.recentSearches.length>0?this.renderRecent():this.renderEmpty()}renderRecent(){this.resultsList&&(this.resultsList.innerHTML=`<div class="search-section-header">${r("modals.search.recent")}</div>`,this.recentSearches.forEach((e,t)=>{const s=document.createElement("div");s.className=`search-result-item recent${t===this.selectedIndex?" selected":""}`,s.dataset.recent=e;const a=document.createElement("span");a.className="search-result-icon",a.textContent="üïê";const i=document.createElement("span");i.className="search-result-title",i.textContent=e,s.appendChild(a),s.appendChild(i),s.addEventListener("click",()=>{this.input&&(this.input.value=e),this.handleSearch()}),this.resultsList.appendChild(s)}))}renderEmpty(){this.resultsList&&(this.resultsList.innerHTML=`
      <div class="search-empty">
        <div class="search-empty-icon">üîç</div>
        <div>${r("modals.search.empty")}</div>
        <div class="search-empty-hint">${this.hint}</div>
      </div>
    `)}renderResults(){if(!this.resultsList)return;if(this.results.length===0){this.resultsList.innerHTML=`
        <div class="search-empty">
          <div class="search-empty-icon">‚àÖ</div>
          <div>${r("modals.search.noResults")}</div>
        </div>
      `;return}const e={country:"üè≥Ô∏è",news:"üì∞",hotspot:"üìç",market:"üìà",prediction:"üéØ",conflict:"‚öîÔ∏è",base:"üèõÔ∏è",pipeline:"üõ¢",cable:"üåê",datacenter:"üñ•Ô∏è",earthquake:"üåç",outage:"üì°",nuclear:"‚ò¢Ô∏è",irradiator:"‚öõÔ∏è",techcompany:"üè¢",ailab:"üß†",startup:"üöÄ",techevent:"üìÖ",techhq:"ü¶Ñ",accelerator:"üöÄ",exchange:"üèõÔ∏è",financialcenter:"üí∞",centralbank:"üè¶",commodityhub:"üì¶"};this.resultsList.innerHTML=this.results.map((t,s)=>`
      <div class="search-result-item ${s===this.selectedIndex?"selected":""}" data-index="${s}">
        <span class="search-result-icon">${e[t.type]}</span>
        <div class="search-result-content">
          <div class="search-result-title">${this.highlightMatch(t.title)}</div>
          ${t.subtitle?`<div class="search-result-subtitle">${m(t.subtitle)}</div>`:""}
        </div>
        <span class="search-result-type">${m(r(`modals.search.types.${t.type}`)||t.type)}</span>
      </div>
    `).join(""),this.resultsList.querySelectorAll(".search-result-item").forEach(t=>{t.addEventListener("click",()=>{const s=parseInt(t.dataset.index||"0");this.selectResult(s)})})}highlightMatch(e){var n;const t=((n=this.input)==null?void 0:n.value.trim())||"",s=m(e);if(!t)return s;const a=m(t),i=new RegExp(`(${a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi");return s.replace(i,"<mark>$1</mark>")}handleKeydown(e){switch(e.key){case"ArrowDown":e.preventDefault(),this.moveSelection(1);break;case"ArrowUp":e.preventDefault(),this.moveSelection(-1);break;case"Enter":e.preventDefault(),this.selectResult(this.selectedIndex);break;case"Escape":e.preventDefault(),this.close();break}}moveSelection(e){const t=this.results.length||this.recentSearches.length;t!==0&&(this.selectedIndex=(this.selectedIndex+e+t)%t,this.updateSelection())}updateSelection(){if(!this.resultsList)return;this.resultsList.querySelectorAll(".search-result-item").forEach((t,s)=>{t.classList.toggle("selected",s===this.selectedIndex)});const e=this.resultsList.querySelector(".selected");e==null||e.scrollIntoView({block:"nearest"})}selectResult(e){var s,a;if(this.results.length===0&&this.recentSearches.length>0){const i=this.recentSearches[e];i&&this.input&&(this.input.value=i,this.handleSearch());return}const t=this.results[e];t&&(this.saveRecentSearch(((s=this.input)==null?void 0:s.value.trim())||""),this.close(),(a=this.onSelect)==null||a.call(this,t))}loadRecentSearches(){try{const e=localStorage.getItem(oa);this.recentSearches=e?JSON.parse(e):[]}catch{this.recentSearches=[]}}saveRecentSearch(e){if(!(!e||e.length<2)){this.recentSearches=[e,...this.recentSearches.filter(t=>t!==e)].slice(0,mr);try{localStorage.setItem(oa,JSON.stringify(this.recentSearches))}catch{}}}}const la="mobile-warning-dismissed";class ca{constructor(){y(this,"element");this.element=document.createElement("div"),this.element.className="mobile-warning-overlay",this.element.innerHTML=`
      <div class="mobile-warning-modal">
        <div class="mobile-warning-header">
          <span class="mobile-warning-icon">üì±</span>
          <span class="mobile-warning-title">${r("modals.mobileWarning.title")}</span>
        </div>
        <div class="mobile-warning-content">
          <p>${r("modals.mobileWarning.description")}</p>
          <p>${r("modals.mobileWarning.tip")}</p>
        </div>
        <div class="mobile-warning-footer">
          <label class="mobile-warning-remember">
            <input type="checkbox" id="mobileWarningRemember">
            <span>${r("modals.mobileWarning.dontShowAgain")}</span>
          </label>
          <button class="mobile-warning-btn">${r("modals.mobileWarning.gotIt")}</button>
        </div>
      </div>
    `,document.body.appendChild(this.element),this.setupEventListeners();const e=this.element.querySelector(".mobile-warning-modal");e==null||e.addEventListener("animationend",()=>{e.style.willChange="auto"},{once:!0})}setupEventListeners(){var e;(e=this.element.querySelector(".mobile-warning-btn"))==null||e.addEventListener("click",()=>{this.dismiss()}),this.element.addEventListener("click",t=>{t.target.classList.contains("mobile-warning-overlay")&&this.dismiss()})}dismiss(){const e=this.element.querySelector("#mobileWarningRemember");e!=null&&e.checked&&localStorage.setItem(la,"true"),this.hide()}show(){this.element.classList.add("active")}hide(){this.element.classList.remove("active")}static shouldShow(){return localStorage.getItem(la)==="true"?!1:gt()}getElement(){return this.element}}const vr={1:"#ff0040",2:"#ff4400",3:"#ffaa00",4:"#00aaff",5:"#2d8a6e"};class fr{constructor(){y(this,"element");y(this,"isExpanded",!1);y(this,"status",null);y(this,"tensions",[]);const e=G("div",{className:"pizzint-panel hidden"},G("div",{className:"pizzint-header"},G("span",{className:"pizzint-title"},r("components.pizzint.title")),G("button",{className:"pizzint-close",onClick:()=>{this.isExpanded=!1,e.classList.add("hidden")}},"√ó")),G("div",{className:"pizzint-status-bar"},G("div",{className:"pizzint-defcon-label"})),G("div",{className:"pizzint-locations"}),G("div",{className:"pizzint-tensions"},G("div",{className:"pizzint-tensions-title"},r("components.pizzint.tensionsTitle")),G("div",{className:"pizzint-tensions-list"})),G("div",{className:"pizzint-footer"},G("span",{className:"pizzint-source"},r("components.pizzint.source")," ",G("a",{href:"https://pizzint.watch",target:"_blank",rel:"noopener"},"PizzINT")),G("span",{className:"pizzint-updated"})));this.element=G("div",{className:"pizzint-indicator"},G("button",{className:"pizzint-toggle",title:r("components.pizzint.title"),onClick:()=>{this.isExpanded=!this.isExpanded,e.classList.toggle("hidden",!this.isExpanded)}},G("span",{className:"pizzint-icon"},"üçï"),G("span",{className:"pizzint-defcon"},"--"),G("span",{className:"pizzint-score"},"--%")),e),this.injectStyles()}injectStyles(){if(document.getElementById("pizzint-styles"))return;const e=document.createElement("style");e.id="pizzint-styles",e.textContent=`
      .pizzint-indicator {
        position: relative;
        z-index: 1000;
        font-family: 'JetBrains Mono', monospace;
      }
      .pizzint-toggle {
        display: flex;
        align-items: center;
        gap: 6px;
        background: transparent;
        border: 1px solid var(--overlay-heavy);
        border-radius: 4px;
        padding: 4px 8px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .pizzint-toggle:hover {
        background: var(--overlay-medium);
        border-color: var(--border-strong);
      }
      .pizzint-icon { font-size: 14px; }
      .pizzint-defcon {
        font-size: 10px;
        font-weight: bold;
        padding: 2px 5px;
        border-radius: 3px;
        background: var(--text-ghost);
        color: var(--accent);
      }
      .pizzint-score {
        font-size: 10px;
        color: var(--text-dim);
      }
      .pizzint-panel {
        position: absolute;
        top: 100%;
        left: 0;
        margin-top: 8px;
        width: 320px;
        background: var(--bg);
        border: 1px solid var(--overlay-heavy);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 8px 32px var(--shadow-color);
      }
      .pizzint-panel.hidden { display: none; }
      .pizzint-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        border-bottom: 1px solid var(--overlay-medium);
      }
      .pizzint-title {
        font-size: 14px;
        font-weight: bold;
        color: var(--accent);
      }
      .pizzint-close {
        background: none;
        border: none;
        color: var(--text-faint);
        font-size: 20px;
        cursor: pointer;
        padding: 0;
        line-height: 1;
      }
      .pizzint-close:hover { color: var(--accent); }
      .pizzint-status-bar {
        padding: 12px 16px;
        background: var(--overlay-light);
      }
      .pizzint-defcon-label {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--text);
        text-align: center;
      }
      .pizzint-locations {
        padding: 8px 16px;
        max-height: 180px;
        overflow-y: auto;
      }
      .pizzint-location {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 6px 0;
        border-bottom: 1px solid var(--overlay-light);
        font-size: 11px;
      }
      .pizzint-location:last-child { border-bottom: none; }
      .pizzint-location-name {
        color: var(--text);
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-right: 8px;
      }
      .pizzint-location-status {
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: bold;
        text-transform: uppercase;
      }
      .pizzint-location-status.spike { background: var(--defcon-1); color: var(--accent); }
      .pizzint-location-status.high { background: var(--defcon-2); color: var(--accent); }
      .pizzint-location-status.elevated { background: var(--defcon-3); color: var(--bg); }
      .pizzint-location-status.nominal { background: var(--defcon-4); color: var(--accent); }
      .pizzint-location-status.quiet { background: var(--status-live); color: var(--bg); }
      .pizzint-location-status.closed { background: var(--text-ghost); color: var(--text-dim); }
      .pizzint-tensions {
        padding: 12px 16px;
        border-top: 1px solid var(--overlay-medium);
      }
      .pizzint-tensions-title {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--text-faint);
        margin-bottom: 8px;
      }
      .pizzint-tension-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 4px 0;
        font-size: 11px;
      }
      .pizzint-tension-label { color: var(--text); }
      .pizzint-tension-score {
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .pizzint-tension-value { color: var(--accent); font-weight: bold; }
      .pizzint-tension-trend { font-size: 10px; }
      .pizzint-tension-trend.rising { color: var(--defcon-2); }
      .pizzint-tension-trend.falling { color: var(--status-live); }
      .pizzint-tension-trend.stable { color: var(--text-dim); }
      .pizzint-footer {
        display: flex;
        justify-content: space-between;
        padding: 8px 16px;
        border-top: 1px solid var(--overlay-medium);
        font-size: 10px;
        color: var(--text-ghost);
      }
      .pizzint-footer a {
        color: var(--text-faint);
        text-decoration: none;
      }
      .pizzint-footer a:hover { color: var(--accent); }
    `,document.head.appendChild(e)}updateStatus(e){this.status=e,this.render()}updateTensions(e){this.tensions=e,this.renderTensions()}render(){if(!this.status)return;const e=this.element.querySelector(".pizzint-defcon"),t=this.element.querySelector(".pizzint-score"),s=this.element.querySelector(".pizzint-defcon-label"),a=this.element.querySelector(".pizzint-locations"),i=this.element.querySelector(".pizzint-updated"),n=vr[this.status.defconLevel]||"#888";e.textContent=r("components.pizzint.defcon",{level:String(this.status.defconLevel)}),e.style.background=n,e.style.color=this.status.defconLevel<=3?"#000":"#fff",t.textContent=`${this.status.aggregateActivity}%`,s.textContent=this.getDefconLabel(this.status.defconLevel),s.style.color=n,as(a,...this.status.locations.map(o=>G("div",{className:"pizzint-location"},G("span",{className:"pizzint-location-name"},o.name),G("span",{className:`pizzint-location-status ${this.getStatusClass(o)}`},this.getStatusLabel(o)))));const l=this.formatTimeAgo(this.status.lastUpdate);i.textContent=r("components.pizzint.updated",{timeAgo:l})}renderTensions(){const e=this.element.querySelector(".pizzint-tensions-list");e&&as(e,...this.tensions.map(t=>{const s=t.trend==="rising"?"‚Üë":t.trend==="falling"?"‚Üì":"‚Üí",a=t.changePercent>0?`+${t.changePercent}%`:`${t.changePercent}%`;return G("div",{className:"pizzint-tension-row"},G("span",{className:"pizzint-tension-label"},t.label),G("span",{className:"pizzint-tension-score"},G("span",{className:"pizzint-tension-value"},t.score.toFixed(1)),G("span",{className:`pizzint-tension-trend ${t.trend}`},`${s} ${a}`)))}))}getStatusClass(e){return e.is_closed_now?"closed":e.is_spike?"spike":e.current_popularity>=70?"high":e.current_popularity>=40?"elevated":e.current_popularity>=15?"nominal":"quiet"}getStatusLabel(e){return e.is_closed_now?r("components.pizzint.statusClosed"):e.is_spike?`${r("components.pizzint.statusSpike")} ${e.current_popularity}%`:e.current_popularity>=70?`${r("components.pizzint.statusHigh")} ${e.current_popularity}%`:e.current_popularity>=40?`${r("components.pizzint.statusElevated")} ${e.current_popularity}%`:e.current_popularity>=15?`${r("components.pizzint.statusNominal")} ${e.current_popularity}%`:`${r("components.pizzint.statusQuiet")} ${e.current_popularity}%`}formatTimeAgo(e){const t=Date.now()-e.getTime();return t<6e4?r("components.pizzint.justNow"):t<36e5?r("components.pizzint.minutesAgo",{m:String(Math.floor(t/6e4))}):r("components.pizzint.hoursAgo",{h:String(Math.floor(t/36e5))})}getDefconLabel(e){var a;const t=`components.pizzint.defconLabels.${e}`,s=r(t);return s===t?((a=this.status)==null?void 0:a.defconLabel)||"":s}getElement(){return this.element}hide(){this.element.style.display="none"}show(){this.element.style.display=""}}const br=3,pa=10,Cr=6e4,wr=1e4,kr=6,Mt="worldmonitor-intel-findings";class ut{constructor(){y(this,"badge");y(this,"dropdown");y(this,"isOpen",!1);y(this,"refreshInterval",null);y(this,"lastFindingCount",0);y(this,"onSignalClick",null);y(this,"onAlertClick",null);y(this,"findings",[]);y(this,"boundCloseDropdown",()=>this.closeDropdown());y(this,"audio",null);y(this,"audioEnabled",!0);y(this,"enabled");y(this,"contextMenu",null);this.enabled=ut.getStoredEnabledState(),this.badge=document.createElement("button"),this.badge.className="intel-findings-badge",this.badge.title=r("components.intelligenceFindings.badgeTitle"),this.badge.innerHTML='<span class="findings-icon">üéØ</span><span class="findings-count">0</span>',this.dropdown=document.createElement("div"),this.dropdown.className="intel-findings-dropdown",this.badge.addEventListener("click",e=>{e.stopPropagation(),this.toggleDropdown()}),this.badge.addEventListener("contextmenu",e=>{e.preventDefault(),e.stopPropagation(),this.showContextMenu(e.clientX,e.clientY)}),this.dropdown.addEventListener("click",e=>{const t=e.target;if(t.closest(".findings-more")){e.stopPropagation(),this.showAllFindings(),this.closeDropdown();return}const s=t.closest(".finding-item");if(!s)return;e.stopPropagation();const a=s.getAttribute("data-finding-id"),i=this.findings.find(n=>n.id===a);i&&(is(i.id,i.source,i.type,i.priority),i.source==="signal"&&this.onSignalClick?this.onSignalClick(i.original):i.source==="alert"&&this.onAlertClick&&this.onAlertClick(i.original),this.closeDropdown())}),this.enabled&&(document.addEventListener("click",this.boundCloseDropdown),this.mount(),this.initAudio(),this.update(),this.startRefresh())}initAudio(){this.audio=new Audio("data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleQYjfKapmWswEjCJvuPQfSoXZZ+3qqBJESSP0unGaxMJVYiytrFeLhR6p8znrFUXRW+bs7V3Qx1hn8Xjp1cYPnegprhkMCFmoLi1k0sZTYGlqqlUIA=="),this.audio.volume=.3}playSound(){this.audioEnabled&&this.audio&&(this.audio.currentTime=0,this.audio.play().catch(()=>{}))}setOnSignalClick(e){this.onSignalClick=e}setOnAlertClick(e){this.onAlertClick=e}static getStoredEnabledState(){return localStorage.getItem(Mt)!=="hidden"}isEnabled(){return this.enabled}setEnabled(e){this.enabled!==e&&(this.enabled=e,e?(localStorage.removeItem(Mt),document.addEventListener("click",this.boundCloseDropdown),this.mount(),this.initAudio(),this.update(),this.startRefresh()):(localStorage.setItem(Mt,"hidden"),document.removeEventListener("click",this.boundCloseDropdown),this.refreshInterval&&(clearInterval(this.refreshInterval),this.refreshInterval=null),this.closeDropdown(),this.dismissContextMenu(),this.badge.remove()))}showContextMenu(e,t){this.dismissContextMenu();const s=document.createElement("div");s.className="intel-findings-context-menu",s.style.left=`${e}px`,s.style.top=`${t}px`,s.innerHTML=`<div class="context-menu-item">${r("components.intelligenceFindings.hideFindings")}</div>`,s.querySelector(".context-menu-item").addEventListener("click",i=>{i.stopPropagation(),this.setEnabled(!1),this.dismissContextMenu()});const a=()=>this.dismissContextMenu();document.addEventListener("click",a,{once:!0}),this.contextMenu=s,document.body.appendChild(s)}dismissContextMenu(){this.contextMenu&&(this.contextMenu.remove(),this.contextMenu=null)}mount(){const e=document.querySelector(".header-right");e&&(this.badge.appendChild(this.dropdown),e.insertBefore(this.badge,e.firstChild))}startRefresh(){this.refreshInterval=setInterval(()=>this.update(),wr)}update(){this.findings=this.mergeFindings();const e=this.findings.length,t=this.badge.querySelector(".findings-count");t&&(t.textContent=String(e)),e>this.lastFindingCount&&this.lastFindingCount>0&&(this.badge.classList.add("pulse"),setTimeout(()=>this.badge.classList.remove("pulse"),1e3),this.playSound()),this.lastFindingCount=e;const s=this.findings.some(i=>i.priority==="critical"),a=this.findings.some(i=>i.priority==="high"||i.confidence>=.7);this.badge.classList.remove("status-none","status-low","status-high"),e===0?(this.badge.classList.add("status-none"),this.badge.title=r("components.intelligenceFindings.none")):s||a?(this.badge.classList.add("status-high"),this.badge.title=r("components.intelligenceFindings.reviewRecommended",{count:String(e)})):e<=br?(this.badge.classList.add("status-low"),this.badge.title=r("components.intelligenceFindings.count",{count:String(e)})):(this.badge.classList.add("status-high"),this.badge.title=r("components.intelligenceFindings.reviewRecommended",{count:String(e)})),this.renderDropdown()}mergeFindings(){const e=yi(),t=vi(kr),s=e.map(i=>({id:`signal-${i.id}`,source:"signal",type:i.type,title:i.title,description:i.description,confidence:i.confidence,priority:i.confidence>=.7?"high":i.confidence>=.5?"medium":"low",timestamp:i.timestamp,original:i})),a=t.map(i=>({id:`alert-${i.id}`,source:"alert",type:i.type,title:i.title,description:i.summary,confidence:this.priorityToConfidence(i.priority),priority:i.priority,timestamp:i.timestamp,original:i}));return[...s,...a].sort((i,n)=>{const l=n.timestamp.getTime()-i.timestamp.getTime();return Math.abs(l)<Cr?this.priorityScore(n.priority)-this.priorityScore(i.priority):l})}priorityToConfidence(e){return{critical:95,high:80,medium:60,low:40}[e]??50}priorityScore(e){return{critical:4,high:3,medium:2,low:1}[e]??0}renderDropdown(){if(this.findings.length===0){this.dropdown.innerHTML=`
        <div class="findings-header">
          <span class="header-title">${r("components.intelligenceFindings.title")}</span>
          <span class="findings-badge none">${r("components.intelligenceFindings.monitoring")}</span>
        </div>
        <div class="findings-content">
          <div class="findings-empty">
            <span class="empty-icon">üì°</span>
            <span class="empty-text">${r("components.intelligenceFindings.scanning")}</span>
          </div>
        </div>
      `;return}const e=this.findings.filter(l=>l.priority==="critical").length,t=this.findings.filter(l=>l.priority==="high"||l.confidence>=70).length;let s="moderate",a=r("components.intelligenceFindings.detected",{count:String(this.findings.length)});e>0?(s="critical",a=r("components.intelligenceFindings.critical",{count:String(e)})):t>0&&(s="high",a=r("components.intelligenceFindings.highPriority",{count:String(t)}));const i=this.findings.slice(0,pa).map(l=>{const o=this.formatTimeAgo(l.timestamp),c=this.getTypeIcon(l.type),h=l.priority,d=this.getInsight(l);return`
        <div class="finding-item ${h}" data-finding-id="${m(l.id)}">
          <div class="finding-header">
            <span class="finding-type">${c} ${m(l.title)}</span>
            <span class="finding-confidence ${h}">${r(`components.intelligenceFindings.priority.${l.priority}`)}</span>
          </div>
          <div class="finding-description">${m(l.description)}</div>
          <div class="finding-meta">
            <span class="finding-insight">${m(d)}</span>
            <span class="finding-time">${o}</span>
          </div>
        </div>
      `}).join(""),n=this.findings.length-pa;this.dropdown.innerHTML=`
      <div class="findings-header">
        <span class="header-title">${r("components.intelligenceFindings.title")}</span>
        <span class="findings-badge ${s}">${a}</span>
      </div>
      <div class="findings-content">
        <div class="findings-list">
          ${i}
        </div>
        ${n>0?`<div class="findings-more">${r("components.intelligenceFindings.more",{count:String(n)})}</div>`:""}
      </div>
    `}getInsight(e){if(e.source==="signal")return(La(e.original.type).actionableInsight??"").split(".")[0]||"";const t=e.original;if(t.type==="cii_spike"){const s=t.components.ciiChange;return s&&s.change>=30?r("components.intelligenceFindings.insights.criticalDestabilization"):s&&s.change>=20?r("components.intelligenceFindings.insights.significantShift"):r("components.intelligenceFindings.insights.developingSituation")}return t.type==="convergence"?r("components.intelligenceFindings.insights.convergence"):t.type==="cascade"?r("components.intelligenceFindings.insights.cascade"):r("components.intelligenceFindings.insights.review")}getTypeIcon(e){return{breaking_surge:"üî•",silent_divergence:"üîá",flow_price_divergence:"üìä",explained_market_move:"üí°",prediction_leads_news:"üîÆ",geo_convergence:"üåç",hotspot_escalation:"‚ö†Ô∏è",news_leads_markets:"üì∞",velocity_spike:"üìà",keyword_spike:"üìä",convergence:"üîÄ",triangulation:"üî∫",flow_drop:"‚¨áÔ∏è",sector_cascade:"üåä",cii_spike:"üî¥",cascade:"‚ö°",composite:"üîó"}[e]||"üìå"}formatTimeAgo(e){const t=Date.now()-e.getTime();return t<6e4?r("components.intelligenceFindings.time.justNow"):t<36e5?r("components.intelligenceFindings.time.minutesAgo",{count:String(Math.floor(t/6e4))}):t<864e5?r("components.intelligenceFindings.time.hoursAgo",{count:String(Math.floor(t/36e5))}):r("components.intelligenceFindings.time.daysAgo",{count:String(Math.floor(t/864e5))})}toggleDropdown(){this.isOpen=!this.isOpen,this.dropdown.classList.toggle("open",this.isOpen),this.badge.classList.toggle("active",this.isOpen),this.isOpen&&this.update()}closeDropdown(){this.isOpen=!1,this.dropdown.classList.remove("open"),this.badge.classList.remove("active")}showAllFindings(){var s;const e=document.createElement("div");e.className="findings-modal-overlay";const t=this.findings.map(a=>{const i=this.formatTimeAgo(a.timestamp),n=this.getTypeIcon(a.type),l=this.getInsight(a);return`
        <div class="findings-modal-item ${a.priority}" data-finding-id="${m(a.id)}">
          <div class="findings-modal-item-header">
            <span class="findings-modal-item-type">${n} ${m(a.title)}</span>
            <span class="findings-modal-item-priority ${a.priority}">${r(`components.intelligenceFindings.priority.${a.priority}`)}</span>
          </div>
          <div class="findings-modal-item-desc">${m(a.description)}</div>
          <div class="findings-modal-item-meta">
            <span class="findings-modal-item-insight">${m(l)}</span>
            <span class="findings-modal-item-time">${i}</span>
          </div>
        </div>
      `}).join("");e.innerHTML=`
      <div class="findings-modal">
        <div class="findings-modal-header">
          <span class="findings-modal-title">üéØ ${r("components.intelligenceFindings.all",{count:String(this.findings.length)})}</span>
          <button class="findings-modal-close">√ó</button>
        </div>
        <div class="findings-modal-content">
          ${t}
        </div>
      </div>
    `,(s=e.querySelector(".findings-modal-close"))==null||s.addEventListener("click",()=>e.remove()),e.addEventListener("click",a=>{a.target.classList.contains("findings-modal-overlay")&&e.remove()}),e.querySelectorAll(".findings-modal-item").forEach(a=>{a.addEventListener("click",()=>{const i=a.getAttribute("data-finding-id"),n=this.findings.find(l=>l.id===i);n&&(is(n.id,n.source,n.type,n.priority),n.source==="signal"&&this.onSignalClick?(this.onSignalClick(n.original),e.remove()):n.source==="alert"&&this.onAlertClick&&(this.onAlertClick(n.original),e.remove()))})}),document.body.appendChild(e)}destroy(){this.refreshInterval&&clearInterval(this.refreshInterval),document.removeEventListener("click",this.boundCloseDropdown),this.badge.remove()}}class $r{constructor(){y(this,"element");y(this,"isOpen",!1);y(this,"currentLang");this.currentLang=fi(),this.element=document.createElement("div"),this.element.className="custom-lang-selector",this.render(),this.setupEventListeners()}getElement(){return this.element}getFlagUrl(e){return`https://flagcdn.com/24x18/${{en:"gb",ar:"sa",zh:"cn",fr:"fr",de:"de",es:"es",it:"it",pl:"pl",pt:"pt",nl:"nl",sv:"se",ru:"ru",ja:"jp",tr:"tr"}[e]||e}.png`}render(){const e=yt.find(t=>t.code===this.currentLang)||yt[0];this.element.innerHTML=`
      <button class="lang-selector-btn" aria-label="${r("components.languageSelector.selectLanguage")}">
        <img src="${this.getFlagUrl(this.currentLang)}" alt="${e==null?void 0:e.label}" class="lang-flag-icon" />
        <span class="lang-code">${this.currentLang.toUpperCase()}</span>
        <span class="lang-arrow">‚ñº</span>
      </button>
      <div class="lang-dropdown hidden">
        ${yt.map(t=>`
          <div class="lang-option ${t.code===this.currentLang?"active":""}" data-code="${t.code}">
            <img src="${this.getFlagUrl(t.code)}" alt="${t.label}" class="lang-flag-icon" />
            <span class="lang-name">${t.label}</span>
          </div>
        `).join("")}
      </div>
    `}setupEventListeners(){const e=this.element.querySelector(".lang-selector-btn"),t=this.element.querySelector(".lang-dropdown");!e||!t||(e.addEventListener("click",s=>{s.stopPropagation(),this.toggle()}),this.element.querySelectorAll(".lang-option").forEach(s=>{s.addEventListener("click",a=>{const i=a.currentTarget.dataset.code;i&&i!==this.currentLang&&Ea(i),this.close()})}),document.addEventListener("click",s=>{this.element.contains(s.target)||this.close()}))}toggle(){this.isOpen=!this.isOpen;const e=this.element.querySelector(".lang-dropdown");this.isOpen?(e==null||e.classList.remove("hidden"),this.element.classList.add("open")):(e==null||e.classList.add("hidden"),this.element.classList.remove("open"))}close(){this.isOpen=!1;const e=this.element.querySelector(".lang-dropdown");e==null||e.classList.add("hidden"),this.element.classList.remove("open")}}const Sr={US:["united states","usa","america","washington","biden","trump","pentagon"],RU:["russia","moscow","kremlin","putin"],CN:["china","beijing","xi jinping","prc"],UA:["ukraine","kyiv","zelensky","donbas"],IR:["iran","tehran","khamenei","irgc"],IL:["israel","tel aviv","netanyahu","idf","gaza"],TW:["taiwan","taipei"],KP:["north korea","pyongyang","kim jong"],SA:["saudi arabia","riyadh","mbs"],TR:["turkey","ankara","erdogan"],PL:["poland","warsaw"],DE:["germany","berlin"],FR:["france","paris","macron"],GB:["britain","uk","london","starmer"],IN:["india","delhi","modi"],PK:["pakistan","islamabad"],SY:["syria","damascus","assad"],YE:["yemen","sanaa","houthi"],MM:["myanmar","burma","rangoon"],VE:["venezuela","caracas","maduro"]};function da(p,e,t,s,a,i,n){var f,b;const o=Rt().find(k=>k.code===p)||null,c=Sr[p]||[e.toLowerCase()],h=t.filter(k=>{const C=k.primaryTitle.toLowerCase();return c.some(w=>C.includes(w))}),d=[...h].sort((k,C)=>{var E,A;const w={critical:5,high:4,medium:3,low:2,info:1},$=w[((E=k.threat)==null?void 0:E.level)||"info"]||0;return(w[((A=C.threat)==null?void 0:A.level)||"info"]||0)-$}),g=s.find(k=>{var C,w;return((C=k.targetNation)==null?void 0:C.toLowerCase())===e.toLowerCase()||((w=k.shortName)==null?void 0:w.toLowerCase())===p.toLowerCase()})||null,u=a.filter(k=>{const C=k.title.toLowerCase();return c.some(w=>C.includes(w))}),v={critical:0,high:0,medium:0,categories:new Set};for(const k of h){const C=(f=k.threat)==null?void 0:f.level;C==="critical"?v.critical++:C==="high"?v.high++:C==="medium"&&v.medium++,(b=k.threat)!=null&&b.category&&k.threat.category!=="general"&&v.categories.add(k.threat.category)}return{countryCode:p,countryName:e,cii:o?{score:o.score,level:o.level,trend:o.trend,components:o.components,change24h:o.change24h}:null,news:d.slice(0,5).map(k=>{var C;return{title:k.primaryTitle,threatLevel:((C=k.threat)==null?void 0:C.level)||"info",sourceCount:k.sourceCount}}),theater:g?{theaterName:g.theaterName,postureLevel:g.postureLevel,totalAircraft:g.totalAircraft,totalVessels:g.totalVessels,fighters:g.fighters,tankers:g.tankers,awacs:g.awacs,strikeCapable:g.strikeCapable}:null,markets:u.slice(0,4).map(k=>({title:k.title,yesPrice:k.yesPrice})),threats:{critical:v.critical,high:v.high,medium:v.medium,categories:[...v.categories]},signals:i||{protests:0,militaryFlights:0,militaryVessels:0,outages:0},convergence:n||null}}const Ve=1080,ue=1920;function Lr(p){return{prediction_leads_news:"Prediction Leading",news_leads_markets:"News Leading",silent_divergence:"Silent Divergence",velocity_spike:"Velocity Spike",keyword_spike:"Keyword Spike",convergence:"Convergence",triangulation:"Triangulation",flow_drop:"Flow Drop",flow_price_divergence:"Flow/Price Divergence",geo_convergence:"Geographic Convergence",explained_market_move:"Market Move Explained",sector_cascade:"Sector Cascade",military_surge:"Military Surge",military_flight:"Military Flights",internet_outage:"Internet Outages",protest:"Protests",naval_vessel:"Naval Vessels",ais_gap:"AIS Gaps",satellite_fire:"Satellite Fires"}[p]||p.replace(/_/g," ").replace(/\b\w/g,t=>t.toUpperCase())}const Er={critical:"#ef4444",high:"#f97316",elevated:"#eab308",normal:"#22c55e",low:"#3b82f6"},xr={critical:"#ef4444",high:"#f97316",medium:"#eab308",low:"#22c55e",info:"#3b82f6"},Mr="/favico/worldmonitor-icon-1024.png";function Tr(p){return new Promise((e,t)=>{const s=new Image;s.onload=()=>e(s),s.onerror=t,s.src=p})}async function Oa(p){var Ee,pe,de,x,L,Je,et,tt;const e=document.createElement("canvas");e.width=Ve,e.height=ue;const t=e.getContext("2d");let s=null;try{s=await Tr(Mr)}catch{}t.fillStyle="#0c0c14",t.fillRect(0,0,Ve,ue);let a=0;const i=72,n=Ve-i,l=48;a=60,s&&t.drawImage(s,i,a-4,l,l);const o=s?i+l+14:i;t.fillStyle="#666",t.font="700 30px Inter, system-ui, sans-serif",t.letterSpacing="6px",t.fillText("WORLDMONITOR",o,a+26),t.letterSpacing="0px";const c=new Date().toLocaleDateString(bi(),{weekday:"short",day:"numeric",month:"short",year:"numeric"});t.font="400 24px Inter, system-ui, sans-serif",t.fillStyle="#555";const h=t.measureText(c).width;t.fillText(c,n-h,a+26),a+=56,Te(t,a,i),a+=74,t.fillStyle="#ffffff",t.font="800 86px Inter, system-ui, sans-serif",t.fillText(p.countryName.toUpperCase(),i,a),t.font="700 28px Inter, system-ui, sans-serif";const d=p.countryCode,g=t.measureText(d).width+24;t.fillStyle="rgba(255,255,255,0.1)",re(t,n-g,a-28,g,36,6),t.fill(),t.fillStyle="#888",t.fillText(d,n-g+12,a-2);const u=Er[((Ee=p.cii)==null?void 0:Ee.level)||"normal"]||"#888",v=((pe=p.cii)==null?void 0:pe.score)??0;a+=62,t.fillStyle=u,t.font="800 72px Inter, system-ui, sans-serif",t.fillText(`${v}`,i,a);const f=t.measureText(`${v}`).width;t.fillStyle="#777",t.font="400 38px Inter, system-ui, sans-serif",t.fillText("/100",i+f+4,a);const b=t.measureText("/100").width;if((de=p.cii)!=null&&de.change24h){const _=p.cii.change24h,q=_>0?"+":"";t.fillStyle=_>0?"#ef4444":_<0?"#22c55e":"#888",t.font="600 28px Inter, system-ui, sans-serif",t.fillText(`${q}${_} 24h`,i+f+4+b+16,a)}const k=((x=p.cii)==null?void 0:x.trend)==="rising"?"‚ñ≤":((L=p.cii)==null?void 0:L.trend)==="falling"?"‚ñº":"‚óè",C=(((Je=p.cii)==null?void 0:Je.trend)||"stable").toUpperCase(),w=(((et=p.cii)==null?void 0:et.level)||"normal").toUpperCase();t.font="700 26px Inter, system-ui, sans-serif",t.fillStyle=u;const $=`${k} ${C}`,P=t.measureText($).width+28;re(t,n-P,a-26,P,34,6),t.fill(),t.fillStyle="#fff",t.fillText($,n-P+14,a-3),t.font="600 22px Inter, system-ui, sans-serif";const E=t.measureText(w).width+24,A=n-P-E-12;t.fillStyle="rgba(255,255,255,0.08)",re(t,A,a-24,E,30,4),t.fill(),t.fillStyle=u,t.fillText(w,A+12,a-3),a+=32;const N=Ve-i*2;if(t.fillStyle="#1a1a2e",re(t,i,a,N,18,9),t.fill(),v>0&&(t.fillStyle=u,re(t,i,a,N*v/100,18,9),t.fill()),(tt=p.cii)!=null&&tt.components){a+=44;const _=[{label:r("common.unrest").toUpperCase(),val:p.cii.components.unrest,color:"#f97316"},{label:r("common.conflict").toUpperCase(),val:p.cii.components.conflict,color:"#dc2626"},{label:r("common.security").toUpperCase(),val:p.cii.components.security,color:"#ef4444"},{label:r("common.information").toUpperCase(),val:p.cii.components.information,color:"#8b5cf6"}],q=(N-24)/3;for(const I of _){const z=i+_.indexOf(I)*(q+12);t.fillStyle="#777",t.font="600 20px Inter, system-ui, sans-serif",t.fillText(I.label,z,a),t.fillStyle=I.color,t.font="700 20px Inter, system-ui, sans-serif";const H=I.val.toFixed(0),me=t.measureText(H).width;t.fillText(H,z+q-me,a),t.fillStyle="#1a1a2e",re(t,z,a+8,q,8,4),t.fill(),t.fillStyle=I.color,re(t,z,a+8,q*Math.min(I.val,100)/100,8,4),t.fill()}a+=24}if(p.signals.protests+p.signals.militaryFlights+p.signals.militaryVessels+p.signals.outages>0){a+=40,Te(t,a,i),a+=46,Re(t,"ACTIVE SIGNALS",i,a),a+=48;const _=[{icon:"üì¢",label:"Protests",count:p.signals.protests,color:"#f97316"},{icon:"‚úà",label:"Military Aircraft",count:p.signals.militaryFlights,color:"#ef4444"},{icon:"‚öì",label:"Military Vessels",count:p.signals.militaryVessels,color:"#3b82f6"},{icon:"üåê",label:"Internet Outages",count:p.signals.outages,color:"#8b5cf6"}].filter(I=>I.count>0),q=(n-i)/Math.min(_.length,4);for(const I of _){const z=i+_.indexOf(I)*q;t.fillStyle=I.color,t.font="800 40px Inter, system-ui, sans-serif",t.fillText(`${I.count}`,z,a),t.fillStyle="#aaa",t.font="400 20px Inter, system-ui, sans-serif",t.fillText(`${I.icon} ${I.label}`,z,a+28)}a+=28}if(p.convergence&&p.convergence.score>0){a+=40,Te(t,a,i),a+=46,Re(t,"SIGNAL CONVERGENCE",i,a),a+=46;const _=Math.round(p.convergence.score),q=_>=70?"#ef4444":_>=40?"#eab308":"#22c55e";t.fillStyle=q,t.font="800 48px Inter, system-ui, sans-serif",t.fillText(`${_}`,i,a);const I=t.measureText(`${_}`).width;t.fillStyle="#777",t.font="400 30px Inter, system-ui, sans-serif",t.fillText("/100 convergence",i+I+10,a),p.convergence.signalTypes.length>0&&(a+=36,t.fillStyle="#999",t.font="400 22px Inter, system-ui, sans-serif",t.fillText(p.convergence.signalTypes.map(Lr).join("  ¬∑  "),i,a));for(const z of p.convergence.regionalDescriptions.slice(0,2))a+=34,t.fillStyle="#888",t.font="400 22px Inter, system-ui, sans-serif",t.fillText(Tt(t,z,n-i),i,a)}const B=ue-110;if(p.news.length>0&&a<B-200){a+=40,Te(t,a,i),a+=46,Re(t,"TOP HEADLINES",i,a);for(const z of p.news.slice(0,5)){if(a>B-80)break;a+=54;const H=xr[z.threatLevel]||"#3b82f6",me=z.threatLevel.toUpperCase();t.font="700 20px Inter, system-ui, sans-serif";const ye=t.measureText(me).width+18;t.fillStyle=H,t.globalAlpha=.2,re(t,i,a-20,ye,28,4),t.fill(),t.globalAlpha=1,t.fillStyle=H,t.fillText(me,i+9,a),t.fillStyle="#e0e0e0",t.font="400 26px Inter, system-ui, sans-serif";const D=i+ye+14,V=n-D;if(t.fillText(Tt(t,z.title,V),D,a),z.sourceCount>1){t.fillStyle="#666",t.font="400 18px Inter, system-ui, sans-serif";const J=`${z.sourceCount} sources`,xe=t.measureText(J).width;t.fillText(J,n-xe,a)}}a+=36;const _=p.news.reduce((z,H)=>z+(H.sourceCount||1),0),q=p.news.filter(z=>z.threatLevel==="critical"||z.threatLevel==="high").length;t.fillStyle="#555",t.font="400 22px Inter, system-ui, sans-serif";let I=`${_} sources across ${p.news.length} stories`;q>0&&(I+=`  ¬∑  ${q} high-priority alerts`),t.fillText(I,i,a)}if(p.theater&&a<B-200){a+=40,Te(t,a,i),a+=46,Re(t,"MILITARY POSTURE",i,a);const _=p.theater.postureLevel==="critical"?"#ef4444":p.theater.postureLevel==="elevated"?"#f97316":"#22c55e";a+=52,t.fillStyle="#e0e0e0",t.font="600 32px Inter, system-ui, sans-serif",t.fillText(p.theater.theaterName,i,a);const q=p.theater.postureLevel.toUpperCase();t.font="700 24px Inter, system-ui, sans-serif";const I=t.measureText(q).width+24;t.fillStyle=_,re(t,n-I,a-24,I,34,6),t.fill(),t.fillStyle="#fff",t.fillText(q,n-I+12,a-2),a+=48,t.font="400 28px Inter, system-ui, sans-serif",t.fillStyle="#bbb",t.fillText(`‚úà ${p.theater.totalAircraft} aircraft`,i,a);const z=t.measureText(`‚úà ${p.theater.totalAircraft} aircraft`).width;if(t.fillText(`‚öì ${p.theater.totalVessels} vessels`,i+z+40,a),p.theater.fighters||p.theater.tankers||p.theater.awacs){a+=40,t.fillStyle="#888",t.font="400 24px Inter, system-ui, sans-serif";const H=[];p.theater.fighters&&H.push(`Fighters: ${p.theater.fighters}`),p.theater.tankers&&H.push(`Tankers: ${p.theater.tankers}`),p.theater.awacs&&H.push(`AWACS: ${p.theater.awacs}`),t.fillText(H.join("   ¬∑   "),i,a)}p.theater.strikeCapable&&(a+=40,t.fillStyle="#ef4444",t.font="700 24px Inter, system-ui, sans-serif",t.fillText("‚ö† STRIKE CAPABLE",i,a))}if(p.markets.length>0&&a<B-150){a+=40,Te(t,a,i),a+=46,Re(t,"PREDICTION MARKETS",i,a);for(const _ of p.markets.slice(0,4)){a+=50,t.fillStyle="#ddd",t.font="400 26px Inter, system-ui, sans-serif",t.fillText(Tt(t,_.title,n-i-120),i,a);const q=Math.round(_.yesPrice),I=`${q}%`,z=q>=70?"#ef4444":q>=40?"#eab308":"#22c55e";t.fillStyle=z,t.font="700 28px Inter, system-ui, sans-serif";const H=t.measureText(I).width;t.fillText(I,n-H,a)}}if(p.threats.critical+p.threats.high+p.threats.medium>0&&a<B-150){a+=40,Te(t,a,i),a+=46,Re(t,"THREAT BREAKDOWN",i,a),a+=48;const _=[{label:"Critical",count:p.threats.critical,color:"#ef4444"},{label:"High",count:p.threats.high,color:"#f97316"},{label:"Medium",count:p.threats.medium,color:"#eab308"}].filter(I=>I.count>0),q=Math.max(..._.map(I=>I.count));for(const I of _){t.fillStyle=I.color,t.font="700 26px Inter, system-ui, sans-serif",t.fillText(`${I.count}`,i,a),t.fillStyle="#bbb",t.font="400 26px Inter, system-ui, sans-serif";const z=t.measureText(`${I.count}`).width;t.fillText(` ${I.label}`,i+z,a);const H=i+200,ye=(n-H)*(I.count/q);t.fillStyle=I.color,t.globalAlpha=.35,re(t,H,a-18,ye,26,5),t.fill(),t.globalAlpha=1,a+=40}p.threats.categories.length>0&&(a+=6,t.fillStyle="#888",t.font="400 24px Inter, system-ui, sans-serif",t.fillText(p.threats.categories.map(I=>I.charAt(0).toUpperCase()+I.slice(1)).join("  ¬∑  "),i,a))}const X=new Date().toISOString().replace("T"," ").slice(0,16)+" UTC";t.strokeStyle="#222",t.lineWidth=1,t.beginPath(),t.moveTo(i,ue-90),t.lineTo(n,ue-90),t.stroke();const Q=40;s&&t.drawImage(s,i,ue-78,Q,Q);const ie=s?i+Q+12:i;t.fillStyle="#444",t.font="600 24px Inter, system-ui, sans-serif",t.letterSpacing="2px",t.fillText("WORLDMONITOR.APP",ie,ue-55),t.letterSpacing="0px",t.font="400 20px Inter, system-ui, sans-serif",t.fillText("Real-time global intelligence monitoring",ie,ue-30),t.font="400 22px Inter, system-ui, sans-serif",t.fillStyle="#555";const ge=t.measureText(X).width;return t.fillText(X,n-ge,ue-55),e}function Te(p,e,t){p.strokeStyle="#222",p.lineWidth=1,p.beginPath(),p.moveTo(t,e),p.lineTo(Ve-t,e),p.stroke()}function Re(p,e,t,s){p.fillStyle="#777",p.font="700 26px Inter, system-ui, sans-serif",p.letterSpacing="4px",p.fillText(e,t,s),p.letterSpacing="0px"}function Tt(p,e,t){if(p.measureText(e).width<=t)return e;let s=e;for(;s.length>0&&p.measureText(s+"...").width>t;)s=s.slice(0,-1);return s+"..."}function re(p,e,t,s,a,i){p.beginPath(),p.moveTo(e+i,t),p.lineTo(e+s-i,t),p.quadraticCurveTo(e+s,t,e+s,t+i),p.lineTo(e+s,t+a-i),p.quadraticCurveTo(e+s,t+a,e+s-i,t+a),p.lineTo(e+i,t+a),p.quadraticCurveTo(e,t+a,e,t+a-i),p.lineTo(e,t+i),p.quadraticCurveTo(e,t,e+i,t),p.closePath()}function ht(p,e="ciianalysis",t,s){const a=new URLSearchParams({c:p,t:e,ts:Date.now().toString()});return t!==void 0&&a.set("s",String(t)),s&&a.set("l",s),`https://worldmonitor.app/api/story?${a.toString()}`}function Pt(p){const e=p.toUpperCase();return e.length!==2?"":String.fromCodePoint(127462+e.charCodeAt(0)-65,127462+e.charCodeAt(1)-65)}const pt={twitter:p=>{var e,t;return`${Pt(p.countryCode)} ${p.countryName} Intelligence Brief

Instability: ${((e=p.cii)==null?void 0:e.score)||"N/A"}/100 (${((t=p.cii)==null?void 0:t.level)||"N/A"})
${p.threats.critical>0?`‚ö†Ô∏è ${p.threats.critical} critical threats
`:""}
Generated by @WorldMonitorApp`},whatsapp:p=>{var e,t,s,a,i;return`${Pt(p.countryCode)} *${p.countryName} Intelligence Brief*

*Instability:* ${((e=p.cii)==null?void 0:e.score)||"N/A"}/100 (${((t=p.cii)==null?void 0:t.level)||"N/A"})
*Trend:* ${((s=p.cii)==null?void 0:s.trend)||"stable"}
${p.threats.critical>0?`*‚ö†Ô∏è Critical:* ${p.threats.critical}
`:""}${p.threats.high>0?`*üî¥ High:* ${p.threats.high}
`:""}
üìä View full analysis: ${ht(p.countryCode,"ciianalysis",(a=p.cii)==null?void 0:a.score,(i=p.cii)==null?void 0:i.level)}`},linkedin:p=>{var e,t,s;return`Intelligence Update: ${p.countryName}

Real-time instability assessment:
‚Ä¢ Score: ${((e=p.cii)==null?void 0:e.score)||"N/A"}/100 (${((t=p.cii)==null?void 0:t.level)||"N/A"})
‚Ä¢ 24h change: ${(s=p.cii)!=null&&s.change24h?(p.cii.change24h>0?"+":"")+p.cii.change24h:"N/A"}%
${p.threats.critical>0?`‚Ä¢ Critical threats: ${p.threats.critical}
`:""}
Data via World Monitor - Open source geopolitical intelligence`},telegram:p=>{var e,t,s,a,i,n;return`${Pt(p.countryCode)} *${p.countryName} Intelligence*

üìä Instability: *${((e=p.cii)==null?void 0:e.score)||"N/A"}/100* (${((t=p.cii)==null?void 0:t.level)||"N/A"})
üìà Trend: *${((s=p.cii)==null?void 0:s.trend)||"stable"}*
${(a=p.cii)!=null&&a.change24h?`üìâ 24h: *${p.cii.change24h>0?"+":""}${p.cii.change24h}*
`:""}${p.threats.critical>0?`üö® Critical: *${p.threats.critical}*
`:""}${p.threats.high>0?`üî¥ High: *${p.threats.high}*
`:""}
üîó ${ht(p.countryCode,"ciianalysis",(i=p.cii)==null?void 0:i.score,(n=p.cii)==null?void 0:n.level)}`}};function Xt(p){var s,a;const e=ht(p.countryCode,"ciianalysis",(s=p.cii)==null?void 0:s.score,(a=p.cii)==null?void 0:a.level);return{twitter:`https://twitter.com/intent/tweet?text=${encodeURIComponent(pt.twitter(p))}&url=${encodeURIComponent(e)}`,linkedin:`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(e)}`,reddit:`https://reddit.com/submit?url=${encodeURIComponent(e)}&title=${encodeURIComponent(`${p.countryName} Intelligence Brief - World Monitor`)}`,facebook:`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(e)}`,whatsapp:`https://wa.me/?text=${encodeURIComponent(pt.whatsapp(p).replace(`
`,"%0A"))}`,telegram:`https://t.me/share/url?url=${encodeURIComponent(e)}&text=${encodeURIComponent(pt.telegram(p).replace(`
`,"%0A"))}`}}let U=null,Fe=null,Ze=null,ae=null;function Pr(p){var e,t,s,a,i,n;At(),ae=p,U=document.createElement("div"),U.className="story-modal-overlay",U.innerHTML=`
    <div class="story-modal">
      <button class="story-close-x" aria-label="${r("modals.story.close")}">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M15 5L5 15M5 5l10 10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      </button>
      <div class="story-modal-content">
        <div class="story-loading">
          <div class="story-spinner"></div>
          <span>${r("modals.story.generating")}</span>
        </div>
      </div>
      <div class="story-share-bar" style="display:none">
        <button class="story-share-btn story-save" title="${r("modals.story.save")}">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M12 3v12m0 0l-4-4m4 4l4-4M4 17v2a2 2 0 002 2h12a2 2 0 002-2v-2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <span>${r("modals.story.save")}</span>
        </button>
        <button class="story-share-btn story-whatsapp" title="${r("modals.story.whatsapp")}">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/><path d="M12 2C6.477 2 2 6.477 2 12c0 1.89.525 3.66 1.438 5.168L2 22l4.832-1.438A9.955 9.955 0 0012 22c5.523 0 10-4.477 10-10S17.523 2 12 2z"/></svg>
          <span>${r("modals.story.whatsapp")}</span>
        </button>
        <button class="story-share-btn story-twitter" title="${r("modals.story.twitter")}">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
          <span>${r("modals.story.twitter")}</span>
        </button>
        <button class="story-share-btn story-linkedin" title="${r("modals.story.linkedin")}">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 01-2.063-2.065 2.064 2.064 0 112.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
          <span>${r("modals.story.linkedin")}</span>
        </button>
        <button class="story-share-btn story-copy" title="${r("modals.story.copyLink")}">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
          <span>${r("modals.story.copyLink")}</span>
        </button>
      </div>
    </div>
  `,U.addEventListener("click",l=>{l.target===U&&At()}),(e=U.querySelector(".story-close-x"))==null||e.addEventListener("click",At),(t=U.querySelector(".story-save"))==null||t.addEventListener("click",Ot),(s=U.querySelector(".story-whatsapp"))==null||s.addEventListener("click",()=>ae&&Ir(ae)),(a=U.querySelector(".story-twitter"))==null||a.addEventListener("click",()=>ae&&Rr(ae)),(i=U.querySelector(".story-linkedin"))==null||i.addEventListener("click",()=>ae&&Nr(ae)),(n=U.querySelector(".story-copy"))==null||n.addEventListener("click",()=>ae&&Dr(ae)),document.body.appendChild(U),requestAnimationFrame(async()=>{if(U)try{await Ar(p)}catch(l){console.error("[StoryModal] Render error:",l);const o=U==null?void 0:U.querySelector(".story-modal-content");o&&(o.innerHTML=`<div class="story-error">${r("modals.story.error")}</div>`)}})}async function Ar(p){Fe=(await Oa(p)).toDataURL("image/png");const t=atob(Fe.split(",")[1]??""),s=new Uint8Array(t.length);for(let n=0;n<t.length;n++)s[n]=t.charCodeAt(n);Ze=new Blob([s],{type:"image/png"});const a=U==null?void 0:U.querySelector(".story-modal-content");if(a){a.innerHTML="";const n=document.createElement("img");n.className="story-image",n.src=Fe,n.alt=`${p.countryName} Intelligence Story`,a.appendChild(n)}const i=U==null?void 0:U.querySelector(".story-share-bar");i&&(i.style.display="flex")}function At(){U&&(U.remove(),U=null,Fe=null,Ze=null,ae=null)}function Ot(){if(!Fe)return;const p=document.createElement("a");p.href=Fe,p.download=`worldmonitor-${(ae==null?void 0:ae.countryCode.toLowerCase())||"story"}-${Date.now()}.png`,p.click(),Be(".story-save",r("modals.story.saved"),r("modals.story.save"))}async function Ir(p){var s;if(!Ze){Ot();return}const e=new File([Ze],`${p.countryCode.toLowerCase()}-worldmonitor.png`,{type:"image/png"}),t=Xt(p);if(navigator.share&&((s=navigator.canShare)!=null&&s.call(navigator,{files:[e]})))try{await navigator.share({text:pt.whatsapp(p).replace(`

`,`
`),files:[e]});return}catch{}try{await navigator.clipboard.write([new ClipboardItem({"image/png":Ze})]),Be(".story-whatsapp",r("modals.story.copied"),r("modals.story.whatsapp"))}catch{Ot(),Be(".story-whatsapp",r("modals.story.saved"),r("modals.story.whatsapp"))}window.open(t.whatsapp,"_blank")}async function Rr(p){const e=Xt(p);window.open(e.twitter,"_blank"),Be(".story-twitter",r("modals.story.opening"),r("modals.story.twitter"))}async function Nr(p){const e=Xt(p);window.open(e.linkedin,"_blank"),Be(".story-linkedin",r("modals.story.opening"),r("modals.story.linkedin"))}async function Dr(p){const e=ht(p.countryCode);await navigator.clipboard.writeText(e),Be(".story-copy",r("modals.story.copied"),r("modals.story.copyLink"))}function Be(p,e,t){const s=U==null?void 0:U.querySelector(p);if(!s)return;const a=s.querySelector("span");a&&(a.textContent=e,setTimeout(()=>{a&&(a.textContent=t)},2500))}const Fr=!1,Hr="full",K=class K{constructor(e){y(this,"container");y(this,"PANEL_ORDER_KEY","panel-order");y(this,"PANEL_SPANS_KEY","worldmonitor-panel-spans");y(this,"map",null);y(this,"panels",{});y(this,"newsPanels",{});y(this,"allNews",[]);y(this,"newsByCategory",{});y(this,"currentTimeRange","7d");y(this,"monitors");y(this,"panelSettings");y(this,"mapLayers");y(this,"signalModal",null);y(this,"playbackControl",null);y(this,"statusPanel",null);y(this,"exportPanel",null);y(this,"languageSelector",null);y(this,"searchModal",null);y(this,"mobileWarningModal",null);y(this,"pizzintIndicator",null);y(this,"latestPredictions",[]);y(this,"latestMarkets",[]);y(this,"latestClusters",[]);y(this,"applyTimeRangeFilterToNewsPanelsDebounced",It(()=>{this.applyTimeRangeFilterToNewsPanels()},120));y(this,"isPlaybackMode",!1);y(this,"initialUrlState",null);y(this,"inFlight",new Set);y(this,"isMobile");y(this,"seenGeoAlerts",new Set);y(this,"snapshotIntervalId",null);y(this,"refreshTimeoutIds",new Map);y(this,"isDestroyed",!1);y(this,"boundKeydownHandler",null);y(this,"boundFullscreenHandler",null);y(this,"boundResizeHandler",null);y(this,"boundVisibilityHandler",null);y(this,"idleTimeoutId",null);y(this,"boundIdleResetHandler",null);y(this,"isIdle",!1);y(this,"IDLE_PAUSE_MS",120*1e3);y(this,"disabledSources",new Set);y(this,"mapFlashCache",new Map);y(this,"MAP_FLASH_COOLDOWN_MS",600*1e3);y(this,"initialLoadComplete",!1);y(this,"criticalBannerEl",null);y(this,"countryBriefPage",null);y(this,"countryTimeline",null);y(this,"findingsBadge",null);y(this,"pendingDeepLinkCountry",null);y(this,"briefRequestToken",0);y(this,"isDesktopApp",Ci());y(this,"UPDATE_CHECK_INTERVAL_MS",360*60*1e3);y(this,"updateCheckIntervalId",null);y(this,"clockIntervalId",null);y(this,"intelligenceCache",{});y(this,"cyberThreatsCache",null);const t=document.getElementById(e);if(!t)throw new Error(`Container ${e} not found`);this.container=t,this.isMobile=gt(),this.monitors=st(Z.monitors,[]);const s=this.isMobile?wi:ki,a=localStorage.getItem("worldmonitor-variant"),i=M;if(console.log(`[App] Variant check: stored="${a}", current="${i}"`),a!==i)console.log("[App] Variant changed - resetting to defaults"),localStorage.setItem("worldmonitor-variant",i),localStorage.removeItem(Z.mapLayers),localStorage.removeItem(Z.panels),localStorage.removeItem(this.PANEL_ORDER_KEY),localStorage.removeItem(this.PANEL_SPANS_KEY),this.mapLayers={...s},this.panelSettings={..._e};else{this.mapLayers=st(Z.mapLayers,s),this.panelSettings=st(Z.panels,_e),console.log("[App] Loaded panel settings from storage:",Object.entries(this.panelSettings).filter(([o,c])=>!c.enabled).map(([o])=>o));const l="worldmonitor-panel-order-v1.9";if(!localStorage.getItem(l)){const o=localStorage.getItem(this.PANEL_ORDER_KEY);if(o)try{const c=JSON.parse(o),h=["insights","strategic-posture","cii","strategic-risk"],d=c.filter(v=>!h.includes(v)&&v!=="live-news"),u=c.indexOf("live-news")!==-1?["live-news"]:[];u.push(...h.filter(v=>c.includes(v))),u.push(...d),localStorage.setItem(this.PANEL_ORDER_KEY,JSON.stringify(u)),console.log("[App] Migrated panel order to v1.8 layout")}catch{}localStorage.setItem(l,"done")}if(i==="tech"){const o="worldmonitor-tech-insights-top-v1";if(!localStorage.getItem(o)){const c=localStorage.getItem(this.PANEL_ORDER_KEY);if(c)try{const h=JSON.parse(c),d=h.filter(u=>u!=="insights"&&u!=="live-news"),g=[];h.includes("live-news")&&g.push("live-news"),h.includes("insights")&&g.push("insights"),g.push(...d),localStorage.setItem(this.PANEL_ORDER_KEY,JSON.stringify(g)),console.log("[App] Tech variant: Migrated insights panel to top")}catch{}localStorage.setItem(o,"done")}}}const n="worldmonitor-layout-reset-v2.5";if(!localStorage.getItem(n)){const l=!!localStorage.getItem(this.PANEL_ORDER_KEY),o=!!localStorage.getItem(this.PANEL_SPANS_KEY);(l||o)&&(localStorage.removeItem(this.PANEL_ORDER_KEY),localStorage.removeItem(this.PANEL_SPANS_KEY),console.log("[App] Applied layout reset migration (v2.5): cleared panel order/spans")),localStorage.setItem(n,"done")}if(this.isDesktopApp){const l=this.panelSettings["runtime-config"]??{name:"Desktop Configuration",enabled:!0,priority:2};l.enabled=!0,this.panelSettings["runtime-config"]=l,se(Z.panels,this.panelSettings)}if(this.initialUrlState=ns(window.location.search,this.mapLayers),this.initialUrlState.layers){if(i==="tech"){const l=["conflicts","bases","hotspots","nuclear","irradiators","sanctions","military","protests","pipelines","waterways","ais","flights","spaceports","minerals"],o=this.initialUrlState.layers;l.forEach(c=>{o[c]=!1})}this.mapLayers=this.initialUrlState.layers}this.mapLayers.cyberThreats=!1,this.disabledSources=new Set(st(Z.disabledFeeds,[]))}async init(){var s,a,i;const e=performance.now();await $i(),await Si(),await be.init(),vt()?this.mapLayers.ais&&os():this.mapLayers.ais=!1,this.renderLayout(),this.startHeaderClock(),this.signalModal=new hr,this.signalModal.setLocationClickHandler((n,l)=>{var o;(o=this.map)==null||o.setCenter(n,l,4)}),this.isMobile||(this.findingsBadge=new ut,this.findingsBadge.setOnSignalClick(n=>{var l,o;(l=this.countryBriefPage)!=null&&l.isVisible()||localStorage.getItem("wm-settings-open")!=="1"&&((o=this.signalModal)==null||o.showSignal(n))}),this.findingsBadge.setOnAlertClick(n=>{var l,o;(l=this.countryBriefPage)!=null&&l.isVisible()||localStorage.getItem("wm-settings-open")!=="1"&&((o=this.signalModal)==null||o.showAlert(n))})),this.setupMobileWarning(),this.setupPlaybackControl(),this.setupStatusPanel(),this.setupPizzIntIndicator(),this.setupExportPanel(),this.setupLanguageSelector(),this.setupSearchModal(),this.setupMapLayerHandlers(),this.setupCountryIntel(),this.setupEventListeners();const t=ns(window.location.search,this.mapLayers);this.pendingDeepLinkCountry=t.country??null,this.setupUrlStateSync(),this.syncDataFreshnessWithLayers(),await Li(),await this.loadAllData(),lo(),vt()||(s=this.map)==null||s.hideLayerToggle("ais"),Gs()===!1&&((a=this.map)==null||a.hideLayerToggle("outages")),(i=this.map)==null||i.hideLayerToggle("cyberThreats"),this.setupRefreshIntervals(),this.setupSnapshotSaving(),Ei().catch(n=>console.warn("[Storage] Snapshot cleanup failed:",n)),this.handleDeepLinks(),this.setupUpdateChecks(),xi("wm_app_loaded",{load_time_ms:Math.round(performance.now()-e),panel_count:Object.keys(this.panels).length}),this.setupPanelViewTracking()}handleDeepLinks(){const e=new URL(window.location.href),t=60,s=500,a=2e3;if(e.pathname==="/story"||e.searchParams.has("c")){const n=e.searchParams.get("c");if(n){rs("story",n);const o={UA:"Ukraine",RU:"Russia",CN:"China",US:"United States",IR:"Iran",IL:"Israel",TW:"Taiwan",KP:"North Korea",SA:"Saudi Arabia",TR:"Turkey",PL:"Poland",DE:"Germany",FR:"France",GB:"United Kingdom",IN:"India",PK:"Pakistan",SY:"Syria",YE:"Yemen",MM:"Myanmar",VE:"Venezuela"}[n.toUpperCase()]||n;let c=0;const h=()=>{if(S.hasSufficientData()&&this.latestClusters.length>0){this.openCountryStory(n.toUpperCase(),o);return}if(c+=1,c>=t){this.showToast("Data not available");return}else setTimeout(h,s)};setTimeout(h,a),history.replaceState(null,"","/");return}}const i=this.pendingDeepLinkCountry;if(this.pendingDeepLinkCountry=null,i){rs("country",i);const n=K.resolveCountryName(i);let l=0;const o=()=>{if(S.hasSufficientData()){this.openCountryBriefByCode(i,n);return}if(l+=1,l>=t){this.showToast("Data not available");return}else setTimeout(o,s)};setTimeout(o,a)}}setupPanelViewTracking(){const e=new Set,t=new IntersectionObserver(a=>{for(const i of a)if(i.isIntersecting&&i.intersectionRatio>=.3){const n=i.target.dataset.panel;n&&!e.has(n)&&(e.add(n),Mi(n))}},{threshold:.3}),s=document.getElementById("panelsGrid");if(s)for(const a of Array.from(s.children))a.dataset.panel&&t.observe(a)}setupUpdateChecks(){!this.isDesktopApp||this.isDestroyed||(setTimeout(()=>{this.isDestroyed||this.checkForUpdate()},5e3),this.updateCheckIntervalId&&clearInterval(this.updateCheckIntervalId),this.updateCheckIntervalId=setInterval(()=>{this.isDestroyed||this.checkForUpdate()},this.UPDATE_CHECK_INTERVAL_MS))}logUpdaterOutcome(e,t={}){(e==="open_failed"||e==="fetch_failed"?console.warn:console.info)("[updater]",e,t)}getDesktopBuildVariant(){return Hr}async checkForUpdate(){try{const e=await fetch("https://worldmonitor.app/api/version");if(!e.ok){this.logUpdaterOutcome("fetch_failed",{status:e.status});return}const t=await e.json(),s=t.version;if(!s){this.logUpdaterOutcome("fetch_failed",{reason:"missing_remote_version"});return}const a="2.5.4";if(!this.isNewerVersion(s,a)){this.logUpdaterOutcome("no_update",{current:a,remote:s});return}const i=`wm-update-dismissed-${s}`;if(localStorage.getItem(i)){this.logUpdaterOutcome("update_available",{current:a,remote:s,dismissed:!0});return}const n=typeof t.url=="string"&&t.url?t.url:"https://github.com/koala73/worldmonitor/releases/latest";this.logUpdaterOutcome("update_available",{current:a,remote:s,dismissed:!1}),Ti(a,s),await this.showUpdateBadge(s,n)}catch(e){this.logUpdaterOutcome("fetch_failed",{error:e instanceof Error?e.message:String(e)})}}isNewerVersion(e,t){const s=e.split(".").map(Number),a=t.split(".").map(Number);for(let i=0;i<Math.max(s.length,a.length);i++){const n=s[i]??0,l=a[i]??0;if(n>l)return!0;if(n<l)return!1}return!1}mapDesktopDownloadPlatform(e,t){const s=e.toLowerCase(),a=t.toLowerCase().replace("amd64","x86_64").replace("x64","x86_64").replace("arm64","aarch64");return s==="windows"?a==="x86_64"?"windows-exe":null:s==="macos"||s==="darwin"?a==="aarch64"?"macos-arm64":a==="x86_64"?"macos-x64":null:null}async resolveUpdateDownloadUrl(e){try{const t=await ls("get_desktop_runtime_info"),s=this.mapDesktopDownloadPlatform(t.os,t.arch);if(s){const a=this.getDesktopBuildVariant();return`https://worldmonitor.app/api/download?platform=${s}&variant=${a}`}}catch{}return e}async showUpdateBadge(e,t){const s=this.container.querySelector(".version");if(!s)return;const a=this.container.querySelector(".update-badge");if((a==null?void 0:a.dataset.version)===e)return;a==null||a.remove();const i=await this.resolveUpdateDownloadUrl(t),n=document.createElement("a");n.className="update-badge",n.dataset.version=e,n.href=i,n.target=this.isDesktopApp?"_self":"_blank",n.rel="noopener",n.textContent=`UPDATE v${e}`,n.addEventListener("click",o=>{if(o.preventDefault(),Pi(e),this.isDesktopApp){ls("open_url",{url:i}).catch(c=>{this.logUpdaterOutcome("open_failed",{url:i,error:c instanceof Error?c.message:String(c)}),window.open(i,"_blank","noopener")});return}window.open(i,"_blank","noopener")});const l=document.createElement("span");l.className="update-badge-dismiss",l.textContent="√ó",l.addEventListener("click",o=>{o.preventDefault(),o.stopPropagation(),Ai(e),localStorage.setItem(`wm-update-dismissed-${e}`,"1"),n.remove()}),n.appendChild(l),s.insertAdjacentElement("afterend",n)}startHeaderClock(){const e=document.getElementById("headerClock");if(!e)return;const t=()=>{e.textContent=new Date().toUTCString().replace("GMT","UTC")};t(),this.clockIntervalId=setInterval(t,1e3)}setupMobileWarning(){ca.shouldShow()&&(this.mobileWarningModal=new ca,this.mobileWarningModal.show())}setupStatusPanel(){this.statusPanel=new Ii;const e=this.container.querySelector(".header-left");e&&e.appendChild(this.statusPanel.getElement())}setupPizzIntIndicator(){if(M==="tech"||M==="finance")return;this.pizzintIndicator=new fr;const e=this.container.querySelector(".header-left");e&&e.appendChild(this.pizzintIndicator.getElement())}async loadPizzInt(){var e,t,s,a,i,n,l,o;try{const[c,h]=await Promise.all([Ri(),Ni()]);if(c.locationsMonitored===0){(e=this.pizzintIndicator)==null||e.hide(),(t=this.statusPanel)==null||t.updateApi("PizzINT",{status:"error"}),S.recordError("pizzint","No monitored locations returned");return}(s=this.pizzintIndicator)==null||s.show(),(a=this.pizzintIndicator)==null||a.updateStatus(c),(i=this.pizzintIndicator)==null||i.updateTensions(h),(n=this.statusPanel)==null||n.updateApi("PizzINT",{status:"ok"}),S.recordUpdate("pizzint",Math.max(c.locationsMonitored,h.length))}catch(c){console.error("[App] PizzINT load failed:",c),(l=this.pizzintIndicator)==null||l.hide(),(o=this.statusPanel)==null||o.updateApi("PizzINT",{status:"error"}),S.recordError("pizzint",String(c))}}setupExportPanel(){this.exportPanel=new Di(()=>({news:this.latestClusters.length>0?this.latestClusters:this.allNews,markets:this.latestMarkets,predictions:this.latestPredictions,timestamp:Date.now()}));const e=this.container.querySelector(".header-right");e&&e.insertBefore(this.exportPanel.getElement(),e.firstChild)}setupLanguageSelector(){this.languageSelector=new $r;const e=this.container.querySelector(".header-right"),t=this.container.querySelector("#searchBtn");e&&t?e.insertBefore(this.languageSelector.getElement(),t):e&&e.insertBefore(this.languageSelector.getElement(),e.firstChild)}syncDataFreshnessWithLayers(){for(const[e,t]of Object.entries(cs)){const s=this.mapLayers[e]??!1;for(const a of t)S.setEnabled(a,s)}vt()||S.setEnabled("ais",!1),Gs()===!1&&S.setEnabled("outages",!1)}setupMapLayerHandlers(){var e;(e=this.map)==null||e.setOnLayerChange((t,s,a)=>{var n;console.log(`[App.onLayerChange] ${t}: ${s} (${a})`),Fi(t,s,a),this.mapLayers[t]=s,se(Z.mapLayers,this.mapLayers);const i=cs[t];if(i)for(const l of i)S.setEnabled(l,s);if(t==="ais"){s?((n=this.map)==null||n.setLayerLoading("ais",!0),os(),this.waitForAisData()):qs();return}s&&this.loadDataForLayer(t)})}setupCountryIntel(){this.map&&(this.countryBriefPage=new Dt,this.countryBriefPage.setShareStoryHandler((e,t)=>{var s;(s=this.countryBriefPage)==null||s.hide(),this.openCountryStory(e,t)}),this.countryBriefPage.setExportImageHandler(async(e,t)=>{try{const s=this.getCountrySignals(e,t),a=W.getCountryClusters().find(u=>u.country===e),i=W.getRegionalConvergence().filter(u=>u.countries.includes(e)),n=a?{score:a.convergenceScore,signalTypes:[...a.signalTypes],regionalDescriptions:i.map(u=>u.description)}:null,l=this.panels["strategic-posture"],o=(l==null?void 0:l.getPostures())||[],c=da(e,t,this.latestClusters,o,this.latestPredictions,s,n),d=(await Oa(c)).toDataURL("image/png"),g=document.createElement("a");g.href=d,g.download=`country-brief-${e.toLowerCase()}-${Date.now()}.png`,g.click()}catch(s){console.error("[CountryBrief] Image export failed:",s)}}),this.map.onCountryClicked(async e=>{e.code&&e.name?(ps(e.code,e.name,"map"),this.openCountryBriefByCode(e.code,e.name)):this.openCountryBrief(e.lat,e.lon)}),this.countryBriefPage.onClose(()=>{var t,s,a;this.briefRequestToken++,(t=this.map)==null||t.clearCountryHighlight(),(s=this.map)==null||s.setRenderPaused(!1),(a=this.countryTimeline)==null||a.destroy(),this.countryTimeline=null;const e=this.getShareUrl();e&&history.replaceState(null,"",e)}))}async openCountryBrief(e,t){var n,l;if(!this.countryBriefPage)return;const s=++this.briefRequestToken;this.countryBriefPage.showLoading(),(n=this.map)==null||n.setRenderPaused(!0);const a=Sa(e,t);if(a){if(s!==this.briefRequestToken)return;this.openCountryBriefByCode(a.code,a.name);return}const i=await Uo(e,t);if(s===this.briefRequestToken){if(!i){this.countryBriefPage.hide(),(l=this.map)==null||l.setRenderPaused(!1);return}this.openCountryBriefByCode(i.code,i.country)}}async openCountryBriefByCode(e,t){var v,f;if(!this.countryBriefPage)return;(v=this.map)==null||v.setRenderPaused(!0),Hi(e);const s=Oe[e]||K.resolveCountryName(e);s!==e&&(t=s);const i=Rt().find(b=>b.code===e)??null,n=this.getCountrySignals(e,t);this.countryBriefPage.show(t,e,i,n),(f=this.map)==null||f.highlightCountry(e);const l=this.getShareUrl();l&&history.replaceState(null,"",l);const c=new Bi("",{fetch:(...b)=>globalThis.fetch(...b)}).getCountryStockIndex({countryCode:e}).then(b=>({available:b.available,code:b.code,symbol:b.symbol,indexName:b.indexName,price:String(b.price),weekChangePercent:String(b.weekChangePercent),currency:b.currency})).catch(()=>({available:!1,code:"",symbol:"",indexName:"",price:"0",weekChangePercent:"0",currency:""}));c.then(b=>{var k;((k=this.countryBriefPage)==null?void 0:k.getCode())===e&&this.countryBriefPage.updateStock(b)}),zi(t).then(b=>{var k;((k=this.countryBriefPage)==null?void 0:k.getCode())===e&&this.countryBriefPage.updateMarkets(b)}).catch(()=>{var b;((b=this.countryBriefPage)==null?void 0:b.getCode())===e&&this.countryBriefPage.updateMarkets([])});const h=K.getCountrySearchTerms(t,e),d=K.getOtherCountryTerms(e),u=this.allNews.filter(b=>{const k=b.title.toLowerCase();return h.some(C=>k.includes(C))}).filter(b=>{const k=b.title.toLowerCase(),C=K.firstMentionPosition(k,h),w=K.firstMentionPosition(k,d);return C!==1/0&&(w===1/0||C<=w)});u.length>0&&this.countryBriefPage.updateNews(u.slice(0,8)),this.countryBriefPage.updateInfrastructure(e),this.mountCountryTimeline(e,t);try{const b={};i&&(b.score=i.score,b.level=i.level,b.trend=i.trend,b.components=i.components,b.change24h=i.change24h),Object.assign(b,n);const k=W.getCountryClusters().find(E=>E.country===e);k&&(b.convergenceScore=k.convergenceScore,b.signalTypes=[...k.signalTypes]);const C=W.getRegionalConvergence().filter(E=>E.countries.includes(e));C.length&&(b.regionalConvergence=C.map(E=>E.description));const w=u.slice(0,15).map(E=>E.title);w.length&&(b.headlines=w);const $=await c;if($.available){const E=parseFloat($.weekChangePercent);b.stockIndex=`${$.indexName}: ${$.price} (${E>=0?"+":""}${$.weekChangePercent}% week)`}let P="";try{P=(await new _i("",{fetch:(...N)=>globalThis.fetch(...N)}).getCountryIntelBrief({countryCode:e})).brief}catch{}if(P)this.countryBriefPage.updateBrief({brief:P,country:t,code:e});else{const E=b.headlines||[];let A="";const N=ds?"summarization-beta":"summarization";if(E.length>=2&&be.isAvailable&&be.isModelLoaded(N))try{const F=`Summarize the current situation in ${t} based on these headlines: ${E.slice(0,8).join(". ")}`,[B]=await be.summarize([F],ds?"summarization-beta":void 0);B&&B.length>20&&(A=B)}catch{}if(A)this.countryBriefPage.updateBrief({brief:A,country:t,code:e,fallback:!0});else{const F=[];i&&F.push(r("countryBrief.fallback.instabilityIndex",{score:String(i.score),level:r(`countryBrief.levels.${i.level}`),trend:r(`countryBrief.trends.${i.trend}`)})),n.protests>0&&F.push(r("countryBrief.fallback.protestsDetected",{count:String(n.protests)})),n.militaryFlights>0&&F.push(r("countryBrief.fallback.aircraftTracked",{count:String(n.militaryFlights)})),n.militaryVessels>0&&F.push(r("countryBrief.fallback.vesselsTracked",{count:String(n.militaryVessels)})),n.outages>0&&F.push(r("countryBrief.fallback.internetOutages",{count:String(n.outages)})),n.earthquakes>0&&F.push(r("countryBrief.fallback.recentEarthquakes",{count:String(n.earthquakes)})),b.stockIndex&&F.push(r("countryBrief.fallback.stockIndex",{value:b.stockIndex})),E.length>0&&(F.push("",r("countryBrief.fallback.recentHeadlines")),E.slice(0,5).forEach(B=>F.push(`‚Ä¢ ${B}`))),F.length>0?this.countryBriefPage.updateBrief({brief:F.join(`
`),country:t,code:e,fallback:!0}):this.countryBriefPage.updateBrief({brief:"",country:t,code:e,error:"No AI service available. Configure GROQ_API_KEY in Settings for full briefs."})}}}catch(b){console.error("[CountryBrief] fetch error:",b),this.countryBriefPage.updateBrief({brief:"",country:t,code:e,error:"Failed to generate brief"})}}mountCountryTimeline(e,t){var h,d,g,u,v,f,b,k,C;(h=this.countryTimeline)==null||h.destroy(),this.countryTimeline=null;const s=(d=this.countryBriefPage)==null?void 0:d.getTimelineMount();if(!s)return;const a=[],i=t.toLowerCase(),n=us(e)||!!K.COUNTRY_BOUNDS[e],l=(w,$)=>n&&this.isInCountry(w,$,e),o=Date.now()-10080*60*1e3;if((g=this.intelligenceCache.protests)!=null&&g.events)for(const w of this.intelligenceCache.protests.events)(((u=w.country)==null?void 0:u.toLowerCase())===i||l(w.lat,w.lon))&&a.push({timestamp:new Date(w.time).getTime(),lane:"protest",label:w.title||`${w.eventType} in ${w.city||w.country}`,severity:w.severity==="high"?"high":w.severity==="medium"?"medium":"low"});if(this.intelligenceCache.earthquakes)for(const w of this.intelligenceCache.earthquakes)(l(((v=w.location)==null?void 0:v.latitude)??0,((f=w.location)==null?void 0:f.longitude)??0)||(b=w.place)!=null&&b.toLowerCase().includes(i))&&a.push({timestamp:w.occurredAt,lane:"natural",label:`M${w.magnitude.toFixed(1)} ${w.place}`,severity:w.magnitude>=6?"critical":w.magnitude>=5?"high":w.magnitude>=4?"medium":"low"});if(this.intelligenceCache.military){for(const w of this.intelligenceCache.military.flights)(n?this.isInCountry(w.lat,w.lon,e):((k=w.operatorCountry)==null?void 0:k.toUpperCase())===e)&&a.push({timestamp:new Date(w.lastSeen).getTime(),lane:"military",label:`${w.callsign} (${w.aircraftModel||w.aircraftType})`,severity:w.isInteresting?"high":"low"});for(const w of this.intelligenceCache.military.vessels)(n?this.isInCountry(w.lat,w.lon,e):((C=w.operatorCountry)==null?void 0:C.toUpperCase())===e)&&a.push({timestamp:new Date(w.lastAisUpdate).getTime(),lane:"military",label:`${w.name} (${w.vesselType})`,severity:w.isDark?"high":"low"})}const c=hs(e);if(c!=null&&c.conflicts)for(const w of c.conflicts)a.push({timestamp:new Date(w.time).getTime(),lane:"conflict",label:`${w.eventType}: ${w.location||w.country}`,severity:w.fatalities>0?"critical":"high"});this.countryTimeline=new jo(s),this.countryTimeline.render(a.filter(w=>w.timestamp>=o))}static firstMentionPosition(e,t){let s=1/0;for(const a of t){const i=e.indexOf(a);i!==-1&&i<s&&(s=i)}return s}static getOtherCountryTerms(e){const t=K.otherCountryTermsCache.get(e);if(t)return t;const s=new Set;Object.entries(K.COUNTRY_ALIASES).forEach(([i,n])=>{i!==e&&n.forEach(l=>{const o=l.toLowerCase();o.trim().length>0&&s.add(o)})});const a=[...s];return K.otherCountryTermsCache.set(e,a),a}static resolveCountryName(e){if(Oe[e])return Oe[e];try{const t=Intl.DisplayNames;if(!t)return e;const a=new t(["en"],{type:"region"}).of(e);if(a&&a.toUpperCase()!==e)return a}catch{}return e}static getCountrySearchTerms(e,t){const s=K.COUNTRY_ALIASES[t];return s||(/^[A-Z]{2}$/i.test(e.trim())?[]:[e.toLowerCase()])}isInCountry(e,t,s){const a=Oi(e,t,s);if(a!=null)return a;const i=K.COUNTRY_BOUNDS[s];return i?e>=i.s&&e<=i.n&&t>=i.w&&t<=i.e:!1}getCountrySignals(e,t){var g,u;const s=t.toLowerCase(),a=us(e)||!!K.COUNTRY_BOUNDS[e];let i=0;(g=this.intelligenceCache.protests)!=null&&g.events&&(i=this.intelligenceCache.protests.events.filter(v=>{var f;return((f=v.country)==null?void 0:f.toLowerCase())===s||a&&this.isInCountry(v.lat,v.lon,e)}).length);let n=0,l=0;this.intelligenceCache.military&&(n=this.intelligenceCache.military.flights.filter(v=>{var f;return a?this.isInCountry(v.lat,v.lon,e):((f=v.operatorCountry)==null?void 0:f.toUpperCase())===e}).length,l=this.intelligenceCache.military.vessels.filter(v=>{var f;return a?this.isInCountry(v.lat,v.lon,e):((f=v.operatorCountry)==null?void 0:f.toUpperCase())===e}).length);let o=0;this.intelligenceCache.outages&&(o=this.intelligenceCache.outages.filter(v=>{var f;return((f=v.country)==null?void 0:f.toLowerCase())===s||a&&this.isInCountry(v.lat,v.lon,e)}).length);let c=0;this.intelligenceCache.earthquakes&&(c=this.intelligenceCache.earthquakes.filter(v=>{var f,b,k;return a?this.isInCountry(((f=v.location)==null?void 0:f.latitude)??0,((b=v.location)==null?void 0:b.longitude)??0,e):(k=v.place)==null?void 0:k.toLowerCase().includes(s)}).length);const h=hs(e),d=!!Oe[e];return{protests:i,militaryFlights:n,militaryVessels:l,outages:o,earthquakes:c,displacementOutflow:(h==null?void 0:h.displacementOutflow)??0,climateStress:(h==null?void 0:h.climateStress)??0,conflictEvents:((u=h==null?void 0:h.conflicts)==null?void 0:u.length)??0,isTier1:d}}openCountryStory(e,t){if(!S.hasSufficientData()||this.latestClusters.length===0){this.showToast("Data still loading ‚Äî try again in a moment");return}const s=this.panels["strategic-posture"],a=(s==null?void 0:s.getPostures())||[],i=this.getCountrySignals(e,t),n=W.getCountryClusters().find(h=>h.country===e),l=W.getRegionalConvergence().filter(h=>h.countries.includes(e)),o=n?{score:n.convergenceScore,signalTypes:[...n.signalTypes],regionalDescriptions:l.map(h=>h.description)}:null,c=da(e,t,this.latestClusters,a,this.latestPredictions,i,o);Pr(c)}showToast(e){var s;(s=document.querySelector(".toast-notification"))==null||s.remove();const t=document.createElement("div");t.className="toast-notification",t.textContent=e,document.body.appendChild(t),requestAnimationFrame(()=>t.classList.add("visible")),setTimeout(()=>{t.classList.remove("visible"),setTimeout(()=>t.remove(),300)},3e3)}shouldShowIntelligenceNotifications(){var e;return!this.isMobile&&!!((e=this.findingsBadge)!=null&&e.isEnabled())}setupSearchModal(){const e=M==="tech"?{placeholder:r("modals.search.placeholderTech"),hint:r("modals.search.hintTech")}:M==="finance"?{placeholder:r("modals.search.placeholderFinance"),hint:r("modals.search.hintFinance")}:{placeholder:r("modals.search.placeholder"),hint:r("modals.search.hint")};this.searchModal=new yr(this.container,e),M==="tech"?(this.searchModal.registerSource("techcompany",Ui.map(t=>{var s;return{id:t.id,title:t.name,subtitle:`${t.sector} ${t.city} ${((s=t.keyProducts)==null?void 0:s.join(" "))||""}`.trim(),data:t}})),this.searchModal.registerSource("ailab",Gi.map(t=>{var s;return{id:t.id,title:t.name,subtitle:`${t.type} ${t.city} ${((s=t.focusAreas)==null?void 0:s.join(" "))||""}`.trim(),data:t}})),this.searchModal.registerSource("startup",qi.map(t=>{var s,a;return{id:t.id,title:t.name,subtitle:`${t.ecosystemTier} ${((s=t.topSectors)==null?void 0:s.join(" "))||""} ${((a=t.notableStartups)==null?void 0:a.join(" "))||""}`.trim(),data:t}})),this.searchModal.registerSource("datacenter",Se.map(t=>({id:t.id,title:t.name,subtitle:`${t.owner} ${t.chipType||""}`.trim(),data:t}))),this.searchModal.registerSource("cable",ce.map(t=>({id:t.id,title:t.name,subtitle:t.major?"Major internet backbone":"Undersea cable",data:t}))),this.searchModal.registerSource("techhq",We.map(t=>({id:t.id,title:t.company,subtitle:`${t.type==="faang"?"Big Tech":t.type==="unicorn"?"Unicorn":"Public"} ‚Ä¢ ${t.city}, ${t.country}`,data:t}))),this.searchModal.registerSource("accelerator",qt.map(t=>({id:t.id,title:t.name,subtitle:`${t.type} ‚Ä¢ ${t.city}, ${t.country}${t.notable?` ‚Ä¢ ${t.notable.slice(0,2).join(", ")}`:""}`,data:t})))):(this.searchModal.registerSource("hotspot",He.map(t=>{var s;return{id:t.id,title:t.name,subtitle:`${t.subtext||""} ${((s=t.keywords)==null?void 0:s.join(" "))||""} ${t.description||""}`.trim(),data:t}})),this.searchModal.registerSource("conflict",Le.map(t=>{var s,a;return{id:t.id,title:t.name,subtitle:`${((s=t.parties)==null?void 0:s.join(" "))||""} ${((a=t.keywords)==null?void 0:a.join(" "))||""} ${t.description||""}`.trim(),data:t}})),this.searchModal.registerSource("base",De.map(t=>({id:t.id,title:t.name,subtitle:`${t.type} ${t.description||""}`.trim(),data:t}))),this.searchModal.registerSource("pipeline",Xe.map(t=>{var s;return{id:t.id,title:t.name,subtitle:`${t.type} ${t.operator||""} ${((s=t.countries)==null?void 0:s.join(" "))||""}`.trim(),data:t}})),this.searchModal.registerSource("cable",ce.map(t=>({id:t.id,title:t.name,subtitle:t.major?"Major cable":"",data:t}))),this.searchModal.registerSource("datacenter",Se.map(t=>({id:t.id,title:t.name,subtitle:`${t.owner} ${t.chipType||""}`.trim(),data:t}))),this.searchModal.registerSource("nuclear",Ne.map(t=>({id:t.id,title:t.name,subtitle:`${t.type} ${t.operator||""}`.trim(),data:t}))),this.searchModal.registerSource("irradiator",Qe.map(t=>({id:t.id,title:`${t.city}, ${t.country}`,subtitle:t.organization||"",data:t})))),M==="finance"&&(this.searchModal.registerSource("exchange",jt.map(t=>({id:t.id,title:`${t.shortName} - ${t.name}`,subtitle:`${t.tier} ‚Ä¢ ${t.city}, ${t.country}${t.marketCap?` ‚Ä¢ $${t.marketCap}T`:""}`,data:t}))),this.searchModal.registerSource("financialcenter",Vt.map(t=>({id:t.id,title:t.name,subtitle:`${t.type} financial center${t.gfciRank?` ‚Ä¢ GFCI #${t.gfciRank}`:""}${t.specialties?` ‚Ä¢ ${t.specialties.slice(0,3).join(", ")}`:""}`,data:t}))),this.searchModal.registerSource("centralbank",Wt.map(t=>({id:t.id,title:`${t.shortName} - ${t.name}`,subtitle:`${t.type}${t.currency?` ‚Ä¢ ${t.currency}`:""} ‚Ä¢ ${t.city}, ${t.country}`,data:t}))),this.searchModal.registerSource("commodityhub",Yt.map(t=>({id:t.id,title:t.name,subtitle:`${t.type} ‚Ä¢ ${t.city}, ${t.country}${t.commodities?` ‚Ä¢ ${t.commodities.slice(0,3).join(", ")}`:""}`,data:t})))),this.searchModal.registerSource("country",this.buildCountrySearchItems()),this.searchModal.setOnSelect(t=>this.handleSearchResult(t)),this.boundKeydownHandler=t=>{var s,a;(t.metaKey||t.ctrlKey)&&t.key==="k"&&(t.preventDefault(),(s=this.searchModal)!=null&&s.isOpen()?this.searchModal.close():(this.updateSearchIndex(),(a=this.searchModal)==null||a.open()))},document.addEventListener("keydown",this.boundKeydownHandler)}handleSearchResult(e){var t,s,a,i,n,l,o,c,h,d,g,u,v,f,b,k,C,w,$,P,E,A,N,F,B,te,X,Q,ie,ge,Ee,pe,de;switch(ji(e.type),e.type){case"news":{const x=e.data;this.scrollToPanel("politics"),this.highlightNewsItem(x.link);break}case"hotspot":{const x=e.data;(t=this.map)==null||t.setView("global"),setTimeout(()=>{var L;(L=this.map)==null||L.triggerHotspotClick(x.id)},300);break}case"conflict":{const x=e.data;(s=this.map)==null||s.setView("global"),setTimeout(()=>{var L;(L=this.map)==null||L.triggerConflictClick(x.id)},300);break}case"market":{this.scrollToPanel("markets");break}case"prediction":{this.scrollToPanel("polymarket");break}case"base":{const x=e.data;(a=this.map)==null||a.setView("global"),setTimeout(()=>{var L;(L=this.map)==null||L.triggerBaseClick(x.id)},300);break}case"pipeline":{const x=e.data;(i=this.map)==null||i.setView("global"),(n=this.map)==null||n.enableLayer("pipelines"),this.mapLayers.pipelines=!0,setTimeout(()=>{var L;(L=this.map)==null||L.triggerPipelineClick(x.id)},300);break}case"cable":{const x=e.data;(l=this.map)==null||l.setView("global"),(o=this.map)==null||o.enableLayer("cables"),this.mapLayers.cables=!0,setTimeout(()=>{var L;(L=this.map)==null||L.triggerCableClick(x.id)},300);break}case"datacenter":{const x=e.data;(c=this.map)==null||c.setView("global"),(h=this.map)==null||h.enableLayer("datacenters"),this.mapLayers.datacenters=!0,setTimeout(()=>{var L;(L=this.map)==null||L.triggerDatacenterClick(x.id)},300);break}case"nuclear":{const x=e.data;(d=this.map)==null||d.setView("global"),(g=this.map)==null||g.enableLayer("nuclear"),this.mapLayers.nuclear=!0,setTimeout(()=>{var L;(L=this.map)==null||L.triggerNuclearClick(x.id)},300);break}case"irradiator":{const x=e.data;(u=this.map)==null||u.setView("global"),(v=this.map)==null||v.enableLayer("irradiators"),this.mapLayers.irradiators=!0,setTimeout(()=>{var L;(L=this.map)==null||L.triggerIrradiatorClick(x.id)},300);break}case"earthquake":case"outage":(f=this.map)==null||f.setView("global");break;case"techcompany":{const x=e.data;(b=this.map)==null||b.setView("global"),(k=this.map)==null||k.enableLayer("techHQs"),this.mapLayers.techHQs=!0,setTimeout(()=>{var L;(L=this.map)==null||L.setCenter(x.lat,x.lon,4)},300);break}case"ailab":{const x=e.data;(C=this.map)==null||C.setView("global"),setTimeout(()=>{var L;(L=this.map)==null||L.setCenter(x.lat,x.lon,4)},300);break}case"startup":{const x=e.data;(w=this.map)==null||w.setView("global"),($=this.map)==null||$.enableLayer("startupHubs"),this.mapLayers.startupHubs=!0,setTimeout(()=>{var L;(L=this.map)==null||L.setCenter(x.lat,x.lon,4)},300);break}case"techevent":(P=this.map)==null||P.setView("global"),(E=this.map)==null||E.enableLayer("techEvents"),this.mapLayers.techEvents=!0;break;case"techhq":{const x=e.data;(A=this.map)==null||A.setView("global"),(N=this.map)==null||N.enableLayer("techHQs"),this.mapLayers.techHQs=!0,setTimeout(()=>{var L;(L=this.map)==null||L.setCenter(x.lat,x.lon,4)},300);break}case"accelerator":{const x=e.data;(F=this.map)==null||F.setView("global"),(B=this.map)==null||B.enableLayer("accelerators"),this.mapLayers.accelerators=!0,setTimeout(()=>{var L;(L=this.map)==null||L.setCenter(x.lat,x.lon,4)},300);break}case"exchange":{const x=e.data;(te=this.map)==null||te.setView("global"),(X=this.map)==null||X.enableLayer("stockExchanges"),this.mapLayers.stockExchanges=!0,setTimeout(()=>{var L;(L=this.map)==null||L.setCenter(x.lat,x.lon,4)},300);break}case"financialcenter":{const x=e.data;(Q=this.map)==null||Q.setView("global"),(ie=this.map)==null||ie.enableLayer("financialCenters"),this.mapLayers.financialCenters=!0,setTimeout(()=>{var L;(L=this.map)==null||L.setCenter(x.lat,x.lon,4)},300);break}case"centralbank":{const x=e.data;(ge=this.map)==null||ge.setView("global"),(Ee=this.map)==null||Ee.enableLayer("centralBanks"),this.mapLayers.centralBanks=!0,setTimeout(()=>{var L;(L=this.map)==null||L.setCenter(x.lat,x.lon,4)},300);break}case"commodityhub":{const x=e.data;(pe=this.map)==null||pe.setView("global"),(de=this.map)==null||de.enableLayer("commodityHubs"),this.mapLayers.commodityHubs=!0,setTimeout(()=>{var L;(L=this.map)==null||L.setCenter(x.lat,x.lon,4)},300);break}case"country":{const{code:x,name:L}=e.data;ps(x,L,"search"),this.openCountryBriefByCode(x,L);break}}}scrollToPanel(e){const t=document.querySelector(`[data-panel="${e}"]`);t&&(t.scrollIntoView({behavior:"smooth",block:"center"}),t.classList.add("flash-highlight"),setTimeout(()=>t.classList.remove("flash-highlight"),1500))}highlightNewsItem(e){setTimeout(()=>{const t=document.querySelector(`[data-news-id="${e}"]`);t&&(t.scrollIntoView({behavior:"smooth",block:"center"}),t.classList.add("flash-highlight"),setTimeout(()=>t.classList.remove("flash-highlight"),1500))},100)}updateSearchIndex(){if(!this.searchModal)return;this.searchModal.registerSource("country",this.buildCountrySearchItems());const e=this.allNews.slice(0,500).map(t=>({id:t.link,title:t.title,subtitle:t.source,data:t}));console.log(`[Search] Indexing ${e.length} news items (allNews total: ${this.allNews.length})`),this.searchModal.registerSource("news",e),this.latestPredictions.length>0&&this.searchModal.registerSource("prediction",this.latestPredictions.map(t=>({id:t.title,title:t.title,subtitle:`${Math.round(t.yesPrice)}% probability`,data:t}))),this.latestMarkets.length>0&&this.searchModal.registerSource("market",this.latestMarkets.map(t=>{var s;return{id:t.symbol,title:`${t.symbol} - ${t.name}`,subtitle:`$${((s=t.price)==null?void 0:s.toFixed(2))||"N/A"}`,data:t}}))}buildCountrySearchItems(){var a;const e=((a=this.panels.cii)==null?void 0:a.getScores())??[],t=e.length>0?e:Rt(),s=new Map(t.map(i=>[i.code,i]));return Object.entries(Oe).map(([i,n])=>{const l=s.get(i);return{id:i,title:`${K.toFlagEmoji(i)} ${n}`,subtitle:l?`CII: ${l.score}/100 ‚Ä¢ ${l.level}`:"Country Brief",data:{code:i,name:n}}})}static toFlagEmoji(e){const t=e.toUpperCase();return/^[A-Z]{2}$/.test(t)?t.split("").map(s=>String.fromCodePoint(127462+s.charCodeAt(0)-65)).join(""):"üè≥Ô∏è"}setupPlaybackControl(){this.playbackControl=new gr,this.playbackControl.onSnapshot(t=>{t?(this.isPlaybackMode=!0,this.restoreSnapshot(t)):(this.isPlaybackMode=!1,this.loadAllData())});const e=this.container.querySelector(".header-right");e&&e.insertBefore(this.playbackControl.getElement(),e.firstChild)}setupSnapshotSaving(){const e=async()=>{var s;if(this.isPlaybackMode||this.isDestroyed)return;const t={};this.latestMarkets.forEach(a=>{a.price!==null&&(t[a.symbol]=a.price)}),await ro({timestamp:Date.now(),events:this.latestClusters,marketPrices:t,predictions:this.latestPredictions.map(a=>({title:a.title,yesPrice:a.yesPrice})),hotspotLevels:((s=this.map)==null?void 0:s.getHotspotLevels())??{}})};e().catch(t=>console.warn("[Snapshot] save failed:",t)),this.snapshotIntervalId=setInterval(()=>void e().catch(t=>console.warn("[Snapshot] save failed:",t)),900*1e3)}restoreSnapshot(e){var a;for(const i of Object.values(this.newsPanels))i.showLoading();const t=e.events;this.latestClusters=t;const s=e.predictions.map((i,n)=>({id:`snap-${n}`,title:i.title,yesPrice:i.yesPrice,noPrice:100-i.yesPrice,volume24h:0,liquidity:0}));this.latestPredictions=s,this.panels.polymarket.renderPredictions(s),(a=this.map)==null||a.setHotspotLevels(e.hotspotLevels)}renderLayout(){this.container.innerHTML=`
      <div class="header">
        <div class="header-left">
          <div class="variant-switcher">
            <a href="${this.isDesktopApp||M==="full"?"#":"https://worldmonitor.app"}"
               class="variant-option ${M==="full"?"active":""}"
               data-variant="full"
               ${!this.isDesktopApp&&M!=="full"?'target="_blank" rel="noopener"':""}
               title="${r("header.world")}${M==="full"?` ${r("common.currentVariant")}`:""}">
              <span class="variant-icon">üåç</span>
              <span class="variant-label">${r("header.world")}</span>
            </a>
            <span class="variant-divider"></span>
            <a href="${this.isDesktopApp||M==="tech"?"#":"https://tech.worldmonitor.app"}"
               class="variant-option ${M==="tech"?"active":""}"
               data-variant="tech"
               ${!this.isDesktopApp&&M!=="tech"?'target="_blank" rel="noopener"':""}
               title="${r("header.tech")}${M==="tech"?` ${r("common.currentVariant")}`:""}">
              <span class="variant-icon">üíª</span>
              <span class="variant-label">${r("header.tech")}</span>
            </a>
            <span class="variant-divider"></span>
            <a href="${this.isDesktopApp||M==="finance"?"#":"https://finance.worldmonitor.app"}"
               class="variant-option ${M==="finance"?"active":""}"
               data-variant="finance"
               ${!this.isDesktopApp&&M!=="finance"?'target="_blank" rel="noopener"':""}
               title="${r("header.finance")}${M==="finance"?` ${r("common.currentVariant")}`:""}">
              <span class="variant-icon">üìà</span>
              <span class="variant-label">${r("header.finance")}</span>
            </a>
          </div>
          <span class="logo">MONITOR THE SITUATION</span>
          <!-- credit and github links hidden -->
          <div class="status-indicator">
            <span class="status-dot"></span>
            <span>${r("header.live")}</span>
          </div>
          <div class="region-selector">
            <select id="regionSelect" class="region-select">
              <option value="global">${r("components.deckgl.views.global")}</option>
              <option value="america">${r("components.deckgl.views.americas")}</option>
              <option value="mena">${r("components.deckgl.views.mena")}</option>
              <option value="eu">${r("components.deckgl.views.europe")}</option>
              <option value="asia">${r("components.deckgl.views.asia")}</option>
              <option value="latam">${r("components.deckgl.views.latam")}</option>
              <option value="africa">${r("components.deckgl.views.africa")}</option>
              <option value="oceania">${r("components.deckgl.views.oceania")}</option>
            </select>
          </div>
        </div>
        <div class="header-right">
          <button class="search-btn" id="searchBtn"><kbd>‚åòK</kbd> ${r("header.search")}</button>
          ${this.isDesktopApp?"":`<button class="copy-link-btn" id="copyLinkBtn">${r("header.copyLink")}</button>`}
          <button class="theme-toggle-btn" id="headerThemeToggle" title="${r("header.toggleTheme")}">
            ${le()==="dark"?'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>':'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>'}
          </button>
          ${this.isDesktopApp?"":`<button class="fullscreen-btn" id="fullscreenBtn" title="${r("header.fullscreen")}">‚õ∂</button>`}
          <button class="settings-btn" id="settingsBtn">‚öô ${r("header.settings")}</button>
          <button class="sources-btn" id="sourcesBtn">üì° ${r("header.sources")}</button>
        </div>
      </div>
      <div class="main-content">
        <div class="map-section" id="mapSection">
          <div class="panel-header">
            <div class="panel-header-left">
              <span class="panel-title">${M==="tech"?r("panels.techMap"):r("panels.map")}</span>
            </div>
            <span class="header-clock" id="headerClock"></span>
            <button class="map-pin-btn" id="mapPinBtn" title="${r("header.pinMap")}">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 17v5M9 10.76a2 2 0 01-1.11 1.79l-1.78.9A2 2 0 005 15.24V16a1 1 0 001 1h12a1 1 0 001-1v-.76a2 2 0 00-1.11-1.79l-1.78-.9A2 2 0 0115 10.76V7a1 1 0 011-1 1 1 0 001-1V4a1 1 0 00-1-1H8a1 1 0 00-1 1v1a1 1 0 001 1 1 1 0 011 1v3.76z"/>
              </svg>
            </button>
          </div>
          <div class="map-container" id="mapContainer"></div>
          <div class="map-resize-handle" id="mapResizeHandle"></div>
        </div>
        <div class="panels-grid" id="panelsGrid"></div>
      </div>
      <div class="modal-overlay" id="settingsModal">
        <div class="modal">
          <div class="modal-header">
            <span class="modal-title">${r("header.settings")}</span>
            <button class="modal-close" id="modalClose">√ó</button>
          </div>
          <div class="panel-toggle-grid" id="panelToggles"></div>
        </div>
      </div>
      <div class="modal-overlay" id="sourcesModal">
        <div class="modal sources-modal">
          <div class="modal-header">
            <span class="modal-title">${r("header.sources")}</span>
            <span class="sources-counter" id="sourcesCounter"></span>
            <button class="modal-close" id="sourcesModalClose">√ó</button>
          </div>
          <div class="sources-search">
            <input type="text" id="sourcesSearch" placeholder="${r("header.filterSources")}" />
          </div>
          <div class="sources-toggle-grid" id="sourceToggles"></div>
          <div class="sources-footer">
            <button class="sources-select-all" id="sourcesSelectAll">${r("common.selectAll")}</button>
            <button class="sources-select-none" id="sourcesSelectNone">${r("common.selectNone")}</button>
          </div>
        </div>
      </div>
    `,this.createPanels(),this.renderPanelToggles()}renderCriticalBanner(e){var n,l;if(this.isMobile){this.criticalBannerEl&&(this.criticalBannerEl.remove(),this.criticalBannerEl=null),document.body.classList.remove("has-critical-banner");return}const t=sessionStorage.getItem("banner-dismissed");if(t&&Date.now()-parseInt(t,10)<1800*1e3)return;const s=e.filter(o=>o.postureLevel==="critical"||o.postureLevel==="elevated"&&o.strikeCapable);if(s.length===0){this.criticalBannerEl&&(this.criticalBannerEl.remove(),this.criticalBannerEl=null,document.body.classList.remove("has-critical-banner"));return}const a=s[0],i=a.postureLevel==="critical";if(!this.criticalBannerEl){this.criticalBannerEl=document.createElement("div"),this.criticalBannerEl.className="critical-posture-banner";const o=document.querySelector(".header");o&&o.insertAdjacentElement("afterend",this.criticalBannerEl)}document.body.classList.add("has-critical-banner"),this.criticalBannerEl.className=`critical-posture-banner ${i?"severity-critical":"severity-elevated"}`,this.criticalBannerEl.innerHTML=`
      <div class="banner-content">
        <span class="banner-icon">${i?"üö®":"‚ö†Ô∏è"}</span>
        <span class="banner-headline">${m(a.headline)}</span>
        <span class="banner-stats">${a.totalAircraft} aircraft ‚Ä¢ ${m(a.summary)}</span>
        ${a.strikeCapable?'<span class="banner-strike">STRIKE CAPABLE</span>':""}
      </div>
      <button class="banner-view" data-lat="${a.centerLat}" data-lon="${a.centerLon}">View Region</button>
      <button class="banner-dismiss">√ó</button>
    `,(n=this.criticalBannerEl.querySelector(".banner-view"))==null||n.addEventListener("click",()=>{var o;console.log("[Banner] View Region clicked:",a.theaterId,"lat:",a.centerLat,"lon:",a.centerLon),gs("view",a.theaterId),typeof a.centerLat=="number"&&typeof a.centerLon=="number"?(o=this.map)==null||o.setCenter(a.centerLat,a.centerLon,4):console.error("[Banner] Missing coordinates for",a.theaterId)}),(l=this.criticalBannerEl.querySelector(".banner-dismiss"))==null||l.addEventListener("click",()=>{var o;gs("dismiss",a.theaterId),(o=this.criticalBannerEl)==null||o.classList.add("dismissed"),document.body.classList.remove("has-critical-banner"),sessionStorage.setItem("banner-dismissed",Date.now().toString())})}destroy(){var e;this.isDestroyed=!0,this.snapshotIntervalId&&(clearInterval(this.snapshotIntervalId),this.snapshotIntervalId=null),this.updateCheckIntervalId&&(clearInterval(this.updateCheckIntervalId),this.updateCheckIntervalId=null),this.clockIntervalId&&(clearInterval(this.clockIntervalId),this.clockIntervalId=null);for(const t of this.refreshTimeoutIds.values())clearTimeout(t);this.refreshTimeoutIds.clear(),this.boundKeydownHandler&&(document.removeEventListener("keydown",this.boundKeydownHandler),this.boundKeydownHandler=null),this.boundFullscreenHandler&&(document.removeEventListener("fullscreenchange",this.boundFullscreenHandler),this.boundFullscreenHandler=null),this.boundResizeHandler&&(window.removeEventListener("resize",this.boundResizeHandler),this.boundResizeHandler=null),this.boundVisibilityHandler&&(document.removeEventListener("visibilitychange",this.boundVisibilityHandler),this.boundVisibilityHandler=null),this.idleTimeoutId&&(clearTimeout(this.idleTimeoutId),this.idleTimeoutId=null),this.boundIdleResetHandler&&(["mousedown","keydown","scroll","touchstart","mousemove"].forEach(t=>{document.removeEventListener(t,this.boundIdleResetHandler)}),this.boundIdleResetHandler=null),(e=this.map)==null||e.destroy(),qs()}createPanels(){const e=document.getElementById("panelsGrid"),t=document.getElementById("mapContainer");this.map=new ur(t,{zoom:this.isMobile?2.5:1,pan:{x:0,y:0},view:this.isMobile?"mena":"global",layers:this.mapLayers,timeRange:"7d"}),this.map.initEscalationGetters(),this.currentTimeRange=this.map.getTimeRange();const s=new O("politics",r("panels.politics"));this.attachRelatedAssetHandlers(s),this.newsPanels.politics=s,this.panels.politics=s;const a=new O("tech",r("panels.tech"));this.attachRelatedAssetHandlers(a),this.newsPanels.tech=a,this.panels.tech=a;const i=new O("finance",r("panels.finance"));this.attachRelatedAssetHandlers(i),this.newsPanels.finance=i,this.panels.finance=i;const n=new Vi;this.panels.heatmap=n;const l=new Wi;this.panels.markets=l;const o=new Yi(this.monitors);this.panels.monitors=o,o.onChanged(D=>{this.monitors=D,se(Z.monitors,D),this.updateMonitorResults()});const c=new Zi;this.panels.commodities=c;const h=new Ki;this.panels.polymarket=h;const d=new O("gov",r("panels.gov"));this.attachRelatedAssetHandlers(d),this.newsPanels.gov=d,this.panels.gov=d;const g=new O("intel",r("panels.intel"));this.attachRelatedAssetHandlers(g),this.newsPanels.intel=g,this.panels.intel=g;const u=new Xi;this.panels.crypto=u;const v=new O("middleeast",r("panels.middleeast"));this.attachRelatedAssetHandlers(v),this.newsPanels.middleeast=v,this.panels.middleeast=v;const f=new O("layoffs",r("panels.layoffs"));this.attachRelatedAssetHandlers(f),this.newsPanels.layoffs=f,this.panels.layoffs=f;const b=new O("ai",r("panels.ai"));this.attachRelatedAssetHandlers(b),this.newsPanels.ai=b,this.panels.ai=b;const k=new O("startups",r("panels.startups"));this.attachRelatedAssetHandlers(k),this.newsPanels.startups=k,this.panels.startups=k;const C=new O("vcblogs",r("panels.vcblogs"));this.attachRelatedAssetHandlers(C),this.newsPanels.vcblogs=C,this.panels.vcblogs=C;const w=new O("regionalStartups",r("panels.regionalStartups"));this.attachRelatedAssetHandlers(w),this.newsPanels.regionalStartups=w,this.panels.regionalStartups=w;const $=new O("unicorns",r("panels.unicorns"));this.attachRelatedAssetHandlers($),this.newsPanels.unicorns=$,this.panels.unicorns=$;const P=new O("accelerators",r("panels.accelerators"));this.attachRelatedAssetHandlers(P),this.newsPanels.accelerators=P,this.panels.accelerators=P;const E=new O("funding",r("panels.funding"));this.attachRelatedAssetHandlers(E),this.newsPanels.funding=E,this.panels.funding=E;const A=new O("producthunt",r("panels.producthunt"));this.attachRelatedAssetHandlers(A),this.newsPanels.producthunt=A,this.panels.producthunt=A;const N=new O("security",r("panels.security"));this.attachRelatedAssetHandlers(N),this.newsPanels.security=N,this.panels.security=N;const F=new O("policy",r("panels.policy"));this.attachRelatedAssetHandlers(F),this.newsPanels.policy=F,this.panels.policy=F;const B=new O("hardware",r("panels.hardware"));this.attachRelatedAssetHandlers(B),this.newsPanels.hardware=B,this.panels.hardware=B;const te=new O("cloud",r("panels.cloud"));this.attachRelatedAssetHandlers(te),this.newsPanels.cloud=te,this.panels.cloud=te;const X=new O("dev",r("panels.dev"));this.attachRelatedAssetHandlers(X),this.newsPanels.dev=X,this.panels.dev=X;const Q=new O("github",r("panels.github"));this.attachRelatedAssetHandlers(Q),this.newsPanels.github=Q,this.panels.github=Q;const ie=new O("ipo",r("panels.ipo"));this.attachRelatedAssetHandlers(ie),this.newsPanels.ipo=ie,this.panels.ipo=ie;const ge=new O("thinktanks",r("panels.thinktanks"));this.attachRelatedAssetHandlers(ge),this.newsPanels.thinktanks=ge,this.panels.thinktanks=ge;const Ee=new Qi;this.panels.economic=Ee;const pe=new O("africa",r("panels.africa"));this.attachRelatedAssetHandlers(pe),this.newsPanels.africa=pe,this.panels.africa=pe;const de=new O("latam",r("panels.latam"));this.attachRelatedAssetHandlers(de),this.newsPanels.latam=de,this.panels.latam=de;const x=new O("asia",r("panels.asia"));this.attachRelatedAssetHandlers(x),this.newsPanels.asia=x,this.panels.asia=x;const L=new O("energy",r("panels.energy"));this.attachRelatedAssetHandlers(L),this.newsPanels.energy=L,this.panels.energy=L;for(const D of Object.keys(at)){if(this.newsPanels[D]||!Array.isArray(at[D]))continue;const V=this.panels[D]&&!this.newsPanels[D]?`${D}-news`:D;if(this.panels[V])continue;const J=_e[V]??_e[D],xe=(J==null?void 0:J.name)??D.charAt(0).toUpperCase()+D.slice(1),ve=new O(V,xe);this.attachRelatedAssetHandlers(ve),this.newsPanels[D]=ve,this.panels[V]=ve}if(M==="full"){const D=new Ji;this.panels["gdelt-intel"]=D;const V=new en;V.setShareStoryHandler((ne,oe)=>{this.openCountryStory(ne,oe)}),this.panels.cii=V;const J=new tn;this.panels.cascade=J;const xe=new sn;this.panels["satellite-fires"]=xe;const ve=new an;ve.setLocationClickHandler((ne,oe)=>{var ee;(ee=this.map)==null||ee.setCenter(ne,oe,4)}),this.panels["strategic-risk"]=ve;const fe=new nn;fe.setLocationClickHandler((ne,oe)=>{var ee;console.log("[App] StrategicPosture handler called:",{lat:ne,lon:oe,hasMap:!!this.map}),(ee=this.map)==null||ee.setCenter(ne,oe,4)}),this.panels["strategic-posture"]=fe;const Qt=new on;Qt.setEventClickHandler((ne,oe)=>{var ee;(ee=this.map)==null||ee.setCenter(ne,oe,5)}),this.panels["ucdp-events"]=Qt;const Jt=new rn;Jt.setCountryClickHandler((ne,oe)=>{var ee;(ee=this.map)==null||ee.setCenter(ne,oe,4)}),this.panels.displacement=Jt;const es=new ln;es.setZoneClickHandler((ne,oe)=>{var ee;(ee=this.map)==null||ee.setCenter(ne,oe,4)}),this.panels.climate=es;const Ga=new cn;this.panels["population-exposure"]=Ga}if(M==="finance"){const D=new pn(V=>{zo(this.map,this.mapLayers,V.lat,V.lon)});this.panels["gcc-investments"]=D}const Je=new dn;this.panels["live-news"]=Je;const et=new un;this.panels["live-webcams"]=et,this.panels.events=new hn("events");const tt=new gn;if(this.panels["service-status"]=tt,this.isDesktopApp){const D=new mn({mode:"alert"});this.panels["runtime-config"]=D}const _=new yn;this.panels["tech-readiness"]=_,this.panels["macro-signals"]=new vn,this.panels["etf-flows"]=new fn,this.panels.stablecoins=new bn;const q=new Cn;this.panels.insights=q;const I=Object.keys(_e).filter(D=>D!=="map"),z=this.getSavedPanelOrder();let H=I;if(z.length>0){const D=I.filter(fe=>!z.includes(fe)),V=z.filter(fe=>I.includes(fe)),J=V.indexOf("monitors");J!==-1&&V.splice(J,1);const xe=V.indexOf("politics")+1||0,ve=D.filter(fe=>fe!=="monitors");V.splice(xe,0,...ve),V.push("monitors"),H=V}const me=H.indexOf("live-news");me>0&&(H.splice(me,1),H.unshift("live-news"));const ye=H.indexOf("live-webcams");if(ye!==-1&&ye!==H.indexOf("live-news")+1){H.splice(ye,1);const D=H.indexOf("live-news")+1;H.splice(D,0,"live-webcams")}if(this.isDesktopApp){const D=H.indexOf("runtime-config");D>1?(H.splice(D,1),H.splice(1,0,"runtime-config")):D===-1&&H.splice(1,0,"runtime-config")}H.forEach(D=>{const V=this.panels[D];if(V){const J=V.getElement();this.makeDraggable(J,D),e.appendChild(J)}}),this.map.onTimeRangeChanged(D=>{this.currentTimeRange=D,this.applyTimeRangeFilterToNewsPanelsDebounced()}),this.applyPanelSettings(),this.applyInitialUrlState()}applyInitialUrlState(){if(!this.initialUrlState||!this.map)return;const{view:e,zoom:t,lat:s,lon:a,timeRange:i,layers:n}=this.initialUrlState;e&&this.map.setView(e),i&&this.map.setTimeRange(i),n&&(this.mapLayers=n,se(Z.mapLayers,this.mapLayers),this.map.setLayers(n)),e||(t!==void 0&&this.map.setZoom(t),s!==void 0&&a!==void 0&&t!==void 0&&t>2&&this.map.setCenter(s,a));const l=document.getElementById("regionSelect"),o=this.map.getState().view;l&&o&&(l.value=o)}getSavedPanelOrder(){try{const e=localStorage.getItem(this.PANEL_ORDER_KEY);return e?JSON.parse(e):[]}catch{return[]}}savePanelOrder(){const e=document.getElementById("panelsGrid");if(!e)return;const t=Array.from(e.children).map(s=>s.dataset.panel).filter(s=>!!s);localStorage.setItem(this.PANEL_ORDER_KEY,JSON.stringify(t))}attachRelatedAssetHandlers(e){e.setRelatedAssetHandlers({onRelatedAssetClick:t=>this.handleRelatedAssetClick(t),onRelatedAssetsFocus:t=>{var s;return(s=this.map)==null?void 0:s.highlightAssets(t)},onRelatedAssetsClear:()=>{var t;return(t=this.map)==null?void 0:t.highlightAssets(null)}})}handleRelatedAssetClick(e){if(this.map)switch(e.type){case"pipeline":this.map.enableLayer("pipelines"),this.mapLayers.pipelines=!0,se(Z.mapLayers,this.mapLayers),this.map.triggerPipelineClick(e.id);break;case"cable":this.map.enableLayer("cables"),this.mapLayers.cables=!0,se(Z.mapLayers,this.mapLayers),this.map.triggerCableClick(e.id);break;case"datacenter":this.map.enableLayer("datacenters"),this.mapLayers.datacenters=!0,se(Z.mapLayers,this.mapLayers),this.map.triggerDatacenterClick(e.id);break;case"base":this.map.enableLayer("bases"),this.mapLayers.bases=!0,se(Z.mapLayers,this.mapLayers),this.map.triggerBaseClick(e.id);break;case"nuclear":this.map.enableLayer("nuclear"),this.mapLayers.nuclear=!0,se(Z.mapLayers,this.mapLayers),this.map.triggerNuclearClick(e.id);break}}makeDraggable(e,t){e.draggable=!0,e.dataset.panel=t,e.addEventListener("dragstart",s=>{var i,n,l;const a=s.target;if(e.dataset.resizing==="true"){s.preventDefault();return}if((i=a.classList)!=null&&i.contains("panel-resize-handle")||(n=a.closest)!=null&&n.call(a,".panel-resize-handle")){s.preventDefault();return}e.classList.add("dragging"),(l=s.dataTransfer)==null||l.setData("text/plain",t)}),e.addEventListener("dragend",()=>{e.classList.remove("dragging"),this.savePanelOrder()}),e.addEventListener("dragover",s=>{s.preventDefault();const a=document.querySelector(".dragging");if(!a||a===e)return;const i=document.getElementById("panelsGrid");if(!i)return;const n=24,c=Array.from(i.children).filter(h=>h===a?!1:!h.classList.contains("hidden")).sort((h,d)=>{const g=h.getBoundingClientRect(),u=d.getBoundingClientRect();return Math.abs(g.top-u.top)<=n?g.left-u.left:g.top-u.top}).find(h=>{const d=h.getBoundingClientRect();return s.clientY<d.top+n?!0:s.clientY>=d.top+n&&s.clientY<=d.bottom-n?s.clientX<d.left+d.width/2:s.clientY<d.top+d.height/2});c?i.insertBefore(a,c):i.appendChild(a)})}setupEventListeners(){var a,i,n,l,o,c;(a=document.getElementById("searchBtn"))==null||a.addEventListener("click",()=>{var h;this.updateSearchIndex(),(h=this.searchModal)==null||h.open()}),(i=document.getElementById("copyLinkBtn"))==null||i.addEventListener("click",async()=>{const h=this.getShareUrl();if(!h)return;const d=document.getElementById("copyLinkBtn");try{await this.copyToClipboard(h),this.setCopyLinkFeedback(d,"Copied!")}catch(g){console.warn("Failed to copy share link:",g),this.setCopyLinkFeedback(d,"Copy failed")}}),(n=document.getElementById("settingsBtn"))==null||n.addEventListener("click",()=>{var h;(h=document.getElementById("settingsModal"))==null||h.classList.add("active")}),(l=document.getElementById("modalClose"))==null||l.addEventListener("click",()=>{var h;(h=document.getElementById("settingsModal"))==null||h.classList.remove("active")}),(o=document.getElementById("settingsModal"))==null||o.addEventListener("click",h=>{var d,g,u;(g=(d=h.target)==null?void 0:d.classList)!=null&&g.contains("modal-overlay")&&((u=document.getElementById("settingsModal"))==null||u.classList.remove("active"))}),(c=document.getElementById("headerThemeToggle"))==null||c.addEventListener("click",()=>{const h=le()==="dark"?"light":"dark";wn(h),this.updateHeaderThemeIcon()}),this.setupSourcesModal(),this.isDesktopApp&&this.container.querySelectorAll(".variant-option").forEach(h=>{h.addEventListener("click",d=>{const g=h.dataset.variant;g&&g!==M&&(d.preventDefault(),localStorage.setItem("worldmonitor-variant",g),window.location.reload())})});const e=document.getElementById("fullscreenBtn");!this.isDesktopApp&&e&&(e.addEventListener("click",()=>this.toggleFullscreen()),this.boundFullscreenHandler=()=>{e.textContent=(document.fullscreenElement,"‚õ∂"),e.classList.toggle("active",!!document.fullscreenElement)},document.addEventListener("fullscreenchange",this.boundFullscreenHandler));const t=document.getElementById("regionSelect");t==null||t.addEventListener("change",()=>{var h;(h=this.map)==null||h.setView(t.value),kn(t.value)});const s=document.getElementById("langSelect");s==null||s.addEventListener("change",()=>{Ea(s.value)}),this.boundResizeHandler=()=>{var h;(h=this.map)==null||h.render()},window.addEventListener("resize",this.boundResizeHandler),this.setupMapResize(),this.setupMapPin(),this.boundVisibilityHandler=()=>{document.body.classList.toggle("animations-paused",document.hidden),document.hidden?be.unloadOptionalModels():this.resetIdleTimer()},document.addEventListener("visibilitychange",this.boundVisibilityHandler),window.addEventListener("focal-points-ready",()=>{var h;(h=this.panels.cii)==null||h.refresh(!0)}),window.addEventListener("theme-changed",()=>{var h;(h=this.map)==null||h.render(),this.updateHeaderThemeIcon()}),this.setupIdleDetection()}setupIdleDetection(){this.boundIdleResetHandler=()=>{this.isIdle&&(this.isIdle=!1,document.body.classList.remove("animations-paused")),this.resetIdleTimer()},["mousedown","keydown","scroll","touchstart","mousemove"].forEach(e=>{document.addEventListener(e,this.boundIdleResetHandler,{passive:!0})}),this.resetIdleTimer()}resetIdleTimer(){this.idleTimeoutId&&clearTimeout(this.idleTimeoutId),this.idleTimeoutId=setTimeout(()=>{document.hidden||(this.isIdle=!0,document.body.classList.add("animations-paused"),console.log("[App] User idle - pausing animations to save resources"))},this.IDLE_PAUSE_MS)}setupUrlStateSync(){if(!this.map)return;const e=It(()=>{const t=this.getShareUrl();t&&history.replaceState(null,"",t)},250);this.map.onStateChanged(()=>{e();const t=document.getElementById("regionSelect");if(t&&this.map){const s=this.map.getState();t.value!==s.view&&(t.value=s.view)}}),e()}getShareUrl(){var a;if(!this.map)return null;const e=this.map.getState(),t=this.map.getCenter(),s=`${window.location.origin}${window.location.pathname}`;return $n(s,{view:e.view,zoom:e.zoom,center:t,timeRange:e.timeRange,layers:e.layers,country:(a=this.countryBriefPage)!=null&&a.isVisible()?this.countryBriefPage.getCode()??void 0:void 0})}async copyToClipboard(e){var s;if((s=navigator.clipboard)!=null&&s.writeText){await navigator.clipboard.writeText(e);return}const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.opacity="0",document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t)}setCopyLinkFeedback(e,t){if(!e)return;const s=e.textContent??"";e.textContent=t,e.classList.add("copied"),window.setTimeout(()=>{e.textContent=s,e.classList.remove("copied")},1500)}toggleFullscreen(){if(document.fullscreenElement)document.exitFullscreen().catch(()=>{});else{const e=document.documentElement;if(e.requestFullscreen)e.requestFullscreen().catch(()=>{});else if(e.webkitRequestFullscreen)try{e.webkitRequestFullscreen()}catch{}}}setupMapResize(){const e=document.getElementById("mapSection"),t=document.getElementById("mapResizeHandle");if(!e||!t)return;const s=()=>window.innerWidth>=2e3?320:400,a=()=>Math.max(s(),window.innerHeight-60),i=localStorage.getItem("map-height");if(i){const c=Number.parseInt(i,10);if(Number.isFinite(c)){const h=Math.max(s(),Math.min(c,a()));e.style.height=`${h}px`,h!==c&&localStorage.setItem("map-height",`${h}px`)}else localStorage.removeItem("map-height")}let n=!1,l=0,o=0;t.addEventListener("mousedown",c=>{n=!0,l=c.clientY,o=e.offsetHeight,e.classList.add("resizing"),document.body.style.cursor="ns-resize",c.preventDefault()}),document.addEventListener("mousemove",c=>{var g;if(!n)return;const h=c.clientY-l,d=Math.max(s(),Math.min(o+h,a()));e.style.height=`${d}px`,(g=this.map)==null||g.render()}),document.addEventListener("mouseup",()=>{var c;n&&(n=!1,e.classList.remove("resizing"),document.body.style.cursor="",localStorage.setItem("map-height",e.style.height),(c=this.map)==null||c.render())})}setupMapPin(){const e=document.getElementById("mapSection"),t=document.getElementById("mapPinBtn");if(!e||!t)return;localStorage.getItem("map-pinned")==="true"&&(e.classList.add("pinned"),t.classList.add("active")),t.addEventListener("click",()=>{const a=e.classList.toggle("pinned");t.classList.toggle("active",a),localStorage.setItem("map-pinned",String(a))})}renderPanelToggles(){const e=document.getElementById("panelToggles"),t=Object.entries(this.panelSettings).filter(([a])=>a!=="runtime-config"||this.isDesktopApp).map(([a,i])=>`
        <div class="panel-toggle-item ${i.enabled?"active":""}" data-panel="${a}">
          <div class="panel-toggle-checkbox">${i.enabled?"‚úì":""}</div>
          <span class="panel-toggle-label">${this.getLocalizedPanelName(a,i.name)}</span>
        </div>
      `).join(""),s=this.isMobile?"":(()=>{var i;const a=((i=this.findingsBadge)==null?void 0:i.isEnabled())??ut.getStoredEnabledState();return`
      <div class="panel-toggle-item ${a?"active":""}" data-panel="intel-findings">
        <div class="panel-toggle-checkbox">${a?"‚úì":""}</div>
        <span class="panel-toggle-label">Intelligence Findings</span>
      </div>
    `})();e.innerHTML=t+s,e.querySelectorAll(".panel-toggle-item").forEach(a=>{a.addEventListener("click",()=>{var l;const i=a.dataset.panel;if(i==="intel-findings"){if(!this.findingsBadge)return;const o=!this.findingsBadge.isEnabled();this.findingsBadge.setEnabled(o),ms("intel-findings",o),this.renderPanelToggles();return}const n=this.panelSettings[i];console.log("[Panel Toggle] Clicked:",i,"Current enabled:",n==null?void 0:n.enabled),n&&(n.enabled=!n.enabled,ms(i,n.enabled),console.log("[Panel Toggle] New enabled:",n.enabled),se(Z.panels,this.panelSettings),this.renderPanelToggles(),this.applyPanelSettings(),console.log("[Panel Toggle] After apply - config.enabled:",(l=this.panelSettings[i])==null?void 0:l.enabled))})})}getLocalizedPanelName(e,t){if(e==="runtime-config")return r("modals.runtimeConfig.title");const a=`panels.${e.replace(/-([a-z])/g,(n,l)=>l.toUpperCase())}`,i=r(a);return i===a?t:i}getAllSourceNames(){const e=new Set;return Object.values(at).forEach(t=>{t&&t.forEach(s=>e.add(s.name))}),ys.forEach(t=>e.add(t.name)),Array.from(e).sort((t,s)=>t.localeCompare(s))}renderSourceToggles(e=""){const t=document.getElementById("sourceToggles"),s=this.getAllSourceNames(),a=e.toLowerCase(),i=e?s.filter(o=>o.toLowerCase().includes(a)):s;t.innerHTML=i.map(o=>{const c=!this.disabledSources.has(o),h=m(o);return`
        <div class="source-toggle-item ${c?"active":""}" data-source="${h}">
          <div class="source-toggle-checkbox">${c?"‚úì":""}</div>
          <span class="source-toggle-label">${h}</span>
        </div>
      `}).join(""),t.querySelectorAll(".source-toggle-item").forEach(o=>{o.addEventListener("click",()=>{const c=o.dataset.source;this.disabledSources.has(c)?this.disabledSources.delete(c):this.disabledSources.add(c),se(Z.disabledFeeds,Array.from(this.disabledSources)),this.renderSourceToggles(e)})});const n=s.length-this.disabledSources.size,l=document.getElementById("sourcesCounter");l&&(l.textContent=r("header.sourcesEnabled",{enabled:String(n),total:String(s.length)}))}setupSourcesModal(){var e,t,s,a,i,n;(e=document.getElementById("sourcesBtn"))==null||e.addEventListener("click",()=>{var o;(o=document.getElementById("sourcesModal"))==null||o.classList.add("active");const l=document.getElementById("sourcesSearch");l&&(l.value=""),this.renderSourceToggles()}),(t=document.getElementById("sourcesModalClose"))==null||t.addEventListener("click",()=>{var l;(l=document.getElementById("sourcesModal"))==null||l.classList.remove("active")}),(s=document.getElementById("sourcesModal"))==null||s.addEventListener("click",l=>{var o,c,h;(c=(o=l.target)==null?void 0:o.classList)!=null&&c.contains("modal-overlay")&&((h=document.getElementById("sourcesModal"))==null||h.classList.remove("active"))}),(a=document.getElementById("sourcesSearch"))==null||a.addEventListener("input",l=>{const o=l.target.value;this.renderSourceToggles(o)}),(i=document.getElementById("sourcesSelectAll"))==null||i.addEventListener("click",()=>{var o;this.disabledSources.clear(),se(Z.disabledFeeds,[]);const l=((o=document.getElementById("sourcesSearch"))==null?void 0:o.value)||"";this.renderSourceToggles(l)}),(n=document.getElementById("sourcesSelectNone"))==null||n.addEventListener("click",()=>{var c;const l=this.getAllSourceNames();this.disabledSources=new Set(l),se(Z.disabledFeeds,l);const o=((c=document.getElementById("sourcesSearch"))==null?void 0:c.value)||"";this.renderSourceToggles(o)})}applyPanelSettings(){Object.entries(this.panelSettings).forEach(([e,t])=>{if(e==="map"){const a=document.getElementById("mapSection");a&&a.classList.toggle("hidden",!t.enabled);return}const s=this.panels[e];s==null||s.toggle(t.enabled)})}updateHeaderThemeIcon(){const e=document.getElementById("headerThemeToggle");if(!e)return;const t=le()==="dark";e.innerHTML=t?'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>':'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>'}async loadAllData(){const e=async(a,i)=>{if(!this.inFlight.has(a)){this.inFlight.add(a);try{await i()}catch(n){console.error(`[App] ${a} failed:`,n)}finally{this.inFlight.delete(a)}}},t=[{name:"news",task:e("news",()=>this.loadNews())},{name:"markets",task:e("markets",()=>this.loadMarkets())},{name:"predictions",task:e("predictions",()=>this.loadPredictions())},{name:"pizzint",task:e("pizzint",()=>this.loadPizzInt())},{name:"fred",task:e("fred",()=>this.loadFredData())},{name:"oil",task:e("oil",()=>this.loadOilAnalytics())},{name:"spending",task:e("spending",()=>this.loadGovernmentSpending())}];M==="full"&&t.push({name:"intelligence",task:e("intelligence",()=>this.loadIntelligenceSignals())}),M==="full"&&t.push({name:"firms",task:e("firms",()=>this.loadFirmsData())}),this.mapLayers.natural&&t.push({name:"natural",task:e("natural",()=>this.loadNatural())}),this.mapLayers.weather&&t.push({name:"weather",task:e("weather",()=>this.loadWeatherAlerts())}),this.mapLayers.ais&&t.push({name:"ais",task:e("ais",()=>this.loadAisSignals())}),this.mapLayers.cables&&t.push({name:"cables",task:e("cables",()=>this.loadCableActivity())}),this.mapLayers.cables&&t.push({name:"cableHealth",task:e("cableHealth",()=>this.loadCableHealth())}),this.mapLayers.flights&&t.push({name:"flights",task:e("flights",()=>this.loadFlightDelays())}),(this.mapLayers.techEvents||M==="tech")&&t.push({name:"techEvents",task:e("techEvents",()=>this.loadTechEvents())}),M==="tech"&&t.push({name:"techReadiness",task:e("techReadiness",()=>{var a;return(a=this.panels["tech-readiness"])==null?void 0:a.refresh()})}),(await Promise.allSettled(t.map(a=>a.task))).forEach((a,i)=>{var n;a.status==="rejected"&&console.error(`[App] ${(n=t[i])==null?void 0:n.name} load failed:`,a.reason)}),this.updateSearchIndex()}async loadDataForLayer(e){var t,s;if(!this.inFlight.has(e)){this.inFlight.add(e),(t=this.map)==null||t.setLayerLoading(e,!0);try{switch(e){case"natural":await this.loadNatural();break;case"fires":await this.loadFirmsData();break;case"weather":await this.loadWeatherAlerts();break;case"outages":await this.loadOutages();break;case"cyberThreats":await this.loadCyberThreats();break;case"ais":await this.loadAisSignals();break;case"cables":await Promise.all([this.loadCableActivity(),this.loadCableHealth()]);break;case"protests":await this.loadProtests();break;case"flights":await this.loadFlightDelays();break;case"military":await this.loadMilitary();break;case"techEvents":console.log("[loadDataForLayer] Loading techEvents..."),await this.loadTechEvents(),console.log("[loadDataForLayer] techEvents loaded");break;case"ucdpEvents":case"displacement":case"climate":await this.loadIntelligenceSignals();break}}finally{this.inFlight.delete(e),(s=this.map)==null||s.setLayerLoading(e,!1)}}}findFlashLocation(e){const t=e.toLowerCase();let s=null;const a=i=>{if(!i)return 0;let n=0;for(const l of i){const o=l.trim().toLowerCase();o.length>=3&&t.includes(o)&&n++}return n};for(const i of He){const n=a(i.keywords);n>0&&(!s||n>s.matches)&&(s={lat:i.lat,lon:i.lon,matches:n})}for(const i of Le){const n=a(i.keywords);n>0&&(!s||n>s.matches)&&(s={lat:i.center[1],lon:i.center[0],matches:n})}return s}flashMapForNews(e){if(!this.map||!this.initialLoadComplete)return;const t=Date.now();for(const[s,a]of this.mapFlashCache.entries())t-a>this.MAP_FLASH_COOLDOWN_MS&&this.mapFlashCache.delete(s);for(const s of e){const a=`${s.source}|${s.link||s.title}`,i=this.mapFlashCache.get(a);if(i&&t-i<this.MAP_FLASH_COOLDOWN_MS)continue;const n=this.findFlashLocation(s.title);n&&(this.map.flashLocation(n.lat,n.lon),this.mapFlashCache.set(a,t))}}getTimeRangeWindowMs(e){return{"1h":36e5,"6h":216e5,"24h":864e5,"48h":1728e5,"7d":6048e5,all:1/0}[e]}filterItemsByTimeRange(e,t=this.currentTimeRange){if(t==="all")return e;const s=Date.now()-this.getTimeRangeWindowMs(t);return e.filter(a=>{const i=a.pubDate instanceof Date?a.pubDate.getTime():new Date(a.pubDate).getTime();return Number.isFinite(i)?i>=s:!0})}getTimeRangeLabel(e=this.currentTimeRange){return{"1h":"the last hour","6h":"the last 6 hours","24h":"the last 24 hours","48h":"the last 48 hours","7d":"the last 7 days",all:"all time"}[e]}renderNewsForCategory(e,t){this.newsByCategory[e]=t;const s=this.newsPanels[e];if(!s)return;const a=this.filterItemsByTimeRange(t);if(a.length===0&&t.length>0){s.renderFilteredEmpty(`No items in ${this.getTimeRangeLabel()}`);return}s.renderNews(a)}applyTimeRangeFilterToNewsPanels(){Object.entries(this.newsByCategory).forEach(([e,t])=>{this.renderNewsForCategory(e,t)})}async loadNewsCategory(e,t){var s,a,i,n,l;try{const o=this.newsPanels[e],c=100;let h=0,d=null,g=null;const u=(t??[]).filter(k=>!this.disabledSources.has(k.name));if(u.length===0)return delete this.newsByCategory[e],o&&o.showError(r("common.allSourcesDisabled")),(s=this.statusPanel)==null||s.updateFeed(e.charAt(0).toUpperCase()+e.slice(1),{status:"ok",itemCount:0}),[];const v=()=>{g&&(this.renderNewsForCategory(e,g),g=null,h=Date.now())},f=k=>{if(!o)return;g=k;const C=Date.now()-h;if(C>=c){d&&(clearTimeout(d),d=null),v();return}d||(d=setTimeout(()=>{d=null,v()},c-C))},b=await vs(u,{onBatch:k=>{f(k),this.flashMapForNews(k)}});if(this.renderNewsForCategory(e,b),o){if(d&&(clearTimeout(d),d=null,g=null),b.length===0){const k=Sn(),C=u.filter(w=>k.has(w.name));if(C.length>0){const w=C.map($=>$.name).join(", ");o.showError(`${r("common.noNewsAvailable")} (${w} failed)`)}}try{const k=await fs(`news:${e}`,b.length),C=bs(b.length,k);o.setDeviation(C.zScore,C.percentChange,C.level)}catch(k){console.warn(`[Baseline] news:${e} write failed:`,k)}}return(a=this.statusPanel)==null||a.updateFeed(e.charAt(0).toUpperCase()+e.slice(1),{status:"ok",itemCount:b.length}),(i=this.statusPanel)==null||i.updateApi("RSS2JSON",{status:"ok"}),b}catch(o){return(n=this.statusPanel)==null||n.updateFeed(e.charAt(0).toUpperCase()+e.slice(1),{status:"error",errorMessage:String(o)}),(l=this.statusPanel)==null||l.updateApi("RSS2JSON",{status:"error"}),delete this.newsByCategory[e],[]}}async loadNews(){var n,l,o,c,h,d;const e=Object.entries(at).filter(g=>Array.isArray(g[1])&&g[1].length>0).map(([g,u])=>({key:g,feeds:u})),s=Math.max(1,Math.min(M==="tech"?4:5,e.length)),a=[];for(let g=0;g<e.length;g+=s){const u=e.slice(g,g+s),v=await Promise.allSettled(u.map(({key:f,feeds:b})=>this.loadNewsCategory(f,b)));a.push(...v)}const i=[];if(a.forEach((g,u)=>{var v;g.status==="fulfilled"?i.push(...g.value):console.error(`[App] News category ${(v=e[u])==null?void 0:v.key} failed:`,g.reason)}),M==="full"){const g=ys.filter(v=>!this.disabledSources.has(v.name)),u=this.newsPanels.intel;if(g.length===0)delete this.newsByCategory.intel,u&&u.showError(r("common.allIntelSourcesDisabled")),(n=this.statusPanel)==null||n.updateFeed("Intel",{status:"ok",itemCount:0});else{const v=await Promise.allSettled([vs(g)]);if(((l=v[0])==null?void 0:l.status)==="fulfilled"){const f=v[0].value;if(this.renderNewsForCategory("intel",f),u)try{const b=await fs("news:intel",f.length),k=bs(f.length,b);u.setDeviation(k.zScore,k.percentChange,k.level)}catch(b){console.warn("[Baseline] news:intel write failed:",b)}(o=this.statusPanel)==null||o.updateFeed("Intel",{status:"ok",itemCount:f.length}),i.push(...f),this.flashMapForNews(f)}else delete this.newsByCategory.intel,console.error("[App] Intel feed failed:",(c=v[0])==null?void 0:c.reason)}}this.allNews=i,this.initialLoadComplete=!0,Ge([{type:"news",region:"global",count:i.length}]).then(g=>{g.length>0&&W.ingestTemporalAnomalies(g)}).catch(()=>{}),(h=this.map)==null||h.updateHotspotActivity(this.allNews),this.updateMonitorResults();try{if(this.latestClusters=be.isAvailable?await Cs(this.allNews):await ft.clusterNews(this.allNews),be.isAvailable&&this.latestClusters.length>0){const u=this.panels.insights;u==null||u.updateInsights(this.latestClusters)}const g=this.latestClusters.filter(u=>u.lat!=null&&u.lon!=null).map(u=>{var v;return{lat:u.lat,lon:u.lon,title:u.primaryTitle,threatLevel:((v=u.threat)==null?void 0:v.level)??"info",timestamp:u.lastUpdated}});g.length>0&&((d=this.map)==null||d.setNewsLocations(g))}catch(g){console.error("[App] Clustering failed, clusters unchanged:",g)}}async loadMarkets(){var e,t,s,a,i,n,l;try{const o=await bt(Ln,{onBatch:u=>{this.latestMarkets=u,this.panels.markets.renderMarkets(u)}}),c="FINNHUB_API_KEY not configured ‚Äî add in Settings";if(this.latestMarkets=o.data,this.panels.markets.renderMarkets(o.data),o.skipped)(e=this.statusPanel)==null||e.updateApi("Finnhub",{status:"error"}),o.data.length===0&&((t=this.panels.markets)==null||t.showConfigError(c)),(s=this.panels.heatmap)==null||s.showConfigError(c);else{(a=this.statusPanel)==null||a.updateApi("Finnhub",{status:"ok"});const u=await bt(En.map(v=>({...v,display:v.name})),{onBatch:v=>{this.panels.heatmap.renderHeatmap(v.map(f=>({name:f.name,change:f.change})))}});this.panels.heatmap.renderHeatmap(u.data.map(v=>({name:v.name,change:v.change})))}const h=this.panels.commodities,d=u=>({display:u.display,price:u.price,change:u.change,sparkline:u.sparkline});let g=!1;for(let u=0;u<3&&!g;u++){u>0&&(h.showRetrying(),await new Promise(b=>setTimeout(b,2e4)));const f=(await bt(xn,{onBatch:b=>h.renderCommodities(b.map(d))})).data.map(d);f.some(b=>b.price!==null)&&(h.renderCommodities(f),g=!0)}g||h.renderCommodities([])}catch{(i=this.statusPanel)==null||i.updateApi("Finnhub",{status:"error"})}try{let o=await ws();o.length===0&&(this.panels.crypto.showRetrying(),await new Promise(c=>setTimeout(c,2e4)),o=await ws()),this.panels.crypto.renderCrypto(o),(n=this.statusPanel)==null||n.updateApi("CoinGecko",{status:o.length>0?"ok":"error"})}catch{(l=this.statusPanel)==null||l.updateApi("CoinGecko",{status:"error"})}}async loadPredictions(){var e,t,s,a;try{const i=await Mn();this.latestPredictions=i,this.panels.polymarket.renderPredictions(i),(e=this.statusPanel)==null||e.updateFeed("Polymarket",{status:"ok",itemCount:i.length}),(t=this.statusPanel)==null||t.updateApi("Polymarket",{status:"ok"}),S.recordUpdate("polymarket",i.length),S.recordUpdate("predictions",i.length),this.runCorrelationAnalysis()}catch(i){(s=this.statusPanel)==null||s.updateFeed("Polymarket",{status:"error",errorMessage:String(i)}),(a=this.statusPanel)==null||a.updateApi("Polymarket",{status:"error"}),S.recordError("polymarket",String(i)),S.recordError("predictions",String(i))}}async loadNatural(){var i,n,l,o,c,h,d,g,u,v,f;const[e,t]=await Promise.allSettled([Tn(),Pn(30)]);e.status==="fulfilled"?(this.intelligenceCache.earthquakes=e.value,(i=this.map)==null||i.setEarthquakes(e.value),An(e.value),(n=this.statusPanel)==null||n.updateApi("USGS",{status:"ok"}),S.recordUpdate("usgs",e.value.length)):(this.intelligenceCache.earthquakes=[],(l=this.map)==null||l.setEarthquakes([]),(o=this.statusPanel)==null||o.updateApi("USGS",{status:"error"}),S.recordError("usgs",String(e.reason))),t.status==="fulfilled"?((c=this.map)==null||c.setNaturalEvents(t.value),(h=this.statusPanel)==null||h.updateFeed("EONET",{status:"ok",itemCount:t.value.length}),(d=this.statusPanel)==null||d.updateApi("NASA EONET",{status:"ok"})):((g=this.map)==null||g.setNaturalEvents([]),(u=this.statusPanel)==null||u.updateFeed("EONET",{status:"error",errorMessage:String(t.reason)}),(v=this.statusPanel)==null||v.updateApi("NASA EONET",{status:"error"}));const s=e.status==="fulfilled"&&e.value.length>0,a=t.status==="fulfilled"&&t.value.length>0;(f=this.map)==null||f.setLayerReady("natural",s||a)}async loadTechEvents(){var e,t,s,a,i,n;if(console.log("[loadTechEvents] Called. SITE_VARIANT:",M,"techEvents layer:",this.mapLayers.techEvents),M!=="tech"&&!this.mapLayers.techEvents){console.log("[loadTechEvents] Skipping - not tech variant and layer disabled");return}try{const o=await new In("",{fetch:(...d)=>globalThis.fetch(...d)}).listTechEvents({type:"conference",mappable:!0,days:90,limit:50});if(!o.success)throw new Error(o.error||"Unknown error");const c=new Date,h=o.events.map(d=>{var g,u,v;return{id:d.id,title:d.title,location:d.location,lat:((g=d.coords)==null?void 0:g.lat)??0,lng:((u=d.coords)==null?void 0:u.lng)??0,country:((v=d.coords)==null?void 0:v.country)??"",startDate:d.startDate,endDate:d.endDate,url:d.url,daysUntil:Math.ceil((new Date(d.startDate).getTime()-c.getTime())/(1e3*60*60*24))}});(e=this.map)==null||e.setTechEvents(h),(t=this.map)==null||t.setLayerReady("techEvents",h.length>0),(s=this.statusPanel)==null||s.updateFeed("Tech Events",{status:"ok",itemCount:h.length}),M==="tech"&&this.searchModal&&this.searchModal.registerSource("techevent",h.map(d=>({id:d.id,title:d.title,subtitle:`${d.location} ‚Ä¢ ${new Date(d.startDate).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}`,data:d})))}catch(l){console.error("[App] Failed to load tech events:",l),(a=this.map)==null||a.setTechEvents([]),(i=this.map)==null||i.setLayerReady("techEvents",!1),(n=this.statusPanel)==null||n.updateFeed("Tech Events",{status:"error",errorMessage:String(l)})}}async loadWeatherAlerts(){var e,t,s,a,i;try{const n=await Rn();(e=this.map)==null||e.setWeatherAlerts(n),(t=this.map)==null||t.setLayerReady("weather",n.length>0),(s=this.statusPanel)==null||s.updateFeed("Weather",{status:"ok",itemCount:n.length}),S.recordUpdate("weather",n.length)}catch(n){(a=this.map)==null||a.setLayerReady("weather",!1),(i=this.statusPanel)==null||i.updateFeed("Weather",{status:"error"}),S.recordError("weather",String(n))}}async loadIntelligenceSignals(){var s,a,i,n,l,o;const e=[];e.push((async()=>{var c,h,d;try{const g=await ks();this.intelligenceCache.outages=g,$s(g),W.ingestOutages(g),S.recordUpdate("outages",g.length),this.mapLayers.outages&&((c=this.map)==null||c.setOutages(g),(h=this.map)==null||h.setLayerReady("outages",g.length>0),(d=this.statusPanel)==null||d.updateFeed("NetBlocks",{status:"ok",itemCount:g.length}))}catch(g){console.error("[Intelligence] Outages fetch failed:",g),S.recordError("outages",String(g))}})());const t=(async()=>{var c,h,d;try{const g=await Ss();this.intelligenceCache.protests=g,Ls(g.events),Es(g.events),W.ingestProtests(g.events);const u=g.sources.acled+g.sources.gdelt;if(u>0&&S.recordUpdate("acled",u),g.sources.gdelt>0&&S.recordUpdate("gdelt",g.sources.gdelt),g.sources.gdelt>0&&S.recordUpdate("gdelt_doc",g.sources.gdelt),this.mapLayers.protests){(c=this.map)==null||c.setProtests(g.events),(h=this.map)==null||h.setLayerReady("protests",g.events.length>0);const v=Ct();(d=this.statusPanel)==null||d.updateFeed("Protests",{status:"ok",itemCount:g.events.length,errorMessage:v.acledConfigured===!1?"ACLED not configured - using GDELT only":void 0})}return g.events}catch(g){return console.error("[Intelligence] Protests fetch failed:",g),S.recordError("acled",String(g)),[]}})();e.push(t.then(()=>{})),e.push((async()=>{try{const c=await Nn();Dn(c.events),c.count>0&&S.recordUpdate("acled_conflict",c.count)}catch(c){console.error("[Intelligence] Conflict events fetch failed:",c),S.recordError("acled_conflict",String(c))}})()),e.push((async()=>{try{const c=await Fn();Hn(c),c.size>0&&S.recordUpdate("ucdp",c.size)}catch(c){console.error("[Intelligence] UCDP fetch failed:",c),S.recordError("ucdp",String(c))}})()),e.push((async()=>{try{const c=await Bn();zn(c),c.size>0&&S.recordUpdate("hapi",c.size)}catch(c){console.error("[Intelligence] HAPI fetch failed:",c),S.recordError("hapi",String(c))}})()),e.push((async()=>{var c,h,d,g,u,v;try{xs()&&Ms();const[f,b]=await Promise.all([Ts(),Ps()]);if(this.intelligenceCache.military={flights:f.flights,flightClusters:f.clusters,vessels:b.vessels,vesselClusters:b.clusters},As().then(k=>{k&&(this.intelligenceCache.usniFleet=k)}).catch(()=>{}),Is(f.flights),Rs(b.vessels),Ns(f.flights,b.vessels),W.ingestFlights(f.flights),W.ingestVessels(b.vessels),S.recordUpdate("opensky",f.flights.length),Ge([{type:"military_flights",region:"global",count:f.flights.length},{type:"vessels",region:"global",count:b.vessels.length}]).then(k=>{k.length>0&&W.ingestTemporalAnomalies(k)}).catch(()=>{}),this.mapLayers.military){(c=this.map)==null||c.setMilitaryFlights(f.flights,f.clusters),(h=this.map)==null||h.setMilitaryVessels(b.vessels,b.clusters),(d=this.map)==null||d.updateMilitaryForEscalation(f.flights,b.vessels);const k=f.flights.length+b.vessels.length;(g=this.statusPanel)==null||g.updateFeed("Military",{status:k>0?"ok":"warning",itemCount:k})}if(!wt()){const k=Ds(f.flights);if(k.length>0){const w=k.map(Fs);Ue(w),this.shouldShowIntelligenceNotifications()&&((u=this.signalModal)==null||u.show(w))}const C=Hs(f.flights);if(C.length>0){const w=C.map(Bs);Ue(w),this.shouldShowIntelligenceNotifications()&&((v=this.signalModal)==null||v.show(w))}}}catch(f){console.error("[Intelligence] Military fetch failed:",f),S.recordError("opensky",String(f))}})()),e.push((async()=>{var c,h;try{const d=await t;let g=await zs();for(let f=1;f<3&&!g.success;f++)await new Promise(b=>setTimeout(b,15e3)),g=await zs();if(!g.success){S.recordError("ucdp_events","UCDP events unavailable (retaining prior event state)");return}const u=d.map(f=>({latitude:f.lat,longitude:f.lon,event_date:f.time.toISOString(),fatalities:f.fatalities??0})),v=_n(g.data,u);(c=this.panels["ucdp-events"])==null||c.setEvents(v),this.mapLayers.ucdpEvents&&((h=this.map)==null||h.setUcdpEvents(v)),v.length>0&&S.recordUpdate("ucdp_events",v.length)}catch(d){console.error("[Intelligence] UCDP events fetch failed:",d),S.recordError("ucdp_events",String(d))}})()),e.push((async()=>{var c,h;try{const d=await On();if(!d.ok){S.recordError("unhcr","UNHCR displacement unavailable (retaining prior displacement state)");return}const g=d.data;(c=this.panels.displacement)==null||c.setData(g),Un(g.countries),this.mapLayers.displacement&&g.topFlows&&((h=this.map)==null||h.setDisplacementFlows(g.topFlows)),g.countries.length>0&&S.recordUpdate("unhcr",g.countries.length)}catch(d){console.error("[Intelligence] UNHCR displacement fetch failed:",d),S.recordError("unhcr",String(d))}})()),e.push((async()=>{var c,h;try{const d=await Gn();if(!d.ok){S.recordError("climate","Climate anomalies unavailable (retaining prior climate state)");return}const g=d.anomalies;(c=this.panels.climate)==null||c.setAnomalies(g),qn(g),this.mapLayers.climate&&((h=this.map)==null||h.setClimateAnomalies(g)),g.length>0&&S.recordUpdate("climate",g.length)}catch(d){console.error("[Intelligence] Climate anomalies fetch failed:",d),S.recordError("climate",String(d))}})()),await Promise.allSettled(e);try{const c=((a=(s=this.panels["ucdp-events"])==null?void 0:s.getEvents)==null?void 0:a.call(s))||[],h=[...(((i=this.intelligenceCache.protests)==null?void 0:i.events)||[]).slice(0,10).map(d=>({id:d.id,lat:d.lat,lon:d.lon,type:"conflict",name:d.title||"Protest"})),...c.slice(0,10).map(d=>({id:d.id,lat:d.latitude,lon:d.longitude,type:d.type_of_violence,name:`${d.side_a} vs ${d.side_b}`}))];if(h.length>0){const d=await jn(h);(n=this.panels["population-exposure"])==null||n.setExposures(d),d.length>0&&S.recordUpdate("worldpop",d.length)}else(l=this.panels["population-exposure"])==null||l.setExposures([])}catch(c){console.error("[Intelligence] Population exposure fetch failed:",c),S.recordError("worldpop",String(c))}(o=this.panels.cii)==null||o.refresh(),console.log("[Intelligence] All signals loaded for CII calculation")}async loadOutages(){var e,t,s,a,i,n,l,o;if(this.intelligenceCache.outages){const c=this.intelligenceCache.outages;(e=this.map)==null||e.setOutages(c),(t=this.map)==null||t.setLayerReady("outages",c.length>0),(s=this.statusPanel)==null||s.updateFeed("NetBlocks",{status:"ok",itemCount:c.length});return}try{const c=await ks();this.intelligenceCache.outages=c,(a=this.map)==null||a.setOutages(c),(i=this.map)==null||i.setLayerReady("outages",c.length>0),$s(c),W.ingestOutages(c),(n=this.statusPanel)==null||n.updateFeed("NetBlocks",{status:"ok",itemCount:c.length}),S.recordUpdate("outages",c.length)}catch(c){(l=this.map)==null||l.setLayerReady("outages",!1),(o=this.statusPanel)==null||o.updateFeed("NetBlocks",{status:"error"}),S.recordError("outages",String(c))}}async loadCyberThreats(){var e;{this.mapLayers.cyberThreats=!1,(e=this.map)==null||e.setLayerReady("cyberThreats",!1);return}}async loadAisSignals(){var e,t,s,a,i,n,l;try{const{disruptions:o,density:c}=await Vn(),h=_s();console.log("[Ships] Events:",{disruptions:o.length,density:c.length,vessels:h.vessels}),(e=this.map)==null||e.setAisData(o,c),W.ingestAisDisruptions(o),Ge([{type:"ais_gaps",region:"global",count:o.length}]).then(v=>{v.length>0&&W.ingestTemporalAnomalies(v)}).catch(()=>{});const d=o.length>0||c.length>0;(t=this.map)==null||t.setLayerReady("ais",d);const g=o.length+c.length,u=g>0?"ok":h.connected?"warning":"error";(s=this.statusPanel)==null||s.updateFeed("Shipping",{status:u,itemCount:g,errorMessage:!h.connected&&g===0?"AIS snapshot unavailable":void 0}),(a=this.statusPanel)==null||a.updateApi("AISStream",{status:h.connected?"ok":"warning"}),d&&S.recordUpdate("ais",g)}catch(o){(i=this.map)==null||i.setLayerReady("ais",!1),(n=this.statusPanel)==null||n.updateFeed("Shipping",{status:"error",errorMessage:String(o)}),(l=this.statusPanel)==null||l.updateApi("AISStream",{status:"error"}),S.recordError("ais",String(o))}}waitForAisData(){let t=0;const s=()=>{var i,n,l,o;t++;const a=_s();if(a.vessels>0||a.connected){this.loadAisSignals(),(i=this.map)==null||i.setLayerLoading("ais",!1);return}if(t>=30){(n=this.map)==null||n.setLayerLoading("ais",!1),(l=this.map)==null||l.setLayerReady("ais",!1),(o=this.statusPanel)==null||o.updateFeed("Shipping",{status:"error",errorMessage:"Connection timeout"});return}setTimeout(s,1e3)};s()}async loadCableActivity(){var e,t,s;try{const a=await Wn();(e=this.map)==null||e.setCableActivity(a.advisories,a.repairShips);const i=a.advisories.length+a.repairShips.length;(t=this.statusPanel)==null||t.updateFeed("CableOps",{status:"ok",itemCount:i})}catch{(s=this.statusPanel)==null||s.updateFeed("CableOps",{status:"error"})}}async loadCableHealth(){var e,t,s;try{const a=await Yn();(e=this.map)==null||e.setCableHealth(a.cables);const i=Object.keys(a.cables),n=i.filter(o=>{var c;return((c=a.cables[o])==null?void 0:c.status)==="fault"}).length,l=i.filter(o=>{var c;return((c=a.cables[o])==null?void 0:c.status)==="degraded"}).length;(t=this.statusPanel)==null||t.updateFeed("CableHealth",{status:"ok",itemCount:n+l})}catch{(s=this.statusPanel)==null||s.updateFeed("CableHealth",{status:"error"})}}async loadProtests(){var e,t,s,a,i,n,l,o,c,h,d,g,u,v,f,b,k;if(this.intelligenceCache.protests){const C=this.intelligenceCache.protests;(e=this.map)==null||e.setProtests(C.events),(t=this.map)==null||t.setLayerReady("protests",C.events.length>0);const w=Ct();(s=this.statusPanel)==null||s.updateFeed("Protests",{status:"ok",itemCount:C.events.length,errorMessage:w.acledConfigured===!1?"ACLED not configured - using GDELT only":void 0}),w.acledConfigured===!0?(a=this.statusPanel)==null||a.updateApi("ACLED",{status:"ok"}):w.acledConfigured===null&&((i=this.statusPanel)==null||i.updateApi("ACLED",{status:"warning"})),(n=this.statusPanel)==null||n.updateApi("GDELT Doc",{status:"ok"}),C.sources.gdelt>0&&S.recordUpdate("gdelt_doc",C.sources.gdelt);return}try{const C=await Ss();this.intelligenceCache.protests=C,(l=this.map)==null||l.setProtests(C.events),(o=this.map)==null||o.setLayerReady("protests",C.events.length>0),Ls(C.events),Es(C.events),W.ingestProtests(C.events);const w=C.sources.acled+C.sources.gdelt;w>0&&S.recordUpdate("acled",w),C.sources.gdelt>0&&S.recordUpdate("gdelt",C.sources.gdelt),C.sources.gdelt>0&&S.recordUpdate("gdelt_doc",C.sources.gdelt),(c=this.panels.cii)==null||c.refresh();const $=Ct();(h=this.statusPanel)==null||h.updateFeed("Protests",{status:"ok",itemCount:C.events.length,errorMessage:$.acledConfigured===!1?"ACLED not configured - using GDELT only":void 0}),$.acledConfigured===!0?(d=this.statusPanel)==null||d.updateApi("ACLED",{status:"ok"}):$.acledConfigured===null&&((g=this.statusPanel)==null||g.updateApi("ACLED",{status:"warning"})),(u=this.statusPanel)==null||u.updateApi("GDELT Doc",{status:"ok"})}catch(C){(v=this.map)==null||v.setLayerReady("protests",!1),(f=this.statusPanel)==null||f.updateFeed("Protests",{status:"error",errorMessage:String(C)}),(b=this.statusPanel)==null||b.updateApi("ACLED",{status:"error"}),(k=this.statusPanel)==null||k.updateApi("GDELT Doc",{status:"error"}),S.recordError("gdelt_doc",String(C))}}async loadFlightDelays(){var e,t,s,a,i,n,l;try{const o=await Zn();(e=this.map)==null||e.setFlightDelays(o),(t=this.map)==null||t.setLayerReady("flights",o.length>0),(s=this.statusPanel)==null||s.updateFeed("Flights",{status:"ok",itemCount:o.length}),(a=this.statusPanel)==null||a.updateApi("FAA",{status:"ok"})}catch(o){(i=this.map)==null||i.setLayerReady("flights",!1),(n=this.statusPanel)==null||n.updateFeed("Flights",{status:"error",errorMessage:String(o)}),(l=this.statusPanel)==null||l.updateApi("FAA",{status:"error"})}}async loadMilitary(){var e,t,s,a,i,n,l,o,c,h,d,g,u,v,f,b,k,C;if(this.intelligenceCache.military){const{flights:w,flightClusters:$,vessels:P,vesselClusters:E}=this.intelligenceCache.military;(e=this.map)==null||e.setMilitaryFlights(w,$),(t=this.map)==null||t.setMilitaryVessels(P,E),(s=this.map)==null||s.updateMilitaryForEscalation(w,P),this.loadCachedPosturesForBanner();const A=this.panels.insights;A==null||A.setMilitaryFlights(w);const N=w.length>0||P.length>0;(a=this.map)==null||a.setLayerReady("military",N);const F=w.length+P.length;(i=this.statusPanel)==null||i.updateFeed("Military",{status:F>0?"ok":"warning",itemCount:F,errorMessage:F===0?"No military activity in view":void 0}),(n=this.statusPanel)==null||n.updateApi("OpenSky",{status:"ok"});return}try{xs()&&Ms();const[w,$]=await Promise.all([Ts(),Ps()]);if(this.intelligenceCache.military={flights:w.flights,flightClusters:w.clusters,vessels:$.vessels,vesselClusters:$.clusters},As().then(N=>{N&&(this.intelligenceCache.usniFleet=N)}).catch(()=>{}),(l=this.map)==null||l.setMilitaryFlights(w.flights,w.clusters),(o=this.map)==null||o.setMilitaryVessels($.vessels,$.clusters),Is(w.flights),Rs($.vessels),Ns(w.flights,$.vessels),W.ingestFlights(w.flights),W.ingestVessels($.vessels),Ge([{type:"military_flights",region:"global",count:w.flights.length},{type:"vessels",region:"global",count:$.vessels.length}]).then(N=>{N.length>0&&W.ingestTemporalAnomalies(N)}).catch(()=>{}),(c=this.map)==null||c.updateMilitaryForEscalation(w.flights,$.vessels),(h=this.panels.cii)==null||h.refresh(),!wt()){const N=Ds(w.flights);if(N.length>0){const B=N.map(Fs);Ue(B),this.shouldShowIntelligenceNotifications()&&((d=this.signalModal)==null||d.show(B))}const F=Hs(w.flights);if(F.length>0){const B=F.map(Bs);Ue(B),this.shouldShowIntelligenceNotifications()&&((g=this.signalModal)==null||g.show(B))}}this.loadCachedPosturesForBanner();const P=this.panels.insights;P==null||P.setMilitaryFlights(w.flights);const E=w.flights.length>0||$.vessels.length>0;(u=this.map)==null||u.setLayerReady("military",E);const A=w.flights.length+$.vessels.length;(v=this.statusPanel)==null||v.updateFeed("Military",{status:A>0?"ok":"warning",itemCount:A,errorMessage:A===0?"No military activity in view":void 0}),(f=this.statusPanel)==null||f.updateApi("OpenSky",{status:"ok"}),S.recordUpdate("opensky",w.flights.length)}catch(w){(b=this.map)==null||b.setLayerReady("military",!1),(k=this.statusPanel)==null||k.updateFeed("Military",{status:"error",errorMessage:String(w)}),(C=this.statusPanel)==null||C.updateApi("OpenSky",{status:"error"}),S.recordError("opensky",String(w))}}async loadCachedPosturesForBanner(){try{const e=await Kn();if(e&&e.postures.length>0){this.renderCriticalBanner(e.postures);const t=this.panels["strategic-posture"];t==null||t.updatePostures(e)}}catch(e){console.warn("[App] Failed to load cached postures for banner:",e)}}async loadFredData(){var s,a,i,n,l,o,c,h;const e=this.panels.economic,t=Os("FRED Economic");if(t.onCooldown){e==null||e.setErrorState(!0,`Temporarily unavailable (retry in ${t.remainingSeconds}s)`),(s=this.statusPanel)==null||s.updateApi("FRED",{status:"error"});return}try{e==null||e.setLoading(!0);const d=await kt(),g=Os("FRED Economic");if(g.onCooldown){e==null||e.setErrorState(!0,`Temporarily unavailable (retry in ${g.remainingSeconds}s)`),(a=this.statusPanel)==null||a.updateApi("FRED",{status:"error"});return}if(d.length===0){if(!Us("economicFred")){e==null||e.setErrorState(!0,"FRED_API_KEY not configured ‚Äî add in Settings"),(i=this.statusPanel)==null||i.updateApi("FRED",{status:"error"});return}e==null||e.showRetrying(),await new Promise(v=>setTimeout(v,2e4));const u=await kt();if(u.length===0){e==null||e.setErrorState(!0,"FRED data temporarily unavailable ‚Äî will retry"),(n=this.statusPanel)==null||n.updateApi("FRED",{status:"error"});return}e==null||e.setErrorState(!1),e==null||e.update(u),(l=this.statusPanel)==null||l.updateApi("FRED",{status:"ok"}),S.recordUpdate("economic",u.length);return}e==null||e.setErrorState(!1),e==null||e.update(d),(o=this.statusPanel)==null||o.updateApi("FRED",{status:"ok"}),S.recordUpdate("economic",d.length)}catch{if(Us("economicFred")){e==null||e.showRetrying();try{await new Promise(g=>setTimeout(g,2e4));const d=await kt();if(d.length>0){e==null||e.setErrorState(!1),e==null||e.update(d),(c=this.statusPanel)==null||c.updateApi("FRED",{status:"ok"}),S.recordUpdate("economic",d.length);return}}catch{}}(h=this.statusPanel)==null||h.updateApi("FRED",{status:"error"}),e==null||e.setErrorState(!0,"FRED data temporarily unavailable ‚Äî will retry"),e==null||e.setLoading(!1)}}async loadOilAnalytics(){var t,s;const e=this.panels.economic;try{const a=await Xn();e==null||e.updateOil(a);const i=!!(a.wtiPrice||a.brentPrice||a.usProduction||a.usInventory);if((t=this.statusPanel)==null||t.updateApi("EIA",{status:i?"ok":"error"}),i){const n=[a.wtiPrice,a.brentPrice,a.usProduction,a.usInventory].filter(Boolean).length;S.recordUpdate("oil",n||1)}else S.recordError("oil","Oil analytics returned no values")}catch(a){console.error("[App] Oil analytics failed:",a),(s=this.statusPanel)==null||s.updateApi("EIA",{status:"error"}),S.recordError("oil",String(a))}}async loadGovernmentSpending(){var t,s;const e=this.panels.economic;try{const a=await Qn({daysBack:7,limit:15});e==null||e.updateSpending(a),(t=this.statusPanel)==null||t.updateApi("USASpending",{status:a.awards.length>0?"ok":"error"}),a.awards.length>0?S.recordUpdate("spending",a.awards.length):S.recordError("spending","No awards returned")}catch(a){console.error("[App] Government spending failed:",a),(s=this.statusPanel)==null||s.updateApi("USASpending",{status:"error"}),S.recordError("spending",String(a))}}updateMonitorResults(){this.panels.monitors.renderResults(this.allNews)}async runCorrelationAnalysis(){var e,t;try{this.latestClusters.length===0&&this.allNews.length>0&&(this.latestClusters=be.isAvailable?await Cs(this.allNews):await ft.clusterNews(this.allNews)),this.latestClusters.length>0&&(Jn(this.latestClusters),S.recordUpdate("gdelt",this.latestClusters.length),(e=this.panels.cii)==null||e.refresh());const s=await ft.analyzeCorrelations(this.latestClusters,this.latestPredictions,this.latestMarkets);let a=[];wt()||(a=eo(this.seenGeoAlerts).map(to));const i=so(),n=[...s,...a,...i];n.length>0&&(Ue(n),this.shouldShowIntelligenceNotifications()&&((t=this.signalModal)==null||t.show(n)))}catch(s){console.error("[App] Correlation analysis failed:",s)}}async loadFirmsData(){var e,t,s,a,i,n,l,o;try{const c=await ao(1);if(c.skipped){(e=this.panels["satellite-fires"])==null||e.showConfigError("NASA_FIRMS_API_KEY not configured ‚Äî add in Settings"),(t=this.statusPanel)==null||t.updateApi("FIRMS",{status:"error"});return}const{regions:h,totalCount:d}=c;if(d>0){const g=io(h),u=no(h);W.ingestSatelliteFires(g.map(v=>{var f,b;return{lat:((f=v.location)==null?void 0:f.latitude)??0,lon:((b=v.location)==null?void 0:b.longitude)??0,brightness:v.brightness,frp:v.frp,region:v.region,acq_date:new Date(v.detectedAt).toISOString().slice(0,10)}})),(s=this.map)==null||s.setFires(oo(g)),(a=this.panels["satellite-fires"])==null||a.update(u,d),S.recordUpdate("firms",d),Ge([{type:"satellite_fires",region:"global",count:d}]).then(v=>{v.length>0&&W.ingestTemporalAnomalies(v)}).catch(()=>{})}else(i=this.panels["satellite-fires"])==null||i.update([],0);(n=this.statusPanel)==null||n.updateApi("FIRMS",{status:"ok"})}catch(c){console.warn("[App] FIRMS load failed:",c),(l=this.panels["satellite-fires"])==null||l.update([],0),(o=this.statusPanel)==null||o.updateApi("FIRMS",{status:"error"}),S.recordError("firms",String(c))}}scheduleRefresh(e,t,s,a){const o=(d,g)=>{const u=d*(g?4:1),v=u*.1,f=u+(Math.random()*2-1)*v;return Math.max(1e3,Math.round(f))},c=d=>{if(this.isDestroyed)return;const g=setTimeout(h,d);this.refreshTimeoutIds.set(e,g)},h=async()=>{if(this.isDestroyed)return;if(document.visibilityState==="hidden"){c(o(s,!0));return}if(a&&!a()){c(o(s,!1));return}if(this.inFlight.has(e)){c(o(s,!1));return}this.inFlight.add(e);try{await t()}catch(g){console.error(`[App] Refresh ${e} failed:`,g)}finally{this.inFlight.delete(e),c(o(s,!1))}};c(o(s,document.visibilityState==="hidden"))}setupRefreshIntervals(){this.scheduleRefresh("news",()=>this.loadNews(),it.feeds),this.scheduleRefresh("markets",()=>this.loadMarkets(),it.markets),this.scheduleRefresh("predictions",()=>this.loadPredictions(),it.predictions),this.scheduleRefresh("pizzint",()=>this.loadPizzInt(),600*1e3),this.scheduleRefresh("natural",()=>this.loadNatural(),300*1e3,()=>this.mapLayers.natural),this.scheduleRefresh("weather",()=>this.loadWeatherAlerts(),600*1e3,()=>this.mapLayers.weather),this.scheduleRefresh("fred",()=>this.loadFredData(),1800*1e3),this.scheduleRefresh("oil",()=>this.loadOilAnalytics(),1800*1e3),this.scheduleRefresh("spending",()=>this.loadGovernmentSpending(),3600*1e3),M==="full"&&this.scheduleRefresh("intelligence",()=>(this.intelligenceCache={},this.loadIntelligenceSignals()),300*1e3),this.scheduleRefresh("firms",()=>this.loadFirmsData(),1800*1e3),this.scheduleRefresh("ais",()=>this.loadAisSignals(),it.ais,()=>this.mapLayers.ais),this.scheduleRefresh("cables",()=>this.loadCableActivity(),1800*1e3,()=>this.mapLayers.cables),this.scheduleRefresh("cableHealth",()=>this.loadCableHealth(),300*1e3,()=>this.mapLayers.cables),this.scheduleRefresh("flights",()=>this.loadFlightDelays(),600*1e3,()=>this.mapLayers.flights),this.scheduleRefresh("cyberThreats",()=>(this.cyberThreatsCache=null,this.loadCyberThreats()),600*1e3,()=>Fr)}};y(K,"COUNTRY_BOUNDS",{IR:{n:40,s:25,e:63,w:44},IL:{n:33.3,s:29.5,e:35.9,w:34.3},SA:{n:32,s:16,e:55,w:35},AE:{n:26.1,s:22.6,e:56.4,w:51.6},IQ:{n:37.4,s:29.1,e:48.6,w:38.8},SY:{n:37.3,s:32.3,e:42.4,w:35.7},YE:{n:19,s:12,e:54.5,w:42},LB:{n:34.7,s:33.1,e:36.6,w:35.1},CN:{n:53.6,s:18.2,e:134.8,w:73.5},TW:{n:25.3,s:21.9,e:122,w:120},JP:{n:45.5,s:24.2,e:153.9,w:122.9},KR:{n:38.6,s:33.1,e:131.9,w:124.6},KP:{n:43,s:37.7,e:130.7,w:124.2},IN:{n:35.5,s:6.7,e:97.4,w:68.2},PK:{n:37,s:24,e:77,w:61},AF:{n:38.5,s:29.4,e:74.9,w:60.5},UA:{n:52.4,s:44.4,e:40.2,w:22.1},RU:{n:82,s:41.2,e:180,w:19.6},BY:{n:56.2,s:51.3,e:32.8,w:23.2},PL:{n:54.8,s:49,e:24.1,w:14.1},EG:{n:31.7,s:22,e:36.9,w:25},LY:{n:33,s:19.5,e:25,w:9.4},SD:{n:22,s:8.7,e:38.6,w:21.8},US:{n:49,s:24.5,e:-66.9,w:-125},GB:{n:58.7,s:49.9,e:1.8,w:-8.2},DE:{n:55.1,s:47.3,e:15,w:5.9},FR:{n:51.1,s:41.3,e:9.6,w:-5.1},TR:{n:42.1,s:36,e:44.8,w:26},BR:{n:5.3,s:-33.8,e:-34.8,w:-73.9}}),y(K,"COUNTRY_ALIASES",{IL:["israel","israeli","gaza","hamas","hezbollah","netanyahu","idf","west bank","tel aviv","jerusalem"],IR:["iran","iranian","tehran","persian","irgc","khamenei"],RU:["russia","russian","moscow","kremlin","putin","ukraine war"],UA:["ukraine","ukrainian","kyiv","zelensky","zelenskyy"],CN:["china","chinese","beijing","taiwan strait","south china sea","xi jinping"],TW:["taiwan","taiwanese","taipei"],KP:["north korea","pyongyang","kim jong"],KR:["south korea","seoul"],SA:["saudi","riyadh","mbs"],SY:["syria","syrian","damascus","assad"],YE:["yemen","houthi","sanaa"],IQ:["iraq","iraqi","baghdad"],AF:["afghanistan","afghan","kabul","taliban"],PK:["pakistan","pakistani","islamabad"],IN:["india","indian","new delhi","modi"],EG:["egypt","egyptian","cairo","suez"],LB:["lebanon","lebanese","beirut"],TR:["turkey","turkish","ankara","erdogan","t√ºrkiye"],US:["united states","american","washington","pentagon","white house"],GB:["united kingdom","british","london","uk "],BR:["brazil","brazilian","brasilia","lula","bolsonaro"],AE:["united arab emirates","uae","emirati","dubai","abu dhabi"]}),y(K,"otherCountryTermsCache",new Map);let Ut=K;const Ke="https://worldmonitor.app",ua="https://worldmonitor.app/favico/og-image.png";function Br(p){const{countryCode:e,countryName:t,ciiScore:s,ciiLevel:a,trend:i,type:n}=p,l=`${t} Intelligence Brief | World Monitor`,o=_r(s,a,i,n,t),c=`${Ke}/api/story?c=${e}&t=${n}`;let h=`${Ke}/api/og-story?c=${e}&t=${n}`;s!==void 0&&(h+=`&s=${s}`),a&&(h+=`&l=${a}`),Y("title",l),Y("description",o),Ua(c),Y("og:title",l),Y("og:description",o),Y("og:url",c),Y("og:image",h),Y("twitter:title",l),Y("twitter:description",o),Y("twitter:url",c),Y("twitter:image",h),sessionStorage.setItem("storyMeta",JSON.stringify(p)),console.log("[MetaTags] Updated for story:",t)}function zr(){const p="World Monitor - Global Situation with AI Insights",e="AI-powered real-time global intelligence dashboard with live news, markets, military tracking, and geopolitical data.";Y("title",p),Y("description",e),Ua(Ke),Y("og:title",p),Y("og:description",e),Y("og:url",Ke),Y("og:image",ua),Y("twitter:title",p),Y("twitter:description",e),Y("twitter:url",Ke),Y("twitter:image",ua),sessionStorage.removeItem("storyMeta"),console.log("[MetaTags] Reset to defaults")}function _r(p,e,t,s,a){const i=[];if(p!==void 0&&e&&i.push(`${a} has an instability score of ${p}/100 (${e})`),t){const l=t==="rising"?"trending upward":t==="falling"?"trending downward":"stable";i.push(`Risk is ${l}`)}const n={ciianalysis:"Full intelligence analysis with military posture and prediction markets",crisisalert:"Crisis-focused briefing with convergence alerts",dailybrief:"AI-synthesized daily briefing of top stories",marketfocus:"Prediction market probabilities and market-moving events"};return s&&n[s]&&i.push(n[s]),`World Monitor ${i.join(". ")}. Free, open-source geopolitical intelligence.`}function Y(p,e){const t=document.querySelector(`meta[property="${p}"], meta[name="${p}"]`);t&&t.remove();const s=document.createElement("meta");p.startsWith("og:")||p.startsWith("twitter:")?s.setAttribute("property",p):s.setAttribute("name",p),s.setAttribute("content",e),document.head.appendChild(s)}function Ua(p){let e=document.querySelector('link[rel="canonical"]');e||(e=document.createElement("link"),e.setAttribute("rel","canonical"),document.head.appendChild(e)),e.setAttribute("href",p)}function Or(p){const e=p.searchParams.get("c"),t=p.searchParams.get("t")||"ciianalysis";if(!e||!/^[A-Z]{2,3}$/i.test(e))return null;const a=["ciianalysis","crisisalert","dailybrief","marketfocus"].includes(t)?t:"ciianalysis",i={UA:"Ukraine",RU:"Russia",CN:"China",US:"United States",IR:"Iran",IL:"Israel",TW:"Taiwan",KP:"North Korea",SA:"Saudi Arabia",TR:"Turkey",PL:"Poland",DE:"Germany",FR:"France",GB:"United Kingdom",IN:"India",PK:"Pakistan",SY:"Syria",YE:"Yemen",MM:"Myanmar",VE:"Venezuela"};return{countryCode:e.toUpperCase(),countryName:i[e.toUpperCase()]||e.toUpperCase(),type:a}}function Ur(){const p=new URL(window.location.href);if(p.pathname==="/story"||p.searchParams.has("c")){const e=Or(p);e&&Br(e)}else zr()}function Gr(p){return`wm-chunk-reload:${p}`}function qr(p,e={}){const t=Gr(p),s=e.eventName??"vite:preloadError",a=e.eventTarget??window,i=e.storage??sessionStorage,n=e.reload??(()=>window.location.reload());return a.addEventListener(s,()=>{i.getItem(t)||(i.setItem(t,"1"),n())}),t}function jr(p,e=sessionStorage){e.removeItem(p)}const Vr=void 0;So({dsn:void 0,release:"worldmonitor@2.5.4",environment:location.hostname==="worldmonitor.app"?"production":location.hostname.includes("vercel.app")?"preview":"development",enabled:!!Vr&&!location.hostname.startsWith("localhost")&&!("__TAURI_INTERNALS__"in window),sendDefaultPii:!0,tracesSampleRate:.1,ignoreErrors:["Invalid WebGL2RenderingContext","WebGL context lost",/reading 'imageManager'/,/ResizeObserver loop/,/NotAllowedError/,/InvalidAccessError/,/importScripts/,/^TypeError: Load failed( \(.*\))?$/,/^TypeError: Failed to fetch( \(.*\))?$/,/^TypeError: cancelled$/,/^TypeError: NetworkError/,/runtime\.sendMessage\(\)/,/Java object is gone/,/^Object captured as promise rejection with keys:/,/Unable to load image/,/Non-Error promise rejection captured with value:/,/Connection to Indexed Database server lost/,/webkit\.messageHandlers/,/(?:unsafe-eval.*Content Security Policy|Content Security Policy.*unsafe-eval)/,/Fullscreen request denied/,/requestFullscreen/,/webkitEnterFullscreen/,/vc_text_indicators_context/,/Program failed to link: null/,/too much recursion/,/zaloJSV2/,/Java bridge method invocation error/,/Could not compile fragment shader/,/can't redefine non-configurable property/,/Can.t find variable: (CONFIG|currentInset|NP)/,/invalid origin/,/\.data\.split is not a function/,/signal is aborted without reason/,/Failed to fetch dynamically imported module/,/Importing a module script failed/,/contentWindow\.postMessage/,/Could not compile vertex shader/,/objectStoreNames/,/Unexpected identifier 'https'/,/Can't find variable: _0x/,/WKWebView was deallocated/,/Unexpected end of input/,/window\.android\.\w+ is not a function/,/Attempted to assign to readonly property/,/FetchEvent\.respondWith/,/e\.toLowerCase is not a function/,/\.trim is not a function/,/\.(indexOf|findIndex) is not a function/,/QuotaExceededError/,/^TypeError: Â∑≤ÂèñÊ∂à$/,/Maximum call stack size exceeded/,/^fetchError: Network request failed$/,/window\.ethereum/,/^SyntaxError: Unexpected token/],beforeSend(p){var s,a,i,n,l,o,c;const e=((i=(a=(s=p.exception)==null?void 0:s.values)==null?void 0:a[0])==null?void 0:i.value)??"";if(e.length<=3&&/^[a-zA-Z_$]+$/.test(e))return null;const t=((c=(o=(l=(n=p.exception)==null?void 0:n.values)==null?void 0:l[0])==null?void 0:o.stacktrace)==null?void 0:c.frames)??[];if(/this\.style\._layers|reading '_layers'|this\.light is null|can't access property "(id|type|setFilter)", \w+ is (null|undefined)|Cannot read properties of null \(reading '(id|type|setFilter|_layers)'\)|null is not an object \(evaluating '(E\.|this\.style)/.test(e)&&t.some(h=>/\/map-[A-Za-z0-9]+\.js/.test(h.filename??"")))return null;if(/^TypeError:/.test(e)&&t.length>0){const h=t.filter(d=>d.in_app&&!/\/sentry-[A-Za-z0-9]+\.js/.test(d.filename??""));if(h.length>0&&h.every(d=>/\/map-[A-Za-z0-9]+\.js/.test(d.filename??"")))return null}return p}});window.addEventListener("unhandledrejection",p=>{var e;((e=p.reason)==null?void 0:e.name)==="NotAllowedError"&&p.preventDefault()});const Wr=qr("2.5.4");Ao();xa();Ur();co();po().then(async()=>{await xa(),uo()}).catch(()=>{});ho();requestAnimationFrame(()=>{document.documentElement.classList.remove("no-transition")});localStorage.removeItem("wm-settings-open");const Yr=new Ut("app");Yr.init().then(()=>{jr(Wr)}).catch(console.error);window.geoDebug={inject:yo,cells:mo,count:go};Object.defineProperty(window,"beta",{get(){const p=localStorage.getItem("worldmonitor-beta-mode")==="true";return console.log(`[Beta] ${p?"ON":"OFF"}`),p},set(p){p?localStorage.setItem("worldmonitor-beta-mode","true"):localStorage.removeItem("worldmonitor-beta-mode"),location.reload()}});("__TAURI_INTERNALS__"in window||"__TAURI__"in window)&&document.addEventListener("contextmenu",p=>{const e=p.target;e.tagName==="INPUT"||e.tagName==="TEXTAREA"||e.isContentEditable||p.preventDefault()});!("__TAURI_INTERNALS__"in window)&&!("__TAURI__"in window)&&Xa(async()=>{const{registerSW:p}=await import("./virtual_pwa-register-4EJd4gx4.js");return{registerSW:p}},__vite__mapDeps([0,1,2])).then(({registerSW:p})=>{p({onRegisteredSW(e,t){t&&setInterval(async()=>{if(navigator.onLine)try{await t.update()}catch{}},3600*1e3)},onOfflineReady(){console.log("[PWA] App ready for offline use")}})});
