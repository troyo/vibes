var K=Object.defineProperty;var P=(n,s,e)=>s in n?K(n,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[s]=e;var p=(n,s,e)=>P(n,typeof s!="symbol"?s+"":s,e);import"./main-KbY2xpw4.js";import{cJ as S,t,cK as R,ak as q,cF as x,cD as _,bg as W,cL as V,cM as C,e as E}from"./panels-1tn6mlCz.js";import"./map-BR3s9WVN.js";import"./i18n-VWbTNjcU.js";const k="WORLDMONITOR_API_KEY";class D{constructor(){p(this,"el");p(this,"keyInput");p(this,"emailInput");p(this,"regStatus");p(this,"keyBadge");p(this,"pendingKeyValue",null);this.el=document.createElement("div"),this.el.className="wm-tab",this.render()}render(){const s=S(k),e=s.present?t("modals.settingsWindow.worldMonitor.apiKey.statusValid"):t("modals.settingsWindow.worldMonitor.apiKey.statusMissing"),r=s.present?"ok":"warn";this.el.innerHTML=`
      <div class="wm-hero">
        <h2 class="wm-hero-title">${t("modals.settingsWindow.worldMonitor.heroTitle")}</h2>
        <p class="wm-hero-desc">${t("modals.settingsWindow.worldMonitor.heroDescription")}</p>
      </div>
      <section class="wm-section">
        <h2 class="wm-section-title">${t("modals.settingsWindow.worldMonitor.apiKey.title")}</h2>
        <p class="wm-section-desc">${t("modals.settingsWindow.worldMonitor.apiKey.description")}</p>
        <div class="wm-key-row">
          <div class="wm-input-wrap">
            <input type="password" class="wm-input" data-wm-key-input
              placeholder="${t("modals.settingsWindow.worldMonitor.apiKey.placeholder")}" autocomplete="off" spellcheck="false" />
            <button type="button" class="wm-toggle-vis" data-wm-toggle title="Show/hide">&#x1f441;</button>
          </div>
          <span class="wm-badge ${r}" data-wm-badge>${e}</span>
        </div>
      </section>
      <div class="wm-divider"><span>${t("modals.settingsWindow.worldMonitor.dividerOr")}</span></div>
      <section class="wm-section">
        <h2 class="wm-section-title">${t("modals.settingsWindow.worldMonitor.register.title")}</h2>
        <p class="wm-section-desc">${t("modals.settingsWindow.worldMonitor.register.description")}</p>
        <div class="wm-register-row">
          <input type="email" class="wm-input wm-email" data-wm-email
            placeholder="${t("modals.settingsWindow.worldMonitor.register.emailPlaceholder")}" />
          <button type="button" class="wm-submit-btn" data-wm-register>${t("modals.settingsWindow.worldMonitor.register.submitBtn")}</button>
        </div>
        <p class="wm-reg-status" data-wm-reg-status></p>
      </section>
      <div class="wm-byok">
        <h3 class="wm-byok-title">${t("modals.settingsWindow.worldMonitor.byokTitle")}</h3>
        <p class="wm-byok-desc">${t("modals.settingsWindow.worldMonitor.byokDescription")}</p>
      </div>
    `,this.keyInput=this.el.querySelector("[data-wm-key-input]"),this.emailInput=this.el.querySelector("[data-wm-email]"),this.regStatus=this.el.querySelector("[data-wm-reg-status]"),this.keyBadge=this.el.querySelector("[data-wm-badge]"),this.keyInput.addEventListener("input",()=>{this.pendingKeyValue=this.keyInput.value}),this.el.querySelector("[data-wm-toggle]").addEventListener("click",()=>{this.keyInput.type=this.keyInput.type==="password"?"text":"password"}),this.el.querySelector("[data-wm-register]").addEventListener("click",()=>{this.submitRegistration()})}async submitRegistration(){const s=this.emailInput.value.trim();if(!s||!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s)){this.regStatus.textContent=t("modals.settingsWindow.worldMonitor.register.error"),this.regStatus.className="wm-reg-status error";return}const e=this.el.querySelector("[data-wm-register]");e.disabled=!0,e.textContent=t("modals.settingsWindow.worldMonitor.register.submitting");try{const a=await(await fetch("/api/register-interest",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:s,source:"desktop-settings"})})).json();a.status==="already_registered"?(this.regStatus.textContent=t("modals.settingsWindow.worldMonitor.register.alreadyRegistered"),this.regStatus.className="wm-reg-status ok"):a.status==="registered"?(this.regStatus.textContent=t("modals.settingsWindow.worldMonitor.register.success"),this.regStatus.className="wm-reg-status ok"):(this.regStatus.textContent=a.error||t("modals.settingsWindow.worldMonitor.register.error"),this.regStatus.className="wm-reg-status error")}catch{this.regStatus.textContent=t("modals.settingsWindow.worldMonitor.register.error"),this.regStatus.className="wm-reg-status error"}finally{e.disabled=!1,e.textContent=t("modals.settingsWindow.worldMonitor.register.submitBtn")}}hasPendingChanges(){return this.pendingKeyValue!==null&&this.pendingKeyValue.length>0}async save(){if(this.pendingKeyValue===null)return;await R(k,this.pendingKeyValue),this.pendingKeyValue=null;const s=S(k);this.keyBadge.textContent=s.present?t("modals.settingsWindow.worldMonitor.apiKey.statusValid"):t("modals.settingsWindow.worldMonitor.apiKey.statusMissing"),this.keyBadge.className=`wm-badge ${s.present?"ok":"warn"}`}getElement(){return this.el}destroy(){this.el.innerHTML=""}}let I=!1;function m(n,s="ok"){const e=document.getElementById("settingsActionStatus");e&&(e.textContent=n,e.classList.remove("ok","error"),e.classList.add(s))}async function $(n,s){const e=await C(n);if(e){m(`${s}: ${e}`,"ok");return}m(t("modals.settingsWindow.invokeFail",{command:n}),"error")}function O(){const n=document.querySelectorAll(".settings-tab"),s=document.querySelectorAll(".settings-tab-panel");n.forEach(e=>{e.addEventListener("click",()=>{var i;const r=e.dataset.tab;if(!r)return;n.forEach(d=>{d.classList.remove("active"),d.setAttribute("aria-selected","false")}),s.forEach(d=>d.classList.remove("active")),e.classList.add("active"),e.setAttribute("aria-selected","true");const a=e.getAttribute("aria-controls");a&&((i=document.getElementById(a))==null||i.classList.add("active")),r==="debug"&&!I&&(I=!0,H())})})}function L(){C("close_settings_window").then(()=>{},()=>window.close())}const B=["aiOllama","aiGroq","aiOpenRouter"];function T(n,s){s.innerHTML="";const e=n.getElement();e.classList.remove("resized","span-2","span-3","span-4"),e.classList.add("settings-runtime-panel"),s.appendChild(e)}async function N(){var v,h,u,y;await q(),x(),requestAnimationFrame(()=>{document.documentElement.classList.remove("no-transition")}),await _();const n=document.getElementById("llmApp"),s=document.getElementById("apiKeysApp"),e=document.getElementById("worldmonitorApp");if(!n||!s)return;const r=new W({mode:"full",buffered:!0,featureFilter:B}),a=new W({mode:"full",buffered:!0,featureFilter:V.filter(o=>!B.includes(o.id)).map(o=>o.id)});T(r,n),T(a,s);const i=new D;e&&(e.innerHTML="",e.appendChild(i.getElement()));const d=[r,a];window.addEventListener("beforeunload",()=>{d.forEach(o=>o.destroy()),i.destroy()}),(v=document.getElementById("okBtn"))==null||v.addEventListener("click",()=>{(async()=>{try{const o=i.hasPendingChanges(),g=d.filter(l=>l.hasPendingChanges());if(g.length===0&&!o){L();return}if(o&&await i.save(),g.length>0){m(t("modals.settingsWindow.validating"),"ok");const l=g.flatMap(w=>w.getMissingRequiredSecrets());if(l.length>0){m(`Missing required: ${l.join(", ")}`,"error");return}const f=(await Promise.all(g.map(w=>w.verifyPendingSecrets()))).flat();if(await Promise.all(g.map(w=>w.commitVerifiedSecrets())),f.length>0){m(t("modals.settingsWindow.verifyFailed",{errors:f.join(", ")}),"error");return}}m(t("modals.settingsWindow.saved"),"ok"),L()}catch(o){console.error("[settings] save error:",o),m(t("modals.settingsWindow.failed",{error:String(o)}),"error")}})()}),(h=document.getElementById("cancelBtn"))==null||h.addEventListener("click",()=>{L()}),(u=document.getElementById("openLogsBtn"))==null||u.addEventListener("click",()=>{$("open_logs_folder",t("modals.settingsWindow.openLogs"))}),(y=document.getElementById("openSidecarLogBtn"))==null||y.addEventListener("click",()=>{$("open_sidecar_log_file",t("modals.settingsWindow.openApiLog"))}),O()}const b="http://127.0.0.1:46123";function H(){const n=document.getElementById("verboseApiLog"),s=document.getElementById("fetchDebugLog"),e=document.getElementById("autoRefreshLog"),r=document.getElementById("refreshLogBtn"),a=document.getElementById("clearLogBtn"),i=document.getElementById("trafficLog"),d=document.getElementById("trafficCount");s&&(s.checked=localStorage.getItem("wm-debug-log")==="1",s.addEventListener("change",()=>{localStorage.setItem("wm-debug-log",s.checked?"1":"0")}));async function v(){if(n)try{const l=await(await fetch(`${b}/api/local-debug-toggle`)).json();n.checked=l.verboseMode}catch{}}n==null||n.addEventListener("change",async()=>{try{const l=await(await fetch(`${b}/api/local-debug-toggle`,{method:"POST"})).json();n&&(n.checked=l.verboseMode),m(l.verboseMode?t("modals.settingsWindow.verboseOn"):t("modals.settingsWindow.verboseOff"),"ok")}catch{m(t("modals.settingsWindow.sidecarError"),"error")}}),v();async function h(){if(i)try{const f=(await(await fetch(`${b}/api/local-traffic-log`)).json()).entries||[];if(d&&(d.textContent=`(${f.length})`),f.length===0){i.innerHTML=`<p class="diag-empty">${t("modals.settingsWindow.noTraffic")}</p>`;return}const w=f.slice().reverse().map(c=>{var M;const A=((M=c.timestamp.split("T")[1])==null?void 0:M.replace("Z",""))||c.timestamp;return`<tr class="diag-${c.status<300?"ok":c.status<500?"warn":"err"}"><td>${E(A)}</td><td>${c.method}</td><td title="${E(c.path)}">${E(c.path)}</td><td>${c.status}</td><td>${c.durationMs}ms</td></tr>`}).join("");i.innerHTML=`<table class="diag-table"><thead><tr><th>${t("modals.settingsWindow.table.time")}</th><th>${t("modals.settingsWindow.table.method")}</th><th>${t("modals.settingsWindow.table.path")}</th><th>${t("modals.settingsWindow.table.status")}</th><th>${t("modals.settingsWindow.table.duration")}</th></tr></thead><tbody>${w}</tbody></table>`}catch{i.innerHTML=`<p class="diag-empty">${t("modals.settingsWindow.sidecarUnreachable")}</p>`}}r==null||r.addEventListener("click",()=>void h()),a==null||a.addEventListener("click",async()=>{try{await fetch(`${b}/api/local-traffic-log`,{method:"DELETE"})}catch{}i&&(i.innerHTML=`<p class="diag-empty">${t("modals.settingsWindow.logCleared")}</p>`),d&&(d.textContent="(0)")});let u=null;function y(){o(),u=setInterval(()=>void h(),3e3)}function o(){u&&(clearInterval(u),u=null)}e==null||e.addEventListener("change",()=>{e.checked?y():o()}),h(),y()}localStorage.setItem("wm-settings-open","1");window.addEventListener("beforeunload",()=>localStorage.removeItem("wm-settings-open"));N();
